// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../request ../../core/arrayUtils ../../core/Error ../../core/Logger ../../geometry/support/spatialReferenceUtils ../graphics/featureConversionUtils ../graphics/OptimizedFeatureSet ../graphics/data/projectionSupport ../graphics/data/projectionSupport ../graphics/sources/geojson/geojson ../graphics/sources/support/clientSideDefaults ../support/FieldsIndex ../support/fieldType ../../tasks/support/FeatureSet".split(" "),function(fa,c,a,y,G,r,X,z,P,Y,T,Z,Q,aa,ba,ca,da){function t(d,
g,f){return a.__awaiter(this,void 0,void 0,function(){var l;return a.__generator(this,function(h){switch(h.label){case 0:return[4,U(d,g,f)];case 1:return l=h.sent(),[2,P.convertToFeatureSet(l)]}})})}function U(d,g,f){var l;return a.__awaiter(this,void 0,void 0,function(){var h,H,m,k,V,c,q,n,e,u,A,b,v,B,w,C,D,E,I,W,r,F,G,J,K,L,M,N,R,x,O,S,p;return a.__generator(this,function(t){switch(t.label){case 0:return h=d.capabilities.query.maxRecordCount,H=d.collectionId,m=d.layerDefinition,k=d.url,V=k+"/collections/"+
H+"/items",c=g.geometry,q=g.num,n=g.outSpatialReference,e=g.start,u=g.timeExtent,A=g.where,v=(b=Z.project(c,z.WGS84))?b.xmin+","+b.ymin+","+b.xmax+","+b.ymax:null,B=ea(u),w=A&&"1\x3d1"!==A?A:null,C=null!==e&&void 0!==e?e:0,D=null!==q&&void 0!==q?q:null!=e&&void 0!==e?10:h,[4,y(V,a.__assign(a.__assign({},f),{query:{bbox:v,datetime:B,query:w,limit:D,startindex:C,f:"application/geo+json"}}))];case 1:E=t.sent().data;I=null===(l=E.links)||void 0===l?void 0:l.filter(function(b){return"next"===b.rel});W=
0!==(null===I||void 0===I?void 0:I.length);r=m.fields;F=m.globalIdField;G=m.hasM;J=m.hasZ;K=m.objectIdField;L=m.geometryType;M=Q.createOptimizedFeatures(E,{geometryType:L,hasZ:J,objectIdFieldName:K});if(!z.equals(n,z.WGS84))for(N=0,R=M;N<R.length;N++)x=R[N],x.geometry&&(x.geometry=P.convertFromGeometry(T.project(P.convertToGeometry(x.geometry,L,J,!1),z.WGS84,n)));O=0;for(S=M;O<S.length;O++)x=S[O],x.objectId=x.attributes[K];p=new Y.default;p.exceededTransferLimit=W;p.features=M;p.fields=r;p.geometryType=
L;p.globalIdFieldName=F;p.hasM=G;p.hasZ=J;p.objectIdFieldName=K;p.spatialReference=n||z.WGS84;return[2,p]}})})}function ea(d){if(!d)return null;var g=d.start;d=d.end;return(g?g.toISOString():"..")+"/"+(d?d.toISOString():"..")}Object.defineProperty(c,"__esModule",{value:!0});var F=X.getLogger("esri.layers.graphics.sources.ogcfeature");c.getCollectionDefinition=function(d,g,f,l,h){void 0===h&&(h=5);return a.__awaiter(this,void 0,void 0,function(){var H,m,k,c,t,q,n,e,u,A,b,v,B,w,C,D,E;return a.__generator(this,
function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,T.checkProjectionSupport(z.WGS84,f.spatialReference)];case 1:return a.sent(),[3,3];case 2:throw a.sent(),new r("ogc-feature-layer:projection-not-supported","Projection not supported");case 3:return H=d+"/collections/"+g+"/items",[4,y(H,{signal:l,query:{limit:h,f:"application/geo+json"}})];case 4:return m=a.sent().data,[4,Q.validateGeoJSON(m)];case 5:a.sent();k=Q.inferLayerProperties(m,{geometryType:f.geometryType});c=f.fields||k.fields||
[];t=null!=f.hasZ?f.hasZ:k.hasZ;q=k.geometryType;n=f.objectIdField||k.objectIdFieldName||"OBJECTID";e=f.timeInfo;u=G.find(c,function(b){return b.name===n});if(A=!u){if(!k.objectIdFieldType)throw new r("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");c.unshift({name:n,alias:n,type:"esriFieldTypeOID",editable:!1,nullable:!1})}else u.type="esriFieldTypeOID",u.editable=!1,u.nullable=!1;n!==k.objectIdFieldName&&(b=G.find(c,function(b){return b.name===
k.objectIdFieldName}))&&(b.type="esriFieldTypeInteger");if(!q)throw new r("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");c===k.fields&&0<k.unknownFields.length&&F.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:k.unknownFields}});v=0;for(B=c;v<B.length;v++){b=B[v];null==b.name&&(b.name=b.alias);null==b.alias&&(b.alias=b.name);
"esriFieldTypeOID"!==b.type&&"esriFieldTypeGlobalID"!==b.type&&(b.editable=null==b.editable?!0:!!b.editable,b.nullable=null==b.nullable?!0:!!b.nullable);if(!b.name)throw new r("ogc-feature-layer:invalid-field-name","field name is missing",{field:b});if(-1===ca.kebabDict.jsonValues.indexOf(b.type))throw new r("ogc-feature-layer:invalid-field-type",'invalid type for field "'+b.name+'"',{field:b});}e&&(w=new ba(c),e.startTimeField&&((C=w.get(e.startTimeField))?(e.startTimeField=C.name,C.type="esriFieldTypeDate"):
e.startTimeField=null),e.endTimeField&&((D=w.get(e.endTimeField))?(e.endTimeField=D.name,D.type="esriFieldTypeDate"):e.endTimeField=null),e.trackIdField&&((E=w.get(e.trackIdField))?e.trackIdField=E.name:(e.trackIdField=null,F.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:e}}))),e.startTimeField||e.endTimeField||(F.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:e}}),
e=null));return[2,{drawingInfo:aa.createDrawingInfo(q),geometryType:q,fields:c,hasZ:!!t,objectIdField:n,timeInfo:e}]}})})};c.getServerCollection=function(d,g,c,l){return a.__awaiter(this,void 0,void 0,function(){var h,f;return a.__generator(this,function(a){switch(a.label){case 0:return h=d+"/collections/"+g,[4,y(h,{signal:l,query:{f:c}})];case 1:return f=a.sent().data,[2,f]}})})};c.getServerCollections=function(d,c,f){return a.__awaiter(this,void 0,void 0,function(){var l,h;return a.__generator(this,
function(a){switch(a.label){case 0:return l=d+"/collections",[4,y(l,{signal:f,query:{f:c}})];case 1:return h=a.sent().data,[2,h]}})})};c.getServerConformance=function(c,g,f){return a.__awaiter(this,void 0,void 0,function(){var d,h;return a.__generator(this,function(a){switch(a.label){case 0:return d=c+"/conformance",[4,y(d,{signal:f,query:{f:g}})];case 1:return h=a.sent().data,[2,h]}})})};c.getServerLandingPage=function(c,g,f){return a.__awaiter(this,void 0,void 0,function(){var d;return a.__generator(this,
function(a){switch(a.label){case 0:return[4,y(c,{signal:f,query:{f:g}})];case 1:return d=a.sent().data,[2,d]}})})};c.queryFeatureSet=function(c,g,f){return a.__awaiter(this,void 0,void 0,function(){var d;return a.__generator(this,function(a){switch(a.label){case 0:return[4,t(c,g,f)];case 1:return d=a.sent(),[2,da.fromJSON(d)]}})})};c.queryFeatureSetJSON=t;c.queryOptimizedFeatureSet=U});