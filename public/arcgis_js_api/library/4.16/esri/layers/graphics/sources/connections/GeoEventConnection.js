// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../geometry ../../../../request ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../FeatureLayer ./StreamConnection ../../../../tasks/operations/query ../../../../tasks/operations/zscale ../../../../tasks/support/Query".split(" "),function(v,q,d,y,z,n,A,k,t,u,B,C,w,D,E){Object.defineProperty(q,"__esModule",{value:!0});var l=A.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),
r;(function(d){d[d.CONNECTING=0]="CONNECTING";d[d.OPEN=1]="OPEN";d[d.CLOSING=2]="CLOSING";d[d.CLOSED=3]="CLOSED"})(r=q.ReadyState||(q.ReadyState={}));v=function(q){function e(a,c,b,h,g,d,e,k){void 0===d&&(d=5);void 0===e&&(e=3);var f=q.call(this)||this;f._destroyed=!1;f.errorString=null;f._source=a;f._sourceSpatialReference=c;f._spatialReference=b;f._filter=g;f._outFields=k;f._maxQueryDepth=d;f._maxRecordCountFactor=e;f._featureZScaler=D.getGeometryZScaler(h,c,b);f._open();return f}d.__extends(e,
q);e.prototype._open=function(){return d.__awaiter(this,void 0,void 0,function(){var a,c,b,h;return d.__generator(this,function(g){switch(g.label){case 0:return[4,this._fetchServiceDefinition(this._source)];case 1:return a=g.sent(),a.timeInfo.trackIdField||l.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),[4,this._fetchWebSocketUrl(a.streamUrls,this._spatialReference)];
case 2:return c=g.sent(),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),[4,this._buddyServicesQuery];case 3:return g.sent(),[4,this._tryCreateWebSocket(c)];case 4:return g.sent(),b=this._filter,h=this._outFields,this._destroyed||this._setFilter(b,h),[2]}})})};e.prototype.destroy=function(){this._destroyed=!0;k.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close());
this._websocket=null};Object.defineProperty(e.prototype,"connectionStatus",{get:function(){if(k.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case r.CONNECTING:case r.OPEN:return"connected";case r.CLOSING:case r.CLOSED:return"disconnected"}},enumerable:!0,configurable:!0});e.prototype._tryCreateWebSocket=function(a,c){void 0===c&&(c=1E3);return d.__awaiter(this,void 0,void 0,function(){var b,h,g;return d.__generator(this,function(f){switch(f.label){case 0:f.trys.push([0,
2,,4]);if(this._destroyed)return[2];b=this;return[4,this._createWebSocket(a)];case 1:return b._websocket=f.sent(),this.notifyChange("connectionStatus"),[3,4];case 2:return h=f.sent(),g=c/1E3,l.error(new n("geoevent-connection","Failed to connect. Attempting to reconnect in "+g+"s",h)),[4,t.after(c)];case 3:return f.sent(),[2,this._tryCreateWebSocket(a,1.5*c)];case 4:return[2]}})})};e.prototype._createWebSocket=function(a){var c=this,b=new WebSocket(a);a=t.create(function(a,c){b.onopen=function(){return a(b)};
b.onclose=function(a){return c(a)}});a.then(function(){c._destroyed?(b.onclose=function(){},b.close()):(b.onclose=function(a){return c._onClose(a)},b.onerror=function(a){return c._onError(a)},b.onmessage=function(a){return c._onMessage(a)})});return a};e.prototype._onMessage=function(a){var c;try{c=this._enrich(JSON.parse(a.data)),this._featureZScaler&&this._featureZScaler(c.geometry)}catch(b){l.error(new n("geoevent-connection","Failed to parse message",b));return}this.onFeature(c)};e.prototype._onError=
function(a){this._set("errorString","Encountered an error over WebSocket connection");l.error("geoevent-connection","Encountered an error over WebSocket connection")};e.prototype._onClose=function(a){this._websocket=null;this.notifyChange("connectionStatus");1E3!==a.code&&l.error("geoevent-connection","WebSocket closed unexpectedly with error code "+a.code);this._destroyed||this._open()};e.prototype._fetchServiceDefinition=function(a){return d.__awaiter(this,void 0,void 0,function(){var c,b,h,g;return d.__generator(this,
function(f){switch(f.label){case 0:return c={f:"json"},b=z(a,{query:c,responseType:"json"}),[4,b];case 1:return h=f.sent(),this._serviceDefinition=g=h.data,[2,g]}})})};e.prototype._fetchWebSocketUrl=function(a,c){return d.__awaiter(this,void 0,void 0,function(){var b,h,g,f;return d.__generator(this,function(d){b=a[0];h=b.urls;g=b.token;f=this._inferWebSocketBaseUrl(h);return[2,f+"/subscribe?outSR\x3d"+c.wkid+(g?"\x26token\x3d"+g:"")]})})};e.prototype._inferWebSocketBaseUrl=function(a){if(1===a.length)return a[0];
for(var c=0;c<a.length;c++){var b=a[c];if(-1!==b.indexOf("wss"))return b}l.error(new n("geoevent-connection","Unable to infer WebSocket url",a));return null};e.prototype._setFilter=function(a,c){return d.__awaiter(this,void 0,void 0,function(){var b,h,g,f,e,x,p=this;return d.__generator(this,function(d){b=this._websocket;this._filter=a;this._outFields=c;if(k.isNone(b)||k.isNone(a)&&k.isNone(c))return[2];h=JSON.stringify({filter:this._serializeFilter(a,c)});g=!1;f=t.createResolver();e=function(){g||
(p._destroyed||p._websocket!==b||l.error(new n("geoevent-connection","Server timed out when setting filter")),f.reject())};x=function(a){a=JSON.parse(a.data);a.filter&&(a.error&&(l.error(new n("geoevent-connection","Failed to set service filter",a.error)),p._set("errorString","Could not set service filter - "+a.error),f.reject(a.error)),b.onmessage=p._onMessage.bind(p),g=!0,f.resolve())};b.onmessage=x;b.send(h);setTimeout(e,1E4);return[2,f.promise]})})};e.prototype._serializeFilter=function(a,c){var b=
{};if(k.isNone(a)&&k.isNone(c))return b;if(k.isSome(a)&&a.geometry)try{var h=y.fromJSON(a.geometry);if("extent"!==h.type)throw new n("Expected extent but found type "+h.type);b.geometry=JSON.stringify(h.shiftCentralMeridian())}catch(g){l.error(new n("geoevent-connection","Encountered an error when setting connection geometryDefinition",g))}k.isSome(a)&&a.where&&"1 \x3d 1"!==a.where&&(b.where=a.where);k.isSome(c)&&(b.outFields=c.join(","));return b};e.prototype._enrich=function(a){if(!this._relatedFeatures)return a;
var c=a.attributes[this._serviceDefinition.relatedFeatures.joinField];if(!this._relatedFeatures.has(c))return l.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",a),a;var b=this._relatedFeatures.get(c),c=b.attributes,b=b.geometry,h;for(h in c)a.attributes[h]=c[h];b&&(a.geometry=b);a.geometry||a.centroid||l.error(new n("geoevent-connection","Found malformed feature - no geometry found",a));return a};e.prototype._queryBuddyServices=function(){return d.__awaiter(this,
void 0,void 0,function(){var a,c,b,h,g,f,e,k,p,m;return d.__generator(this,function(d){switch(d.label){case 0:return d.trys.push([0,3,,4]),a=this._serviceDefinition,c=a.relatedFeatures,b=a.keepLatestArchive,h=this._queryRelatedFeatures(c),g=this._queryArchive(b),[4,h];case 1:return d.sent(),[4,g];case 2:f=d.sent();if(!f)return[2];e=0;for(k=f.features;e<k.length;e++)p=k[e],this.onFeature(this._enrich(p));return[3,4];case 3:return m=d.sent(),l.error(new n("geoevent-connection","Encountered an error when querying buddy services",
{error:m})),[3,4];case 4:return[2]}})})};e.prototype._queryRelatedFeatures=function(a){return d.__awaiter(this,void 0,void 0,function(){var c;return d.__generator(this,function(b){switch(b.label){case 0:return a?[4,this._queryBuddy(a.featuresUrl)]:[2];case 1:return c=b.sent(),this._addRelatedFeatures(c),[2]}})})};e.prototype._queryArchive=function(a){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(c){return a?[2,this._queryBuddy(a.featuresUrl)]:[2,void 0]})})};
e.prototype._queryBuddy=function(a){return d.__awaiter(this,void 0,void 0,function(){var c,b,h,g,f,e,l,p,m,n;return d.__generator(this,function(d){switch(d.label){case 0:return c=new B({url:a}),[4,c.load()];case 1:return b=d.sent().capabilities,h=b.query.supportsMaxRecordCountFactor,g=b.query.supportsPagination,f=b.query.supportsCentroid,e=this._maxRecordCountFactor,l=c.capabilities.query.maxRecordCount,p=h?l*e:l,m=new E,m.outFields=k.unwrapOr(this._outFields,["*"]),m.where=k.unwrapOr(k.get(this._filter,
"where"),"1\x3d1"),m.returnGeometry=!0,m.returnExceededLimitFeatures=!0,m.outSpatialReference=this._spatialReference,f&&(m.returnCentroid=!0),h&&(m.maxRecordCountFactor=e),g?(m.num=p,c.destroy(),[2,this._queryPages(a,m)]):[4,w.executeQuery(a,m,this._sourceSpatialReference)];case 2:return n=d.sent(),c.destroy(),[2,n.data]}})})};e.prototype._queryPages=function(a,c,b,e){void 0===b&&(b=[]);void 0===e&&(e=0);return d.__awaiter(this,void 0,void 0,function(){var g;return d.__generator(this,function(d){switch(d.label){case 0:return c.start=
e*c.num,[4,w.executeQuery(a,c,this._sourceSpatialReference)];case 1:g=d.sent().data;if(g.exceededTransferLimit&&e<this._maxQueryDepth)return g.features.forEach(function(a){return b.push(a)}),[2,this._queryPages(a,c,b,e+1)];b.forEach(function(a){return g.features.push(a)});return[2,g]}})})};e.prototype._addRelatedFeatures=function(a){var c=new Map,b=this._serviceDefinition.relatedFeatures.joinField,d=0;for(a=a.features;d<a.length;d++){var e=a[d];c.set(e.attributes[b],e)}this._relatedFeatures=c};d.__decorate([u.property()],
e.prototype,"connectionStatus",null);d.__decorate([u.property()],e.prototype,"errorString",void 0);return e=d.__decorate([u.subclass("esri.layers.graphics.sources.connections.GeoEventConnection")],e)}(C.default);q.default=v});