// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../request ../../../core/Error ../../../core/Loadable ../../../core/maybe ../../../core/promiseUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators ../../../tasks/QueryTask ../../../tasks/operations/queryAttachments ../../../tasks/operations/zscale".split(" "),function(t,u,e,q,v,C,B,m,r,n,D,E,F){function G(f){return e.__awaiter(this,void 0,void 0,function(){var b;return e.__generator(this,function(a){return"string"===typeof f?(b=r.dataComponents(f),
[2,b?b:{data:f}]):[2,m.create(function(a,d){var c=new FileReader;c.readAsDataURL(f);c.onload=function(){return a(r.dataComponents(c.result))};c.onerror=function(a){return d(a)}})]})})}Object.defineProperty(u,"__esModule",{value:!0});t=function(f){function b(){var a=null!==f&&f.apply(this,arguments)||this;a.type="feature-layer";return a}e.__extends(b,f);b.prototype.load=function(a){a=B.isSome(a)?a.signal:null;this.addResolvingPromise(this._fetchService(a));return m.resolve(this)};Object.defineProperty(b.prototype,
"queryTask",{get:function(){var a=this.layer,c=a.parsedUrl,d=a.gdbVersion,b=a.spatialReference;return new D({url:null!=a.dynamicDataSource?c.path+"?"+r.objectToQuery(c.query):c.path,gdbVersion:d,sourceSpatialReference:b})},enumerable:!0,configurable:!0});b.prototype.addAttachment=function(a,c){var d=this;return this.load().then(function(){var b=a.attributes[d.layer.objectIdField],p=d.layer.parsedUrl.path+"/"+b+"/addAttachment",l=e.__assign(e.__assign({f:"json"},d.layer.parsedUrl.query),{gdbVersion:d.layer.gdbVersion}),
l=d._getFormDataForAttachment(c,l);return q(p,{body:l}).then(function(a){return d._createFeatureEditResult(a.data.addAttachmentResult)}).catch(function(a){throw d._createAttachmentErrorResult(b,a);})})};b.prototype.updateAttachment=function(a,c,d){var b=this;return this.load().then(function(){var g=a.attributes[b.layer.objectIdField],l=b.layer.parsedUrl.path+"/"+g+"/updateAttachment",h=e.__assign(e.__assign({f:"json"},b.layer.parsedUrl.query),{gdbVersion:b.layer.gdbVersion,attachmentId:c}),h=b._getFormDataForAttachment(d,
h);return q(l,{body:h}).then(function(a){return b._createFeatureEditResult(a.data.updateAttachmentResult)}).catch(function(a){throw b._createAttachmentErrorResult(g,a);})})};b.prototype.applyEdits=function(a,c){return e.__awaiter(this,void 0,void 0,function(){var d,b,p,l,h,y,k,z,w,f,n,x,m,r,t,A,u,v;return e.__generator(this,function(g){switch(g.label){case 0:return[4,this.load()];case 1:g.sent(),d=a.addFeatures.map(this._serializeFeature,this),b=a.updateFeatures.map(this._serializeFeature,this),p=
this._getFeatureIds(a.deleteFeatures),F.unapplyEditsZUnitScaling(d,b,this.layer.spatialReference),l=[],h=[],y=e.__spreadArrays(a.deleteAttachments),k=0,z=a.addAttachments,g.label=2;case 2:if(!(k<z.length))return[3,5];w=z[k];n=(f=l).push;return[4,this._serializeAttachment(w)];case 3:n.apply(f,[g.sent()]),g.label=4;case 4:return k++,[3,2];case 5:x=0,m=a.updateAttachments,g.label=6;case 6:if(!(x<m.length))return[3,9];w=m[x];t=(r=h).push;return[4,this._serializeAttachment(w)];case 7:t.apply(r,[g.sent()]),
g.label=8;case 8:return x++,[3,6];case 9:return A=l.length||h.length||y.length?{adds:l,updates:h,deletes:y}:null,u={f:"json",adds:d.length?JSON.stringify(d):null,updates:b.length?JSON.stringify(b):null,deletes:p.length?p.join(","):null,gdbVersion:c&&c.gdbVersion||this.layer.gdbVersion,rollbackOnFailure:c&&c.rollbackOnFailureEnabled,useGlobalIds:c&&c.globalIdUsed,attachments:A&&JSON.stringify(A)},[4,q(this.layer.parsedUrl.path+"/applyEdits",{query:u,method:"post",responseType:"json"})];case 10:return v=
g.sent(),[2,this._createEditsResult(v)]}})})};b.prototype.deleteAttachments=function(a,c){var d=this;return this.load().then(function(){var b=a.attributes[d.layer.objectIdField];return q(d.layer.parsedUrl.path+"/"+b+"/deleteAttachments",{query:e.__assign(e.__assign({f:"json"},d.layer.parsedUrl.query),{gdbVersion:d.layer.gdbVersion,attachmentIds:c.join(",")}),method:"post",responseType:"json"}).then(function(a){return a.data.deleteAttachmentResults.map(d._createFeatureEditResult)}).catch(function(a){throw d._createAttachmentErrorResult(b,
a);})})};b.prototype.queryAttachments=function(a,c){var d=this;void 0===c&&(c={});var b=this.layer.parsedUrl,p=b.path;return this.load().then(function(){var g=e.__assign(e.__assign({},c),{query:e.__assign(e.__assign({},b.query),{gdbVersion:d.layer.gdbVersion,f:"json"}),responseType:"json"});if(!d.layer.get("capabilities.operations.supportsQueryAttachments")){for(var h=a.objectIds,f=[],k=0;k<h.length;k++)f.push(q(p+"/"+h[k]+"/attachments",g));return m.all(f).then(function(a){return h.map(function(c,
b){return{parentObjectId:c,attachmentInfos:a[b].data.attachmentInfos}})}).then(function(a){return E.processAttachmentQueryResult(a,p)})}return d.queryTask.executeAttachmentQuery(a,g)})};b.prototype.queryFeatures=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.execute(a,c)})};b.prototype.queryFeaturesJSON=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeJSON(a,c)})};b.prototype.queryObjectIds=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeForIds(a,
c)})};b.prototype.queryFeatureCount=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeForCount(a,c)})};b.prototype.queryExtent=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeForExtent(a,c)})};b.prototype.queryRelatedFeatures=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeRelationshipQuery(a,c)})};b.prototype._fetchService=function(a){return e.__awaiter(this,void 0,void 0,function(){var c,
b;return e.__generator(this,function(d){switch(d.label){case 0:return(c=this.layer.sourceJSON)?(this.sourceJSON=c,[2]):[4,q(this.layer.parsedUrl.path,{query:e.__assign({f:"json"},this.layer.parsedUrl.query),responseType:"json",signal:a})];case 1:return this.sourceJSON=b=d.sent().data,[2]}})})};b.prototype._serializeFeature=function(a){var c=a.geometry;a=a.attributes;return B.isNone(c)?{attributes:a}:"mesh"===c.type||"extent"===c.type?null:{geometry:c.toJSON(),attributes:a}};b.prototype._serializeAttachment=
function(a){return e.__awaiter(this,void 0,void 0,function(){var c,b,g,f,l,h,m,k,n;return e.__generator(this,function(d){switch(d.label){case 0:c=a.feature;b=a.attachment;g=b.globalId;f=b.name;l=b.contentType;h=b.data;m=b.uploadId;k={globalId:g,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};c&&(k.parentGlobalId="attributes"in c?c.attributes&&c.attributes[this.layer.globalIdField]:c.globalId);if(!m)return[3,1];k.uploadId=m;return[3,3];case 1:return h?[4,G(h)]:[3,3];case 2:n=
d.sent(),k.contentType=n.mediaType,k.data=n.data,h instanceof File&&(k.name=h.name),d.label=3;case 3:return f&&(k.name=f),l&&(k.contentType=l),[2,k]}})})};b.prototype._getFeatureIds=function(a){var c=a[0];return c?"objectId"in c?this._getIdsFromFeatureIdentifier(a):this._getIdsFromFeatures(a):[]};b.prototype._getIdsFromFeatures=function(a){var c=this.layer.objectIdField;return a.map(function(a){return a.attributes&&a.attributes[c]})};b.prototype._getIdsFromFeatureIdentifier=function(a){return a.map(function(a){return a.objectId})};
b.prototype._createEditsResult=function(a){var b=a.data;a=a.data&&a.data.attachments;return{addFeatureResults:b.addResults?b.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:b.updateResults?b.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:b.deleteResults?b.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:a&&a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:a&&a.updateResults?
a.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:a&&a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[]}};b.prototype._createFeatureEditResult=function(a){var b=!0===a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new v("feature-layer-source:edit-failure",b.description,{code:b.code}):null}};b.prototype._createAttachmentErrorResult=function(a,b){return{objectId:a,globalId:null,error:new v("feature-layer-source:attachment-failure",
b.details.messages&&b.details.messages[0]||b.message,{code:b.details.httpStatus||b.details.messageCode})}};b.prototype._getFormDataForAttachment=function(a,b){if(a=a instanceof FormData?a:a&&a.elements?new FormData(a):null)for(var c in b){var e=b[c];null!=e&&(a.set?a.set(c,e):a.append(c,e))}return a};e.__decorate([n.property()],b.prototype,"type",void 0);e.__decorate([n.property({constructOnly:!0})],b.prototype,"layer",void 0);e.__decorate([n.property({readOnly:!0,dependsOn:["layer.parsedUrl","layer.gdbVersion",
"layer.dynamicDataSource"]})],b.prototype,"queryTask",null);return b=e.__decorate([n.subclass("esri.layers.graphics.sources.FeatureLayerSource")],b)}(C);u.default=t});