// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Accessor ../../../core/asyncUtils ../../../core/Collection ../../../core/compilerUtils ../../../core/Error ../../../core/Handles ../../../core/lang ../../../core/Logger ../../../core/maybe ../../../core/Promise ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../support/arcgisLayerUrl ../../../portal/support/geometryServiceUtils ../../../tasks/support/StatisticDefinition ../../../views/3d/layers/support/FeatureTileFetcher3D ../../../views/3d/layers/support/FeatureTileFetcher3DDebugger ../../../views/3d/support/debugFlags ../../../views/support/WatchUpdatingTracking".split(" "),
function(e,R,c,E,B,t,u,F,G,C,H,y,I,k,f,d,J,K,L,M,N,O,P){function D(c,a){if(!a)return!1;for(var d=0;d<a.length;d++)if(!c.has(a[d]))return!0;return!1}var v=H.getLogger("esri.layers.graphics.controllers.FeatureTileController3D");e=function(e){function a(b){b=e.call(this,b)||this;b.type="feature-tile-3d";b.watchUpdatingTracking=new P.WatchUpdatingTracking;b.serviceDataExtent=null;b.serviceDataCount=h.constants.NO_SERVICE_DATA_COUNT;b.vertexLimitExceeded=!1;b.displayFeatureLimit=null;b.suspended=!1;b.tileFetcher=
null;b.handles=new G;b.fetchDataInfoPromise=null;b.fetchDataInfoAbortController=null;b.lifeCycleAbortController=k.createAbortController();return b}c.__extends(a,e);h=a;Object.defineProperty(a.prototype,"extent",{set:function(b){if(b&&!b.spatialReference.equals(this.layerView.view.spatialReference))v.error("#extent\x3d","extent needs to be in the same spatial reference as the view");else{var a=this._get("extent");a===b||a&&b&&a.equals(b)||(b=b?b.clone():null,this._set("extent",b))}},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"updating",{get:function(){return!!(this.tileFetcher&&this.tileFetcher.updating||null!=this.fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"updatingTotal",{get:function(){return this.updating&&this.tileFetcher?this.tileFetcher.updatingTotal:0},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"updatingRemaining",{get:function(){return this.updating&&this.tileFetcher?this.tileFetcher.updatingRemaining:0},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"expectedFeatureDiff",{get:function(){return this.updating&&this.tileFetcher?this.tileFetcher.expectedFeatureDiff:0},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"memoryForUnusedFeatures",{get:function(){return this.tileFetcher?this.tileFetcher.memoryForUnusedFeatures:
0},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!(!this.tileFetcher||!this.tileFetcher.maximumNumberOfFeaturesExceeded)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"filteredDataExtent",{get:function(){return this.extent},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maximumNumberOfFeatures",{get:function(){return this.displayFeatureLimit?this.displayFeatureLimit.maximumNumberOfFeatures:
0},set:function(b){b!==this.maximumNumberOfFeatures&&(null==b?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",b))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"hasMaximumNumberOfFeaturesOverride",{get:function(){return this._isOverridden("maximumNumberOfFeatures")},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"mode",{get:function(){if(this.serviceDataCount===h.constants.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";
var b=this.layerView,a=b.layer,b=(b=(b=b.view)&&b.featureTiles)&&b.tilingScheme;return a&&a.minScale&&this.serviceDataExtent&&b&&(a=this.approximateExtentSizeAtScale(a.minScale,b),(this.serviceDataExtent.width/a+this.serviceDataExtent.height/a)/2>h.constants.MAX_SNAPSHOT_MIN_SCALE_FACTOR)?"tiles":!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxTotalSnapshotVertices",{get:function(){var b=
this._get("maxTotalSnapshotVertices")||0;return Math.max(b,"snapshot"===this.mode&&this.tileFetcher&&this.tileFetcher.totalVertices||0)},enumerable:!0,configurable:!0});a.prototype.approximateExtentSizeAtScale=function(b,a){var l=this.layerView.view,c=a.levels[0];return(c.tileSize[0]/(c.scale/b)+c.tileSize[1]/(c.scale/b))/2*Math.ceil((l.width/a.pixelSize+l.height/a.pixelSize)/2)};Object.defineProperty(a.prototype,"tileDescriptors",{get:function(){return"snapshot"===this.mode?new t([{id:"dummy-tile-full-extent",
lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new t},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"test",{get:function(){return{fetchDataInfoPromise:this.fetchDataInfoPromise,tileFetcher:this.tileFetcher}},enumerable:!0,configurable:!0});a.prototype.initialize=function(){var b=this;this.watchUpdatingTracking.add(this,"vertexLimitInfo",function(){return b.watchUpdatingTracking.addPromise(b.updateVertexLimitExceeded(null,b.lifeCycleAbortController.signal))});
this.watchUpdatingTracking.add(this,"mode",function(){return b.modeChanged()},2);var a=k.resolve().then(function(){return b.verifyCapabilities()}).then(function(){return b.watchUpdatingTracking.addPromise(b.fetchServiceDataInfo())}).then(function(){return b.initializeTileFetcher()});this.addResolvingPromise(a)};a.prototype.verifyCapabilities=function(){var b=this.layerView.layer;if(!b.get("capabilities.operations.supportsQuery"))throw new F("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",
{layer:b});};a.prototype.destroy=function(){this.cancelFetchServiceDataInfo();this.tileFetcher&&(this.tileFetcher.destroy(),this.tileFetcher=null);this.handles&&(this.handles.destroy(),this.handles=null);this.tilesHandle&&(this.tilesHandle.remove(),this.tilesHandle=null);this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null);this.watchUpdatingTracking.destroy();this._set("watchUpdatingTracking",null)};a.prototype.suspend=function(){this.suspended||
(this.suspended=!0,this.tileFetcher&&this.tileFetcher.suspend())};a.prototype.resume=function(){this.suspended&&(this.suspended=!1,this.tileFetcher&&this.tileFetcher.resume())};a.prototype.restart=function(){var b=this,a=function(){b.tileFetcher&&b.tileFetcher.restart()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(a,a))};a.prototype.refetch=function(){var b=this,a=function(){b.tileFetcher&&b.tileFetcher.refetch()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(a,
a))};a.prototype.initializeTileFetcher=function(){var b=this,a=this.layerView.view,c=f.whenOnce(a.featureTiles,"tilingScheme",this.lifeCycleAbortController.signal);this.watchUpdatingTracking.addPromise(c);c.then(function(){var c=b.layerView,l=c.layer;b.tileFetcher=new M.FeatureTileFetcher3D({context:b.context,filterExtent:b.filteredDataExtent,tileDescriptors:b.tileDescriptors,features:b.graphics});b.suspended?b.tileFetcher.suspend():b.tileFetcher.resume();var w=b.layerView.view.resourceController;
w&&(b.handles.add(w.memoryController.events.on("quality-changed",function(a){b.tileFetcher.memoryFactor=a})),b.tileFetcher.memoryFactor=w.memoryController.memoryFactor);(w="polygon"===b.context.geometryType?"polygonLodFactor":"polyline"===b.context.geometryType?"polylineLodFactor":null)&&b.handles.add(f.init(b.layerView.view,"qualitySettings.graphics3D."+w,function(a){b.tileFetcher.lodFactor=a||1}));b.watchUpdatingTracking.add(l,"createQueryVersion",function(){return b.dataFilterChanged()});b.watchUpdatingTracking.add(c,
"availableFields",function(a,c){return b.availableFieldsChanged(c,a)});b.watchUpdatingTracking.add(c,"requiredFields",function(a,c){return b.requiredFieldsChanged(c,a)});b.handles.add([l.on("apply-edits",function(a){return b.applyEdits(a)}),b.watch("filteredDataExtent",function(a){return b.tileFetcher.filterExtent=a},!0),b.watch("tileDescriptors",function(a){return b.tileFetcher.tileDescriptors=a},!0),f.init(b,"maximumNumberOfFeatures",function(a){b.tileFetcher.maximumNumberOfFeatures=a;b.tileFetcher.useTileCount=
b.serviceDataCount>a},!0),f.init(b,"serviceDataCount",function(a){return b.tileFetcher.useTileCount=a>b.maximumNumberOfFeatures},!0),f.init(O,"FEATURE_TILE_FETCH_SHOW_TILES",function(c){c&&b.tileFetcher&&!b.tileFetcher.debugger?(b.tileFetcher.debugger=new N.FeatureTileFetcher3DDebugger(b.tileFetcher,a.featureTiles.tilingScheme.toTileInfo(),a),b.tileFetcher.debugger.update()):!c&&b.tileFetcher&&b.tileFetcher.debugger&&(b.tileFetcher.debugger.destroy(),b.tileFetcher.debugger=null)})]);b.supportsExceedsLimitQuery||
b.watchUpdatingTracking.add(b,"maxTotalSnapshotVertices",function(){return b.watchUpdatingTracking.addPromise(b.updateVertexLimitExceeded(null,b.lifeCycleAbortController.signal))})}).catch(function(){})};a.prototype.modeChanged=function(){switch(this.mode){case "tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:v.warn("Unhandled feature layer mode "+this.mode);case "snapshot":this.tilesHandle&&(this.tilesHandle.remove(),this.tilesHandle=null)}};
a.prototype.dataFilterChanged=function(){this._set("maxTotalSnapshotVertices",0);this.notifyChange("maxTotalSnapshotVertices");this.refetch()};a.prototype.applyEdits=function(b){var a=this;this.tileFetcher.applyEdits(b).then(function(b){b&&(b.deletedFeatures.length||b.updatedFeatures.length||b.addedFeatures.length)&&a.watchUpdatingTracking.addPromise(a.updateServiceDataExtent(a.lifeCycleAbortController.signal))})};a.prototype.availableFieldsChanged=function(b,a){this.tileFetcher&&D(this.tileFetcher.availableFields,
a)&&this.refetch()};a.prototype.requiredFieldsChanged=function(b,a){this.tileFetcher&&D(this.tileFetcher.availableFields,a)&&this.restart()};a.prototype.createVertexLimitExceededQuery=function(b){var a=this.layerView.layer,c=a.createQuery();c.outStatistics=[new L({statisticType:"exceedslimit",maxVertexCount:b,outStatisticFieldName:"exceedslimit",maxPointCount:1E8,maxRecordCount:1E8})];a.capabilities.query.supportsCacheHint&&(c.cacheHint=!0);return c};a.prototype.createDataInfoQuery=function(){var b=
this.layerView.layer,a=b.createQuery();a.outSpatialReference=this.layerView.view.spatialReference;b.capabilities.query.supportsCacheHint&&(a.cacheHint=!0);return a};a.prototype.fullExtentIsAccurate=function(){var b=this.layerView.layer;if(b.definitionExpression)return!1;switch(b.type){case "feature":return J.isHostedAgolService(b.url);case "csv":case "geojson":case "ogc-feature":return!0;default:u.neverReached(b)}};a.prototype.updateServiceDataExtent=function(b){return c.__awaiter(this,void 0,void 0,
function(){var a;return c.__generator(this,function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,this.tryUpdateServiceDataExtent(b)];case 1:return c.sent(),[3,3];case 2:return a=c.sent(),k.isAbortError(a)||this._set("serviceDataExtent",C.clone(this.layerView.fullExtentInLocalViewSpatialReference)),[3,3];case 3:return[2]}})})};a.prototype.tryUpdateServiceDataExtent=function(b){return c.__awaiter(this,void 0,void 0,function(){var a,d,g,z,p,e,q,k,r,f,n,m;return c.__generator(this,function(c){switch(c.label){case 0:a=
this.layerView;d=a.layer;g=d.capabilities.query.supportsExtent;z=C.clone(a.fullExtentInLocalViewSpatialReference);p=d.fullExtent;e=this.fullExtentIsAccurate();q=this.serviceDataCount;k=g&&q<=h.constants.MAX_FEATURE_COUNT_FOR_EXTENT&&(!z||!e);if(!(k&&"queryExtent"in d))return[3,2];r=this.createDataInfoQuery();return[4,d.queryExtent(r,{timeout:h.constants.QUERY_EXTENT_TIMEOUT,signal:b})];case 1:return f=c.sent(),this._set("serviceDataExtent",f.extent),[3,6];case 2:if(!z)return[3,3];this._set("serviceDataExtent",
z);return[3,6];case 3:if(!p)return[3,5];n="portalItem"in d?d.portalItem:null;return[4,K.projectGeometry(p,a.view.spatialReference,n,b)];case 4:return m=c.sent(),this._set("serviceDataExtent",m),[3,6];case 5:this._set("serviceDataExtent",null),c.label=6;case 6:return[2]}})})};a.prototype.updateServiceDataCount=function(b){return c.__awaiter(this,void 0,void 0,function(){var a,d,g;return c.__generator(this,function(c){switch(c.label){case 0:return a=this.layerView.layer,"queryFeatureCount"in a?[4,B.result(a.queryFeatureCount(this.createDataInfoQuery(),
{timeout:h.constants.QUERY_STATISTICS_TIMEOUT,signal:b}))]:(d=h.constants.NO_SERVICE_DATA_COUNT,this._set("serviceDataCount",d),[2]);case 1:g=c.sent();if(!0===g.ok)this._set("serviceDataCount",g.value);else{if(k.isAbortError(g.error))throw g.error;d=h.constants.NO_SERVICE_DATA_COUNT;this._set("serviceDataCount",d)}return[2]}})})};Object.defineProperty(a.prototype,"vertexLimitInfo",{get:function(){if(!this.displayFeatureLimit||!this.displayFeatureLimit.maximumSymbolComplexity)return null;var b=this.displayFeatureLimit,
a=b.maximumSymbolComplexity,b=b.maximumTotalNumberOfPrimitives,c=a.primitivesPerCoordinate,a=a.primitivesPerFeature,d=this._get("vertexLimitInfo");return y.isNone(d)||d.maximumTotalNumberOfPrimitives!==b||d.primitivesPerCoordinate!==c||d.primitivesPerFeature!==a?{primitivesPerCoordinate:c,primitivesPerFeature:a,maximumTotalNumberOfPrimitives:b}:d},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"supportsExceedsLimitQuery",{get:function(){var b=this.layerView.layer;return b.capabilities&&
b.capabilities.operations&&b.capabilities.operations.supportsExceedsLimitStatistics},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"minimumNumberOfVerticesForGeometry",{get:function(){var b=this.layerView.layer.geometryType;switch(b){case "point":return 1;case "multipoint":return 1;case "polygon":return 4;case "polyline":return 2;case "multipatch":case "mesh":return 3;default:return u.neverReached(b),0}},enumerable:!0,configurable:!0});a.prototype.updateVertexLimitExceeded=function(b,
a){return c.__awaiter(this,void 0,void 0,function(){var d,g,e,p,l,q,f,r,v,n,m,t,x,u,A;return c.__generator(this,function(c){switch(c.label){case 0:d=y.isSome(this.vertexLimitInfo)&&0>=this.vertexLimitInfo.primitivesPerFeature;g=1<this.minimumNumberOfVerticesForGeometry;e=this.layerView.layer;p=this.supportsExceedsLimitQuery;if(y.isNone(this.vertexLimitInfo)||!d&&!g)return this._set("vertexLimitExceeded",!1),[2];l=this.vertexLimitInfo;q=l.primitivesPerFeature;f=l.primitivesPerCoordinate;r=l.maximumTotalNumberOfPrimitives;
return(v=0!==q)&&y.isSome(b)?[4,b]:[3,2];case 1:c.sent(),c.label=2;case 2:return n=this.serviceDataCount,m=(t=n!==h.constants.NO_SERVICE_DATA_COUNT)?Math.ceil((r-n*q)/(f||1)):Math.ceil(r/(f||1)),g&&(m=Math.min(m,Q)),t&&this.minimumNumberOfVerticesForGeometry*n>m?(this._set("vertexLimitExceeded",!0),[2]):p?[4,B.result(e.queryFeatures(this.createVertexLimitExceededQuery(m),{timeout:h.constants.QUERY_STATISTICS_TIMEOUT,signal:a}))]:(this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>m),[2]);
case 3:x=c.sent();if(!1===x.ok){if(k.isAbortError(x.error))throw x.error;this._set("vertexLimitExceeded",!1);return[2]}u=x.value;(A=u.features[0])&&A.attributes?this._set("vertexLimitExceeded",!!A.attributes.exceedslimit):this._set("vertexLimitExceeded",!1);return[2]}})})};a.prototype.fetchServiceDataInfo=function(){return c.__awaiter(this,void 0,void 0,function(){var b,a,d,g,e,f=this;return c.__generator(this,function(c){this.cancelFetchServiceDataInfo();b=k.createAbortController();a=b.signal;d=
this.updateServiceDataCount(a);g=k.eachAlways([d,this.updateVertexLimitExceeded(d,a)]);e=g.then(function(){return f.updateServiceDataExtent(a)}).catch(function(a){k.isAbortError(a)||v.error("#fetchServiceDataInfo()",a)}).then(function(){e===f.fetchDataInfoPromise&&(f.fetchDataInfoPromise=null,f.fetchDataInfoAbortController=null);b=null});b&&(this.fetchDataInfoPromise=e);this.fetchDataInfoAbortController=b;return[2,g.then(function(){},function(){})]})})};a.prototype.cancelFetchServiceDataInfo=function(){var a=
this.fetchDataInfoAbortController;a&&(this.fetchDataInfoPromise=this.fetchDataInfoAbortController=null,a.abort())};Object.defineProperty(a.prototype,"debug",{get:function(){return{storedFeatures:this.tileFetcher?this.tileFetcher.storedFeatures:0,totalFeatures:this.tileFetcher?this.tileFetcher.totalFeatures:0,totalVertices:this.tileFetcher?this.tileFetcher.totalVertices:0}},enumerable:!0,configurable:!0});var h;c.__decorate([d.property({readOnly:!0})],a.prototype,"type",void 0);c.__decorate([d.property({constructOnly:!0})],
a.prototype,"graphics",void 0);c.__decorate([d.property({constructOnly:!0})],a.prototype,"layerView",void 0);c.__decorate([d.property({constructOnly:!0})],a.prototype,"context",void 0);c.__decorate([d.property()],a.prototype,"extent",null);c.__decorate([d.property({dependsOn:["tileFetcher.updating","mode","layerView.view.featureTiles.updating","fetchDataInfoPromise","watchUpdatingTracking.updating"]})],a.prototype,"updating",null);c.__decorate([d.property({readOnly:!0})],a.prototype,"watchUpdatingTracking",
void 0);c.__decorate([d.property({dependsOn:["updating","tileFetcher.updatingTotal"]})],a.prototype,"updatingTotal",null);c.__decorate([d.property({dependsOn:["updating","tileFetcher.updatingRemaining"]})],a.prototype,"updatingRemaining",null);c.__decorate([d.property({dependsOn:["updating","tileFetcher.expectedFeatureDiff"]})],a.prototype,"expectedFeatureDiff",null);c.__decorate([d.property({dependsOn:["tileFetcher.memoryForUnusedFeatures"]})],a.prototype,"memoryForUnusedFeatures",null);c.__decorate([d.property({dependsOn:["tileFetcher.maximumNumberOfFeaturesExceeded"]})],
a.prototype,"maximumNumberOfFeaturesExceeded",null);c.__decorate([d.property({readOnly:!0})],a.prototype,"serviceDataExtent",void 0);c.__decorate([d.property({readOnly:!0})],a.prototype,"serviceDataCount",void 0);c.__decorate([d.property({readOnly:!0})],a.prototype,"vertexLimitExceeded",void 0);c.__decorate([d.property({readOnly:!0,dependsOn:["extent"]})],a.prototype,"filteredDataExtent",null);c.__decorate([d.property()],a.prototype,"displayFeatureLimit",void 0);c.__decorate([d.property({type:Number,
dependsOn:["displayFeatureLimit"]})],a.prototype,"maximumNumberOfFeatures",null);c.__decorate([d.property({readOnly:!0,dependsOn:"serviceDataCount displayFeatureLimit maximumNumberOfFeatures vertexLimitExceeded serviceDataExtent layerView.layer.minScale layerView.view.featureTiles.tilingScheme".split(" ")})],a.prototype,"mode",null);c.__decorate([d.property({readOnly:!0,dependsOn:["mode","tileFetcher.totalVertices"]})],a.prototype,"maxTotalSnapshotVertices",null);c.__decorate([d.property({readOnly:!0,
dependsOn:["mode"]})],a.prototype,"tileDescriptors",null);c.__decorate([d.property()],a.prototype,"tileFetcher",void 0);c.__decorate([d.property()],a.prototype,"fetchDataInfoPromise",void 0);c.__decorate([d.property({readOnly:!0,dependsOn:["displayFeatureLimit"]})],a.prototype,"vertexLimitInfo",null);return a=h=c.__decorate([d.subclass("esri.layers.graphics.controllers.FeatureTileController3D")],a)}(I.EsriPromiseMixin(E));var Q=5E6;(function(c){(function(a){a.NO_SERVICE_DATA_COUNT=Infinity;a.MAX_SNAPSHOT_MIN_SCALE_FACTOR=
5;a.reset=function(){a.MAX_FEATURE_COUNT_FOR_EXTENT=1E4;a.QUERY_STATISTICS_TIMEOUT=12E3;a.QUERY_EXTENT_TIMEOUT=1E4}})(c.constants||(c.constants={}))})(e||(e={}));e.constants.reset();return e});