// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/accessorSupport/decorators ../RasterInfo ../RasterStorageInfo ./BaseRaster ../rasterFormats/TiffDecoder ../rasterFormats/TiffTags".split(" "),function(P,Q,b,E,H,L,g,M,N,O,F,x){var C=function(b,c){return(b=b.get(c))&&b.values},y=function(b,c){return(b=b.get(c))&&b.values[0]};return function(A){function c(){var e=null!==A&&A.apply(this,arguments)||this;e._files=null;e._headerInfo=null;e._bufferSize=
1048576;return e}b.__extends(c,A);c.prototype.open=function(e){return b.__awaiter(this,void 0,void 0,function(){var m,r,d,l,h,f,a,k,c,n,q,D,t,u,p,v,z,I,J,B,w,g,x,y,A,C,K;return b.__generator(this,function(G){switch(G.label){case 0:return[4,this.init()];case 1:return G.sent(),m=e?L.unwrap(e.signal):null,[4,this.request({url:this.url,range:{from:0,to:this._bufferSize},responseType:"array-buffer"},m)];case 2:r=G.sent();if(!r)throw new H("tiffraster:open","failed to open url "+this.url);this.datasetName=
this.url.slice(this.url.lastIndexOf("/")+1);d=F.parseSignature(r);l=d.littleEndian;h=d.firstIFD;f=[];return[4,this.readIFDs(f,r,l,h,0,4,m)];case 3:G.sent();a=F.getImageInfo(f);k=a.width;c=a.height;n=a.tileWidth;q=a.tileHeight;D=a.planes;t=a.pixelType;u=a.compression;p=a.firstPyramidLevel;v=a.maximumPyramidLevel;z=a.pyramidBlockWidth;I=a.pyramidBlockHeight;J=a.tileBoundary;B=a.metadata;w=E.Extent.fromJSON(a.extent);g=w.spatialReference;x=w?new E.Point({x:w.xmin,y:w.ymax,spatialReference:g}):new E.Point({x:0,
y:0});y=new N({blockWidth:n,blockHeight:q,pyramidBlockWidth:z,pyramidBlockHeight:I,compression:u,origin:x,firstPyramidLevel:p,maximumPyramidLevel:v,blockBoundary:J});A=new E.Point({x:(w.xmax-w.xmin)/k,y:(w.ymax-w.ymin)/c,spatialReference:g});C=B?{BandProperties:B.bandProperties,DataType:B.dataType}:null;K=new M({width:k,height:c,bandCount:D,pixelType:t,compression:u,pixelSize:A,storageInfo:y,spatialReference:g,keyProperties:C,extent:w,statistics:B?B.statistics:null});this._set("rasterInfo",K);this._headerInfo=
b.__assign({littleEndian:l,ifds:f},a);if(!this._headerInfo.isSupported)throw new H("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);return[2]}})})};c.prototype.fetchRawTile=function(e,m,c,d){void 0===d&&(d={});return b.__awaiter(this,void 0,void 0,function(){var l,h,f,a,k,r,n,q,D,t,u,p,v,z,g;return b.__generator(this,function(b){switch(b.label){case 0:if(!this._headerInfo&&this._headerInfo.isSupported)return[2,null];l=this.rasterInfo.storageInfo.blockBoundary;h=0<e?this.rasterInfo.storageInfo.pyramidBlockWidth:
this.rasterInfo.storageInfo.blockWidth;f=0<e?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight;a=l[e];if(!a||a.maxRow<m||a.maxCol<c||a.minRow>m||a.minCol>c)return[2,null];k=this.getTileLocation(e,m,c);if(!k)return[2,null];r=k.range;n=k.actualTileWidth;q=k.actualTileHeight;D=k.ifd;return[4,this.request({url:this.url,range:r,responseType:"array-buffer"},d.signal)];case 1:return t=b.sent(),[4,this.decodePixelBlock(t,{format:"tiff",customOptions:{headerInfo:this._headerInfo,
ifd:D,offset:0,size:0},width:h,height:f,planes:null,pixelType:null})];case 2:u=b.sent();if(n!==h||q!==f)if(g=u.mask)for(p=0;p<f;p++)for(z=p*h,v=p<q?n:0;v<h;v++)g[z+v]=0;else for(g=new Uint8Array(h*f),u.mask=g,p=0;p<q;p++)for(z=p*h,v=0;v<n;v++)g[z+v]=1;return[2,u]}})})};c.prototype.readIFDs=function(e,c,r,d,l,h,f){void 0===h&&(h=4);return b.__awaiter(this,void 0,void 0,function(){var a;return b.__generator(this,function(b){switch(b.label){case 0:return d?d>=c.byteLength||0>d?[4,this.request({url:this.url,
range:{from:d+l,to:d+l+this._bufferSize},responseType:"array-buffer"},f)]:[3,2]:[2,null];case 1:c=b.sent(),l=d+l,d=0,b.label=2;case 2:return[4,this.readIFD(c,r,d,l,x.TIFF_TAGS,h,f)];case 3:return a=b.sent(),e.push(a.ifd),a.nextIFD?[4,this.readIFDs(e,c,r,a.nextIFD-l,l,h,f)]:[2,null];case 4:return b.sent(),[2]}})})};c.prototype.readIFD=function(e,c,r,d,l,h,f){void 0===l&&(l=x.TIFF_TAGS);void 0===h&&(h=4);return b.__awaiter(this,void 0,void 0,function(){var a,k,g,n,q,m,t,u,p;return b.__generator(this,
function(b){switch(b.label){case 0:if(!e)return[2,null];a=F.parseIFD(e,c,r,d,l,h);if(!a.success)return[3,5];k=[];a.ifd.forEach(function(a){a.values||k.push(a)});if(!(0<k.length))return[3,2];g=k.map(function(a){return a.offlineOffsetSize});n=Math.min.apply(null,g.map(function(a){return a[0]}));q=Math.min.apply(null,g.map(function(a){return a[0]+a[1]}));return q-n<=this._bufferSize?[4,this.request({url:this.url,range:{from:n,to:n+this._bufferSize},responseType:"array-buffer"},f)]:[3,2];case 1:e=b.sent(),
d=n,k.forEach(function(a){return F.parseFieldValues(e,c,a,d)}),b.label=2;case 2:if(!a.ifd.has("GEOKEYDIRECTORY"))return[3,4];m=a.ifd.get("GEOKEYDIRECTORY");t=m.values;if(!(t&&4<t.length))return[3,4];u=t[0]+"."+t[1]+"."+t[2];return[4,this.readIFD(e,c,m.valueOffset+6-d,d,x.GEO_KEYS,2,f)];case 3:p=b.sent(),m.data=p.ifd,m.data&&m.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[u]}),b.label=4;case 4:return[2,a];case 5:return a.requiredBufferSize&&a.requiredBufferSize!==e.byteLength?
[4,this.request({url:this.url,range:{from:d,to:d+a.requiredBufferSize+4},responseType:"array-buffer"},f)]:[3,7];case 6:return e=b.sent(),e.byteLength<a.requiredBufferSize?[2,null]:[2,this.readIFD(e,c,0,d,x.TIFF_TAGS,4,f)];case 7:return[2]}})})};c.prototype.getTileLocation=function(b,c,g){var d=this.rasterInfo.storageInfo,e=d.firstPyramidLevel,h=d.blockBoundary,f=0===b?0:b-(e-1);b=this._headerInfo.ifds[f];if(!b)return null;d=C(b,"TILEOFFSETS");if(void 0===d)return null;var e=C(b,"TILEBYTECOUNTS"),
f=h[f],a=f.minRow,k=f.minCol,h=f.maxRow,f=f.maxCol;if(c>h||g>f||c<a||g<k)return null;var a=y(b,"IMAGEWIDTH"),k=y(b,"IMAGELENGTH"),m=y(b,"TILEWIDTH"),n=y(b,"TILELENGTH"),q=c*(f+1)+g,d=d[q],e=e[q];return null==d||null==e?null:{range:{from:d,to:d+e-1},ifd:b,actualTileWidth:g===f?a%m:m,actualTileHeight:c===h?k%n:n}};b.__decorate([g.property()],c.prototype,"_files",void 0);b.__decorate([g.property()],c.prototype,"_headerInfo",void 0);b.__decorate([g.property()],c.prototype,"_bufferSize",void 0);b.__decorate([g.property({type:String,
json:{write:!0}})],c.prototype,"datasetFormat",void 0);return c=b.__decorate([g.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],c)}(O)});