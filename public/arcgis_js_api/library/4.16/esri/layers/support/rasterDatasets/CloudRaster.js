// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../RasterInfo ../RasterStorageInfo ../TileInfo ./BaseRaster ./DBFParser ../../../tasks/support/FeatureSet".split(" "),function(M,N,k,w,D,E,F,p,G,H,I,J,K,L){var h=new Map;h.set("int16","esriFieldTypeSmallInteger");h.set("int32","esriFieldTypeInteger");h.set("int64","esriFieldTypeInteger");h.set("float32","esriFieldTypeSingle");h.set("float64","esriFieldTypeDouble");
h.set("text","esriFieldTypeString");return function(v){function b(){var a=null!==v&&v.apply(this,arguments)||this;a.storageInfo=null;return a}k.__extends(b,v);b.prototype.open=function(a){return k.__awaiter(this,void 0,void 0,function(){var l,d,f,c,e,n;return k.__generator(this,function(b){switch(b.label){case 0:return[4,this.init()];case 1:return b.sent(),l=a?E.unwrap(a.signal):null,[4,this.request({url:this.url+"/conf.json",responseType:"json"},l)];case 2:d=b.sent();if(!this._validateHeader(d))throw new D("cloudraster:open",
"Invalid or unsupported conf.json.");this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);f=this._parseHeader(d);c=f.storageInfo;e=f.rasterInfo;return"thematic"!==e.dataType?[3,4]:[4,this._fetchAuxiliaryInformation()];case 3:n=b.sent(),e.attributeTable=n,b.label=4;case 4:return this._set("storageInfo",c),this._set("rasterInfo",e),this.ioConfig.retryCount=this.ioConfig.retryCount||0,[2]}})})};b.prototype.fetchRawTile=function(a,l,d,f){void 0===f&&(f={});return k.__awaiter(this,void 0,void 0,
function(){var c,e,b,x,q,t,r;return k.__generator(this,function(n){switch(n.label){case 0:c=this.rasterInfo.storageInfo.maximumPyramidLevel-a;if(0>c)return[2,null];e=this._buildCacheFilePath(c,l,d,f.multidimensionalDefinition);b=this._getIndexRecordFromBundle(l,d);return[4,this.request({url:e,range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer"},f.signal)];case 1:x=n.sent();if(!x)return[2,null];q=new Uint8Array(x);t=this._getTileEndAndContentType(q,b);return 0===t.recordSize?
[2,null]:[4,this.request({url:e,range:{from:t.position,to:t.position+t.recordSize},responseType:"array-buffer"},f.signal)];case 2:return(r=n.sent())?[2,this.decodePixelBlock(r,{width:this.rasterInfo.storageInfo.tileInfo.size[0],height:this.rasterInfo.storageInfo.tileInfo.size[1],planes:null,pixelType:null})]:[2,null]}})})};b.prototype._validateHeader=function(a){var l="origin extent geodataXform LODInfos blockWidth blockHeight bandCount pixelType pixelSizeX pixelSizeY format packetSize".split(" ");
return a&&"RasterInfo"===a.type&&!l.some(function(d){return!a[d]})};b.prototype._parseHeader=function(a){var l="u1 u2 u4 u8 s8 u16 s16 u32 s32 f32 f64".split(" ")[a.pixelType],d=a.bandCount,f=a.histograms,c=a.colormap,e=a.blockWidth,b=a.blockHeight,k=a.firstPyramidLevel,q=a.maximumPyramidLevel,t=a.statistics&&a.statistics.map(function(a){return{min:a.min,max:a.max,avg:a.mean,stddev:a.standardDeviation,median:a.median,mode:a.mode}}),r=new w.SpatialReference(a.extent.spatialReference||a.geodataXform.spatialReference),
h=new w.Extent({xmin:a.extent.xmin,ymin:a.extent.ymin,xmax:a.extent.xmax,ymax:a.extent.ymax,spatialReference:r}),p=new w.Point({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:r}),v=a.properties,y=a.format.toLowerCase().replace("cache/",""),B=new w.Point(a.origin.x,a.origin.y,r),z,g,m,u;if(c&&c.colors)for(z=[],g=0;g<c.colors.length;g++)m=c.colors[g],u=c.values?c.values[g]:g,z.push([u,m&255,m<<16>>>24,m<<8>>>24,m>>>24]);c=a.LODInfos;m=[];for(g=0;g<c.levels.length;g++)m.push({level:c.levels[g],resolution:c.resolutions[g],
scale:96/.0254*c.resolutions[g]});c=new I({dpi:96,lods:m,format:y,origin:B,size:[e,b],spatialReference:r});y={recordSize:8,packetSize:a.packetSize,headerSize:a.packetSize*a.packetSize*8+64};m=Math.round((h.xmax-h.xmin)/p.x);u=Math.round((h.ymax-h.ymin)/p.y);var C=[{maxCol:Math.ceil(m/e)-1,maxRow:Math.ceil(u/b)-1,minCol:0,minRow:0}],A=2;if(0<q)for(g=0;g<q;g++)C.push({maxCol:Math.ceil(m/A/e)-1,maxRow:Math.ceil(u/A/b)-1,minCol:0,minRow:0}),A*=2;a=new G({width:m,height:u,pixelType:l,bandCount:d,extent:h,
spatialReference:r,pixelSize:p,keyProperties:v,statistics:t,histograms:f,multidimensionalInfo:a.mdInfo,colormap:z,storageInfo:new H({blockWidth:e,blockHeight:b,pyramidBlockWidth:e,pyramidBlockHeight:b,origin:B,tileInfo:c,firstPyramidLevel:k,maximumPyramidLevel:q,blockBoundary:C})});return{storageInfo:y,rasterInfo:a}};b.prototype._fetchAuxiliaryInformation=function(a){return k.__awaiter(this,void 0,void 0,function(){var l,d,b,c,e,n,p,q;return k.__generator(this,function(f){switch(f.label){case 0:return l=
this.request({url:this.url+"/conf.vat.json",responseType:"json"},a).then(function(a){return a}).catch(function(){return null}),d=this.request({url:this.url+"/conf.vat.dbf",responseType:"array-buffer"},a).then(function(a){return a}).catch(function(){return null}),[4,F.all([l,d])];case 1:return b=f.sent(),b[0]&&(e=b[0].fields,n=b[0].values,e&&n&&(e=e.map(function(a){return{type:"OID"===a.name?"esriFieldTypeOID":h.get(a.type),name:a.name,alias:a.alias||a.name}}),p=n.map(function(a){return{attributes:a}}),
e&&n&&(c={fields:e,features:p}))),!c&&b[1]&&(q=K.parse(b[1]),c=q.recordSet),[2,L.fromJSON(c)]}})})};b.prototype._buildCacheFilePath=function(a,b,d,f){var c=this.storageInfo.packetSize;d=Math.floor(d/c)*c;b="R"+this._toHexString4(Math.floor(b/c)*c)+"C"+this._toHexString4(d);var c="L",c=10<=a?c+a.toString():c+("0"+a.toString()),e=f&&f[0];if(!e)return this.url+"/_alllayers/"+c+"/"+b+".bundle";a=this.rasterInfo.multidimensionalInfo.variables.filter(function(a){return a.name===e.variableName})[0].dimensions[0].values.indexOf(e.values[0]).toString(16);
f=4-a.length;for(d=0;d<f;d++)a="0"+a;return this.url+"/_alllayers/"+e.variableName+"/"+("S"+a)+"/"+c+"/"+b+".bundle"};b.prototype._getIndexRecordFromBundle=function(a,b){var d=this.storageInfo.packetSize;a=a%d*d+b%d;if(0>a)throw"Invalid level / row / col";return a*this.storageInfo.recordSize+64};b.prototype._getTileEndAndContentType=function(a,b){a=a.subarray(b,b+8);b=0;var d;for(d=0;5>d;d++)b|=(a[d]&255)<<8*d;var f=b&0xffffffffff;b=0;for(d=5;8>d;d++)b|=(a[d]&255)<<8*(d-5);return{position:f,recordSize:b&
0xffffffffff}};b.prototype._toHexString4=function(a){a=a.toString(16);if(4!==a.length)for(var b=4-a.length;0<b--;)a="0"+a;return a};k.__decorate([p.property({readOnly:!0})],b.prototype,"storageInfo",void 0);k.__decorate([p.property({type:String,json:{write:!0}})],b.prototype,"datasetFormat",void 0);return b=k.__decorate([p.subclass("esri.layers.support.rasterDatasets.CloudRaster")],b)}(J)});