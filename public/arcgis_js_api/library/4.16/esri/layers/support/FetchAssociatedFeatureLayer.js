// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../kernel ../../request ../../core/arrayUtils ../../core/maybe ../../core/promiseUtils ../FeatureLayer ../../portal/Portal ../../portal/PortalItem".split(" "),function(k,l,b,u,q,x,g,n,v,y,z){Object.defineProperty(l,"__esModule",{value:!0});k=function(){function f(c,d){this.layer=c;this.signal=d;this.rootDocument=null;if(c=this.layer.parsedUrl.path.match(/^(.*)\/SceneServer\/layers\/([\d]*)\/?$/i))this.urlParts={root:c[1],layerId:parseInt(c[2],10)}}f.prototype.fetch=
function(){return b.__awaiter(this,void 0,void 0,function(){var c,d,e;return b.__generator(this,function(a){switch(a.label){case 0:if(!this.urlParts||-1===["mesh-pyramids","points"].indexOf(this.layer.profile))return[2,null];if(!this.layer.portalItem)return[3,1];d=this.layer.portalItem;return[3,3];case 1:return[4,this.portalItemFromServiceItemId()];case 2:d=a.sent(),a.label=3;case 3:return c=d,g.isNone(c)?[2,this.loadFromUrl()]:[4,this.findAndLoadRelatedPortalItem(c)];case 4:return e=a.sent(),g.isNone(e)?
[2,null]:[2,this.loadFeatureLayerFromPortalItem(e)]}})})};f.prototype.fetchRootDocument=function(){return b.__awaiter(this,void 0,void 0,function(){var c,d,e;return b.__generator(this,function(a){switch(a.label){case 0:if(g.isSome(this.rootDocument))return[2,this.rootDocument];if(g.isNone(this.urlParts))return this.rootDocument={},[2,{}];c={query:{f:"json"},responseType:"json",authMode:"no-prompt",signal:this.signal};d=this.urlParts.root+"/SceneServer";a.label=1;case 1:return a.trys.push([1,3,,4]),
[4,q(d,c)];case 2:return e=a.sent(),this.rootDocument=e.data,[3,4];case 3:return a.sent(),this.rootDocument={},[3,4];case 4:return[2,this.rootDocument]}})})};f.prototype.fetchServiceOwningPortalUrl=function(){return b.__awaiter(this,void 0,void 0,function(){var c,d,e,a,w;return b.__generator(this,function(b){switch(b.label){case 0:if((c=u.id&&u.id.findServerInfo(this.layer.parsedUrl.path))&&c.owningSystemUrl)return[2,c.owningSystemUrl];d=this.layer.parsedUrl.path.replace(/(.*\/rest)\/.*/i,"$1")+"/info";
b.label=1;case 1:return b.trys.push([1,3,,4]),[4,q(d,{query:{f:"json"},responseType:"json",signal:this.signal})];case 2:return e=b.sent(),(a=e.data.owningSystemUrl)?[2,a]:[3,4];case 3:return w=b.sent(),n.throwIfAbortError(w),[3,4];case 4:return[2,null]}})})};f.prototype.findAndLoadRelatedPortalItem=function(c){return b.__awaiter(this,void 0,void 0,function(){var d,e;return b.__generator(this,function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,c.fetchRelatedItems({relationshipType:"Service2Service",
direction:"reverse"},{signal:this.signal})];case 1:return d=a.sent(),[2,x.find(d,function(a){return"Feature Service"===a.type})||null];case 2:return e=a.sent(),n.throwIfAbortError(e),[2,null];case 3:return[2]}})})};f.prototype.loadFeatureLayerFromPortalItem=function(c){return b.__awaiter(this,void 0,void 0,function(){var d,e;return b.__generator(this,function(a){switch(a.label){case 0:return[4,c.load({signal:this.signal})];case 1:return a.sent(),[4,this.findMatchingAssociatedSublayerUrl(c.url)];case 2:return d=
a.sent(),e=new v({url:d,portalItem:c}),[2,e.load({signal:this.signal})]}})})};f.prototype.loadFromUrl=function(){return b.__awaiter(this,void 0,void 0,function(){var c,d;return b.__generator(this,function(e){switch(e.label){case 0:return[4,this.findMatchingAssociatedSublayerUrl(this.urlParts.root+"/FeatureServer")];case 1:return c=e.sent(),d=new v({url:c}),[2,d.load({signal:this.signal})]}})})};f.prototype.findMatchingAssociatedSublayerUrl=function(c){return b.__awaiter(this,void 0,void 0,function(){var d,
e,a,f,g,r,t,k,p,h,m,l;return b.__generator(this,function(b){switch(b.label){case 0:return d=c.replace(/^(.*FeatureServer)(\/[\d]*\/?)?$/i,"$1"),e={query:{f:"json"},responseType:"json",authMode:"no-prompt",signal:this.signal},a=this.urlParts.layerId,f=this.fetchRootDocument(),g=q(d,e),[4,n.all([g,f])];case 1:r=b.sent();t=r[0];p=(k=r[1])&&k.layers;h=t.data&&t.data.layers;if(!Array.isArray(h))throw Error("expected layers array");if(Array.isArray(p))for(m=0;m<Math.min(p.length,h.length);m++){if(l=p[m],
l.id===a)return[2,d+"/"+h[m].id]}else if(a<h.length)return[2,d+"/"+h[a].id];throw Error("could not find matching associated sublayer");}})})};f.prototype.portalItemFromServiceItemId=function(){return b.__awaiter(this,void 0,void 0,function(){var c,d,e,a;return b.__generator(this,function(b){switch(b.label){case 0:return[4,this.fetchRootDocument()];case 1:c=b.sent();d=c.serviceItemId;if(!d)return[2,null];e=new z({id:d});return[4,this.fetchServiceOwningPortalUrl()];case 2:a=b.sent();g.isSome(a)&&(e.portal=
new y({url:a}));try{return[2,e.load({signal:this.signal})]}catch(A){return n.throwIfAbortError(A),[2,null]}}})})};return f}();l.FetchAssociatedFeatureLayer=k});