// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib @dojo/framework/shim/array ../../core/Error ../../core/maybe ../../core/object ../../core/promiseUtils ../../core/SetUtils ./domains ../../support/arcadeOnDemand @dojo/framework/shim/Promise".split(" "),function(P,c,g,r,Q,G,x,H,p,t,R){function I(a,b,d){if(a)for(var e=0;e<a.length;e++){var c=a[e],h=x.getDeepValue(c,b);(h=h&&"function"!==typeof h&&m(d,h))&&x.setDeepValue(c,h.name,b)}}function q(a,b){if(!a||!b)return[];y.clear();u(y,a,b);return p.valuesOfSet(y).sort()}function u(a,
b,d){if(d)if(b&&b.length)if(r.includes(d,"*"))for(d=0;d<b.length;d++)a.add(b[d].name);else for(var c=0;c<d.length;c++)f=d[c],n(a,b,f);else if(r.includes(d,"*"))a.clear(),a.add("*");else for(b=0;b<d.length;b++){var f=d[b];a.add(f)}}function n(a,b,d){b&&b.length?(b=m(b,d))&&a.add(b.name):"string"===typeof d&&a.add(d)}function m(a,b){if("string"!==typeof b)return null;if(null!=a){b=b.toLowerCase();for(var d=0;d<a.length;d++){var c=a[d];if(c&&c.name.toLowerCase()===b)return c}}return null}function v(a,
b,d){return g.__awaiter(this,void 0,void 0,function(){var c,f,h,l,k;return g.__generator(this,function(e){switch(e.label){case 0:return d?[4,R.loadArcade()]:[2];case 1:c=e.sent().arcadeUtils;f=c.extractFieldNames(d);h=0;for(l=f;h<l.length;h++)k=l[h],n(a,b,k);return[2]}})})}function z(a,b){for(var d=0;d<a.length;d++){var c=a[d];if(c&&c.valueType&&c.valueType===b)return c.name}return null}function J(a,b){return g.__awaiter(this,void 0,void 0,function(){var d,c;return g.__generator(this,function(e){if(!b)return[2];
d=b.fields;return(c=x.getDeepValue("elevationInfo.featureExpressionInfo",b))?[2,c.collectRequiredFields(a,d)]:[2]})})}function S(a,b,d){return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,function(c){d.outStatistic.onStatisticValueExpression?v(a,b,d.outStatistic.onStatisticValueExpression):a.add(d.outStatistic.onStatisticField);return[2]})})}function K(a,b){return g.__awaiter(this,void 0,void 0,function(){var d,c;return g.__generator(this,function(e){switch(e.label){case 0:return d=
b.labelingInfo,c=b.fields,d&&d.length?[4,H.all(d.map(function(b){return T(a,c,b)}))]:[2];case 1:return e.sent(),[2]}})})}function T(a,b,d){return g.__awaiter(this,void 0,void 0,function(){var c,f,h,l,k;return g.__generator(this,function(e){switch(e.label){case 0:if(!d)return[2];c=d.getLabelExpression();f=d.where;return"arcade"!==c.type?[3,2]:[4,v(a,b,c.expression)];case 1:return e.sent(),[3,3];case 2:(h=c.expression.match(/{[^}]*}/g))&&h.forEach(function(d){n(a,b,d.slice(1,-1))}),e.label=3;case 3:return l=
/['"]+/g,f&&(k=f.split(" "),3===k.length&&n(a,b,k[0].replace(l,"")),7===k.length&&(n(a,b,k[0].replace(l,"")),n(a,b,k[4].replace(l,"")))),[2]}})})}function A(a){return"number"===typeof a&&!isNaN(a)&&isFinite(a)}function U(a){return null===a||A(a)}function V(a){return null===a||w(a)}function L(a){return null!=a&&"string"===typeof a}function W(a){return null===a||L(a)}function X(){return!0}function B(a,b){var d;switch(a.type){case "date":case "integer":case "long":case "small-integer":case "esriFieldTypeDate":case "esriFieldTypeInteger":case "esriFieldTypeLong":case "esriFieldTypeSmallInteger":d=
a.nullable?V:w;break;case "double":case "single":case "esriFieldTypeSingle":case "esriFieldTypeDouble":d=a.nullable?U:A;break;case "string":case "esriFieldTypeString":d=a.nullable?W:L;break;default:d=X}return 1===arguments.length?d:d(b)}function C(a){return null!=a&&Y.has(a.type)}function M(a,b){return a.nullable&&null===b?null:C(a)&&!N(a.type,Number(b))?D.OUT_OF_RANGE:B(a,b)?a.domain?t.validateDomainValue(a.domain,b):null:E.INVALID_TYPE}function N(a,b){return(a="string"===typeof a?F(a):a)?a.isInteger?
w(b)&&b>=a.min&&b<=a.max:b>=a.min&&b<=a.max:!1}function F(a){switch(a){case "esriFieldTypeSmallInteger":case "small-integer":return c.smallIntegerRange;case "esriFieldTypeInteger":case "integer":return c.integerRange;case "esriFieldTypeSingle":case "single":return c.singleRange;case "esriFieldTypeDouble":case "double":return c.doubleRange}}function O(a,b,d){if(!b||!b.attributes||!a){if(G.isSome(d))for(var c=0;c<a.length;c++)b=a[c],d.add(b);return!0}for(var c=b.attributes,f=!1,h=0;h<a.length;h++)if(b=
a[h],!(b in c))if(f=!0,G.isSome(d))d.add(b);else break;return f}Object.defineProperty(c,"__esModule",{value:!0});c.rendererFields="field field2 field3 normalizationField rotationInfo.field proportionalSymbolInfo.field proportionalSymbolInfo.normalizationField colorInfo.field colorInfo.normalizationField".split(" ");c.visualVariableFields=["field","normalizationField"];c.fixRendererFields=function(a,b){if(null!=a&&null!=b){var d=0;for(a=Array.isArray(a)?a:[a];d<a.length;d++){var e=a[d];I(c.rendererFields,
e,b);if("visualVariables"in e&&e.visualVariables)for(var f=0,e=e.visualVariables;f<e.length;f++)I(c.visualVariableFields,e[f],b)}}};c.fixTimeInfoFields=function(a,b){if(null!=a&&null!=b)if("startField"in a){var d=m(b,a.startField);b=m(b,a.endField);a.startField=d&&d.name||null;a.endField=b&&b.name||null}else d=m(b,a.startTimeField),b=m(b,a.endTimeField),a.startTimeField=d&&d.name||null,a.endTimeField=b&&b.name||null};var y=new Set;c.fixFields=q;c.collectFields=u;c.collectField=n;c.unpackFieldNames=
function(a,b){return b&&a?r.includes(b,"*")?a.map(function(a){return a.name}):b:[]};c.packFields=function(a,b,d){void 0===d&&(d=1);if(!b||!a)return[];if(r.includes(b,"*"))return["*"];b=q(a,b);return b.length/a.length>=d?["*"]:b};c.getField=m;c.hasField=function(a,b){if(!a||!b||"string"!==typeof b)return!1;b=b.toLowerCase();for(var d=0;d<a.length;d++){var c=a[d];if(c&&c.name.toLowerCase()===b)return!0}return!1};c.collectArcadeFieldNames=v;c.getDisplayFieldName=function(a){var b=a.displayField;a=a.fields;
if(b)return b;if(!a||!a.length)return null;if(!(b=z(a,"name-or-title")||z(a,"unique-identifier")||z(a,"type-or-category")))a:{for(b=0;b<a.length;b++){var d=a[b];if(d&&d.name){var c=d.name.toLowerCase();if(-1<c.indexOf("name")||-1<c.indexOf("title")){b=d.name;break a}}}b=null}return b};c.getElevationFields=function(a){return g.__awaiter(this,void 0,void 0,function(){var b;return g.__generator(this,function(d){switch(d.label){case 0:if(!a)return[2,[]];b=new Set;return[4,J(b,a)];case 1:return d.sent(),
[2,p.valuesOfSet(b).sort()]}})})};c.collectElevationFields=J;c.collectFeatureReductionFields=function(a,b,d){return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,function(c){switch(c.label){case 0:return b&&d&&"cluster"===d.type&&d.fields?[4,H.all(d.fields.map(function(d){return S(a,b.fields,d)}))]:[2];case 1:return c.sent(),[2]}})})};c.collectFilterFields=function(a,b,d){return g.__awaiter(this,void 0,void 0,function(){var c,f;return g.__generator(this,function(e){switch(e.label){case 0:if(!b||
!d||!(d.where&&"1\x3d1"!==d.where||d.timeExtent))return[2];b.timeInfo&&d.timeExtent&&u(a,b.fields,[b.timeInfo.startField,b.timeInfo.endField]);return d.where?[4,new Promise(function(a,b){P(["../../core/sql/WhereClause"],a,b)})]:[3,2];case 1:c=e.sent();f=c.WhereClause.create(d.where,b.fieldsIndex);if(!f.isStandardized)throw new Q("fieldUtils:collectFilterFields","Where clause is not standardized");u(a,b.fields,f.fieldNames);e.label=2;case 2:return[2]}})})};c.getTimeFields=function(a){return g.__awaiter(this,
void 0,void 0,function(){var b;return g.__generator(this,function(d){return a?(b="timeInfo"in a&&a.timeInfo)?[2,q(a.fields,[a.trackIdField,b.startField,b.endField])]:[2,[]]:[2,[]]})})};c.getFeatureEditFields=function(a){if(!a)return[];var b="editFieldsInfo"in a&&a.editFieldsInfo;return b?q(a.fields,[b&&b.creatorField,b&&b.creationDateField,b&&b.editorField,b&&b.editDateField]):[]};c.getFeatureGeometryFields=function(a){if(!a)return[];var b="geometryProperties"in a&&a.geometryProperties;return b?q(a.fields,
[b&&b.shapeAreaFieldName,b&&b.shapeLengthFieldName]):[]};c.getLabelingFields=function(a){return g.__awaiter(this,void 0,void 0,function(){var b;return g.__generator(this,function(d){switch(d.label){case 0:if(!a)return[2,[]];b=new Set;return[4,K(b,a)];case 1:return d.sent(),[2,p.valuesOfSet(b).sort()]}})})};c.collectLabelingFields=K;c.getFieldDefaultValue=function(a){var b=a.defaultValue;if(void 0!==b&&B(a,b))return b;if(a.nullable)return null};var w=function(){return"isInteger"in Number?Number.isInteger:
function(a){return"number"===typeof a&&isFinite(a)&&Math.floor(a)===a}}();c.isValueMatchingFieldType=B;c.numericTypes=["integer","small-integer","single","double"];var Y=p.SetFromValues(g.__spreadArrays(c.numericTypes,["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]));c.isNumericField=C;c.isStringField=function(a){return null!=a&&("string"===a.type||"esriFieldTypeString"===a.type)};c.isDateField=function(a){return null!=a&&("date"===a.type||"esriFieldTypeDate"===
a.type)};c.isValidFieldValue=function(a,b){return null===M(a,b)};var D;(D=c.NumericRangeValidationError||(c.NumericRangeValidationError={})).OUT_OF_RANGE="numeric-range-validation-error::out-of-range";var E;(E=c.TypeValidationError||(c.TypeValidationError={})).INVALID_TYPE="type-validation-error::invalid-type";c.sanitizeNullFieldValue=function(a){return null==a||"number"===typeof a&&isNaN(a)?null:a};c.validateFieldValue=M;c.isNumberInRange=N;c.getFieldRange=function(a){var b=t.getDomainRange(a.domain);
if(b)return b;if(C(a))return F(a.type)};c.getNumericTypeForValue=function(a){if(!A(a))return null;if(w(a)){if(a>=c.smallIntegerRange.min&&a<=c.smallIntegerRange.max)return"esriFieldTypeSmallInteger";if(a>=c.integerRange.min&&a<=c.integerRange.max)return"esriFieldTypeInteger"}return a>=c.singleRange.min&&a<=c.singleRange.max?"esriFieldTypeSingle":"esriFieldTypeDouble"};c.smallIntegerRange={min:-32768,max:32767,isInteger:!0};c.integerRange={min:-2147483648,max:2147483647,isInteger:!0};c.singleRange=
{min:-3.4E38,max:1.2E38,isInteger:!1};c.doubleRange={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};c.validationErrorToString=function(a,b,d){switch(a){case t.DomainValidationError.INVALID_CODED_VALUE:return"Value "+d+" is not in the coded domain - field: "+b.name+", domain: "+JSON.stringify(b.domain);case t.DomainValidationError.VALUE_OUT_OF_RANGE:return"Value "+d+" is out of the range of valid values - field: "+b.name+", domain: "+JSON.stringify(b.domain);case E.INVALID_TYPE:return"Value "+
d+" is not a valid value for the field type - field: "+b.name+", type: "+b.type+", nullable: "+b.nullable;case D.OUT_OF_RANGE:return a=F(b.type),"Value "+d+" is out of range for the number type - field: "+b.name+", type: "+b.type+", value range is "+a.min+" to "+a.max}};c.featureHasFields=function(a,b){return!O(a,b,null)};c.populateMissingFields=O;c.getExpressionFields=function(a,b){return g.__awaiter(this,void 0,void 0,function(){var d,c,f,h;return g.__generator(this,function(e){switch(e.label){case 0:d=
new Set,c=0,f=b,e.label=1;case 1:if(!(c<f.length))return[3,4];h=f[c];return[4,v(d,a.fields,h)];case 2:e.sent(),e.label=3;case 3:return c++,[3,1];case 4:return[2,p.valuesOfSet(d).sort()]}})})}});