// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../request ../../core/Error ../../core/promiseUtils ../../layers/support/lazyLayerLoader ../Portal ./jsonContext ../../renderers/support/styleUtils".split(" "),function(z,m,g,r,n,k,h,t,u,v){function w(b,f){return g.__awaiter(this,void 0,void 0,function(){var a,c,l,e,d,h;return g.__generator(this,function(g){switch(g.label){case 0:a=b.instance;c=a.portalItem;l=c.url;e=c.title;d=u.createForItem(c);if("group"===a.type)return a.read({title:e},d),[2,x(a,b)];l&&a.read({url:l},
d);return[4,p(b,f)];case 1:return(h=g.sent())&&a.read(h,d),a.resourceReferences={portalItem:c,paths:d.readResourcePaths},a.read({title:e},d),[2,v.loadStyleRenderer(a,d)]}})})}function x(b,f){var a;a=b.portalItem.type;switch(a){case "Feature Service":a=h.layerLookupMap.FeatureLayer;break;case "Stream Service":a=h.layerLookupMap.StreamLayer;break;case "Scene Service":a=h.layerLookupMap.SceneLayer;break;case "Feature Collection":a=h.layerLookupMap.FeatureLayer;break;default:throw new n("portal:unsupported-item-type-as-group",
"The item type '"+a+"' is not supported as a 'GroupLayer'");}var c;return a().then(function(a){c=a;return p(f)}).then(function(a){return a&&Array.isArray(a.layers)?q(b,c,a):y(b,c)})}function y(b,f){return b.portalItem.url?r(b.portalItem.url,{responseType:"json",query:{f:"json"}}).then(function(a){if((a=a.data)&&Array.isArray(a.layers))return a=a.layers.map(function(a){return{id:a.id,name:a.name}}),q(b,f,{layers:a})}):k.resolve()}function q(b,f,a){var c=a.showLegend;a=a.layers.slice();a.reverse();
a.forEach(function(a){var e=new f({portalItem:b.portalItem,layerId:a.id,sublayerTitleMode:"service-name"});if("Feature Collection"===b.portalItem.type){var d={origin:"portal-item",portal:b.portalItem.portal||t.getDefault()};e.read(a,d);null!=c&&e.read({showLegend:c},d)}b.add(e)})}function p(b,f){if(!1===b.supportsData)return k.resolve();var a=b.instance;return a.portalItem.fetchData("json",f).catch(function(){return null}).then(function(c){var b,e;e="stream"===a.type?!1:"layerId"in a;if(e){e=!0;if(c&&
Array.isArray(c.layers)){null==a.layerId&&(a.layerId=c.layers[0].id);for(var d=0;d<c.layers.length;d++)if(c.layers[d].id===a.layerId){b=c.layers[d];break}b&&(1===c.layers.length&&(e=!1),null!=c.showLegend&&(b.showLegend=c.showLegend))}e&&"service-name"!==a.sublayerTitleMode&&(a.sublayerTitleMode="item-title-and-service-name");return b}return c})}Object.defineProperty(m,"__esModule",{value:!0});m.load=function(b,f){return g.__awaiter(this,void 0,void 0,function(){var a;return g.__generator(this,function(c){switch(c.label){case 0:return(a=
b.instance.portalItem)&&a.id?[4,a.load(f)]:[2,k.resolve()];case 1:c.sent();c=b.instance.portalItem;if(-1===b.supportedTypes.indexOf(c.type))throw new n("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:c.type,expectedType:b.supportedTypes.join(", ")});return[2,w(b,f)]}})})}});