// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/maybe ../../../core/libs/gl-matrix-2/mat3 ../../../core/libs/gl-matrix-2/mat3f32 ../../../core/libs/gl-matrix-2/vec2f32 ../../../layers/support/rasterFunctions/pixelUtils ./DisplayObject ../../webgl/rasterUtils".split(" "),function(e,k,l,m,f,n,h,p,q,g){Object.defineProperty(k,"__esModule",{value:!0});var r={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],
colormap:null,colormapOffset:null,type:"stretch"};e=function(e){function c(b,a,c){void 0===b&&(b=null);void 0===a&&(a=null);void 0===c&&(c=null);var d=e.call(this)||this;d._memoryUsed=null;d.stencilRef=0;d.coordScale=[1,1];d._symbolizerParameters=null;d.height=null;d.pixelRatio=1;d.resolution=0;d.rotation=0;d._source=null;d.rawPixelData=null;d._suspended=!1;d._bandIds=null;d._interpolation=null;d._transformGrid=null;d.width=null;d.x=0;d.y=0;d.transforms={dvs:n.mat3f32.create()};d.source=b;d.transformGrid=
a;d.interpolation=c;return d}l.__extends(c,e);Object.defineProperty(c.prototype,"symbolizerParameters",{get:function(){return this._symbolizerParameters||r},set:function(b){this._symbolizerParameters=b},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"source",{get:function(){return this._source},set:function(b){this._source=b;this._rasterTexture&&(this._rasterTexture.dispose(),this._memoryUsed=this._rasterTexture=null)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"suspended",{get:function(){return this._suspended},set:function(b){this._suspended&&!b&&this.stage&&(this.ready(),this.requestRender());this._suspended=b},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"bandIds",{get:function(){return this._bandIds},set:function(b){this.stage&&this._updateRasterTexture(b);this._bandIds=b},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"interpolation",{get:function(){return this._interpolation},set:function(b){this._interpolation=
b;this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===b||"cubic"===b?9729:9728)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"transformGrid",{get:function(){return this._transformGrid},set:function(b){this._transformGrid=b;this._transformGridTexture&&(this._transformGridTexture.dispose(),this._memoryUsed=this._transformGridTexture=null)},enumerable:!0,configurable:!0});c.prototype.invalidateTexture=function(){this._updateTexture()};c.prototype.setTransform=
function(b){var a=f.mat3.identity(this.transforms.dvs),c=b.toScreenNoRotation([0,0],this.x,this.y),d=this.resolution/this.pixelRatio/b.resolution,e=d*this.width,d=d*this.height,g=Math.PI*this.rotation/180;f.mat3.translate(a,a,h.vec2f32.fromValues(c[0],c[1]));f.mat3.translate(a,a,h.vec2f32.fromValues(e/2,d/2));f.mat3.rotate(a,a,-g);f.mat3.translate(a,a,h.vec2f32.fromValues(-e/2,-d/2));f.mat3.scaleByVec2(a,a,h.vec2f32.fromValues(e,d));f.mat3.multiply(this.transforms.dvs,b.displayViewMat3,a)};c.prototype.getTextures=
function(){if(!this._rasterTexture)return null;var b=[],a=[];this._transformGridTexture&&(a.push(this._transformGridTexture),b.push("u_transformGrid"));this._rasterTexture&&(a.push(this._rasterTexture),b.push("u_image"));this._colormapTexture&&(a.push(this._colormapTexture),b.push("u_colormap"));return{names:b,textures:a}};c.prototype.getMemoryUsage=function(){if(m.isNone(this._memoryUsed)){var b=this.getTextures();if(null==b)return 0;this._memoryUsed=b.textures.map(function(a){return a.descriptor.width*
a.descriptor.height*4}).reduce(function(a,b){return a+b})}return this._memoryUsed};c.prototype.onAttach=function(){this.invalidateTexture()};c.prototype.onDetach=function(){this.invalidateTexture()};c.prototype._updateTexture=function(){var b,a,c;this.stage?(b=this.stage.context,a=(a=this.source)&&a.pixels&&0<a.pixels.length,!this._rasterTexture&&a&&this._updateRasterTexture(this.bandIds),this._rasterTexture&&a&&(this._updateColormapTexture(),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=
g.createTransformTexture(b,this.transformGrid))),this._rasterTexture&&!a&&this._rasterTexture.setData(null),this.suspended||(this.ready(),this.requestRender())):(null===(b=this._rasterTexture)||void 0===b?void 0:b.dispose(),null===(a=this._transformGridTexture)||void 0===a?void 0:a.dispose(),null===(c=this._colormapTexture)||void 0===c?void 0:c.dispose(),this._colormapTexture=this._transformGridTexture=this._rasterTexture=null)};c.prototype._updateRasterTexture=function(b){var a=this.source?p.extractBands(this.source,
b):null;if(a&&a.pixels&&0<a.pixels.length){b=null==b&&null==this.bandIds||b&&this.bandIds&&b.join("")===this.bandIds.join("");if(this._rasterTexture){if(b)return;this._rasterTexture.dispose();this._rasterTexture=null}this._rasterTexture=g.createRasterTexture(this.stage.context,a,this.interpolation||"nearest")}else this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null)};c.prototype._updateColormapTexture=function(){var b=this._colormap,a=this.symbolizerParameters.colormap;if(a){var c=
this.stage.context;if(!b)this._colormapTexture=g.createColormapTexture(c,a),this._colormap=a;else if(a.length!==b.length||a.some(function(a,c){return a!==b[c]}))this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=g.createColormapTexture(c,a),this._colormap=a}else this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormap=null};return c}(q.DisplayObject);k.RasterBitmap=e});