// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/promiseUtils ../../../../../../symbols/support/defaults ./WGLDynamicFillTemplate ./WGLDynamicLineTemplate ./WGLDynamicMarkerTemplate ./WGLDynamicTextTemplate ./WGLFillTemplate ./WGLLineTemplate ./WGLMarkerTemplate ./WGLTextTemplate ../../util/Lock ../../util/Result ../../../../layers/features/textUtils".split(" "),function(r,n,f,t,z,l,p,A,B,C,D,q,u,m,v,w,h,E){function k(e,a){var d=e.length;
e.push(null);a.then(function(a){return e[d]=a});return e}function x(e){return!!(e&1)}Object.defineProperty(n,"__esModule",{value:!0});var g=z.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),y=[];n.isDynamicId=x;r=function(){function e(a,d){this._templateIdCounter=this._idCounter=1;this._idToTemplateGroup=new Map;this._symbolToTemplate=new Map;this._fetchQueue=[];this._idToResolver=new Map;this._cimTemplateCache=new Map;this._cimAnalyses=[];this._lock=new w.default;this._fetchResource=
a;this._joinOnUTurn=d}Object.defineProperty(e.prototype,"_markerError",{get:function(){return this._errorTemplates.marker[0]},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"_fillError",{get:function(){return this._errorTemplates.fill[0]},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"_lineError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"_textError",{get:function(){return this._errorTemplates.line[0]},
enumerable:!0,configurable:!0});e.prototype.createTemplateGroup=function(a,d,c){this._initErrorTemplates();var b=a.hash();if(this._symbolToTemplate.has(b))return this._symbolToTemplate.get(b);var e=[];d&&this._createMeshTemplates(e,d,c,!0);this._createMeshTemplates(e,a,c,!1);a=this._createGroupId("expanded-cim"===a.type);this._idToTemplateGroup.set(a,e);this._symbolToTemplate.set(b,a);return a};e.prototype.getTemplateGroup=function(a){return this._idToTemplateGroup.has(a)?this._idToTemplateGroup.get(a):
y};e.prototype.getDynamicTemplateGroup=function(a){if(!this._idToTemplateGroup.has(a))return y;x(a)||g.error("mapview-template-store","Id "+a+" does not refer to a dynamic template");return this._idToTemplateGroup.get(a)};e.prototype.getMosaicItem=function(a,d,c){var b=this,e=this._createTemplateId(),f=l.create(function(a){return b._idToResolver.set(e,a)});a=d?a.toJSON():a;this._fetchQueue.push({symbol:a,id:e,glyphIds:c});return f};e.prototype.finalize=function(a){return this._fetchQueue.length||
this._lock.isHeld()?w.withLock(this._lock,this._fetchAllQueuedResources.bind(this),a):l.resolve()};e.prototype._initErrorTemplates=function(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],p.errorPolygonSymbol2D,null,!1),marker:this._createMeshTemplates([],p.errorPointSymbol2D,null,!1),line:this._createMeshTemplates([],p.errorPolylineSymbol2D,null,!1)})};e.prototype._fetchAllQueuedResources=function(a){var d=this;if(!this._fetchQueue.length)return l.resolve();var c=
this._fetchQueue,b=this._cimAnalyses;this._fetchQueue=[];this._cimAnalyses=[];return l.all(b).then(function(){return d._fetchResource(c,a).then(function(a){for(var c=0;c<a.length;c++){var b=a[c],e=b.id,b=b.mosaicItem;d._idToResolver.get(e)(b);d._idToResolver.delete(e)}})}).catch(function(a){l.isAbortError(a)?d._fetchQueue=d._fetchQueue.concat(c):g.error(t("mapview-template-store","Unable to fetch requested texture resources",a))})};e.prototype._createGroupId=function(a){return this._idCounter++<<
1|(a?1:0)};e.prototype._createTemplateId=function(){return this._templateIdCounter++};e.prototype._createSMS=function(a,d){return f.__awaiter(this,void 0,void 0,function(){var c;return f.__generator(this,function(b){switch(b.label){case 0:return[4,this.getMosaicItem(a,!0)];case 1:return c=b.sent().spriteMosaicItem,h.ok(c,g)?[2,m.default.fromSimpleMarker(d,a,c)]:[2,this._markerError]}})})};e.prototype._createPMS=function(a,d){return f.__awaiter(this,void 0,void 0,function(){var c;return f.__generator(this,
function(b){switch(b.label){case 0:return[4,this.getMosaicItem(a,!0)];case 1:return c=b.sent().spriteMosaicItem,h.ok(c,g)?[2,m.default.fromPictureMarker(d,a,c)]:[2,this._markerError]}})})};e.prototype._createSFS=function(a,d,c){return f.__awaiter(this,void 0,void 0,function(){var b,e;return f.__generator(this,function(f){switch(f.label){case 0:return[4,this.getMosaicItem(a,!0)];case 1:return b=f.sent().spriteMosaicItem,e=a,h.ok(b,g)?[2,q.default.fromSimpleFill(d,e,b,c)]:[2,this._fillError]}})})};
e.prototype._createPFS=function(a,d,c){return f.__awaiter(this,void 0,void 0,function(){var b,e;return f.__generator(this,function(f){switch(f.label){case 0:return[4,this.getMosaicItem(a,!0)];case 1:return b=f.sent().spriteMosaicItem,e=a,h.ok(b,g)?[2,q.default.fromPictureFill(d,e,b,c)]:[2,this._fillError]}})})};e.prototype._createSLS=function(a,d,c){return f.__awaiter(this,void 0,void 0,function(){var b,e;return f.__generator(this,function(f){switch(f.label){case 0:return[4,this.getMosaicItem(a,!0)];
case 1:return b=f.sent().spriteMosaicItem,e=a,h.ok(b,g)?[2,u.default.fromSimpleLine(d,c,e,b,this._joinOnUTurn)]:[2,this._lineError]}})})};e.prototype._createLMS=function(a,d){return f.__awaiter(this,void 0,void 0,function(){var c,b;return f.__generator(this,function(e){switch(e.label){case 0:return c=a,[4,this.getMosaicItem(c.marker,!0)];case 1:return b=e.sent().spriteMosaicItem,h.ok(b,g)?[2,m.default.fromLineSymbolMarker(d,c,b)]:[2,this._markerError]}})})};e.prototype._createTS=function(a,d){return f.__awaiter(this,
void 0,void 0,function(){var c;return f.__generator(this,function(b){switch(b.label){case 0:return[4,this.getMosaicItem(a,!0)];case 1:return c=b.sent().glyphMosaicItems,[2,v.default.fromText(d,a,c)]}})})};e.prototype._createCIMText=function(a,d){return f.__awaiter(this,void 0,void 0,function(){var c;return f.__generator(this,function(b){switch(b.label){case 0:return[4,this.getMosaicItem(a.cim,!1,E.codepoints(a.text))];case 1:return c=b.sent().glyphMosaicItems,a.cim.mosaicHash=a.materialHash,h.ok(c,
g)?[2,v.default.fromCIMText(d,a,c)]:[2,this._textError]}})})};e.prototype._createCIMFill=function(a,d){return f.__awaiter(this,void 0,void 0,function(){var c;return f.__generator(this,function(b){switch(b.label){case 0:return a.cim.mosaicHash=a.materialHash,[4,this.getMosaicItem(a.cim,!1)];case 1:return c=b.sent().spriteMosaicItem,h.ok(c,g)?[2,q.default.fromCIMFill(d,a,c,!1)]:[2,this._fillError]}})})};e.prototype._createCIMLine=function(a,d){return f.__awaiter(this,void 0,void 0,function(){var c;
return f.__generator(this,function(b){switch(b.label){case 0:return a.cim.mosaicHash=a.materialHash,[4,this.getMosaicItem(a.cim,!1)];case 1:return c=b.sent().spriteMosaicItem,h.ok(c,g)?[2,u.default.fromCIMLine(d,a,c,!1,this._joinOnUTurn)]:[2,this._lineError]}})})};e.prototype._createCIMMarker=function(a,d){return f.__awaiter(this,void 0,void 0,function(){var c;return f.__generator(this,function(b){switch(b.label){case 0:return a.cim.mosaicHash=a.materialHash,[4,this.getMosaicItem(a.cim,!1)];case 1:return c=
b.sent().spriteMosaicItem,h.ok(c,g)?[2,m.default.fromCIMMarker(d,a,c)]:[2,this._markerError]}})})};e.prototype._createCIM=function(a,d){return f.__awaiter(this,void 0,void 0,function(){var c,b,e=this;return f.__generator(this,function(f){c=a.templateHash;if(this._cimTemplateCache.has(c))return[2,this._cimTemplateCache.get(c)];switch(a.type){case "marker":b=this._createCIMMarker(a,d);break;case "line":b=this._createCIMLine(a,d);break;case "fill":b=this._createCIMFill(a,d);break;case "text":b=this._createCIMText(a,
d)}b.then(function(a){return e._cimTemplateCache.set(c,a)});return[2,b]})})};e.prototype._createDynamicCIM=function(a,d){var c=a.templateHash;if(this._cimTemplateCache.has(c))return this._cimTemplateCache.get(c);var b;switch(a.type){case "marker":b=C.default.fromCIMMarker(d,a);break;case "line":b=B.default.fromCIMLine(d,a);break;case "fill":b=A.default.fromCIMFill(d,a);break;case "text":b=D.default.fromCIMText(d,a)}this._cimTemplateCache.set(c,b);return b};e.prototype._createMeshTemplates=function(a,
d,c,b){if(-1!==d.type.indexOf("3d"))return g.error("3D symbols are not supported with MapView"),a;switch(d.type){case "cim":return g.error(t("mapview-bad-type","Found a cim type not yet expanded")),a;case "expanded-cim":b=0;for(d=d.layers;b<d.length;b++){var e=d[b];"function"===typeof e.materialHash?a.push(this._createDynamicCIM(e,c)):k(a,this._createCIM(e,c))}return a;case "simple-marker":return k(a,this._createSMS(d,c));case "picture-marker":return k(a,this._createPMS(d,c));case "simple-fill":return k(a,
this._createSFS(d,c,b)),d.outline&&k(a,this._createSLS(d.outline,c,!0)),a;case "picture-fill":return k(a,this._createPFS(d,c,b)),d.outline&&k(a,this._createSLS(d.outline,c,!0)),a;case "simple-line":return k(a,this._createSLS(d,c,!1)),d.marker&&k(a,this._createLMS(d,c)),a;case "text":return k(a,this._createTS(d,c));default:return g.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),a}};return e}();n.WGLTemplateStore=r});