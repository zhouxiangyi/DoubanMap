// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ./Conflict ./GeometryUtils ./TextShaping ../webgl/Geometry".split(" "),function(O,R,J,t,Z,b){Object.defineProperty(R,"__esModule",{value:!0});O=function(){return function(b,a,p,c,k){void 0===p&&(p=0);void 0===c&&(c=-1);void 0===k&&(k=P);this.x=b;this.y=a;this.angle=p;this.segment=c;this.minzoom=k}}();R.Anchor=O;var aa=function(){return function(b,a,p,c,k,l,f){void 0===l&&(l=P);void 0===f&&(f=t.C_INFINITY);this.anchor=b;this.labelAngle=a;this.glyphAngle=p;this.page=c;this.alternateVerticalGlyph=
k;this.minzoom=l;this.maxzoom=f}}(),ea=function(){return function(b,a,p,c,k,l,f,t,D,z,A,r){this.tl=b;this.tr=a;this.bl=p;this.br=c;this.mosaicRect=k;this.labelAngle=l;this.minAngle=f;this.maxAngle=t;this.anchor=D;this.minzoom=z;this.maxzoom=A;this.page=r}}();R.PlacedSymbol=ea;var fa=function(){return function(b,a){this.footprint=b;this.shapes=a}}();R.Placement=fa;var P=.5;O=function(){function u(){this.mapAngle=0;this._conflictEngine=new J.ConflictEngine}u.prototype.reset=function(){this._conflictEngine.reset()};
u.prototype.setAngle=function(a){this.mapAngle=a};u.prototype.getIconPlacement=function(a,p,c,k,l){var f=c.width/c.pixelRatio,K=c.height/c.pixelRatio,D=l.offset[0]-f/2,z=l.offset[1]-K/2,f=D+f,K=z+K,A=c.rect,r=2/c.pixelRatio,m=D-r,q=z-r,d=m+A.width/c.pixelRatio,y=q+A.height/c.pixelRatio;c=new b.Point(m,q);r=new b.Point(d,y);m=new b.Point(m,y);q=new b.Point(d,q);d=l.rotate*t.C_DEG_TO_RAD;y=1===l.rotationAlignment;0<=a.segment&&!y&&(d+=a.angle);if(0!==d){var v=Math.cos(d),g=Math.sin(d);c.rotate(v,g);
r.rotate(v,g);m.rotate(v,g);q.rotate(v,g)}v=8*l.padding;g=new b.Point(a.x,a.y);a=new J.Footprint(this.mapAngle,v,y);a.addBox(g,new J.Box(D,z,f,K),k,d,p,P,t.C_INFINITY);p=new ea(c,q,m,r,A,0,0,256,g,P,t.C_INFINITY,0);p=new fa(a,[p]);k=P;l.allowOverlap||(k=this._conflictEngine.getMinZoom(p.footprint,k));a.minzoom=k;return p};u.prototype.getTextPlacement=function(a,p,c,k,l,f){for(var K=new b.Point(a.x,a.y),D=f.rotate*t.C_DEG_TO_RAD,z=0===f.rotationAlignment,A=f.keepUpright,r=P,m=!z,q=m?0:a.angle,d=0<=
a.segment&&z,m=new J.Footprint(this.mapAngle,8*f.padding,m),y=[],v=!d,g=Number.POSITIVE_INFINITY,L=Number.NEGATIVE_INFINITY,u=g,S=L,R=d?A:z&&A,T=!1,e=0;e<c.length;e++){var E=c[e];if(E.vertical){T=!0;break}}var n=e=0;if(!d&&T){var h=Z.TextShaping.getTextBox(c,f.lineHeight*Z.SDF_GLYPH_SIZE);switch(f.anchor){case 1:e=h.height/2;n=-h.width/2;break;case 2:e=-h.height/2;n=h.width/2;break;case 3:e=h.height/2;n=h.width/2;break;case 4:e=-h.height/2;n=-h.width/2;break;case 5:e=h.height;break;case 7:n=-h.width;
break;case 6:n=h.width;break;case 8:e=-h.height}}for(var e=e+f.offset[0]*Z.SDF_GLYPH_SIZE,n=n+f.offset[1]*Z.SDF_GLYPH_SIZE,O,ga=0;ga<c.length;ga++){var E=c[ga],w=E.glyphMosaicItem;if(w&&!w.rect.isEmpty){var M=w.rect,N=w.metrics,B=w.page;v&&(O&&O!==E.y&&(h=void 0,h=T?new J.Box(-S+e,g+n,-u+e,L+n):new J.Box(g+e,u+n,L+e,S+n),m.addBox(K,h,k,D,p,P,t.C_INFINITY),g=Number.POSITIVE_INFINITY,L=Number.NEGATIVE_INFINITY,u=g,S=L),O=E.y);var U=[];if(d){if(w=(E.x+N.left-4+.5*w.metrics.width)*k,r=this._placeGlyph(a,
r,w,l,a.segment,1,E.vertical,B,U),A&&(r=this._placeGlyph(a,r,w,l,a.segment,-1,E.vertical,B,U)),2<=r)break}else U.push(new aa(K,q,q,B,!1)),z&&A&&U.push(new aa(K,q+t.C_PI,q+t.C_PI,B,!1));var B=E.x+N.left,w=E.y-Z.SDF_GLYPH_BASELINE-N.top,h=B+N.width,ha=w+N.height,x=void 0,G=void 0,ba=void 0,ca=void 0;if(!d&&T)if(E.vertical)var F=(B+h)/2-N.height/2,Q=(w+ha)/2+N.width/2,x=new b.Point(-Q-4+e,F-4+n),G=new b.Point(x.x+M.width,x.y+M.height),ba=new b.Point(x.x,G.y),ca=new b.Point(G.x,x.y);else x=new b.Point(-w+
4+e,B-4+n),G=new b.Point(x.x-M.height,x.y+M.width),ba=new b.Point(G.x,x.y),ca=new b.Point(x.x,G.y);else x=new b.Point(B-4+e,w-4+n),G=new b.Point(x.x+M.width,x.y+M.height),ba=new b.Point(x.x,G.y),ca=new b.Point(G.x,x.y);for(var la=Q=F=void 0,ma=void 0,ia=0;ia<U.length;ia++){var C=U[ia],V=void 0,W=void 0,X=void 0,Y=void 0;C.alternateVerticalGlyph?(F||(F=(B+h)/2+e,Q=(w+ha)/2+n,F=new b.Point(F-N.height/2-4,Q+N.width/2+4),Q=new b.Point(F.x+M.height,F.y-M.width),la=new b.Point(Q.x,F.y),ma=new b.Point(F.x,
Q.y)),V=F,W=la,X=ma,Y=Q):(V=x,W=ba,X=ca,Y=G);var ja=w,ka=ha,da=C.glyphAngle+D;if(0!==da){var H=Math.cos(da),I=Math.sin(da),V=V.clone(),W=W.clone(),X=X.clone(),Y=Y.clone();V.rotate(H,I);Y.rotate(H,I);W.rotate(H,I);X.rotate(H,I)}H=0;I=256;d&&T?E.vertical?C.alternateVerticalGlyph?(H=32,I=96):(H=224,I=32):(H=224,I=96):(H=192,I=64);y.push(new ea(V,X,W,Y,M,C.labelAngle,H,I,C.anchor,C.minzoom,C.maxzoom,C.page));if(!R||this._legible(C.labelAngle))v?(B<g&&(g=B),ja<u&&(u=ja),h>L&&(L=h),ka>S&&(S=ka)):2>C.minzoom&&
m.addBox(C.anchor,new J.Box(B+e,ja+n,h+e,ka+n),k,da,p,C.minzoom,C.maxzoom)}}}if(2<=r)return null;v&&(h=void 0,h=T?new J.Box(-S+e,g+n,-u+e,L+n):new J.Box(g+e,u+n,L+e,S+n),m.addBox(K,h,k,D,p,P,t.C_INFINITY));a=new fa(m,y);f.allowOverlap||(r=this._conflictEngine.getMinZoom(a.footprint,r));m.minzoom=r;return a};u.prototype.add=function(a){this._conflictEngine.add(a.footprint)};u.prototype._legible=function(a){a=t.radToByte(a);return 65>a||193<=a};u.prototype._placeGlyph=function(a,p,c,k,l,f,u,D,z){var A=
0>f?t.positiveMod(a.angle+t.C_PI,t.C_2PI):a.angle,r=0;0>c&&(f*=-1,c*=-1,r=t.C_PI);0<f&&++l;a=new b.Point(a.x,a.y);var m=k[l],q=t.C_INFINITY;if(k.length<=l)return q;for(;;){var d=m.x-a.x,y=m.y-a.y,v=Math.sqrt(d*d+y*y),g=Math.max(c/v,p),d=t.positiveMod(Math.atan2(y/v,d/v)+r,t.C_2PI);z.push(new aa(a,A,d,D,!1,g,q));u&&z.push(new aa(a,A,d,D,!0,g,q));if(g<=p)return g;a=m.clone();do{l+=f;if(k.length<=l||0>l)return g;m=k[l]}while(a.isEqual(m));q=m.x-a.x;d=m.y-a.y;y=Math.sqrt(q*q+d*d);q*=v/y;d*=v/y;a.x-=q;
a.y-=d;q=g}};return u}();R.PlacementEngine=O});