// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../config ../../../../request ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../symbols/cim/Rasterizer ./definitions ./enums ./fontUtils ./GlyphMosaic ./GlyphSource ./SDFConverter ./SpriteMosaic ./animatedFormats/apng ./animatedFormats/gif ./util/BidiText ./util/Result ./util/symbolUtils".split(" "),
function(V,W,f,F,x,p,G,H,y,C,D,I,J,q,r,K,L,M,N,O,z,A,P,B,Q){function R(b){switch(b.type){case "CIMSolidStroke":case "CIMSolidFill":return!0;case "esriSFS":return"esriSFSSolid"===b.style||"esriSFSNull"===b.style;case "esriSLS":return"esriSLSSolid"===b.style||"esriSLSNull"===b.style;default:return!1}}function u(b){switch(b.type){case "esriSMS":case "esriPMS":case "CIMPointSymbol":case "CIMVectorMarker":case "CIMPictureMarker":case "CIMCharacterMarker":return!1;default:return!0}}function S(b){return f.__awaiter(this,
void 0,void 0,function(){var a,d;return f.__generator(this,function(e){switch(e.label){case 0:a=window.URL.createObjectURL(b),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,x(a,{responseType:"image"})];case 2:return d=e.sent().data,window.URL.revokeObjectURL(a),[2,d];case 3:return e.sent(),window.URL.revokeObjectURL(a),[2,new p("mapview-invalid-resource","Could not fetch requested resource at "+a)];case 4:return[2]}})})}function T(b,a){return f.__awaiter(this,void 0,void 0,function(){var d,e,c,
k,g,h,l,v,m;return f.__generator(this,function(n){switch(n.label){case 0:d=b.imageData?"data:"+b.contentType+";base64,"+b.imageData:b.url;if(-1===d.indexOf(";base64,"))return[3,1];c=d.indexOf(";base64,")+8;k=d.substring(c);g=atob(k);h=new Uint8Array(g.length);for(l=0;l<g.length;l++)h[l]=g.charCodeAt(l);e=h.buffer;return[3,4];case 1:return n.trys.push([1,3,,4]),[4,x(d,f.__assign({responseType:"array-buffer"},a))];case 2:return e=v=n.sent().data,[3,4];case 3:return m=n.sent(),y.isAbortError(m)?[3,4]:
[2,new p("mapview-invalid-resource","Could not fetch requested resource at "+d)];case 4:return[2,e]}})})}var E=I.vec2f32.create(),t=G.getLogger("esri.views.2d.engine.webgl.TextureManager"),U=function(){function b(a,d,e){this.mosaicType=a;this.page=d;this.sdf=e}b.fromMosaic=function(a,d){return new b(a,d.page,d.sdf)};return b}();return function(){function b(a){this._invalidFontsMap=new Map;this._sdfConverter=new N.default(126);this._bindingInfos=[];this._hashToBindingIndex=new Map;this._rasterizer=
new J.default;this._spriteMosaic=new O(a,2048,2048,500);this._glyphSource=new M(F.fontsUrl+"/{fontstack}/{range}.pbf");this._glyphMosaic=new L(1024,1024,this._glyphSource)}b.prototype.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizer.dispose();this._rasterizer=this._glyphMosaic=this._spriteMosaic=null};Object.defineProperty(b.prototype,"sprites",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"glyphs",
{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});b.prototype.rasterizeItem=function(a,d,e){return f.__awaiter(this,void 0,void 0,function(){var c,b,g,h=this;return f.__generator(this,function(k){switch(k.label){case 0:if(H.isNone(a))return t.error(new p("mapview-null-resource","Unable to rasterize null resource",void 0)),[2,null];c=a.type;switch(c){case "CIMTextSymbol":return[3,1];case "esriTS":return[3,1]}return[3,3];case 1:return[4,this._rasterizeText(a,d,e)];case 2:return b=
k.sent(),b.forEach(function(a){return h._setTextureBinding(r.MosaicType.GLYPH,a)}),[2,{glyphMosaicItems:b}];case 3:return a.type&&-1!==a.type.toLowerCase().indexOf("3d")?(t.error(new p("mapview-invalid-type","MapView does not support symbol type: "+a.type,a)),[2,null]):[4,this._rasterizeSpriteSymbol(a,e)];case 4:return g=k.sent(),B.ok(g)&&g&&this._setTextureBinding(r.MosaicType.SPRITE,g),[2,{spriteMosaicItem:g}]}})})};b.prototype.bindTextures=function(a,d,e){if(0!==e.textureBinding){var c=this._bindingInfos[e.textureBinding-
1];e=c.page;switch(c.mosaicType){case r.MosaicType.SPRITE:var c=this.sprites.getWidth(e),b=this.sprites.getHeight(e),c=D.vec2.set(E,c,b);this._spriteMosaic.bind(a,9729,e,q.TEXTURE_BINDING_SPRITE_ATLAS);d.setUniform1i("u_texture",q.TEXTURE_BINDING_SPRITE_ATLAS);d.setUniform2fv("u_mosaicSize",c);break;case r.MosaicType.GLYPH:c=this.glyphs.width;b=this.glyphs.height;c=D.vec2.set(E,c,b);this._glyphMosaic.bind(a,9729,e,q.TEXTURE_BINDING_GLYPH_ATLAS);d.setUniform1i("u_texture",q.TEXTURE_BINDING_GLYPH_ATLAS);
d.setUniform2fv("u_mosaicSize",c);break;default:t.error("mapview-texture-manager","Cannot handle unknown type "+c.mosaicType)}}};b.prototype._hashMosaic=function(a,d){return 1|a<<1|(d.sdf?1:0)<<2|d.page<<3};b.prototype._setTextureBinding=function(a,d){var e=this._hashMosaic(a,d);this._hashToBindingIndex.has(e)||(a=U.fromMosaic(a,d),this._hashToBindingIndex.set(e,this._bindingInfos.length+1),this._bindingInfos.push(a));d.textureBinding=this._hashToBindingIndex.get(e)};b.prototype._rasterizeText=function(a,
d,e){return f.__awaiter(this,void 0,void 0,function(){var c,b,g;return f.__generator(this,function(h){switch(h.label){case 0:c=K.getFullyQualifiedFontName(a.font);b=this._invalidFontsMap.has(c);var k;if(d)k=d;else{k=P.bidiText(a.text)[0];for(var f=[],m=0;m<k.length;m++)f.push(k.charCodeAt(m));k=f}g=k;h.label=1;case 1:return h.trys.push([1,3,,4]),[4,this._glyphMosaic.getGlyphItems(b?"arial-unicode-ms-regular":c,g,e)];case 2:return[2,h.sent()];case 3:return h.sent(),t.error(new p("mapview-invalid-resource",
"Couldn't find font "+c+". Falling back to Arial Unicode MS Regular",void 0)),this._invalidFontsMap.set(c,!0),[2,this._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",g,e)];case 4:return[2]}})})};b.prototype._rasterizeSpriteSymbol=function(a,b){return f.__awaiter(this,void 0,void 0,function(){var e,c,d,g,h,l;return f.__generator(this,function(k){if(R(a))return[2,null];e=Q.keyFromSymbol(a);return this._spriteMosaic.has(e)?[2,this._spriteMosaic.getSpriteItem(e)]:"esriSMS"===a.type&&a.path?[2,this._handleSVG(a,
e,b)]:a.url||a.imageData?[2,this._handleImage(a,e,b)]:(c=this._rasterizer.rasterizeJSONResource(a))?(d=c.size,g=c.image,h=c.sdf,l=c.simplePattern,[2,this._addItemToMosaic(e,d,{type:"static",data:g},u(a),h,l)]):[2,new p("TextureManager","unrecognized or null rasterized image")]})})};b.prototype._handleSVG=function(a,b,e){return f.__awaiter(this,void 0,void 0,function(){var c,d;return f.__generator(this,function(g){switch(g.label){case 0:return c=[126,126],[4,this._sdfConverter.draw(a.path,e)];case 1:return d=
g.sent(),[2,this._addItemToMosaic(b,c,{type:"static",data:new Uint32Array(d.buffer)},!1,!0,!0)]}})})};b.prototype._handleGIFOrPNG=function(a,b,e){return f.__awaiter(this,void 0,void 0,function(){var c,d,g,h,l,v,m,n,w,q,r,t;return f.__generator(this,function(f){switch(f.label){case 0:return[4,T(a,e)];case 1:c=f.sent();if(!B.ok(c))return[3,10];d=A.isGIF(c);g=z.isPNG(c);if(!d&&!g)return[2,new p("mapview-invalid-resource","Image data is neither GIF nor PNG!")];h=void 0;f.label=2;case 2:return f.trys.push([2,
7,,8]),d&&A.isAnimatedGIF(c)?[4,A.default.create(c,e)]:[3,4];case 3:return h=f.sent(),[3,6];case 4:return g&&z.isAnimatedPNG(c)?[4,z.default.create(c,e)]:[3,6];case 5:h=f.sent(),f.label=6;case 6:return[3,8];case 7:return l=f.sent(),y.isAbortError(l)?[3,8]:[2,new p("mapview-invalid-resource","Could not fetch requested resource!")];case 8:if(h&&B.ok(h))return[2,this._addItemToMosaic(b,[h.width,h.height],{type:"animated",data:h},u(a),!1,!1)];v=d?"image/gif":"image/png";m=new Blob([c],{type:v});return[4,
S(m)];case 9:if((n=f.sent())&&n instanceof HTMLImageElement)return w=this._rasterizer.rasterizeImageResource(n,a.colorSubstitutions),q=w.size,r=w.sdf,t=w.image,[2,this._addItemToMosaic(b,q,{type:"static",data:t},u(a),r,!1)];f.label=10;case 10:return[2,new p("mapview-invalid-resource","Could not handle resource!")]}})})};b.prototype._handleImage=function(a,b,e){return f.__awaiter(this,void 0,void 0,function(){var c,d,g,h,l,q,m;return f.__generator(this,function(k){switch(k.label){case 0:var n;(n=a.url&&
-1!==a.url.indexOf(".gif")||a.contentType&&"image/gif"===a.contentType||a.imageData&&-1!==a.imageData.indexOf("data:image/gif"))||(n=a.url&&-1!==a.url.indexOf(".png")||a.contentType&&"image/png"===a.contentType||a.imageData&&-1!==a.imageData.indexOf("data:image/png"));if(n)return[2,this._handleGIFOrPNG(a,b,e)];c=a.imageData?"data:"+a.contentType+";base64,"+a.imageData:a.url;k.label=1;case 1:return k.trys.push([1,3,,4]),[4,x(c,f.__assign({responseType:"image"},e))];case 2:return d=k.sent().data,-1!==
c.indexOf("data:image/svg+xml")&&(d.width=C.pt2px(a.width),d.height=C.pt2px(a.height)),g=this._rasterizer.rasterizeImageResource(d,a.colorSubstitutions),h=g.size,l=g.sdf,q=g.image,[2,this._addItemToMosaic(b,h,{type:"static",data:q},u(a),l,!1)];case 3:return m=k.sent(),y.isAbortError(m)?[3,4]:[2,new p("mapview-invalid-resource","Could not fetch requested resource at "+c)];case 4:return[2,void 0]}})})};b.prototype._addItemToMosaic=function(a,b,e,c,f,g){return this._spriteMosaic.addSpriteItem(a,b,e,
c,f,g)};return b}()});