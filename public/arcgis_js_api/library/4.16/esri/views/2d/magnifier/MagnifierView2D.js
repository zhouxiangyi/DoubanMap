// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../assets ../../../core/promiseUtils ../../webgl ../engine".split(" "),function(g,r,q,t,u,n,p){Object.defineProperty(r,"__esModule",{value:!0});var v=p.enums.WGLDrawPhase;g=function(g){function d(){var a=g.call(this)||this;a.visible=!1;return a}q.__extends(d,g);d.prototype.destroy=function(){this._readbackTexture&&(this._readbackTexture.dispose(),this._readbackTexture=null,this._maskTexture.dispose(),this._maskTexture=null,this._overlayTexture.dispose(),this._overlayTexture=
null,this._vertexArrayObject.dispose(),this._vertexArrayObject=null,this._program.dispose(),this._resourcesPromise=this._program=null)};Object.defineProperty(d.prototype,"magnifier",{get:function(){return this._magnifier},set:function(a){var b=this;this._magnifier=a;this._handle&&this._handle.remove();this._handle=a.watch("version",function(){b.visible=a.visible;b.requestRender()});this.visible=a.visible;this.requestRender()},enumerable:!0,configurable:!0});d.prototype.doRender=function(a){var b=
this.stage.context;if(!this._resourcesPromise)this._resourcesPromise=this._loadResources("esri/images/magnifier/mask.png","esri/images/magnifier/overlay.png");else if(a.drawPhase===v.MAP&&this._canRender()){this._updateResources(b);var m=this._magnifier,f=1/m.factor,e=Math.ceil(f*this.overlay.width),d=Math.ceil(f*this.overlay.height),c=a.state.size,h=a.pixelRatio,f=h*c[0];a=h*c[1];var k=m.position||{x:.5*c[0],y:.5*c[1]},c=h*k.x,h=a-h*k.y,k=.5*e,l=.5*d;k>c?c=k:c>=f-k&&(c=f-k-1);l>h?h=l:h>=a-l&&(h=
a-l-1);var k=c-k,l=h-l,g=this._readbackTexture;b.bindTexture(g,0);b.gl.copyTexImage2D(g.descriptor.target,0,g.descriptor.pixelFormat,k,l,e,d,0);e=(e=this.stage.background&&this.stage.background.color)?[e.a*e.r/255,e.a*e.g/255,e.a*e.b/255,e.a]:[1,1,1,1];d=-1+(c+m.offsetX)/f*2;m=-1+(h-m.offsetY)/a*2;f=this.overlay.width/f*2;a=this.overlay.height/a*2;c=this._program;b.bindVAO(this._vertexArrayObject);b.bindTexture(this._overlayTexture,6);b.bindTexture(this._maskTexture,7);b.bindProgram(c);c.setUniform4fv("u_background",
e);c.setUniform1i("u_readbackTexture",0);c.setUniform1i("u_overlyTexture",6);c.setUniform1i("u_maskTexture",7);c.setUniform2f("u_drawPos",d,m);c.setUniform1f("u_width",f);c.setUniform1f("u_height",a);b.setStencilTestEnabled(!1);b.drawArrays(5,0,4);b.bindVAO()}};d.prototype._canRender=function(){return this.mask&&this.overlay&&null!=this._magnifier};d.prototype._loadResources=function(a,b){return q.__awaiter(this,void 0,void 0,function(){var d,f,e;return q.__generator(this,function(g){switch(g.label){case 0:return[4,
u.all([t.fetchAsset(a,{responseType:"image"}),t.fetchAsset(b,{responseType:"image"})])];case 1:return d=g.sent(),f=d[0].data,e=d[1].data,this.mask=f,this.overlay=e,this.requestRender(),[2]}})})};d.prototype._updateResources=function(a){if(!this._readbackTexture){var b=1/this._magnifier.factor,d=Math.ceil(b*this.overlay.width),b=Math.ceil(b*this.overlay.height);this._program=p.createMagnifierProgram(a);var f=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new n.VertexArrayObject(a,p.magnifier.attributes,
{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},{geometry:n.BufferObject.createVertex(a,35044,f)});this._overlayTexture=new n.Texture(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.overlay);this._maskTexture=new n.Texture(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask);this._readbackTexture=new n.Texture(a,{target:3553,
pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:d,height:b})}};return d}(p.DisplayObject);r.default=g});