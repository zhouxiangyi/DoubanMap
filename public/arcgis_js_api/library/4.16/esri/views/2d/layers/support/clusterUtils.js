// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Error ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/MD5 ../../../../renderers/visualVariables/SizeVariable ../../../../renderers/visualVariables/support/SizeStop ../../engine".split(" "),function(D,f,h,n,t,w,u,k,x,g,y){function z(b,a,c){switch(b){case "avg":case "avg_angle":return"cluster_avg_"+a;case "mode":return"cluster_type_"+a;case "norm":return b=a.toLowerCase()+",norm:field,"+c.toLowerCase(),"cluster_avg_"+
k.createMD5Hash(b)}}function A(b,a){var c=a.name,d=a.outStatistic,e=d.onStatisticField,p=d.onStatisticValueExpression,d=d.statisticType;p?(a=k.createMD5Hash(p.toLowerCase()),b.push({name:c,outStatistic:{onStatisticField:a,onStatisticValueExpression:p,statisticType:d}})):e?b.push({name:c,outStatistic:{onStatisticField:e,statisticType:d}}):v.error(new n("mapview-unsupported-field","Unable to handle field",{field:a}))}function q(b,a,c){var d=k.createMD5Hash(a),e="mode"===c?"cluster_type_"+d:"cluster_avg_"+
d;b.some(function(b){return b.name===e})||b.push({name:e,outStatistic:{onStatisticField:d,onStatisticValueExpression:a,statisticType:c}});return e}function l(b,a,c,d){if("cluster_count"===a||b.some(function(b){return b.name===a}))return a;var e=z(c,a,d);b.some(function(b){return b.name===e})||("norm"===c?b.push({name:e,outStatistic:{onStatisticField:a,onStatisticNormalizationField:d,statisticType:c}}):b.push({name:e,outStatistic:{onStatisticField:a,statisticType:c}}));return e}var B=this;Object.defineProperty(f,
"__esModule",{value:!0});var v=w.getLogger("esri.views.2d.layers.support.clusterUtils");t.add("esri-cluster-arcade-enabled",1);var C=t("esri-cluster-arcade-enabled");f.createClusterRenderer=function(b,a,c,d,e){return h.__awaiter(B,void 0,void 0,function(){var a,r,g,k,m,n;return h.__generator(this,function(p){a=c.clone();if(!f.isClusterCompatibleRenderer(a))return[2,a];if(d.fields)for(r=0,g=d.fields;r<g.length;r++)k=g[r],A(b,k);"visualVariables"in a&&(m=(a.visualVariables||[]).filter(function(a){return"$view.scale"!==
a.valueExpression}),n=f.findSizeVV(m),m.forEach(function(a){"rotation"===a.type?a.field?a.field=l(b,a.field,"avg_angle"):a.valueExpression&&(a.field=q(b,a.valueExpression,"avg_angle"),a.valueExpression=null):a.normalizationField?(a.field=l(b,a.field,"norm",a.normalizationField),a.normalizationField=null):a.field?a.field=l(b,a.field,"avg"):(a.field=q(b,a.valueExpression,"avg"),a.valueExpression=null)}),u.isNone(n)&&!f.hasClusterCountVV(m)&&(m.push(f.createClusterCountSizeVariable(d,e)),a.dynamicClusterSize=
!0),a.visualVariables=m);switch(a.type){case "unique-value":a.field?a.field=l(b,a.field,"mode"):a.valueExpression&&(a.field=q(b,a.valueExpression,"mode"),a.valueExpression=null);break;case "class-breaks":a.normalizationField?(a.field=l(b,a.field,"norm",a.normalizationField),a.normalizationField=null):a.field?a.field=l(b,a.field,"avg"):(a.field=q(b,a.valueExpression,"avg"),a.valueExpression=null)}return[2,a]})})};f.findSizeVV=function(b){for(var a=0;a<b.length;a++){var c=b[a];if("size"===c.type)return c}return null};
f.hasClusterCountVV=function(b){for(var a=0;a<b.length;a++)if("cluster_count"===b[a].field)return!0;return!1};f.createClusterCountSizeVariable=function(b,a){var c=[new g({value:0,size:0}),new g({value:1})];if(u.isNone(a))return new x({field:"cluster_count",stops:h.__spreadArrays(c,[new g({value:2,size:0})])});var d=Object.keys(a).reduce(function(d,f){var e;return h.__assign(h.__assign({},d),(e={},e[f]=h.__spreadArrays(c,[new g({value:Math.max(2,a[f].minValue),size:b.clusterMinSize}),new g({value:Math.max(3,
a[f].maxValue),size:b.clusterMaxSize})]),e))},{});return new y.LevelDependentSizeVariable({field:"cluster_count",levels:d})};f.isClusterCompatibleRenderer=function(b){var a=function(a){return v.error(new n("Unsupported-renderer",a,{renderer:b}))};if("unique-value"===b.type){if(b.field2||b.field3)return a("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1}else if("class-breaks"===b.type){if(b.normalizationField){var c=b.normalizationType;if("field"!==c)return a("FeatureReductionCluster does not support a normalizationType of "+
c),!1}}else if("simple"!==b.type)return a("FeatureReductionCluster does not support renderers of type "+b.type),!1;if(!C){if("valueExpression"in b&&b.valueExpression)return a("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in b&&b.visualVariables||[]).some(function(a){return!!("valueExpression"in a&&a.valueExpression)}))return a("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),
!1}return!0}});