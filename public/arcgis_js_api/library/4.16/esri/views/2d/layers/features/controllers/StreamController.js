// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/Error ../../../../../core/has ../../../../../core/MapUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/data/executeTileQuery ../../../../../layers/graphics/data/FeatureStore ../../../../../layers/graphics/data/StreamFeatureManager ../../../../../layers/graphics/sources/connections/GeoEventConnection ./BaseController ./support/DispatchQueue".split(" "),
function(l,m,c,n,I,z,h,q,g,A,B,C,D,E,F,G){Object.defineProperty(m,"__esModule",{value:!0});var H=function(){function c(a,b){this.store=a;this.onUpdate=b}c.prototype.add=function(a){this.store.add(a)};c.prototype.forEach=function(a){this.store.forEach(a)};c.prototype.removeById=function(a){return this.store.removeById(a)};c.prototype.update=function(a,b){this.onUpdate(a,b)};Object.defineProperty(c.prototype,"size",{get:function(){return this.store.numFeatures},enumerable:!0,configurable:!0});return c}();
l=function(k){function a(){var b=null!==k&&k.apply(this,arguments)||this;b.type="stream";b._tileDispatchMap=new Map;b._updateIntervalId=0;return b}c.__extends(a,k);a.prototype.initialize=function(){var b=this,a=this.service,c=a.objectIdField,e=a.timeInfo,f=a.purgeOptions;this.connection=new E.default(a.source,a.spatialReference,this.spatialReference,a.geometryType,a.serviceFilter);this._set("store",new C.default(this.geometryInfo));this._set("streamFeatureManager",new D.default(new H(this.store,function(a,
d){return b._onUpdate(a,d)}),c,e,f));this.connection.on("feature",function(a){return b._onFeature(a)});["connectionStatus","errorString"].forEach(function(a){b.watch("connection."+a,function(d){return b.remoteClient.invoke("setProperty",{propertyName:a,value:d})})});this._updateIntervalId=setInterval(function(){return b.streamFeatureManager.checkForUpdates()},64);this._shouldPushDataReceived=this.service.enableDataReceived};a.prototype.destroy=function(){clearInterval(this._updateIntervalId);this.connection.destroy();
this.queryEngine.destroy();this._tileDispatchMap.forEach(function(b){return b.destroy()})};Object.defineProperty(a.prototype,"queryEngine",{get:function(){return this._createQueryEngine(this.store)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"updating",{get:function(){return this._tempQueryEngine&&!!this._tempQueryEngine.featureStore.numFeatures||this._anyUpdatesQueued()},enumerable:!0,configurable:!0});a.prototype.update=function(b){return c.__awaiter(this,void 0,void 0,function(){var a,
p,e=this;return c.__generator(this,function(d){switch(d.label){case 0:return this.validateConfig(b),JSON.stringify(this.service.serviceFilter),a=this.renderer.getAttributeHash(),this._set("config",b),[4,this.updatePixelBuffer()];case 1:d.sent();JSON.stringify(this.service.serviceFilter);if("heatmap"===this.renderer.type)return[2];if(a===this.renderer.getAttributeHash())return[3,3];p=this.queryEngine.featureStore;return[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];case 2:d.sent(),
p.forEach(function(b){return e.attributeStore.setAttributeData(b.localId,b,e.geometryInfo,e.viewParams)}),d.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return d.sent(),[4,this.attributeStore.sendUpdates()];case 5:return d.sent(),[2]}})})};a.prototype.invalidate=function(){this._repushActiveTiles()};a.prototype.onEdits=function(){};a.prototype.queryFeatures=function(b){return this.queryEngine.executeQuery(b)};a.prototype.queryFeatureCount=function(b){return this.queryEngine.executeQueryForCount(b)};
a.prototype.queryObjectIds=function(b){return this.queryEngine.executeQueryForIds(b)};a.prototype.queryExtent=function(b){return this.queryEngine.executeQueryForExtent(b)};a.prototype.queryLatestObservations=function(b){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(a){if(!this.service.timeInfo.trackIdField)throw n("mapview-no-trackIdField","queryLatestObservation can only be used with services that define a TrackIdField");return[2,this.queryEngine.executeQueryForLatestObservations(b)]})})};
a.prototype.queryStatistics=function(){throw n("Method not implemented.");};a.prototype.refresh=function(){};a.prototype.setViewState=function(b){var a=this,c=this.viewState&&this.viewState.scale;k.prototype.setViewState.call(this,b);c!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.queryEngine.featureStore.forEach(function(b){return a.attributeStore.setAttributeData(b.localId,b,a.geometryInfo,a.viewParams)}),this.attributeStore.sendUpdates())};a.prototype.onTileUpdate=function(b){var a=
this,c=b.added;b.removed.forEach(function(b){return a._handleTileRemove(b)});c.forEach(function(b){return a._handleTileAdd(b)})};a.prototype.enableEvent=function(b){"data-received"===b.name&&(this._shouldPushDataReceived=b.value)};a.prototype._onFeature=function(b){this._shouldPushDataReceived&&this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:b.attributes,centroid:b.centroid,geometry:b.geometry}});try{var a=this.geometryInfo,c=A.convertFromFeature(b,a.geometryType,a.hasZ,
a.hasM,this.service.objectIdField);this.streamFeatureManager.add(c)}catch(e){}};a.prototype._createStoreWithFeatures=function(b){if(h.isNone(b))return null;var a=this._createFeatureStore();a.addMany(b);return a};a.prototype._onUpdate=function(b,a){return c.__awaiter(this,void 0,void 0,function(){var d,e,f=this;return c.__generator(this,function(c){switch(c.label){case 0:return h.isSome(b)&&b.forEach(function(b){return f.onFeatureAdd(b)}),d=this._createStoreWithFeatures(b),e=this._createStoreWithFeatures(a),
this.attributeStore.sendUpdates(),this.processor.supportsTileUpdates?[4,this._updateActiveTiles(d,e)]:[3,2];case 1:return c.sent(),[3,3];case 2:this._repushActiveTiles(),c.label=3;case 3:return h.isSome(a)&&a.forEach(function(b){return f.onFeatureRemove(b)}),[2]}})})};a.prototype._handleTileAdd=function(b){if(this._tileDispatchMap.has(b.id)){var a=this._tileDispatchMap.get(b.id);a.up()}else a=new G.default,this._tileDispatchMap.set(b.id,a);this._queryTileFeatures(b,!0,this.queryEngine)};a.prototype._handleTileRemove=
function(b){var a=this._tileDispatchMap.get(b.id);a&&(a.destroy(),this._tileDispatchMap.delete(b.id))};a.prototype._anyUpdatesQueued=function(){return z.valuesOfMap(this._tileDispatchMap).some(function(a){return a.hasAction()})};a.prototype._updateActiveTiles=function(a,d){return c.__awaiter(this,void 0,void 0,function(){var b,e,f=this;return c.__generator(this,function(c){switch(c.label){case 0:return b=h.applySome(a,function(a){return f._createQueryEngine(a)}),e=h.applySome(d,function(a){return f._createQueryEngine(a)}),
[4,q.all(this.tileStore.tiles.map(function(a){return f._queryTileFeatures(a,!1,b,e)}))];case 1:return c.sent(),[2]}})})};a.prototype._repushActiveTiles=function(){for(var a=0,c=this.tileStore.tiles;a<c.length;a++)this._queryTileFeatures(c[a],!0,this.queryEngine)};a.prototype._queryTileFeatures=function(a,d,g,e){return c.__awaiter(this,void 0,void 0,function(){var b,k,l,m,n,r,p,v,w,x,t,y,u=this;return c.__generator(this,function(f){switch(f.label){case 0:b={hasZ:!1,hasM:!1,transform:{originPosition:"upperLeft",
scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]}};k=this.queryInfo;l=k.returnCentroid;m=k.returnGeometry;n=this._pixelBuffer;r={returnCentroid:l,returnGeometry:m,pixelBuffer:n,returnOutline:this.returnOutline};if(!this._tileDispatchMap.has(a.id))return[2];p=this._tileDispatchMap.get(a.id);return[4,h.applySome(g,function(b){return b.featureStore.executeTileQuery(a,u.spatialReference,r)})];case 1:return v=f.sent(),w=h.mapOr(v,[],function(a){return a.features}),x=h.mapOr(e,[],function(b){return B.executeTileQueryForIds(b,
a,r)}).map(function(a){return u.attributeStore.getLocalId(a)}),t=q.createResolver(),y=function(e){return c.__awaiter(u,void 0,void 0,function(){var f;return c.__generator(this,function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,this.processor.onTileData(a,{addOrUpdate:w,remove:x,clear:d,transformParams:b},{signal:e})];case 1:return c.sent(),[3,3];case 2:return f=c.sent(),q.throwIfNotAbortError(f),[3,3];case 3:return t.resolve(),[2]}})})},p.enqueue(y),[2,t.promise]}})})};c.__decorate([g.property()],
a.prototype,"connection",void 0);c.__decorate([g.property()],a.prototype,"service",void 0);c.__decorate([g.property({readOnly:!0})],a.prototype,"store",void 0);c.__decorate([g.property({readOnly:!0})],a.prototype,"streamFeatureManager",void 0);c.__decorate([g.property({readOnly:!0,dependsOn:["store","service","config"]})],a.prototype,"queryEngine",null);c.__decorate([g.property()],a.prototype,"updating",null);return a=c.__decorate([g.subclass("esri.views.2d.layers.features.controllers.StreamController")],
a)}(F.default);m.default=l});