// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Accessor ../../../../core/HandleOwner ../../../../core/Identifiable ../../../../core/MapPool ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators ../../../../geometry/Polygon ../../../../geometry/SpatialReference ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/coordsUtils ../../../../geometry/support/jsonUtils ../../../../geometry/support/spatialReferenceUtils ../../../../layers/graphics/data/projectionSupport ../../../../symbols/cim/cimSymbolUtils ../../../../symbols/support/defaults ../../engine ../../engine/webgl/definitions ../features/support/AttributeStore ../features/support/TileStore ./GraphicContainer ./GraphicProcessingQueue ./GraphicStore ./graphicsUtils ../../../layers/GraphicsView".split(" "),
function(w,A,e,D,E,F,B,G,v,m,H,I,r,J,K,t,L,h,x,C,M,y,p,N,O,P,Q,R,S,T,U){function z(e,d,a){if(a.has(e))return a.get(e);d={tile:d,addedOrModified:[],removed:[]};a.set(e,d);return d}Object.defineProperty(A,"__esModule",{value:!0});w=function(w){function d(a){a=w.call(this,a)||this;a._tiles=new Map;a._graphicStoreUpdate=!1;a._graphicsSet=new Set;a._matcher=m.resolve(null);a._tileUpdateSet=new Set;a._tilesToUpdate=new Map;a._graphicIdToAbortController=new Map;a._attached=!1;a._highlightIds=new Map;a._updatingGraphicsTimer=
null;a.lastUpdateId=-1;a.updateRequested=!1;a.graphicUpdateHandler=a.graphicUpdateHandler.bind(a);a.addOrUpdateGraphic=a.addOrUpdateGraphic.bind(a);a._processAnalyzedGraphics=a._processAnalyzedGraphics.bind(a);a._graphicsChangeHandler=a._graphicsChangeHandler.bind(a);return a}e.__extends(d,w);d.prototype.initialize=function(){var a=this;this._tileStore=new P.default(this.view.featuresTilingScheme);this.container=new Q.default(this.view.featuresTilingScheme);this._attributeStore=new O.default({type:"local",
initialize:function(b){return m.resolve(a.container.attributeView.initialize(b))},update:function(b){return a.container.attributeView.requestUpdate(b)},render:function(){return a.container.requestRender()}});this._graphicStore=new S.default(this.view.featuresTilingScheme,this.view.state.scale,this.uid,this.graphics,function(b){a._attributeStore.createLocalId(b.uid);a._setFilterState(b.uid,b.visible)},function(b){a._attributeStore.freeLocalId(b.uid)});this._graphicProcessingQueue=new R.default({process:this.addOrUpdateGraphic});
var c=new p.WGLTemplateStore(this.container.getMaterialItems.bind(this.container),!0);this._matcher=v.isSome(this.renderer)?p.createMatcher(c,null,this.renderer):p.createMatcher(c,null);this._meshFactory=new p.WGLMeshFactory(null,this.uid,null,c);this._templateStore=c;this.watch("renderer",function(b){b&&(a._matcher=v.isSome(a.renderer)?p.createMatcher(c,null,a.renderer):p.createMatcher(c,null))});this._tileStore.on("update",this._onTileUpdate.bind(this));this.container.on("attach",function(){0<a.graphics.items.length&&
a._graphicsChangeHandler({target:a.graphics,added:a.graphics.items,removed:[],moved:[]});a.handles.add(a.graphics.on("change",a._graphicsChangeHandler),"graphics");a._attached=!0;a.notifyChange("updating")});this.container.on("detach",function(){a._graphicProcessingQueue&&a._graphicProcessingQueue.clear()})};d.prototype.destroy=function(){this._updatingGraphicsTimer&&(clearTimeout(this._updatingGraphicsTimer),this._updatingGraphicsTimer=null,this.notifyChange("updating"));this.container.destroy();
this._set("graphics",null);this._graphicProcessingQueue&&(this._graphicProcessingQueue.destroy(),this._graphicProcessingQueue=null);this._graphicStore.clear();this._tileStore.destroy();this._attributeStore=null};Object.defineProperty(d.prototype,"updating",{get:function(){return!this._attached||null!==this._updatingGraphicsTimer||this._graphicProcessingQueue.updating||0<this._tileUpdateSet.size||0<this._tilesToUpdate.size},enumerable:!0,configurable:!0});d.prototype.hitTest=function(a,c){if(!this.view||
!this.view.position)return m.resolve();a=this.view.toMap(I.createScreenPoint(a,c));return this.searchFeatures(a).then(function(a){return a&&a.length?a[0]:null})};d.prototype.searchFeatures=function(a,c){var b=this;void 0===c&&(c=2);return m.create(function(f){f(b._graphicStore.hitTest(a.x,a.y,c,b.view.state.resolution,b.view.state.rotation))})};d.prototype.update=function(a){a=a.state;var c=this.view.featuresTilingScheme.getClosestInfoForScale(a.scale).level;this._graphicStore.updateLevel(c);this._tileStore.setViewState(a);
this._graphicStoreUpdate=!0;this.updateRequested=!1};d.prototype.viewChange=function(){this.requestUpdate()};d.prototype.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.requestUpdateCallback())};d.prototype.processUpdate=function(a){this.updateRequested&&(this.updateRequested=!1,this.update(a))};d.prototype.graphicUpdateHandler=function(a){var c=a.newValue,b=a.graphic;switch(a.property){case "geometry":case "symbol":this._graphicProcessingQueue.push(b,"update");break;
case "visible":this._setFilterState(b.uid,c),this._attributeStore.sendUpdates()}};d.prototype.addHighlight=function(a){for(var c=0;c<a.length;c++){var b=a[c];if(this._highlightIds.has(b)){var f=this._highlightIds.get(b);this._highlightIds.set(b,f+1)}else this._highlightIds.set(b,1)}this._updateHighlight()};d.prototype.removeHighlight=function(a){for(var c=0;c<a.length;c++){var b=a[c];if(this._highlightIds.has(b)){var f=this._highlightIds.get(b)-1;0===f?this._highlightIds.delete(b):this._highlightIds.set(b,
f)}}this._updateHighlight()};d.prototype._updateHighlight=function(){this._attributeStore.setHighlight(G.keysOfMap(this._highlightIds))};d.prototype._getIntersectingTiles=function(a){return(a=this._graphicStore.getBounds(a))&&0!==t.width(a)&&0!==t.height(a)?this._tileStore.boundsIntersections(a):[]};d.prototype._updateTile=function(a){var c=this,b=a.tile,f=this._getGraphicsData(this._templateStore,b,a.addedOrModified);return this._processGraphics(b.key,f).then(function(f){c._patchTile(b.key,{addOrUpdate:f,
remove:a.removed});return f})};d.prototype._patchTile=function(a,c){this._tiles.has(a)&&(a=this._tiles.get(a),this.container.onTileData(a,c),this.container.requestRender())};d.prototype._graphicsChangeHandler=function(a){var c=this;if(!this._graphicStoreUpdate){var b=this.view.state,f=this.view.featuresTilingScheme.getClosestInfoForScale(b.scale).level;this._graphicStore.updateLevel(f);this._tileStore.setViewState(b)}var d=a.added,f=a.removed;a=a.moved;for(var k=this._tilesToUpdate,g,b=[],n=Array(d.length),
e=0;e<d.length;e++){var l=d[e];n[e]=l;this._graphicsSet.add(l);b.push(this.addGraphic(l))}for(e=0;e<f.length;e++){l=f[e];this._abortProcessingGraphic(l.uid);for(var d=this._getIntersectingTiles(l),q=0,h=d;q<h.length;q++)d=h[q],g=d.key.id,d=z(g,d,k),d.removed.push(this._attributeStore.getLocalId(l.uid));this._graphicsSet.delete(l);this._graphicStore.remove(l)}for(f=0;f<a.length;f++)for(e=a[f],d=this._getIntersectingTiles(e),l=0,q=d;l<q.length;l++)d=q[l],g=d.key.id,d=z(g,d,k),d.addedOrModified.push(e);
this._flipUpdatingGraphics();m.all(b).then(function(){for(var a,b=0;b<n.length;b++){a=n[b];for(var d=0,f=c._getIntersectingTiles(a);d<f.length;d++){var e=f[d];g=e.key.id;z(g,e,k).addedOrModified.push(a)}}c._graphicStore.updateZ();var u=[];k.forEach(function(a){return u.push(c._updateTile(a))});return m.all(u).then(function(){k.clear();c.notifyChange("updating")})}).catch(function(){k.clear();c.notifyChange("updating")})};d.prototype._getArcadeInfo=function(a){var c=(a.attributes?Object.keys(a.attributes):
[]).map(function(b){return{name:b,alias:b,type:"string"===typeof a.attributes[b]?"esriFieldTypeString":"esriFieldTypeDouble"}});return v.isNone(a.geometry)?null:{geometryType:h.getJsonType(a.geometry),spatialReference:K.fromJSON(a.geometry.spatialReference),fields:c}};d.prototype._getSymbolForGraphic=function(a,c){return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(b){return v.isSome(a.symbol)?[2,a.symbol]:v.isSome(this.renderer)?[2,this.renderer.getSymbolAsync(a,{scale:this.view.scale,
abortOptions:c})]:[2,this._getNullSymbol(a)]})})};d.prototype._getSymbolResources=function(a,c){return e.__awaiter(this,void 0,void 0,function(){var b,d,u,k,g,n,h,l,q;return e.__generator(this,function(f){switch(f.label){case 0:if(!this.container.stage)return[2,m.resolve(null)];b=this._getArcadeInfo(a);u=M.expandSymbol;return[4,this._getSymbolForGraphic(a,c)];case 1:return[4,u.apply(void 0,[f.sent(),b,c])];case 2:d=f.sent();if("text"!==d.type)return[3,4];k=[];g=d;n=p.bidiText(g.text)[0];for(h=0;h<
n.length;h++)k.push(n.charCodeAt(h));l={symbol:d.toJSON(),id:0,glyphIds:k};return[4,this.container.getMaterialItems([l])];case 3:return q=f.sent()[0].mosaicItem,[2,{symbol:d,mosaicItem:q}];case 4:return[2,{symbol:d,mosaicItem:null}]}})})};d.prototype._projectAndNormalizeGeometry=function(a){return e.__awaiter(this,void 0,void 0,function(){var c,b,d,u=this;return e.__generator(this,function(f){if(v.isNone(a.geometry))return[2,m.resolve(null)];c=a.geometry;h.isPolygon(c)?(b=c.rings,c.rings=b):h.isPolyline(c)?
(d=c.paths,c.paths=d):h.isExtent(c)&&(c=J.fromExtent(c));return[2,C.checkProjectionSupport(c.spatialReference,this.view.spatialReference).then(function(){var a=T.normalizeCentralMeridian(c),a=C.project(a,c.spatialReference,u.view.spatialReference);L.closeRingsAndFixWinding(a);return a})]})})};d.prototype._onTileUpdate=function(a){var c=x.getInfo(this.view.spatialReference);if(a.added&&0<a.added.length)for(var b=0,d=a.added;b<d.length;b++)this._addNewTile(d[b],c);if(a.removed&&0<a.removed.length)for(c=
0,a=a.removed;c<a.length;c++)this._removeTile(a[c].key)};d.prototype.addOrUpdateGraphic=function(a,c,b){return this._addOrUpdateGraphic(a,c,b)};d.prototype.addGraphic=function(a){var c=this;this._abortProcessingGraphic(a.uid);var b=H.createAbortController();this._graphicIdToAbortController.set(a.uid,b);return this._addOrUpdateGraphic(a,"add",{signal:b.signal}).then(function(){c._graphicIdToAbortController.delete(a.uid)}).catch(function(b){c._graphicIdToAbortController.delete(a.uid);if(!m.isAbortError(b))throw b;
})};d.prototype._addOrUpdateGraphic=function(a,c,b){var d=this,e=this._projectAndNormalizeGeometry(a),k=this._getSymbolResources(a,b);return m.all([e,k]).then(function(f){var e=f[0];f=f[1];return"add"===c?d._addProjectedGraphic(a,f,e):d._updateGraphic(a,f,e,b)})};d.prototype._addProjectedGraphic=function(a,c,b){this._graphicsSet.has(a)&&this._graphicStore.add(a,c,b)};d.prototype._updateGraphic=function(a,c,b,d){var f=this;if(!this._graphicStore.has(a)||m.isAborted(d))return m.resolve();b=this._graphicStore.update(a,
c,b);c=b.oldBounds;b=b.newBounds;var e=0===t.width(c)&&0===t.height(c),g=0===t.width(b)&&0===t.height(b),e=e?[]:this._tileStore.boundsIntersections(c);c=g?[]:this._tileStore.boundsIntersections(b);b=B.acquire();for(var n=0;n<e.length;n++)g=e[n],b.set(g.key,{addOrUpdate:null,remove:[this._attributeStore.getLocalId(a.uid)]});for(e=0;e<c.length;e++)g=c[e],n=this._getGraphicData(this._templateStore,g,a),b.has(g.key)?(g=b.get(g.key),g.remove.length=0,g.addOrUpdate=n):b.set(g.key,{addOrUpdate:n,remove:null});
var h=[];b.forEach(function(a,b){var c=f._processGraphics(b,a.addOrUpdate,d).then(function(c){f._patchTile(b,{addOrUpdate:c,remove:a.remove})});h.push(c)});B.release(b);return m.all(h).then(function(){})};d.prototype._addTile=function(a,c){var b=t.create();this.view.featuresTilingScheme.getTileBounds(b,a);b=new p.WGLTile(a,b,!0);c={clear:!0,addOrUpdate:c,remove:[]};this._tiles.set(a,b);this.container.addChild(b);b.setData(c,!1,!1)};d.prototype._addNewTile=function(a,c){var b=this,d=this._graphicStore.queryTileData(this._templateStore,
a);if(c){c=Math.round((c.valid[1]-c.valid[0])/a.resolution);for(var e=0;e<d.length;e++){var k=d[e];k.geometry&&h.isPoint(k.geometry)&&this._wrapPoints(k,c)}}var g=a.key;this._tileUpdateSet.add(a.key);this.notifyChange("updating");this._processGraphics(g,d).then(function(a){b._addTile(g,a);b._tileUpdateSet.delete(g);b.notifyChange("updating")}).catch(function(a){b._tileUpdateSet.delete(g);b.notifyChange("updating");if(!m.isAbortError(a))throw a;})};d.prototype._removeTile=function(a){if(this._tiles.has(a)){var c=
this._tiles.get(a);this.container.removeChild(c);c.destroy();this._tiles.delete(a)}};d.prototype._setFilterState=function(a,c){var b=this._attributeStore.getLocalId(a);a=this._attributeStore.getHighlightFlag(a);this._attributeStore.setData(b,0,0,a|(c?N.FILTER_FLAG_0:0))};d.prototype._getGraphicsData=function(a,c,b){var d=x.getInfo(this.view.spatialReference);a=this._graphicStore.getGraphicsData(a,c,b);if(d)for(c=Math.round((d.valid[1]-d.valid[0])/c.resolution),d=0;d<a.length;d++)b=a[d],b.geometry&&
h.isPoint(b.geometry)&&this._wrapPoints(b,c);a.sort(function(a,b){return a.insertAfter-b.insertAfter});return a};d.prototype._getGraphicData=function(a,c,b){a=this._graphicStore.getGraphicData(a,c,b);b=[a];var d=x.getInfo(this.view.spatialReference);d&&(c=Math.round((d.valid[1]-d.valid[0])/c.resolution),a.geometry&&h.isPoint(a.geometry)&&this._wrapPoints(a,c));return b};d.prototype._wrapPoints=function(a,c){var b=a.geometry;512===c?20>b.x?a.geometry={points:[[b.x,b.y],[c,0]]}:492<b.x&&(a.geometry=
{points:[[b.x,b.y],[-c,0]]}):-20>b.x?a.geometry={points:[[b.x,b.y],[c,0]]}:532<b.x&&(a.geometry={points:[[b.x,b.y],[-c,0]]})};d.prototype._processGraphics=function(a,c,b){return e.__awaiter(this,void 0,void 0,function(){var d,h,k;return e.__generator(this,function(e){switch(e.label){case 0:d=c&&c.length;if(!d||!this._meshFactory)return[2,null];h=this._meshFactory;return[4,this._matcher.then(function(a){return h.analyze(c,a,null,null,b)})];case 1:return k=e.sent(),this._attributeStore.sendUpdates(),
[2,this._processAnalyzedGraphics(a,k)]}})})};d.prototype._processAnalyzedGraphics=function(a,c){for(var b=this._meshFactory,d=b.createMeshData(c.length),e=this._attributeStore,h=0;h<c.length;h++){var g=c[h];g.insertAfter=-1===g.insertAfter?-1:e.getLocalId(g.insertAfter);g.localId=e.getLocalId(g.attributes[this.uid]);b.write(d,g,null,null,a.level,null)}return p.TileData.fromMeshData(d)};d.prototype._abortProcessingGraphic=function(a){this._graphicIdToAbortController.has(a)&&this._graphicIdToAbortController.get(a).abort()};
d.prototype._getNullSymbol=function(a){a=a.geometry;return h.isPolyline(a)?y.errorPolylineSymbol2D:h.isPolygon(a)||h.isExtent(a)?y.errorPolygonSymbol2D:y.errorPointSymbol2D};d.prototype._flipUpdatingGraphics=function(){var a=this;this._updatingGraphicsTimer&&clearTimeout(this._updatingGraphicsTimer);this._updatingGraphicsTimer=setTimeout(function(){a._updatingGraphicsTimer=null;a.notifyChange("updating")},160);this.notifyChange("updating")};e.__decorate([r.property()],d.prototype,"_graphicProcessingQueue",
void 0);e.__decorate([r.property({constructOnly:!0})],d.prototype,"requestUpdateCallback",void 0);e.__decorate([r.property({constructOnly:!0})],d.prototype,"graphics",void 0);e.__decorate([r.property({dependsOn:["_graphicProcessingQueue.updating"]})],d.prototype,"updating",null);e.__decorate([r.property()],d.prototype,"view",void 0);e.__decorate([r.property()],d.prototype,"updateRequested",void 0);return d=e.__decorate([r.subclass("esri.views.2d.layers.support.GraphicsView2D")],d)}(U.GraphicsView(E.HandleOwnerMixin(F.IdentifiableMixin(D))));
A.default=w});