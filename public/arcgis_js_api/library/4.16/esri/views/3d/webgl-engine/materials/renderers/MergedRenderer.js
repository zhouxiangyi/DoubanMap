// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/MapUtils ../../../../../core/MapUtils ../../../../../core/maybe ../../../../../core/maybe ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../support/buffer/glUtil ../../lib/DefaultVertexAttributeLocations ../../lib/renderStats ../../lib/ResizableFloat32Array ../../lib/Util ../WaterGLMaterial ./Instance ./utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),
function(C,Q,E,r,w,x,y,z,F,G,D,H,v,I,u,A,J,K,L){function M(f,b,a,g){for(var c=new Map,d=b.vertexBufferLayout.stride/4,l=function(a,g){var h=a.origin,e=f.get(h.id),k=c.get(h.id);null==k&&(k={optimalCount:null==e?0:e.optimalCount,sparseCount:null==e?0:e.buffer.size,toAdd:[],toRemove:[],origin:h.vec3},c.set(h.id,k));h=b.elementCount(a.data)*d;g?(k.optimalCount+=h,k.sparseCount+=h,k.toAdd.push(a)):(k.optimalCount-=h,k.toRemove.push(a))},m=0;m<a.length;m++){var e=a[m];l(e,!0)}for(a=0;a<g.length;a++)e=
g[a],l(e,!1);return c}C=function(){function f(b,a,g,c){void 0===c&&(c=G.Default3D);this.type="MergedRenderer";this._dataByOrigin=new Map;this._hasOccludees=this._hasHighlights=!1;this._rctx=b;this._vertexAttributeLocations=c;this._material=g;this._materialRep=a;this._glMaterials=A.acquireMaterials(this._material,this._materialRep);this._bufferWriter=g.createBufferWriter()}f.prototype.dispose=function(){A.releaseMaterials(this._material,this._materialRep);this._dataByOrigin&&(this._dataByOrigin.forEach(function(b){b.vao.dispose(!0);
b.vao=null}),this._dataByOrigin.clear(),this._dataByOrigin=null);this._glMaterials&&(this._glMaterials.forEach(function(b){b&&b.dispose()}),this._glMaterials.clear(),this._glMaterials=null)};Object.defineProperty(f.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"hasOccludees",{get:function(){return this._hasOccludees},
enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"hasWater",{get:function(){return!this.isEmpty&&r.someMap(this._glMaterials,function(b){return b instanceof I.WaterGLMaterial})},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"rendersOccluded",{get:function(){return!this.isEmpty&&1!==this._material.renderOccluded},enumerable:!0,configurable:!0});f.prototype.modify=function(b){this.updateGeometries(b.toUpdate);this.addAndRemoveGeometries(b.toAdd,b.toRemove);this.updateRenderCommands()};
f.prototype.addAndRemoveGeometries=function(b,a){var g=this,c=this._bufferWriter,d=c.vertexBufferLayout,l=d.stride/4,m=this._dataByOrigin,e=M(m,c,b,a);e.forEach(function(a,b){e.delete(b);var c=a.optimalCount,h=a.sparseCount,k=m.get(b);null==k&&(v.assert(0<c),k=g.createData(d,c,a.origin),m.set(b,k));if(0===c)k.vao.dispose(!0),k.vao=null,m.delete(b);else{var f=c<a.sparseCount/2;b=N;var q=k.buffer.size,O=k.buffer.array,c=k.buffer.resize(f?c:h,!1);f||c?g.removeAndRebuild(k,a.toRemove,l,O,b):0<a.toRemove.length?
(g.removeByErasing(k,a.toRemove,l,b),0<a.toAdd.length&&(b.end=q)):(b.begin=q,b.end=q);c=P;v.setMatrixTranslation3(c,-a.origin[0],-a.origin[1],-a.origin[2]);g.append(k,a.toAdd,l,c,b);a=k.vao.vertexBuffers.geometry;a.byteSize!==k.buffer.array.buffer.byteLength?a.setData(k.buffer.array):(c=b.begin,b=b.end,c<b&&(c*=4,a.setSubData(k.buffer.array,c,c,4*b)));k.drawCommandsDirty=!0}})};f.prototype.updateGeometries=function(b){for(var a=this._bufferWriter,g=a.vertexBufferLayout.stride/4,c=0;c<b.length;c++){var d=
b[c],l=d.updateType,d=d.renderGeometry,m=this._dataByOrigin.get(d.origin.id),e=m&&m.instances.get(d.uniqueName);if(!e)break;l&1&&(e.isVisible=d.instanceParameters.visible);if(l&9){var h=d.instanceParameters.visible;e.hasHighlights=!!d.instanceParameters.highlights&&h}l&16&&(e.hasOccludees=!!d.instanceParameters.occludees);l&6&&(l=m.buffer.array,h=m.vao,A.calculateTransformRelToOrigin(d,B,t),a.write({transformation:B,invTranspTransformation:t},d.data,a.vertexBufferLayout.createView(l.buffer),e.from),
v.assert(e.from+a.elementCount(d.data)===e.to,"material VBO layout has changed"),h.vertexBuffers.geometry.setSubData(l,e.from*g*4,e.from*g*4,e.to*g*4));m.drawCommandsDirty=!0}};f.prototype.updateRenderCommands=function(){this._dataByOrigin.forEach(function(a){a.hasHiddenInstances=r.someMap(a.instances,function(a){return!a.isVisible});a.hasHighlights=r.someMap(a.instances,function(a){return a.isVisible&&a.hasHighlights});a.hasOccludees=r.someMap(a.instances,function(a){return a.isVisible&&a.hasOccludees})});
this._hasHighlights=r.someMap(this._dataByOrigin,function(a){return a.hasHighlights});this._hasOccludees=r.someMap(this._dataByOrigin,function(a){return a.hasOccludees});var b=function(a){a.drawCommandsDefault=null;a.drawCommandsHighlight=null;a.drawCommandsOccludees=null;a.stats={default:0,highlight:0,occludees:0};if(0!==a.instances.size)if(a.hasOccludees||a.hasHighlights||a.hasHiddenInstances){var b=u.sortInstancesAccordingToRange(E.valuesOfMap(a.instances));a.drawCommandsDefault=[];a.drawCommandsHighlight=
[];a.drawCommandsOccludees=[];for(var c=0;c<b.length;c++){var d=b[c];d.isVisible&&(d.hasOccludees?u.addOrMerge(a.drawCommandsOccludees,d):u.addOrMerge(a.drawCommandsDefault,d),d.hasHighlights&&u.addOrMerge(a.drawCommandsHighlight,d))}b=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c].count;return b/3};a.stats={default:b(a.drawCommandsDefault),highlight:b(a.drawCommandsHighlight),occludees:b(a.drawCommandsOccludees)}}else b=4*a.buffer.size/K.getStride(a.vao.layout.geometry),a.drawCommandsDefault=
[{first:0,count:b}],a.stats={default:b,highlight:0,occludees:0}};this._dataByOrigin.forEach(function(a){a.drawCommandsDirty&&(b(a),a.drawCommandsDirty=!1)})};f.prototype.updateLogic=function(b){return this._material.update(b)};f.prototype.render=function(b,a,g,c){var d=this,l=this._rctx,m=this._glMaterials.get(a.pass),e=4===a.pass,h=b;2===a.pass&&null===h&&(h=22);if(!m||2!==m.ensureResources(l)||null!=h&&!m.beginSlot(h)||e&&!this._hasHighlights)return!1;m.ensureParameters(g);var f=m.getTechnique(),
p=m.getPipelineState(h,!1);l.setPipelineState(p);m.bind(l,g);var n=!1;this._dataByOrigin.forEach(function(a){if(!(w.isNone(a.drawCommandsDefault)&&w.isNone(a.drawCommandsHighlight)&&w.isNone(a.drawCommandsOccludees)||e&&!a.hasHighlights)){g.origin=a.origin;f.bindDraw(g);f.ensureAttributeLocations(a.vao);l.bindVAO(a.vao);var b=f.primitiveType,k=e?a.drawCommandsHighlight:a.drawCommandsDefault,q=e?a.stats.highlight:a.stats.default;x.isSome(k)&&(d.renderCommands(l,b,k),D.addToRenderStats(k.length,q,c),
n=!0);e||(k=a.drawCommandsOccludees,x.isSome(k)&&(q=m.getPipelineState(h,!0),l.setPipelineState(q),d.renderCommands(l,b,k),l.setPipelineState(p),D.addToRenderStats(k.length,a.stats.occludees,c),n=!0))}});return n};f.prototype.renderCommands=function(b,a,g){for(var c=0;c<g.length;c++)b.drawArrays(a,g[c].first,g[c].count)};f.prototype.createData=function(b,a,g){return{instances:new Map,vao:new L(this._rctx,this._vertexAttributeLocations,{geometry:F.glLayout(b)},{geometry:J.createVertex(this._rctx,35044)}),
buffer:new H.ResizableFloat32Array(a),optimalCount:0,origin:g,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,stats:{default:0,highlight:0,occludees:0}}};f.prototype.removeAndRebuild=function(b,a,g,c,d){for(var l=0;l<a.length;l++){var m=a[l].uniqueName,e=b.instances.get(m);b.optimalCount-=(e.to-e.from)*g;b.instances.delete(m)}var h=0,f=b.buffer.array;d.begin=0;d.end=0;var p=-1,n=-1,k=0;b.instances.forEach(function(a){var b=
a.from*g,d=a.to*g,e=d-b;p!==n&&n!==b?(f.set(c.subarray(p,n),k),k+=n-p,p=b):-1===p&&(p=b);n=d;a.from=h/g;h+=e;a.to=h/g});p!==n&&f.set(c.subarray(p,n),k);d.end=h};f.prototype.removeByErasing=function(b,a,g,c){c.begin=Infinity;c.end=-Infinity;for(var d=-1,l=-1,m=0;m<a.length;m++){var e=a[m].uniqueName,h=b.instances.get(e),f=h.from*g,h=h.to*g;d!==l&&l!==f?(b.buffer.erase(d,l),d=f):-1===d&&(d=f);l=h;b.instances.delete(e);b.optimalCount-=h-f;f<c.begin&&(c.begin=f);h>c.end&&(c.end=h)}d!==l&&b.buffer.erase(d,
l)};f.prototype.append=function(b,a,g,c,d){for(var f=this._bufferWriter,m=0;m<a.length;m++){var e=a[m],h=x.isSome(e.transformation)?y.mat4.multiply(B,c,e.transformation):c;y.mat4.invert(t,h);y.mat4.transpose(t,t);var q=d.end;f.write({transformation:h,invTranspTransformation:t},e.data,f.vertexBufferLayout.createView(b.buffer.array.buffer),d.end/g);var h=f.elementCount(e.data)*g,p=q+h;v.assert(null==b.instances.get(e.uniqueName));var n=e.instanceParameters.visible,q=new u.Instance(q/g,p/g,n,!!e.instanceParameters.highlights&&
n,!!e.instanceParameters.occludees);b.instances.set(e.uniqueName,q);b.optimalCount+=h;d.end+=h}};Object.defineProperty(f.prototype,"test",{get:function(){return{material:this._material,glMaterials:this._glMaterials}},enumerable:!0,configurable:!0});return f}();var N={begin:0,end:0},P=z.mat4f64.create(),B=z.mat4f64.create(),t=z.mat4f64.create();return C});