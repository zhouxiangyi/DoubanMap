// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Accessor ../../../core/Handles ../../../core/Logger ../../../core/MapUtils ../../../core/maybe ../../../core/PooledArray ../../../core/SetUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/vec3f64 ../support/debugFlags ../webgl-engine/core/shaderTechnique/CommonUniformStore ../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository ../webgl-engine/lib/AutoDisposable ../webgl-engine/lib/Camera ../webgl-engine/lib/GLMaterialRep ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/GridLocalOriginFactory ../webgl-engine/lib/intersectorUtils ../webgl-engine/lib/RenderContext ../webgl-engine/lib/renderStats ../webgl-engine/lib/SortedRenderGeometryRenderer ../webgl-engine/lib/TextureTechnique ../webgl-engine/lighting/Lightsources ../webgl-engine/lighting/SceneLighting ../webgl-engine/materials/lineStippleUtils ../../webgl/FramebufferObject ../../webgl/Texture ../../webgl/Util".split(" "),
function(A,m,g,I,J,K,l,n,L,M,B,t,x,y,C,N,O,u,P,Q,D,R,S,T,U,V,E,W,X,Y,Z,aa,F){Object.defineProperty(m,"__esModule",{value:!0});var z=K.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");A=function(p){function b(){var a=null!==p&&p.apply(this,arguments)||this;a._hasHighlights=!1;a._rendersOccluded=!1;a._hasWater=!1;a._lighting=new X.SceneLighting;a._localOrigins=new R;a._handles=new J;a._layerRenderers=new Map;a._sortedLayerRenderersDirty=!1;a._sortedLayerRenderers=new L;a._stats=new U.RenderStatsAggregator;
a._geometries=new Map;a._renderTargets={};a._uniqueIdx=0;a.longitudeCyclical=null;return a}g.__extends(b,p);b.prototype.initialize=function(){var a=this;this._rctx=this.renderView.renderingContext;this._renderContext=new T(this._rctx,null,null,null,null,null);this._stippleTextureRepository=new Y.StippleTextureRepository;this.waterTextureRepository=this.renderView.waterTextureRepository;this._shaderTechniqueRepository=new O.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:1,commonUniformStore:new N.CommonUniformStore,
stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository});B.init(this.waterTextureRepository,"loadingState",function(){return a.emitContentChanged()});this._materialRepository=new Q(this.renderView.textureRepository,this._shaderTechniqueRepository);this._materialRepository.onMaterialChanged=function(c){0<(c.renderOccluded&m.overlayRenderOccludedFlag)!==a._rendersOccluded&&a.updateRendersOccluded();a.emitContentChanged();a.notifyChange("updating")};
this._compositingHelper=this.renderView.compositingHelper;this._bindParameters={slot:null,fovY:0,highlightDepthTexture:D.createEmptyDepthTexture(this._rctx),nearFar:[r.near,r.far],origin:null,pixelRatio:null,proj:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,view:null,viewInvTransp:null,viewport:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrViewMat:null,rpProjectionMat:null,ssrEnabled:!1};
this._lighting.set({lights:[new W.AmbientLight(y.vec3f64.fromValues(1,1,1))],groundLightingFactor:1,globalFactor:0})};b.prototype.dispose=function(){this._handles.destroy();this._layerRenderers.forEach(function(a){return a.dispose()});this._layerRenderers.clear();for(var a in this._renderTargets)this._renderTargets[a].dispose();this._renderTargets=null;this._bindParameters.highlightDepthTexture.dispose();this._bindParameters.highlightDepthTexture=null;this._shaderTechniqueRepository.dispose();this._shaderTechniqueRepository=
null};b.prototype.disposeRenderTarget=function(a){var c=this._renderTargets[a];c&&c.dispose();delete this._renderTargets[a]};Object.defineProperty(b.prototype,"updating",{get:function(){return this._sortedLayerRenderersDirty||l.someMap(this._layerRenderers,function(a){return a.updating})||this.waterTextureRepository.updating},enumerable:!0,configurable:!0});b.prototype.commitChanges=function(){var a=this,c=!1;this._layerRenderers.forEach(function(e,d){e.commitChanges()&&(c=!0);e.isEmpty&&(a._layerRenderers.delete(d),
a._sortedLayerRenderersDirty=!0,a._handles.remove(d))});this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),c=!0);this.notifyChange("updating");c&&(this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())};b.prototype.getRenderTargetTexture=function(a){return(a=this._renderTargets[a])?a.colorTexture:null};b.prototype.addGeometries=function(a,c,e){for(var d=0;d<a.length;d++){var b=a[d];null==b.origin&&(b.origin=this._localOrigins.getOrigin(b.center));
b.uniqueName||(b.uniqueName="ov:"+this._uniqueIdx++);this._geometries.set(b.uniqueName,b)}this.ensureLayerRenderer(c).add(a);2===e&&this.notifyGraphicUpdate(a,c,2)};b.prototype.removeGeometries=function(a,c,e){for(var d=0;d<a.length;d++)this._geometries.delete(a[d].uniqueName);(d=this._layerRenderers.get(c))?(d.remove(a),2===e&&this.notifyGraphicUpdate(a,c,2)):z.warn("Attempted to remove geometry for nonexistent layer")};b.prototype.updateGeometries=function(a,c,e){var d=this._layerRenderers.get(c);
d?(d.modify(a,e),this.notifyUpdateGeometries(a,c,e)):z.warn("Attempted to update geometry for nonexistent layer")};b.prototype.notifyUpdateGeometries=function(a,c,e){this.notifyGraphicUpdate(a,c,4===e||2===e?2:1===e?1:0)};b.prototype.notifyGraphicUpdate=function(a,c,e){if(0!==e)for(var d=-1,b=0;b<a.length;b++){var k=a[b].data.graphicUid;k!==d&&(c.notifyGraphicUpdate(k,e),d=k)}};b.prototype.updateHighlights=function(a,c){(c=this._layerRenderers.get(c))?c.modify(a,8):z.warn("Attempted to update highlights for nonexistent layer")};
b.prototype.isEmpty=function(){return 0===this._geometries.size&&!C.OVERLAY_DRAW_DEBUG_TEXTURE};Object.defineProperty(b.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hasWater",{get:function(){return this._hasWater},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"rendersOccluded",{get:function(){return this._rendersOccluded},enumerable:!0,configurable:!0});b.prototype.updateLogic=function(a){var c=
!1;this._layerRenderers.forEach(function(e){e.updateLogic(a)&&(c=!0)});return c};b.prototype.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0};b.prototype.draw=function(a,c){return this.drawPass(0,a,c)};b.prototype.drawWithoutRasterImage=function(a,c){return this.drawPass(0,a,c,2)};b.prototype.drawNormals=function(a,c){return this.drawPass(2,a,c)};b.prototype.drawHighlights=function(a,c){return this.drawPass(4,a,c)};b.prototype.drawOccluded=function(a,c){return this.drawPass(0,a,c,1)};
b.prototype.drawPass=function(a,c,e,d){var b=this;void 0===d&&(d=0);if(0===e.numViews)return!1;this._pixelRatio=e.pixelRatio*Math.abs(e.views[0].extent[2]-e.views[0].extent[0])/Math.abs(e.views[0].viewport[2]-e.views[0].viewport[0]);if(this.isEmpty()||4===a&&!this.hasHighlights||2===a&&!this.hasWater||!this.hasNonZeroSizedView(e))return!1;var k=e.width,h=e.height,q=this._renderTargets[c];if(!q)return!1;q.resize(k,h);var g=this._rctx,l=r;l.pixelRatio=e.pixelRatio||1;this._renderContext.pass=a;this._bindParameters.pixelRatio=
l.pixelRatio;g.bindFramebuffer(q);g.setClearColor(0,0,0,0);g.clearSafe(16384);this.updateLightingUniforms();1===d&&(this._renderContext.renderOccludedMask=m.overlayRenderOccludedFlag);if(C.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==d)for(c=0;c<e.numViews;c++)this.setViewParameters(e.views[c],l),this.drawDebugTexture(k,h,G[e.index%G.length]);0<this._layerRenderers.size&&this._sortedLayerRenderers.forEach(function(c){var f=c.layerView;c=c.renderer;if(2!==d||!n.isSome(f)||0!==f.drapeSourceType){var m=n.isSome(f)&&
n.isSome(f.fullOpacity)&&1>f.fullOpacity&&0===a;m&&(b.bindTemporaryFramebuffer(k,h),g.clearSafe(16384));for(var p=0;p<e.numViews;p++)b.setViewParameters(e.views[p],l),c.draw(b._renderContext,b._bindParameters,b._stats);m&&(g.bindFramebuffer(q),b._compositingHelper.composite(b.temporaryTexture,2,n.unwrap(n.unwrap(f).fullOpacity)))}});g.bindFramebuffer(null);q.colorTexture.descriptor.hasMipmap&&q.colorTexture.generateMipmap();this._renderContext.resetRenderOccludedMask();return!0};b.prototype.createRenderTarget=
function(a,c){for(var e=a,b=0;this._renderTargets[e];)e=a+"_"+ ++b;this._renderTargets[e]=new Z(this._rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:c,maxAnisotropy:8,width:0,height:0});return e};b.prototype.disposeRenderTargetMemory=function(a){(a=this._renderTargets[a])&&a.resize(0,0)};b.prototype.bindTemporaryFramebuffer=function(a,c){n.isNone(this._temporaryRenderTargetId)&&(this._temporaryRenderTargetId=this.createRenderTarget("temp",
!1));var e=this._renderTargets[this._temporaryRenderTargetId];e.resize(a,c);this._rctx.bindFramebuffer(e)};Object.defineProperty(b.prototype,"temporaryTexture",{get:function(){return this._renderTargets[n.unwrap(this._temporaryRenderTargetId)].colorTexture},enumerable:!0,configurable:!0});b.prototype.getGpuMemoryUsage=function(){var a=0,c;for(c in this._renderTargets)a+=F.getGpuMemoryUsage(this._renderTargets[c]);return a};b.prototype.getStats=function(){return this._stats.getAggregatedStats()};b.prototype.hotReloadShaders=
function(){return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,function(a){switch(a.label){case 0:return[4,this._shaderTechniqueRepository.hotReload()];case 1:return a.sent(),[2]}})})};b.prototype.intersect=function(a,c,e){var b=this,f=0;this._geometries.forEach(function(d){if(!e||e(d)){b.intersectRenderGeometry(d,c,0,a,f);var h=b.longitudeCyclical;h&&(d.center[0]-d.bsRadius<h.min&&b.intersectRenderGeometry(d,c,h.range,a,f),d.center[0]+d.bsRadius>h.max&&b.intersectRenderGeometry(d,
c,-h.range,a,f));f++}})};b.prototype.intersectRenderGeometry=function(a,c,e,b,f){var d=this,h=0;n.isSome(a.transformation)&&(e+=a.transformation[12],h=a.transformation[13]);v[0]=c[0]-e;v[1]=c[1]-h;v[2]=1;w[0]=c[0]-e;w[1]=c[1]-h;w[2]=0;a.pixelRatio=this._pixelRatio;a.material.intersect(a,null,a.getShaderTransformation(),b,v,w,function(c,e,h){d.addIntersectionResult(h,a.material.renderPriority,f,b,a.data.layerUid,a.data.graphicUid)},a.calculateShaderTransformation,!0)};b.prototype.addIntersectionResult=
function(a,c,b,d,f,k){var e={type:"external",metadata:{layerUid:f,graphicUid:k}};f=function(f){f.set(e,null,d.results.ground.dist,d.results.ground.normal,d.results.ground.transformation,c,null,null,a,b);f.intersector="OverlayRenderer"};(null==d.results.min.drapedLayerOrder||c>=d.results.min.drapedLayerOrder)&&(null==d.results.min.dist||d.results.ground.dist<=d.results.min.dist)&&f(d.results.min);0!==d.options.store&&(null==d.results.max.drapedLayerOrder||c<d.results.max.drapedLayerOrder)&&(null==
d.results.max.dist||d.results.ground.dist>d.results.max.dist)&&f(d.results.max);2===d.options.store&&(k=new S.IntersectorResult(d.ray),f(k),d.results.all.push(k))};b.prototype.stopAnimationsAtTime=function(a){this._sortedLayerRenderers.forEach(function(c){return c.renderer.stopAnimationsAtTime(a)})};b.prototype.ensureLayerRenderer=function(a){var c=this,b=this._layerRenderers.get(a);b||(b=new V.SortedRenderGeometryRenderer({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(a,
b),this._sortedLayerRenderersDirty=!0,this._handles.add([a.watch("fullOpacity",function(){return c.emitContentChanged()}),B.init(b,"updating",function(){return c.notifyChange("updating")})],a));return b};b.prototype.updateSortedLayerRenderers=function(){var a=this;if(this._sortedLayerRenderersDirty&&(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var c=l.firstKeyOfMap(this._layerRenderers).view.allLayerViews,b=M.SetFromValues(l.valuesOfMap(this._layerRenderers));
c.forEach(function(c){var e=a._layerRenderers.get(c);e&&(a._sortedLayerRenderers.push(new H(c,e)),b.delete(e))});b.forEach(function(c){a._sortedLayerRenderers.push(new H(null,c))})}};b.prototype.setViewParameters=function(a,c){c.viewport=a.viewport;var b=a.extent;x.mat4.ortho(c.projectionMatrix,0,b[2]-b[0],0,b[3]-b[1],c.near,c.far);x.mat4.identity(c.viewMatrix);x.mat4.translate(c.viewMatrix,c.viewMatrix,[-a.extent[0],-a.extent[1],0]);c.setGLViewport(this._rctx);this._renderContext.camera=c;this._bindParameters.view=
c.viewMatrix;this._bindParameters.proj=c.projectionMatrix;this._bindParameters.viewInvTransp=c.viewInverseTransposeMatrix;this._bindParameters.viewport=c.fullViewport;this._shaderTechniqueRepository.getProgramsUsingUniform("proj").forEach(function(a){a.setUniformMatrix4fv("proj",c.projectionMatrix)})};b.prototype.updateLightingUniforms=function(){var a=this;this._shaderTechniqueRepository.getProgramsUsingUniform("lightingMainDirection").forEach(function(c){a._lighting.setUniforms(c)})};b.prototype.hasNonZeroSizedView=
function(a){for(var c=0;c<a.numViews;c++){var b=a.views[c];if(b.extent[0]!==b.extent[2]&&b.extent[1]!==b.extent[3])return!0}return!1};b.prototype.emitContentChanged=function(){if(this.onContentChanged)this.onContentChanged()};b.prototype.updateHasWater=function(){var a=l.someMap(this._layerRenderers,function(a){return a.hasWater});a!==this._hasWater&&(this._hasWater=a)};b.prototype.updateHasHighlights=function(){var a=l.someMap(this._layerRenderers,function(a){return a.hasHighlights});if(a!==this._hasHighlights&&
(this._hasHighlights=a,this.onHasHighlightsChanged))this.onHasHighlightsChanged(this._hasHighlights)};b.prototype.updateRendersOccluded=function(){var a=l.someMap(this._layerRenderers,function(a){return a.rendersOccluded});if(a!==this._rendersOccluded&&(this._rendersOccluded=a,this.onRendersOccludedChanged))this.onRendersOccludedChanged(this.rendersOccluded)};b.prototype.drawDebugTexture=function(a,c,b){var d=this._rctx;this.ensureDebugPatternResources(a,c);a=this._debugPatternProgram;d.bindProgram(a);
d.setPipelineState(this._debugPatternPipelineState);a.setUniform4f("color",b[0],b[1],b[2],1);a.setUniform1i("tex",0);d.bindTexture(this._debugPatternTexture,0);d.bindVAO(this._quadVAO);d.drawArrays(5,0,F.vertexCount(this._quadVAO,"geometry"))};b.prototype.ensureDebugPatternResources=function(a,b){if(!this._debugPatternTexture){for(var c=new Uint8Array(a*b*4),d=0,f=0;f<b;f++)for(var k=0;k<a;k++){var h=Math.floor(k/10),g=Math.floor(f/10);2>h||2>g||10*h>a-20||10*g>b-20?(c[d++]=255,c[d++]=255,c[d++]=
255,c[d++]=255):(c[d++]=255,c[d++]=255,c[d++]=255,h&1&&g&1?c[d++]=k&1^f&1?0:255:c[d++]=h&1^g&1?0:128)}this._debugPatternTexture=new aa(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:a,height:b},c);a=new E.TextureTechniqueConfiguration;a.hasAlpha=!0;this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(E.TextureTechnique,a,this._debugTextureTechnique);this._debugPatternProgram=this._debugTextureTechnique.program;this._debugPatternPipelineState=
this._debugTextureTechnique.pipeline;this._quadVAO=D.createQuadVAO(this._rctx)}};Object.defineProperty(b.prototype,"test",{get:function(){return{layerRenderers:this._layerRenderers}},enumerable:!0,configurable:!0});g.__decorate([u.autoDispose()],b.prototype,"_shaderTechniqueRepository",void 0);g.__decorate([u.autoDispose()],b.prototype,"_stippleTextureRepository",void 0);g.__decorate([t.property(),u.autoDispose()],b.prototype,"waterTextureRepository",void 0);g.__decorate([t.property()],b.prototype,
"renderView",void 0);g.__decorate([t.property({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating"]})],b.prototype,"updating",null);return b=g.__decorate([t.subclass("esri.views.3d.terrain.OverlayRenderer")],b)}(u.AutoDisposableMixin(I));m.OverlayRenderer=A;var H=function(){return function(g,b){this.layerView=g;this.renderer=b}}(),G=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],r=new P.default;r.near=1;r.far=1E4;var v=y.vec3f64.create(),w=y.vec3f64.create();m.DRAPED_Z=-2;m.overlayRenderOccludedFlag=
4});