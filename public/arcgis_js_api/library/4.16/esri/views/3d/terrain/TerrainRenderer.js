// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Color ../../../core/Accessor ../../../core/compilerUtils ../../../core/maybe ../../../core/ObjectPool ../../../core/PooledArray ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingBox ../support/imageUtils ../support/buffer/BufferView ./OverlayRenderer ./PatchGeometryFactory ./PatchRenderData ./TileRenderer ./tileUtils ../webgl-engine/core/shaderLibrary/Slice.glsl ../webgl-engine/core/shaderLibrary/shading/ScreenSpaceReflections.glsl ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/intersectorUtils ../webgl-engine/lib/screenSizePerspectiveUtils ../webgl-engine/lib/tracer ../webgl-engine/materials/internal/MaterialUtil ../webgl-engine/shaders/TerrainTechnique".split(" "),
function(m,oa,h,W,X,Y,E,O,y,n,Z,P,aa,r,u,Q,v,I,ba,ca,R,S,da,ea,A,fa,ga,ha,J,ia,K,L,M){function T(h,b,a){Q.vec4.set(a,h[0]*b[2]+b[0],h[1]*b[3]+b[1],h[2]*b[2],h[3]*b[3])}var N=aa.vec2f64.create(),F=I.create(),p=v.vec4f64.create(),w=v.vec4f64.create(),C=v.vec4f64.create(),ja=function(){return function(){this.extent=v.vec4f64.create();this.maxLevel=this.minLevel=0;this.callback=null}}();m=function(m){function b(a){a=m.call(this,a)||this;a.type="Terrain";a.isGround=!0;a.tileSize=256;a.rctx=null;a._isTransparent=
!1;a.renderDataPool=new O(da.PatchRenderData);a.patchGroups=new y({allocator:function(a){return a||{root:null,origin:null,patches:new y}},deallocator:function(a){a.root=null;a.origin=null;a.patches.clear();return a}});a.patchGroupsDirty=!0;a.patchGroupsMap=new Map;a.tileIterator=new A.IteratorPreorder;a.highestVisibleLODTile=null;a.visible=!0;a._opaque=!0;a._skirtScale=1;a._velvetOverground=!0;a.castShadows=!0;a._ssrEnabled=!1;a.emptyTex=null;a.tileRenderer=null;a.tileBackgroundInitialized=!1;a.tileBackgroundUpdating=
!1;a.stencilEnabledLayerExtents=[];a.numTrianglesRendered=0;a.numTilesRendered=0;a.numTilesCulled=0;a.numOriginsRendered=0;a.clippingExtent=null;a.needsHighlight=!1;a.renderOccludedFlags=1;a.visibleScaleRangeQueries=new y({initialSize:10});a.visibleScaleRangeQueriesInvPtr=0;a.visibleScaleRangeQueryQueue=new y({initialSize:30});a.visibleScaleRangeQueryPool=new O(ja);return a}h.__extends(b,m);b.prototype.destroy=function(){S.clearCaches()};b.prototype.install=function(a){a.addRenderPlugin([2,7,9],this)};
b.prototype.uninstall=function(a){a.removeRenderPlugin(this)};Object.defineProperty(b.prototype,"updating",{get:function(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"canRender",{get:function(){return this.visible&&!!this.rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"renderingDisabled",{set:function(a){this._set("renderingDisabled",
!!a);this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"opaque",{get:function(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled},set:function(a){this._opaque!==a&&(this._opaque=a,this.setNeedsRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"needsLinearDepth",{get:function(){return this.overlayRenderer.hasWater},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isTransparent",{get:function(){return this._isTransparent},
set:function(a){this._isTransparent!==a&&(this._isTransparent=a,this.setNeedsRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"skirtScale",{get:function(){return this._skirtScale},set:function(a){a!==this._skirtScale&&(this._skirtScale=a,this.setNeedsRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"renderPatchBorders",{get:function(){return!!this.shaderTechniqueConfig.tileBorders},set:function(a){this.shaderTechniqueConfig.tileBorders!==a&&
(this.shaderTechniqueConfig.tileBorders=a,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"cullBackFaces",{get:function(){return this.shaderTechniqueConfig.backfaceCullingEnabled},set:function(a){this.shaderTechniqueConfig.backfaceCullingEnabled!==a&&(this.shaderTechniqueConfig.backfaceCullingEnabled=a,this.notifyChange("cullBackFaces"),this.setNeedsRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"renderOrder",{set:function(a){this._set("renderOrder",a);this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"velvetOverground",{set:function(a){this._velvetOverground!==a&&(this._velvetOverground=a,this.setNeedsRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"intersectionHandlerId",{get:function(){return J.TERRAIN_ID},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"slicePlane",{get:function(){return this.shaderTechniqueConfig.slicePlaneEnabled},
set:function(a){this.shaderTechniqueConfig.slicePlaneEnabled!==a&&(this.shaderTechniqueConfig.slicePlaneEnabled=a,this.setNeedsRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"textureFadingEnabled",{set:function(a){this.shaderTechniqueConfig.textureFadingEnabled!==a&&(this.shaderTechniqueConfig.textureFadingEnabled=a,this.setNeedsRender())},enumerable:!0,configurable:!0});b.prototype.setDebugScreenSizePerspective=function(a){this.shaderTechniqueConfig.screenSizePerspective!==
a&&(this.shaderTechniqueConfig.screenSizePerspective=a,this.setNeedsRender())};b.prototype.setRootTiles=function(a){this.rootTiles=a;this.setNeedsRender()};b.prototype.setNeedsHighlight=function(a){this.needsHighlight=a;this.setNeedsRender()};b.prototype.setRenderOccludedOverlay=function(a){this.renderOccludedFlags=a?R.overlayRenderOccludedFlag:1;this.setNeedsRender()};b.prototype.setStencilEnabledLayerExtents=function(a){this.stencilEnabledLayerExtents=a;this.setNeedsRender()};b.prototype.setTileSize=
function(a){this.tileSize=a;this.tileRenderer&&(this.tileRenderer.tileSize=a);this.setNeedsRender()};b.prototype.loadTile=function(a){a.renderData||(a.renderData=this.renderDataPool.acquire(),a.renderData.init(a),a.renderData.localOrigin=this._getLocalOriginOfTile(a));this.updateTileGeometry(a);this.updateTileTexture(a)};b.prototype.queryVisibleLevelRange=function(a,c,b,f){var d=this.visibleScaleRangeQueryPool.acquire();Q.vec4.copy(d.extent,a);d.minLevel=c?c:-Number.MAX_VALUE;d.maxLevel=null!=b?b:
Number.MAX_VALUE;d.callback=f;this.visibleScaleRangeQueryQueue.push(d);this.setNeedsRender()};b.prototype.updateTileTexture=function(a){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(a),this.setNeedsRender(),a.resetPendingUpdate(64))};b.prototype.updateTileGeometry=function(a){for(var c=0,b=a.layerInfo[0];c<b.length;c++)b[c].pendingUpdates&=-33;a.resetPendingUpdate(32);a.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()};b.prototype.unloadTile=
function(a){a.renderData&&(this.releaseTileGeometry(a.renderData),a.renderData.clear(),a.renderData=null,a.setMemoryDirty(),this.setNeedsRender())};b.prototype._getLocalOriginOfTile=function(a){var c=Math.max(0,7*Math.floor((a.lij[0]-3)/7));if("spherical"===this.manifold&&0===c)return u.vec3f64.ZEROS;for(;a.parent&&a.lij[0]>c;)a=a.parent;return a.centerAtSeaLevel};b.prototype.setVisibility=function(a){this.visible=a;this.setNeedsRender()};b.prototype.getStats=function(){return{numTilesRendered:this.numTilesRendered,
numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}};Object.defineProperty(b.prototype,"wireframe",{set:function(a){var c=this;this._get("wireframe")!==a&&(this._set("wireframe",a),this.rootTiles&&(A.traverseTilesPreorder(this.rootTiles,function(b){b.renderData&&b.renderData.updateGeometry(c.rctx,a)}),this.setNeedsRender()))},enumerable:!0,configurable:!0});b.prototype.setNeedsRender=function(a){void 0===a&&(a=1);this.patchGroupsDirty=
!0;this.initContext.requestRender(a)};b.prototype.setTileBackground=function(a){this.tileBackground=a;this._updateTileBackground()};b.prototype.initializeRenderContext=function(a){this.initContext=a;this.rctx=a.rctx;this.shaderTechniques=a.shaderTechniqueRep;this.shaderTechniqueConfig=new M.TerrainTechniqueConfiguration;this.tileRenderer=new ea(this.rctx,this.tileSize,this.shaderTechniques);this.tileBackground&&this._updateTileBackground();this.emptyTex=ha.createEmptyTexture(this.rctx)};b.prototype.uninitializeRenderContext=
function(){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null);this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)};b.prototype.intersect=function(a,c,b,f){if(this.rootTiles&&(!a.options.selectOpaqueTerrainOnly||!a.options.selectionMode||this._opaque)){var d=ka,e=la;r.vec3.subtract(d,f,b);r.vec3.set(e,1/d[0],1/d[1],1/d[2]);var x=a.results.min,k=a.results.max,h=a.results.ground,n=0===a.options.store,u=!!a.results.ground.target,q=null,U=this.clippingExtent,l=this.tileIterator;
l.reset(this.rootTiles);for(var t=J.getVerticalOffsetTerrain(a.verticalOffset),m=function(){var g=l.next();if(null===g.renderData||u&&v._useStencilForTile(g))return"continue";if(a.options.invisibleTerrain){if(!g.visible&&U&&!g.intersectsExtent(U))return"continue"}else if(!g.visible)return"continue";var z=g.renderData.geometryInfo,m=g.renderData.localOrigin,B=-v._skirtScale*z.skirtLength;I.set(F,z.boundingBox);E.isSome(t)&&(t.localOrigin=m,t.applyToAABB(F));if(0!==B){var D=g.up;I.expandWithOffset(F,
B*D[0],B*D[1],B*D[2])}r.vec3.subtract(G,b,m);if(!L.intersectAabbInvDirBefore(F,G,e,a.tolerance,n&&null!=x.dist?x.dist:Infinity))return"continue";var p=function(a,c,b,d){a.set(void 0,A.tile2str(c),b,d,P.mat4f64.IDENTITY,void 0);a.intersector=ma;a.target={type:"external",metadata:{tile:c}}},D=function(e,l){0<=e&&(a.options.backfacesTerrain||0>r.vec3.dot(l,d))&&(a.options.invisibleTerrain||!a.options.selectionMode||null==c||c(b,f,e))&&((null==h.dist||e<h.dist)&&p(h,g,e,l),a.options.storeTerrainResults&&
(2===a.options.store&&(E.isNone(q)?(q=new J.IntersectorResult(a.ray),p(q,g,e,l),a.results.all.push(q)):e<q.dist&&p(q,g,e,l)),(null==x.dist||e<x.dist)&&p(x,g,e,l),0!==a.options.store&&(null==k.dist||e>k.dist)&&p(k,g,e,l)))},w=na;r.vec3.subtract(w,f,m);var m=z.indices,y=z.vertexAttributes,C={data:y.getField("position",ca.BufferViewVec3f).typedBuffer,size:3,offsetIdx:0,strideIdx:y.stride/4},z=z.numWithoutSkirtIndices/3;L.intersectTriangles(G,w,0,z,m,C,null,t,D);0!==B&&S.intersectSkirts(G,w,z,m.length/
3,m,y,"spherical"===v.manifold?function(a){return r.vec3.scale(a,a,B/r.vec3.length(a))}:function(a){return r.vec3.set(a,0,0,B)},t,D)},v=this;!l.done;)m()}};b.prototype.render=function(a){if(9===a.slot){if(0===(a.renderOccludedMask&R.overlayRenderOccludedFlag))return!1}else if(a.slot!==(this.opaque?2:7))return!1;K.trace("# BEGIN RENDER TERRAIN");var c=a.pass,b=1===a.scenelightingData.globalFactor,f=this._updatePatchGroups();switch(c){case 0:c=a.shadowMap&&a.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==
c&&(this.shaderTechniqueConfig.receiveShadows=c);c=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==c&&(this.shaderTechniqueConfig.overlayMode=c);this._renderMaterialPass(a,0,f,9===a.slot?"occluded":"colorAndWater");break;case 3:this.castShadows&&b&&this._renderAuxiliaryPass(a,3,f,"none");break;case 1:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(a,1,f,"none");break;case 2:this._renderAuxiliaryPass(a,2,f,"none");
break;case 4:this.needsHighlight&&(this._renderAuxiliaryPass(a,4,f,"highlight"),a.rctx.clearSafe(256))}K.trace("# END RENDER TERRAIN");0!==this.visibleScaleRangeQueryQueue.length&&this.setNeedsRender();return!0};b.prototype._renderMaterialPass=function(a,c,b,f){var d=this,e=a.rctx,x=a.camera;this._ssrEnabled=a.ssrParams.ssrEnabled;this._setTerrainTechnique(c,"occluded"===f);var k=this.shaderTechnique.program;a.rctx.bindProgram(k);e.bindProgram(k);"colorAndWater"===f&&a.ssrParams&&(a.ssrParams.lastFrameColorTextureID=
9,a.ssrParams.linearDepthTextureID=8,ga.ScreenSpaceReflections.bindUniforms(k,e,a.ssrParams));a.shadowMap&&a.shadowMap.bind(k,7);a.ssaoHelper&&a.ssaoHelper.setUniforms(k,6);k.setUniform1i("tex",0);k.setUniform1i("texNext",1);this._bindOverlayUniforms(k);k.setUniformMatrix4fv("viewNormal",x.viewInverseTransposeMatrix);k.setUniformMatrix4fv("proj",x.projectionMatrix);a.scenelightingData.setUniforms(k,!0);c=x.viewMatrix;r.vec3.set(H,c[12],c[13],c[14]);r.vec3.normalize(H,H);k.setUniform3fv("viewDirection",
H);this.numOriginsRendered=this.numTrianglesRendered=this.numTilesCulled=this.numTilesRendered=0;this._prepareScaleRangeQueries();this.opaque?this._renderPatchGroups(a,k,b,f):a.offscreenRenderingHelper.renderToTargets(function(){return d._renderPatchGroups(a,k,b,f)},a.offscreenRenderingHelper.tmpColor,a.offscreenRenderingHelper.mainDepth,[0,0,0,0]);this._processScaleRangeQueries()};b.prototype._renderAuxiliaryPass=function(a,c,b,f){this._setTerrainTechnique(c,"occluded"===f);c=this.shaderTechnique.program;
a.rctx.bindProgram(c);if(4===a.pass){var d=a.offscreenRenderingHelper;a.rctx.bindTexture(d.depthTexture,6);c.setUniform1i("depthTex",6);c.setUniform4f("highlightViewportPixelSz",0,0,1/d.width,1/d.height)}else if(c.setUniformMatrix4fv("viewNormal",a.camera.viewInverseTransposeMatrix),1===a.pass||3===a.pass)N[0]=a.camera.near,N[1]=a.camera.far,c.setUniform2fv("nearFar",N);this._renderPatchGroupsAuxiliary(a,c,b,f)};b.prototype._updateTileBackground=function(){var a=this;if(this.tileRenderer){this.tileBackgroundUpdating=
!0;var c=function(){a.tileBackgroundInitialized=!0;a.tileBackgroundUpdating=!1;a.rootTiles&&A.traverseTilesPreorder(a.rootTiles,function(c){a.tileRenderer.updateTileTexture(c);a.setNeedsRender()});a.setNeedsRender()};if("string"===typeof this.tileBackground){var b=this.tileBackground;ba.requestImage(b).then(function(d){b===a.tileBackground&&a.tileRenderer&&(a.tileRenderer.setBackground(d),c())})}else{var f=this.tileBackground?W.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(f);
c()}}};b.prototype._updatePatchGroups=function(){var a=this,c=this.patchGroups;if(!this.patchGroupsDirty)return c;this.highestVisibleLODTile=null;this._renderCollectOrigins(c);if(0!==this.renderOrder){for(var b=0;b<c.length;b++)A.sortTiles(this.renderOrder,c.data[b].patches);c.sort(function(c,b){var d=a.renderOrder;c=0===c.patches.length?-d:0===b.patches.length?d:A.compareTiles(c.patches.data[0],b.patches.data[0],d);return c})}this.patchGroupsDirty=!1;return c};b.prototype._renderCollectOrigins=function(a){var c=
this.rootTiles,b="spherical"===this.manifold;a.clear();for(var f=0;f<c.length;f++){var g=c[f],e=a.pushNew();e.root=g;e.origin=b?u.vec3f64.ZEROS:g.centerAtSeaLevel;e.patches.clear();this._renderCollectOriginsForRoot(a,e)}a.filterInPlace(function(a){return 0<a.patches.length})};b.prototype._renderCollectOriginsForRoot=function(a,c){var b=this.tileIterator;b.resetOne(c.root);var f=this.patchGroupsMap;f.clear();for(f.set(c.origin,c);!b.done;){c=b.next();var g=c.renderData;if(g&&!c.visible)this.numTilesCulled++,
b.skipSubtree();else{if(0===c.lij[0]%7){var e=a.pushNew();e.root=c;e.origin=c.centerAtSeaLevel;f.set(c.centerAtSeaLevel,e);e.patches.clear()}if(!c.rendered)this.numTilesCulled++;else if(g){(e=f.get(g.localOrigin))&&e.patches.push(c);if(!this.highestVisibleLODTile||c.vlevel>this.highestVisibleLODTile.vlevel)this.highestVisibleLODTile=c;b.skipSubtree()}}}};b.prototype._scaleQueriesForTile=function(a){var c=a.extent;a=a.lij[0];for(var b=0;b<this.visibleScaleRangeQueriesInvPtr;){var f=this.visibleScaleRangeQueries.data[b],
g=f.extent;a>=f.minLevel&&a<=f.maxLevel&&g[0]<=c[2]&&g[2]>=c[0]&&g[1]<=c[3]&&g[3]>=c[1]?(this.visibleScaleRangeQueries.swapElements(b,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):b++}};b.prototype._useStencilForTile=function(a){for(var c=0,b=this.stencilEnabledLayerExtents;c<b.length;c++)if(a.intersectsExtent(b[c]))return!0;return!1};b.prototype._renderPatchGroupsAuxiliary=function(a,b,d,f){this.shaderTechnique.bindPipelineState(a.rctx);var c=0<this.stencilEnabledLayerExtents.length;
b.setUniformMatrix4fv("proj",a.camera.projectionMatrix);b.setUniform1f("skirtScale",this._skirtScale);"none"!==f&&this._bindOverlayUniforms(b);for(var e=0;e<d.length;e++){var h=d.data[e];this._bindViewForPatchGroup(b,h,a.camera.eye,a.camera.viewMatrix);for(var k=0;k<h.patches.length;k++)this._renderPatch(a.rctx,b,h.patches.data[k],4,c,f)}a.rctx.bindVAO(null)};b.prototype._renderPatchGroups=function(a,b,d,f){var c=a.rctx,e=a.camera,h=e.viewMatrix;this.shaderTechnique.bindPipelineState(c);if(this.shaderTechniqueConfig.screenSizePerspective&&
this.pointsOfInterest){var k=ia.getSettings("spherical"===this.manifold?"global":"local");k.update({distance:this.pointsOfInterest.centerOnSurfaceFrequent.distance,fovY:e.fovY});L.bindScreenSizePerspective(k,b,"screenSizePerspective")}var k=0<this.stencilEnabledLayerExtents.length,m="occluded"===f;m&&(c.bindTexture(this.emptyTex,0),b.setUniform1f("blend",1),b.setUniform4fv("texOffsetAndScale",v.vec4f64.ZEROS));b.setUniform1f("skirtScale",m?0:this._skirtScale);for(var n=this.wireframe?1:4,p=0;p<d.length;p++){var q=
d.data[p],r=q.patches;if(0!==r.length)for(this._bindViewForPatchGroup(b,q,e.eye,h),fa.Slice.bindUniforms(b,this.shaderTechnique.configuration,a.sliceHelper&&a.sliceHelper.plane,q.origin),a.shadowMap&&a.shadowMap.bindView(b,q.origin),this.numOriginsRendered++,q=0;q<r.length;q++){var l=r.data[q],t=l.renderData.textureReference;if(!E.isNone(t)){K.trace("# RENDER TILE "+A.tile2str(l)+", screenDepth:"+l.screenDepth);if(!m){this._scaleQueriesForTile(l);T(l.renderData.geometryInfo.uvOffsetAndScale,t.offsetAndScale,
C);b.setUniform4fv("texOffsetAndScale",C);c.bindTexture(t.texture.texture,0);var t=l.renderData.textureFadeFactor,u=1>t?l.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&E.isSome(u)?(T(l.renderData.geometryInfo.uvOffsetAndScale,u.offsetAndScale,C),b.setUniform1f("textureFadeFactor",t),b.setUniform4fv("nextTexOffsetAndScale",C),c.bindTexture(u.texture.texture,1)):(b.setUniform1f("textureFadeFactor",1),c.bindTexture(this.emptyTex,1));l.renderData.textureIsFading&&
this.setNeedsRender();b.setUniform1f("opacity",l.renderData.opacity)}t=this._renderPatch(c,b,l,n,k,f);l.renderOrder=this.numTilesRendered;this.numTilesRendered++;this.numTrianglesRendered+=t/3}}}c.bindVAO(null)};b.prototype._renderPatch=function(a,b,d,f,g,e){"none"!==e&&(this._bindOverlayTextures(b,d.renderData.overlays,e),b.setUniform1f("overlayOpacity",d.renderData.overlayOpacity));g&&(this._useStencilForTile(d)?this.stencilShaderTechnique.bindPipelineState(a):this.shaderTechnique.bindPipelineState(a));
g=0===this._skirtScale?d.renderData.geometryInfo.numWithoutSkirtIndices:d.renderData.vao.indexBuffer.size;a.bindVAO(d.renderData.vao);b.assertCompatibleVertexAttributeLocations(d.renderData.vao);a.drawElements(f,g,d.renderData.vao.indexBuffer.indexType,0);return g};b.prototype._bindViewForPatchGroup=function(a,b,d,f){a.setUniform3fv("origin",b.origin);Z.mat4.translate(V,f,b.origin);a.setUniformMatrix4fv("view",V);a.setUniform3f("camPos",d[0]-b.origin[0],d[1]-b.origin[1],d[2]-b.origin[2])};b.prototype._bindOverlayUniforms=
function(a){a.setUniform1i("ovInnerColorTex",2);a.setUniform1i("ovOuterColorTex",3);a.setUniform1i("ovInnerWaterTex",4);a.setUniform1i("ovOuterWaterTex",5)};b.prototype._bindOverlayTextures=function(a,b,d){for(var c=0;2>c;c++){var g=2*c,e=b[c],h=void 0,k=void 0;switch(d){case "colorAndWater":h=e.renderTargetIds.color;k=e.renderTargetIds.water;break;case "highlight":h=e.renderTargetIds.highlight;break;case "occluded":h=e.renderTargetIds.occluded;break;case "none":break;default:Y.neverReached(d)}h?
(p[g]=e.texOffset[0],p[g+1]=e.texOffset[1],w[g]=e.texScale[0],w[g+1]=e.texScale[1],g=this.overlayRenderer.getRenderTargetTexture(h),this.rctx.bindTexture(g,2+c),k?(k=this.overlayRenderer.getRenderTargetTexture(k),this.rctx.bindTexture(k,4+c)):this.rctx.bindTexture(this.emptyTex,4+c)):(p[g]=0,p[g+1]=0,w[g]=0,w[g+1]=0,this.rctx.bindTexture(this.emptyTex,2+c),this.rctx.bindTexture(this.emptyTex,4+c))}a.setUniform4fv("overlayTexOffset",p);a.setUniform4fv("overlayTexScale",w)};b.prototype._setTerrainTechnique=
function(a,b){this.shaderTechniqueConfig.output=a;0===a&&(this.shaderTechniqueConfig.atmosphere="spherical"===this.manifold&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled);this.shaderTechniqueConfig.renderOccluded=b;this.shaderTechniqueConfig.stencilEnabled=!1;this.shaderTechnique=this.shaderTechniques.acquireAndReleaseExisting(M.TerrainTechnique,this.shaderTechniqueConfig,this.shaderTechnique);this.shaderTechniqueConfig.stencilEnabled=!0;this.stencilShaderTechnique=
this.shaderTechniques.acquireAndReleaseExisting(M.TerrainTechnique,this.shaderTechniqueConfig,this.stencilShaderTechnique)};b.prototype.releaseTileGeometry=function(a){a.releaseGeometry()&&this.setNeedsRender();this.renderDataPool.release(a)};b.prototype._prepareScaleRangeQueries=function(){for(var a=this.visibleScaleRangeQueries,b=this.visibleScaleRangeQueryQueue;a.length<a.data.length&&0<b.length;){var d=b.pop();a.push(d)}this.visibleScaleRangeQueriesInvPtr=a.length};b.prototype._processScaleRangeQueries=
function(){for(var a=this.visibleScaleRangeQueries,b=this.visibleScaleRangeQueryPool,d=0;d<a.length;d++){var f=a.data[d];b.release(f);f.callback(d>=this.visibleScaleRangeQueriesInvPtr);f.callback=null}a.clear()};Object.defineProperty(b.prototype,"test",{get:function(){return{tileRenderer:this.tileRenderer}},enumerable:!0,configurable:!0});h.__decorate([n.property()],b.prototype,"tileBackgroundInitialized",void 0);h.__decorate([n.property()],b.prototype,"tileBackgroundUpdating",void 0);h.__decorate([n.property({constructOnly:!0})],
b.prototype,"manifold",void 0);h.__decorate([n.property({constructOnly:!0})],b.prototype,"overlayRenderer",void 0);h.__decorate([n.property({readOnly:!0,dependsOn:["tileBackgroundInitialized","tileBackgroundUpdating"]})],b.prototype,"updating",null);h.__decorate([n.property({value:!1})],b.prototype,"renderingDisabled",null);h.__decorate([n.property()],b.prototype,"renderPatchBorders",null);h.__decorate([n.property()],b.prototype,"cullBackFaces",null);h.__decorate([n.property({value:1})],b.prototype,
"renderOrder",null);h.__decorate([n.property()],b.prototype,"wireframe",null);return b=h.__decorate([n.subclass("esri.views.3d.terrain.TerrainRenderer")],b)}(X);var V=P.mat4f64.create(),H=u.vec3f64.create(),ka=u.vec3f64.create(),la=u.vec3f64.create(),G=u.vec3f64.create(),na=u.vec3f64.create(),ma="TerrainRenderer";return m});