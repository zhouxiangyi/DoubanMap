// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Camera ../../../geometry ../../../Graphic ../../../Viewpoint ../../../core/asyncUtils ../../../core/compilerUtils ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/libs/gl-matrix-2/mat3 ../../../core/libs/gl-matrix-2/mat3f64 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/webMercatorUtils ../camera/intersectionUtils ./cameraUtils ./ElevationProvider ./geometryUtils ./mathUtils ./projectionUtils".split(" "),
function(ua,w,f,O,x,fa,I,W,ga,P,ha,ia,X,ja,ka,l,F,r,Y,z,H,m,Z,la,aa,y){function Q(a){return 360-aa.cyclicalDeg.normalize(a)}function D(a){return aa.cyclicalDeg.normalize(360-a)}function C(a,b){a&&a.resolver&&(null==b?a.resolver.reject():a.resolver.resolve(b));return b}function ba(a,b,c,e){if(!b)return C(e);var d=a.spatialReference||x.SpatialReference.WGS84;if(b.camera){a=b.get("camera.position.spatialReference");if(!z.canProject(a,d))return C(e);b=b.camera.clone();a.equals(d)||(b.position=z.project(b.position,
d));return C(e,b)}var h=b.get("targetGeometry.spatialReference");if(h&&!z.canProject(h,d))return C(e);d=m.internalToExternal(a,a.state.camera);h=1;null!=b.rotation&&(d.heading=Q(b.rotation),h=0);null!=c&&(d.tilt=c);if("point"===b.targetGeometry.type){c=b.targetGeometry;var g=void 0,p=b.targetGeometry.clone(),g=null!=b.scale?m.scaleToDistance(a,b.scale,c.latitude):a.state.camera.distance;return m.fromCenterDistance(a,p,g,d,h,e)}return m.fromExtent(a,b.targetGeometry.extent,d.heading,d.tilt,h,e)}function R(a,
b){return null==b.scale&&null!=b.zoom?m.zoomToScale(a,b.zoom):b.scale}function S(a,b){var c=!1;null!=b.heading?(a.heading=b.heading,c=!0):null!=b.rotation&&(a.heading=Q(b.rotation),c=!0);null!=b.tilt&&(a.tilt=b.tilt,c=!0);null!=b.fov&&(a.fov=b.fov);return c}function J(a,b,c){var e=a.spatialReference||x.SpatialReference.WGS84;b=b||m.externalToInternal(a,c.camera);c.targetGeometry=y.vectorToPoint(b.center,a.renderSpatialReference,e);c.scale=m.computeScale(a,b);c.rotation=D(c.camera.heading);return c}
function K(a,b,c){if(b){if(!z.canProject(b.spatialReference,a.spatialReference))throw new P("viewpointutils:incompatible-spatialreference","Spatial reference ("+(b.spatialReference?b.spatialReference.wkid:"unknown")+") is incompatible with the view ("+a.spatialReference.wkid+")",{geometry:b});var e=[];if(!b.hasZ&&a.basemapTerrain){var d=void 0;switch(b.type){case "point":d=b;break;case "multipoint":case "polyline":case "mesh":d=b.extent.center;break;case "extent":d=b.center;break;case "polygon":d=
b.centroid;break;default:ga.neverReached(b)}d&&z.canProject(d,a.basemapTerrain.spatialReference)?k[2]=Z.getElevationAtPoint(a.elevationProvider,d)||0:k[2]=0}(0,ma[b.type])(b,function(a){e.push(a[0],a[1],a[2])},k);var h=e.length/3;if(0!==h&&(d=Array(e.length),y.bufferToBuffer(e,b.spatialReference,0,d,a.spatialReference,0,h)))for(b.hasZ&&(c.hasZ=!0),a=0;a<d.length;a+=3)b.hasZ?(k[0]=d[a+0],k[1]=d[a+1],k[2]=d[a+2]):(k[0]=d[a+0],k[1]=d[a+1]),r.expand(c.boundingBox,k)}}function na(a,b,c,e){return f.__awaiter(this,
void 0,void 0,function(){var d,h,g,p,m,k;return f.__generator(this,function(l){switch(l.label){case 0:return[4,W.result(a.whenViewForGraphic(b))];case 1:d=l.sent();if(!1===d.ok||ha.isNone(d.value)||!("whenGraphicBounds"in d.value))return K(a,b.geometry,e),[2];h=d.value;return[4,W.result(h.whenGraphicBounds(b,{minDemResolution:c}))];case 2:g=l.sent();if(!1===g.ok)return K(a,b.geometry,e),[2];p=g.value;m=p.screenSpaceObjects;k=p.boundingBox;r.expand(e.boundingBox,k);m&&m.forEach(function(a){e.screenSpaceObjects.push(a)});
isFinite(k[2])&&(e.hasZ=!0);return[2]}})})}function ca(a,b,c,e){return f.__awaiter(this,void 0,void 0,function(){var d,h;return f.__generator(this,function(g){switch(g.label){case 0:return Array.isArray(b)&&2===b.length&&(d=b[0],h=b[1],"number"===typeof d&&"number"===typeof h)?(n.x=d,n.y=h,n.z=void 0,n.spatialReference=a.spatialReference.isGeographic?a.spatialReference:x.SpatialReference.WGS84,K(a,n,e),[2]):b&&"function"===typeof b.map?[4,ia.eachAlways(b.map(function(b){return ca(a,b,c,e)}))]:[3,
2];case 1:return g.sent(),[2];case 2:if(!(b instanceof x.BaseGeometry))return[3,3];K(a,b,e);return[3,5];case 3:return b instanceof fa?[4,na(a,b,c,e)]:[3,5];case 4:g.sent(),g.label=5;case 5:return[2]}})})}function oa(a,b,c,e,d){return f.__awaiter(this,void 0,void 0,function(){var h,g,k;return f.__generator(this,function(l){switch(l.label){case 0:if(b.camera)return[2,da(a,b.camera,d)];d.scale=b.scale;d.rotation=b.rotation;d.targetGeometry=b.targetGeometry?b.targetGeometry.clone():null;d.camera=null;
null!=c.heading?d.rotation=D(c.heading):null!=c.rotation&&(d.rotation=c.rotation);h=R(a,c);null!=h&&(d.scale=h);g=m.createAsyncContext(e);ba(a,d,c.tilt,g);k=d;return[4,g.resolver.promise];case 1:return k.camera=l.sent(),[2,d]}})})}function da(a,b,c){c.camera=b.clone();c.camera.fov=a.camera.fov;b=a.spatialReference;var e=c.camera.position.spatialReference;if(!z.canProject(e,b))return null;e.equals(b)||(c.camera.position=z.project(c.camera.position,b));return J(a,null,c)}function T(a,b,c,e,d){return f.__awaiter(this,
void 0,void 0,function(){var h,g,p,n,r,t;return f.__generator(this,function(f){switch(f.label){case 0:if(!c)throw new P("createfromcenter","invalid point");d.targetGeometry=c.clone();h=H.cameraOnContentAlongViewDirection(a);if(b.position){f=d.targetGeometry;var pa=h,u=a.renderSpatialReference;y.pointToVector(b.position,L,u);y.pointToVector(f,U,u);d.targetGeometry=new x.Point(f);d.camera.position=new x.Point(b.position);l.vec3.subtract(M,U,L);m.directionToHeadingTilt(a,L,M,pa.up,d.camera);d.scale=
m.distanceToScale(a,l.vec3.distance(L,U),d.targetGeometry.latitude);d.rotation=D(d.camera.heading);return[2,d]}b.zoomFactor&&(g=h.distance/b.zoomFactor,p=l.vec3.scale(k,h.viewForward,-g),l.vec3.add(h.eye,h.center,p),h.markViewDirty(),d.scale=m.distanceToScale(a,g,c.latitude));m.internalToExternal(a,h,d.camera);n=S(d.camera,b)?0:1;if(b.zoomFactor)return[3,2];d.scale=R(a,b);null==d.scale&&(y.pointToVector(c,k,a.renderSpatialReference),la.frustum.intersectsPoint(h.frustum.planes,k)?d.scale=m.distanceToScale(a,
l.vec3.distance(h.eye,k),c.latitude):d.scale=m.computeScale(a,h));r=m.createAsyncContext(e);m.fromCenterScale(a,d.targetGeometry,d.scale,d.camera,n,r);t=d;return[4,r.resolver.promise];case 1:t.camera=f.sent(),f.label=2;case 2:return[2,d]}})})}function qa(a,b,c,e){return f.__awaiter(this,void 0,void 0,function(){var d,h;return f.__generator(this,function(g){d=H.cameraOnContentAlongViewDirection(a);h=y.vectorToPoint(d.center,a.renderSpatialReference,n,a.spatialReference);return[2,T(a,b,h,c,e)]})})}
function ra(a,b,c,e,d){return f.__awaiter(this,void 0,void 0,function(){var h,g,k,l;return f.__generator(this,function(f){switch(f.label){case 0:return d.targetGeometry=c.clone(),h=H.cameraOnContentAlongViewDirection(a),m.internalToExternal(a,h,d.camera),g=S(d.camera,b)?0:1,k=m.createAsyncContext(e),m.fromExtent(a,c,d.camera.heading,d.camera.tilt,g,k),l=d,[4,k.resolver.promise];case 1:return l.camera=f.sent(),[2,d]}})})}function sa(a,b,c,e,d,h,g){return f.__awaiter(this,void 0,void 0,function(){var p,
n,w,t,x;return f.__generator(this,function(f){switch(f.label){case 0:g.targetGeometry=c.clone();f=p=H.cameraOnContentAlongViewDirection(a);var u=0;c.hasZ?u=c.z:a.basemapTerrain&&(u=Z.getElevationAtPoint(a.elevationProvider,c));l.vec3.set(k,c.x,c.y,u);y.computeLinearTransformation(a.spatialReference,k,ea,a.renderSpatialReference);X.mat3.fromMat4(N,ea);X.mat3.transpose(N,N);r.empty(E);for(var v=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],A=0;A<v.length;A++){var B=v[A],q=e[B[2]];
isFinite(q)||(q=u);l.vec3.set(k,e[B[0]],e[B[1]],q);y.vectorToVector(k,a.spatialReference,k,a.renderSpatialReference);r.expand(E,l.vec3.transformMat3(k,k,N))}u=r.width(E);v=r.height(E);A=r.depth(E);B=1/Math.tan(f.fovY/2);n=Math.max(.5*Math.sqrt(u*u+A*A)*Math.max(B,1/Math.tan(f.fovX/2))+.5*v,.5*v*B+.5*Math.max(u,A))/d;m.internalToExternal(a,p,g.camera);w=S(g.camera,b)?0:1;g.scale=m.distanceToScale(a,n,g.targetGeometry.latitude);t=m.createAsyncContext(h);m.fromCenterScale(a,g.targetGeometry,g.scale,
g.camera,w,t);x=g;return[4,t.resolver.promise];case 1:return x.camera=f.sent(),[2,g]}})})}function v(a){a&&(a.rotation=D(a.camera.heading));return a}Object.defineProperty(w,"__esModule",{value:!0});w.DEFAULT_FRAME_COVERAGE=.66;w.rotationToHeading=Q;w.headingToRotation=D;w.toCamera=ba;w.fromInternalCamera=function(a,b,c){c||(c=new I({camera:new O}));m.internalToExternal(a,b,c.camera);return J(a,b,c)};w.fromCamera=function(a,b,c){c||(c=new I);c.camera=b.clone();return J(a,null,c)};w.create=function(a,
b,c){return f.__awaiter(this,void 0,void 0,function(){var e,d,h,g,p,y,z,t,D,E,u,F,A;return f.__generator(this,function(f){switch(f.label){case 0:if(b&&a.spatialReference){f={target:null};if("declaredClass"in b||Array.isArray(b))f.target=b;else{for(var q in b)f[q]=b[q];b.center&&!f.target&&(f.target=b.center)}e=f}else e=null;if(!e)throw new P("viewpointutils-create:no-target","Missing target for creating viewpoint");d=new I({camera:new O({fov:a.camera.fov})});return e.target instanceof I?[4,oa(a,e.target,
e,c,d)]:[3,2];case 1:return h=f.sent(),[2,v(h)];case 2:if(e.target instanceof O)return[2,v(da(a,e.target,d))];g=null!=e.scale||null!=e.zoom;if(!(e.target instanceof x.Extent))return[3,6];p=e.target.xmin===e.target.xmax||e.target.ymin===e.target.ymax;if(!g&&!p)return[3,4];y=v;return[4,T(a,e,e.target.center,c,d)];case 3:return[2,y.apply(void 0,[f.sent()])];case 4:return z=v,[4,ra(a,e,e.target,c,d)];case 5:return[2,z.apply(void 0,[f.sent()])];case 6:return t={boundingBox:r.empty(),hasZ:!1,screenSpaceObjects:[]},
D=g?m.scaleToResolution(a,R(a,e)):void 0,[4,ca(a,e.target,D,t)];case 7:f.sent();if(!isFinite(t.boundingBox[0]))return[3,11];r.center(t.boundingBox,k);n.x=k[0];n.y=k[1];n.z=k[2];n.spatialReference=a.spatialReference;p=void 0;isFinite(n.z)&&t.hasZ?p=r.isPoint(t.boundingBox):(n.z=void 0,p=Y.isPoint(r.toRect(t.boundingBox,ta)));if(!g&&!p)return[3,9];E=v;return[4,T(a,e,n,c,d)];case 8:return[2,E.apply(void 0,[f.sent()])];case 9:q=t.screenSpaceObjects;f=w.DEFAULT_FRAME_COVERAGE;if(q.length){for(var G=Number.NEGATIVE_INFINITY,
B=0;B<q.length;B++)var C=q[B].screenSpaceBoundingRect,G=Math.max(G,Math.abs(C[0]),Math.abs(C[1]),Math.abs(C[2]),Math.abs(C[3]));u=f-G/Math.min(a.width,a.height)*2}else u=f;F=v;return[4,sa(a,e,n,t.boundingBox,u,c,d)];case 10:return[2,F.apply(void 0,[f.sent()])];case 11:if(e.position)return q=e,f=d,G=H.cameraOnContentAlongViewDirection(a),l.vec3.copy(M,G.viewForward),m.directionToHeadingTilt(a,G.eye,M,G.up,V),f.camera.position=new x.Point(q.position),f.camera.heading=null!=q.heading?q.heading:V.heading,
f.camera.tilt=null!=q.tilt?q.tilt:V.tilt,q=J(a,null,f),[2,v(q)];A=v;return[4,qa(a,e,c,d)];case 12:return[2,A.apply(void 0,[f.sent()])]}})})};var k=F.vec3f64.create(),ea=ka.mat4f64.create(),N=ja.mat3f64.create(),E=r.create(),ta=Y.create(),M=F.vec3f64.create(),L=F.vec3f64.create(),U=F.vec3f64.create(),V={heading:0,tilt:0},n=new x.Point,ma={point:function(a,b,c){c[0]=a.x;c[1]=a.y;a.hasZ&&(c[2]=a.z);b(c)},polygon:function(a,b,c){for(var e=a.hasZ,d=0;d<a.rings.length;d++)for(var f=a.rings[d],g=0;g<f.length;g++)c[0]=
f[g][0],c[1]=f[g][1],e&&(c[2]=f[g][2]),b(c)},polyline:function(a,b,c){for(var e=a.hasZ,d=0;d<a.paths.length;d++)for(var f=a.paths[d],g=0;g<f.length;g++)c[0]=f[g][0],c[1]=f[g][1],e&&(c[2]=f[g][2]),b(c)},multipoint:function(a,b,c){var e=a.points;a=a.hasZ;for(var d=0;d<e.length;d++)c[0]=e[d][0],c[1]=e[d][1],a&&(c[2]=e[d][2]),b(c)},extent:function(a,b,c){a.hasZ?(b(l.vec3.set(c,a.xmin,a.ymin,a.zmin)),b(l.vec3.set(c,a.xmax,a.ymin,a.zmin)),b(l.vec3.set(c,a.xmin,a.ymax,a.zmin)),b(l.vec3.set(c,a.xmax,a.ymax,
a.zmin)),b(l.vec3.set(c,a.xmin,a.ymin,a.zmax)),b(l.vec3.set(c,a.xmax,a.ymin,a.zmax)),b(l.vec3.set(c,a.xmin,a.ymax,a.zmax)),b(l.vec3.set(c,a.xmax,a.ymax,a.zmax))):(b(l.vec3.set(c,a.xmin,a.ymin,c[2])),b(l.vec3.set(c,a.xmax,a.ymin,c[2])),b(l.vec3.set(c,a.xmin,a.ymax,c[2])),b(l.vec3.set(c,a.xmax,a.ymax,c[2])))},mesh:function(a,b,c){if(a=a.vertexAttributes&&a.vertexAttributes.position)for(var e=0;e<a.length;e+=3)b(l.vec3.set(c,a[e+0],a[e+1],a[e+2]))}}});