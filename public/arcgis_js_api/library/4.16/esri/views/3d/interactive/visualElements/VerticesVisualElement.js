// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/Evented ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingBox ../editingTools/settings ./DrapedVisualElementResources ./VisualElementResources ../../layers/graphics/ElevationContext ../../layers/graphics/pointUtils ../../support/projectionUtils ../../webgl-engine/lib/Camera ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/materials/ColorMaterial ../../webgl-engine/materials/ShadedColorMaterial".split(" "),
function(m,n,w,l,q,x,y,z,A,r,t,B,k,C,D,E,F,G,H,u,v,I,J){Object.defineProperty(n,"__esModule",{value:!0});m=function(){function b(a){var c=this;this.view=null;this.camera=new H.default;this.events=new w;this._isDraped=!1;this._spatialReference=this._vertices=null;this._color=k.settings.colorToVec4(k.settings.reshapeManipulators.vertex.color);this._elevationInfo=null;this._occludedMode=8;this.resources=new D.VisualElementResources({view:a.view,createResources:function(a){return c.createResources(a)},
recreateGeometry:function(a,g){a.geometries.length=0;c.recreateGeometry(g,a.vertexMaterial,a.vertexOutlineMaterial,a.geometries);return a.geometries}});this.drapedResources=new C.DrapedVisualElementResources({view:a.view,createResources:function(){return c.createDrapedResources()},recreateGeometry:function(a){}});var g=!0,d;for(d in a)d in this?"attached"===d?g=a[d]:this[d]=a[d]:console.error("Cannot set unknown property",d);this.attached=g}b.prototype.onViewChange=function(){this.camera.copyFrom(this.view.state.camera)};
b.prototype.destroy=function(){this.resources.destroy();this.drapedResources.destroy()};Object.defineProperty(b.prototype,"isDraped",{get:function(){return this._isDraped},set:function(a){a!==this._isDraped&&(this._isDraped=a,this.updateAttached(this.attached))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hidden",{get:function(){return this.resources.hidden},set:function(a){this.resources.hidden=a;this.drapedResources.hidden=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"attached",{get:function(){return this.resources.attached||this.drapedResources.attached},set:function(a){this.updateAttached(a)},enumerable:!0,configurable:!0});b.prototype.updateAttached=function(a){this.resources.attached=!this.isDraped&&a;this.drapedResources.attached=this.isDraped&&a};Object.defineProperty(b.prototype,"vertices",{get:function(){return this._vertices},set:function(a){this._vertices=a;this.resources.recreateGeometry();this.drapedResources.recreateGeometry()},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"spatialReference",{get:function(){return this._spatialReference},set:function(a){this._spatialReference=a;this.resources.recreateGeometry();this.drapedResources.recreateGeometry()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"color",{get:function(){return this._color},set:function(a){r.vec4.exactEquals(a,this._color)||(r.vec4.copy(this._color,a),this.updateMaterial())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"elevationInfo",
{get:function(){return this._elevationInfo},set:function(a){this._elevationInfo=a;this.resources.recreateGeometry()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"occludedMode",{get:function(){return this._occludedMode},set:function(a){a!==this._occludedMode&&(this._occludedMode=a,l.isSome(this.resources.resources)&&(this.resources.resources.vertexMaterial.renderOccluded=a,this.resources.resources.vertexOutlineMaterial.renderOccluded=a),l.isSome(this.drapedResources.resources))},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"vertexMaterialParameters",{get:function(){return{color:this._color,transparent:1>this._color[3]}},enumerable:!0,configurable:!0});b.prototype.updateMaterial=function(){l.isSome(this.resources.resources)&&this.resources.resources.vertexMaterial.setParameterValues(this.vertexMaterialParameters)};b.prototype.recreateGeometry=function(a,c,g,d){for(var b=0,e=this.createRenderGeometries();b<e.length;b++){var f=e[b];a.addGeometry(f.vertexGeometry,
c,f.xform);d.push(f.vertexGeometry);a.addGeometry(f.vertexOutlineGeometry,g,f.xform);d.push(f.vertexOutlineGeometry)}};b.prototype.createResources=function(a){var c=this.color,g=t.vec4f64.fromValues(c[0],c[1],c[2],3<c.length?c[3]:1),b=new J.ShadedColorMaterial({color:g,transparent:1>c[3],writeDepth:!0,cullFace:2},"manipulator");b.renderOccluded=k.settings.reshapeManipulators.vertex.renderOccludedFlag;var c=k.settings.colorToVec4(k.settings.reshapeManipulators.vertex.outlineColor),c=t.vec4f64.fromValues(c[0],
c[1],c[2],4===c.length?c[3]:1),h=new I({color:c,transparent:!0,writeDepth:!0,cullFace:1},"manipulator-outline");h.renderOccluded=k.settings.reshapeManipulators.vertex.renderOccludedFlag;var e=[];this.recreateGeometry(a,b,h,e);return{vertexMaterial:b,vertexOutlineMaterial:h,geometries:e,forEach:function(a){a(b);a(h);e.forEach(a)}}};b.prototype.createDrapedResources=function(){return{geometries:null}};b.prototype.calculateMapBounds=function(a){if(l.isNone(this.resources.resources))return!1;for(var c=
this.view.renderCoordsHelper,b=0,d=this.resources.resources.geometries;b<d.length;b++){var h=d[b].data.getAttribute("position"),e=h.data,f=new Float64Array(e.length);G.bufferToBuffer(h.data,c.spatialReference,0,f,this.view.spatialReference,0,e.length/3);B.expandWithBuffer(a,f)}return!0};b.prototype.computeScreenLocation=function(a,c){c.pixelSize=this.camera.computeScreenPixelSizeAt(a);this.camera.projectPoint(a,c.renderScreenPointArray);this.camera.renderToScreen(c.renderScreenPointArray,c.screenPointArray);
return c};b.prototype.computeTransform=function(a,c){var b=y.mat4f64.create(),d=this.computeScreenLocation(a,K);c*=d.pixelSize;x.mat4.set(b,c,0,0,0,0,c,0,0,0,0,c,0,0,0,0,1);b[12]+=a[0];b[13]+=a[1];b[14]+=a[2];b[15]=1;return b};b.prototype.createRenderGeometries=function(){var a=this.vertices;if(!l.isNone(a)&&0!==a.length&&this.view.state&&this.view.state.camera)this.camera.copyFrom(this.view.state.camera);else return[];for(var b=k.settings.reshapeManipulators.vertex,g=b.size/2,d=g+b.collisionPadding,
h=g/d,b=(g+b.outlineSize)/d,e=F.geometryToRenderInfo(a,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,E.ElevationContext.fromElevationInfo(this.elevationInfo)),a=[],g=e.numVertices,e=e.position,f=0;f<g;++f){var m=new u(v.createSphereGeometry(h,16,16),"VerticesVisualElement-vertex"),n=new u(v.createSphereGeometry(b,16,16),"VerticesVisualElement-vertexOutline"),p=z.vec3.set(L,e[3*f+0],e[3*f+1],e[3*f+2]),p=this.computeTransform(p,d);a.push({vertexGeometry:m,vertexOutlineGeometry:n,
xform:p})}return a};return b}();n.VerticesVisualElement=m;var K={screenPointArray:q.createScreenPointArray(),renderScreenPointArray:q.createRenderScreenPointArray3(),pixelSize:0},L=A.vec3f64.create()});