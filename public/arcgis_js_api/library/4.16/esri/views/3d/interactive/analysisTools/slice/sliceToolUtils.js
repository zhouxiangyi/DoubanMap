// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../geometry ../../../../../core/compilerUtils ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/screenUtils ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/quat ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../Manipulator3D ../../manipulatorUtils ./sliceToolConfig ../../../support/geometryUtils ../../../support/stack ../../../support/geometryUtils/vector ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryData ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Util ../../../webgl-engine/materials/ColorMaterial ../../../webgl-engine/materials/ImageMaterial ../../../webgl-engine/materials/NativeLineMaterial ../../../webgl-engine/materials/RibbonLineMaterial ../../../webgl-engine/materials/SlicePlaneMaterial".split(" "),
function(fa,h,u,Y,S,Z,G,B,N,q,O,T,e,t,D,aa,k,r,l,H,v,ba,x,I,J,ca,P,U,da){function V(a,c,b,d,f,E){var n=e.vec3.dot(a,c),g=l.sv3d.get(),m=l.sv3d.get();d=0===d?Math.abs(n)>k.VERTICAL_DOT_THRESHOLD?1:2:d;switch(d){case 2:e.vec3.cross(g,Math.abs(n)<=k.SMALL_ANGLE_DOT_THRESHOLD?a:b.viewUp,c);e.vec3.copy(m,c);break;case 1:e.vec3.cross(g,b.viewUp,c);e.vec3.cross(m,c,g);break;case 3:e.vec3.cross(g,Math.abs(n)<=k.SMALL_ANGLE_DOT_THRESHOLD?c:b.viewUp,a);e.vec3.cross(m,a,g);break;default:S.neverReached(d)}a=
e.vec3.cross(l.sv3d.get(),g,m);0<e.vec3.dot(a,b.viewForward)&&e.vec3.scale(m,m,-1);e.vec3.normalize(f,g);e.vec3.normalize(E,m)}function Q(a,c){switch(c){case 0:return{basis:a.basis1,direction:1,position:e.vec3.add(l.sv3d.get(),a.origin,a.basis1),edge:c};case 1:return{basis:a.basis2,direction:1,position:e.vec3.add(l.sv3d.get(),a.origin,a.basis2),edge:c};case 2:return{basis:a.basis1,direction:-1,position:e.vec3.subtract(l.sv3d.get(),a.origin,a.basis1),edge:c};case 3:return{basis:a.basis2,direction:-1,
position:e.vec3.subtract(l.sv3d.get(),a.origin,a.basis2),edge:c}}}function R(a,c,b){var d=b.projectPoint(e.vec3.add(l.sv3d.get(),a,c),N.castRenderScreenPointArray3(l.sv3d.get()));a=b.projectPoint(e.vec3.subtract(l.sv3d.get(),a,c),N.castRenderScreenPointArray3(l.sv3d.get()));return e.vec3.squaredLength(e.vec3.subtract(d,d,a))}function C(a){var c=e.vec3.length(a.basis1);a=e.vec3.length(a.basis2);return k.RESIZE_HANDLE_EDGE_PADDING_FRAC*Math.min(c,a)}function K(a){return 0!==a.direction[0]&&0!==a.direction[1]}
function W(a,c,b){var d=function(d){var f=(d?c:a).slice(0),n=e.vec3.subtract(l.sv3d.get(),f[0],f[1]);e.vec3.normalize(n,n);var g=e.vec3.subtract(l.sv3d.get(),f[f.length-1],f[f.length-2]);e.vec3.normalize(g,g);if(0<b.padding){var m=e.vec3.scale(t.vec3f64.create(),g,-b.padding);f[f.length-1]=e.vec3.add(m,m,f[f.length-1]);b.bothEnds&&(m=e.vec3.scale(t.vec3f64.create(),n,-b.padding),f[0]=e.vec3.add(m,m,f[0]))}var p=d?b.tipFocusMultiplier:1,m=b.tipLength*(b.focusTipLength?p:1),h=b.tipRadius*p,p=q.mat4.identity(l.sm4d.get());
if(0<b.padding){var k=m/4,A=e.vec3.set(l.sv3d.get(),0,k,0),k=1+b.padding/k;q.mat4.translate(p,p,A);q.mat4.scale(p,p,e.vec3.set(l.sv3d.get(),k,k,k));q.mat4.translate(p,p,e.vec3.scale(A,A,-1/k))}k=q.mat4.identity(O.mat4f64.create());A=t.vec3f64.fromValues(0,1,0);g=q.mat4.fromQuat(O.mat4f64.create(),T.quat.rotationTo(l.sq4d.get(),A,g));g[12]=f[f.length-1][0];g[13]=f[f.length-1][1];g[14]=f[f.length-1][2];q.mat4.multiply(g,g,p);d=b.tubeRadius*(d?b.tubeFocusMultiplier:1)+b.padding;var y=b.flat,r=[];if(B.isSome(y))r.push([d,
y.thickness/2],[-d,y.thickness/2],[-d,-y.thickness/2],[d,-y.thickness/2]);else for(y=0;12>y;y++){var w=y/12*2*Math.PI;r.push([Math.cos(w)*d,Math.sin(w)*d])}d=x.createPathExtrusionGeometry(r,f,[],[],!1);d=[{part:"tube",geometry:new v(d,"arrow-tube"),transform:k}];var u;B.isSome(b.flat)?k=new v(x.createExtrudedTriangle(m,h,h,b.flat.thickness),"arrow-tip"):(k=new v(x.createConeGeometry(m,h,24,!1,!1,!0),"arrow-tip"),u=new v(x.createConeGeometry(m,h,24,!1,!0,!1),"arrow-cap"));d.push({part:"tip",geometry:k,
transform:g});u&&d.push({part:"cap",geometry:u,transform:g});b.bothEnds&&(n=q.mat4.fromQuat(O.mat4f64.create(),T.quat.rotationTo(l.sq4d.get(),A,n)),n[12]=f[0][0],n[13]=f[0][1],n[14]=f[0][2],q.mat4.multiply(n,n,p),d.push({part:"tip",geometry:k,transform:n}),u&&d.push({part:"cap",geometry:u,transform:n}));return d};return{normal:d(!1),focused:d(!0)}}function X(a,c){var b=e.vec3.subtract(t.vec3f64.create(),a[a.length-1],a[a.length-2]);e.vec3.normalize(b,b);e.vec3.scale(b,b,k.ROTATE_HEADING_TIP_LENGTH);
e.vec3.add(b,b,a[a.length-1]);return c?(c=e.vec3.subtract(t.vec3f64.create(),a[0],a[1]),e.vec3.normalize(c,c),e.vec3.scale(c,c,k.ROTATE_HEADING_TIP_LENGTH),e.vec3.add(c,c,a[0]),u.__spreadArrays([c],a,[b])):u.__spreadArrays(a,[b])}Object.defineProperty(h,"__esModule",{value:!0});var ea=Z.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");h.createPlane=function(a,c,b,d,f,k,n,g){n=n.worldUpAtPosition(a,l.sv3d.get());V(c,n,f,k,g.basis1,g.basis2);e.vec3.scale(g.basis1,g.basis1,b);
e.vec3.scale(g.basis2,g.basis2,d);e.vec3.copy(g.origin,a);r.plane.fromVectorsAndPoint(g.basis2,g.basis1,g.origin,g.plane);return g};h.normalToBases=V;h.forceHorizontalOrVertical=function(a,c,b){var d=c.worldUpAtPosition(a.origin,l.sv3d.get());c=a.basis1;d=H.angleAroundAxis(d,a.basis2,a.basis1)+w;return r.boundedPlane.rotate(a,Math.round(d/w)*w-d,c,b)};h.resizePlane=function(a,c,b,d,f,h){var n=e.vec3.copy(l.sv3d.get(),f.origin);e.vec3.add(n,n,e.vec3.scale(l.sv3d.get(),f.basis1,0>a.direction[0]?1:-1));
e.vec3.add(n,n,e.vec3.scale(l.sv3d.get(),f.basis2,0>a.direction[1]?1:-1));var g=e.vec3.length(f.basis1),m=e.vec3.length(f.basis2);b=e.vec3.subtract(l.sv3d.get(),b,n);var p=e.vec3.subtract(l.sv3d.get(),c,n),E=0;c=0;if(K(a)){var q=C(f),A=C(h),E=g-.5*a.direction[0]*e.vec3.dot(f.basis1,p)/g;c=m-.5*a.direction[1]*e.vec3.dot(f.basis2,p)/m;p=A/q;E*=p;c*=p}p=.5*a.direction[0]*e.vec3.dot(f.basis1,b)/g;q=.5*a.direction[1]*e.vec3.dot(f.basis2,b)/m;b=E+p;c+=q;g=e.vec3.scale(l.sv3d.get(),f.basis1,b/g);f=e.vec3.scale(l.sv3d.get(),
f.basis2,c/m);(0>=b||R(h.origin,g,d)<=k.PLANE_MIN_BASIS_SCREEN_LEN2)&&e.vec3.copy(g,h.basis1);(0>=c||R(h.origin,f,d)<=k.PLANE_MIN_BASIS_SCREEN_LEN2)&&e.vec3.copy(f,h.basis2);d=e.vec3.copy(l.sv3d.get(),n);e.vec3.add(d,d,e.vec3.scale(l.sv3d.get(),g,0>a.direction[0]?-1:1));e.vec3.add(d,d,e.vec3.scale(l.sv3d.get(),f,0>a.direction[1]?-1:1));return r.boundedPlane.fromValues(d,g,f,h)};h.calculatePlaneHalfSize=function(a,c){return k.INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION*Math.min(c.width,c.height)*c.computeRenderPixelSizeAt(a)};
h.createShiftPlane=function(a,c,b,d){b=e.vec3.cross(l.sv3d.get(),c,b);e.vec3.cross(b,b,c);return r.plane.fromPositionAndNormal(a,b,d)};h.calculateBoundedPlaneTranslateRotate=function(a,c){return aa.calculateTranslateRotateFromBases(a.basis1,a.basis2,a.origin,c)};h.createRotatePlane=function(a,c,b,d){c=c.worldUpAtPosition(a.origin,l.sv3d.get());var f=l.sv3d.get();switch(b){case 1:e.vec3.copy(f,c);break;case 2:e.vec3.copy(f,a.basis1)}return r.plane.fromPositionAndNormal(a.origin,f,d)};h.updateShiftRestartHandle=
function(a,c,b,d){var f=Q(b,2),h=l.sm4d.get();q.mat4.rotateZ(h,c,f.edge*Math.PI/2);c=e.vec3.normalize(l.sv3d.get(),f.basis);c=e.vec3.scale(l.sv3d.get(),c,f.direction*d.computeScreenPixelSizeAt(f.position)*k.SHIFT_RESTART_OFFSET_DISTANCE);e.vec3.add(c,c,f.position);var f=d.projectPoint(c,N.castRenderScreenPointArray3(l.sv3d.get())),n,g=d.viewport;n=g[0];var m=g[1],p=g[2],g=g[3],z=Math.min(p,g)/16,F=!0;f[0]<n+z?(f[0]=n+z,F=!1):f[0]>n+p-z&&(f[0]=n+p-z,F=!1);f[1]<m+z?(f[1]=m+z,F=!1):f[1]>m+g-z&&(f[1]=
m+g-z,F=!1);n=F;r.ray.fromRender(d,f,L);e.vec3.normalize(L.direction,L.direction);d=l.sv3d.get();!n&&r.boundedPlane.intersectRay(b,L,d)&&(c=d);h[12]=0;h[13]=0;h[14]=0;a.modelTransform=h;a.renderLocation=t.vec3f64.clone(c);a.state=n?a.state|M:a.state&~M};h.updateResizeHandle=function(a,c,b,d){var f=e.vec3.length(d.basis1),h=e.vec3.length(d.basis2),k=C(d),g=C(d),m=e.vec3.set(l.sv3d.get(),0,0,0);e.vec3.add(m,e.vec3.scale(l.sv3d.get(),d.basis1,c.direction[0]),e.vec3.scale(l.sv3d.get(),d.basis2,c.direction[1]));
e.vec3.add(m,d.origin,m);d=0;var p=1;K(c)?(1===c.direction[0]&&-1===c.direction[1]?d=w:1===c.direction[0]&&1===c.direction[1]?d=Math.PI:-1===c.direction[0]&&1===c.direction[1]&&(d=3*Math.PI/2),p=g):(c=0!==c.direction[0]?1:2,d=1===c?w:0,p=(1===c?h:f)-k);f=q.mat4.identity(l.sm4d.get());q.mat4.rotateZ(f,f,d);q.mat4.scale(f,f,e.vec3.set(l.sv3d.get(),p,p,p));q.mat4.multiply(f,b,f);f[12]=0;f[13]=0;f[14]=0;a.modelTransform=f;a.renderLocation=m};h.updateRotateHeadingHandle=function(a,c,b,d){d=d.worldUpAtPosition(b.origin,
l.sv3d.get());var f=Q(b,0),e=q.mat4.identity(l.sm4d.get());q.mat4.rotateZ(e,e,f.edge*Math.PI/2);q.mat4.rotateX(e,e,-(H.angleAroundAxis(d,b.basis2,b.basis1)+w));q.mat4.multiply(e,c,e);e[12]=0;e[13]=0;e[14]=0;a.modelTransform=e;a.renderLocation=f.position};h.updateRotateTiltHandle=function(a,c,b){b=Q(b,1);var d=q.mat4.identity(l.sm4d.get());q.mat4.rotateZ(d,d,b.edge*Math.PI/2);q.mat4.rotateX(d,d,w);q.mat4.multiply(d,c,d);d[12]=0;d[13]=0;d[14]=0;a.modelTransform=d;a.renderLocation=b.position};h.calculateScreenSpaceBasisLength2=
R;h.calculateResizeHandlePadding=C;h.calculateDiagonalResizeHandleScale=function(a){return C(a)};h.isDiagonalResizeHandle=K;h.createShiftManipulator=function(a){var c=[t.vec3f64.fromValues(0,0,-k.SHIFT_RESTART_ARROW_LENGTH/2),t.vec3f64.fromValues(0,0,k.SHIFT_RESTART_ARROW_LENGTH/2)],b=X(c,!0),d=function(a,b){return W(c,c,{tubeRadius:k.SHIFT_RESTART_TUBE_RADIUS,tipRadius:k.SHIFT_RESTART_TIP_RADIUS,tipLength:k.SHIFT_RESTART_TIP_LENGTH,tubeFocusMultiplier:k.SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER,tipFocusMultiplier:k.SHIFT_RESTART_TIP_FOCUS_MULTIPLIER,
padding:a,bothEnds:!0,flat:null,focusTipLength:!0,addCap:b})},e=d(0,!1),d=d(k.SHIFT_RESTART_ARROW_OUTLINE_WIDTH,!0),l=new J({color:k.SHIFT_RESTART_ARROW_TIP_COLOR,cullFace:2},"slice-shift");l.renderOccluded=16;var n=new J({color:k.SHIFT_RESTART_ARROW_CAP_COLOR,cullFace:2},"slice-shift");n.renderOccluded=16;var g=new J({color:k.SHIFT_RESTART_TUBE_COLOR,cullFace:2},"slice-shift");g.renderOccluded=16;var m=new J({color:k.SHIFT_RESTART_OUTLINE_COLOR,transparent:!0,writeDepth:!1,cullFace:1},"slice-shift");
m.renderOccluded=2;var p=new v(x.createPolylineGeometry([[0,0,0],[-k.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),"slice-rotate-heading"),q=new v(x.createPolylineGeometry([[0,0,0],[-k.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),"slice-rotate-heading"),r=new P({color:k.SHIFT_RESTART_CALLOUT_COLOR},"slice-rotate-heading");r.renderOccluded=4;return new D.Manipulator3D({view:a,renderObjects:u.__spreadArrays(e.normal.map(function(a){var b=a.part;return{geometry:a.geometry,material:"tip"===b?l:"cap"===b?n:g,transform:a.transform,
stateMask:1|h.DidPointerMoveRecentlyFlag}}),d.normal.map(function(a){return{geometry:a.geometry,material:m,transform:a.transform,stateMask:1|h.DidPointerMoveRecentlyFlag}}),[{geometry:p,material:r,stateMask:1|h.DidPointerMoveRecentlyFlag|M}],e.focused.map(function(a){var b=a.part;return{geometry:a.geometry,material:"tip"===b?l:"cap"===b?n:g,transform:a.transform,stateMask:2|h.DidPointerMoveRecentlyFlag}}),d.focused.map(function(a){return{geometry:a.geometry,material:m,transform:a.transform,stateMask:2|
h.DidPointerMoveRecentlyFlag}}),[{geometry:q,material:r,stateMask:2|h.DidPointerMoveRecentlyFlag|M}]),autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[b]},collisionPriority:1,radius:k.SHIFT_RESTART_TIP_RADIUS,state:h.DidPointerMoveRecentlyFlag})};h.createRotateManipulator=function(a,c){var b=new ca({transparent:!0,writeDepth:!1,textureId:c.id},"slice-rotate"),d=k.ROTATE_HEADING_OFFSET_DISTANCE;c=k.ROTATE_HEADING_DISC_RADIUS;var e=c*k.ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER,l=function(a){var b,
c,e=new Uint32Array([0,1,2,2,3,0]);return new v(new ba.GeometryData((b={},b[I.VertexAttrConstants.POSITION]={size:3,data:new Float32Array([d-a,-a,0,d+a,-a,0,d+a,a,0,d-a,a,0])},b[I.VertexAttrConstants.UV0]={size:2,data:new Float32Array([0,0,1,0,1,1,0,1])},b),(c={},c[I.VertexAttrConstants.POSITION]=e,c[I.VertexAttrConstants.UV0]=e,c)))};b.renderOccluded=16;var n=new v(x.createPolylineGeometry([[0,0,0],[d-c,0,0]]),"slice-rotate-heading"),g=new v(x.createPolylineGeometry([[0,0,0],[d-e,0,0]]),"slice-rotate-heading"),
m=new P({color:k.ROTATE_HEADING_CALLOUT_COLOR},"slice-rotate-heading");m.renderOccluded=4;b=[{geometry:l(c),material:b,stateMask:1|h.DidPointerMoveRecentlyFlag},{geometry:n,material:m,stateMask:1|h.DidPointerMoveRecentlyFlag},{geometry:l(e),material:b,stateMask:2|h.DidPointerMoveRecentlyFlag},{geometry:g,material:m,stateMask:2|h.DidPointerMoveRecentlyFlag}];return new D.Manipulator3D({view:a,renderObjects:b,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[d,0,0]},collisionPriority:1,
radius:c/2,state:h.DidPointerMoveRecentlyFlag})};h.createOutlineManipulator=function(a){var c=new v(x.createPolylineGeometry([[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]),"slice-outline"),b=u.__spreadArrays(k.PLANE_OUTLINE_COLOR),b=new U({color:b,writeDepth:!1,width:k.PLANE_OUTLINE_WIDTH},"slice-outline");b.renderOccluded=4;return{manipulator:new D.Manipulator3D({view:a,renderObjects:[{geometry:c,material:b}],interactive:!1,autoScaleRenderObjects:!1,worldSized:!0}),material:b}};h.createGridManipulator=
function(a){var c=new v(x.createSquareGeometry(),"slice-grid"),b=u.__spreadArrays(k.PLANE_BACKGROUND_COLOR),b=new da({backgroundColor:b,gridColor:k.GRID_COLOR,gridWidth:4},"slice-grid");b.renderOccluded=4;return{manipulator:new D.Manipulator3D({view:a,renderObjects:[{geometry:c,material:b}],interactive:!1,autoScaleRenderObjects:!1,worldSized:!0}),material:b}};h.createResizeManipulator=function(a,c){var b=(c=K(c))?[t.vec3f64.fromValues(1,0,0),t.vec3f64.fromValues(0,0,0),t.vec3f64.fromValues(0,1,0)]:
[t.vec3f64.fromValues(1,0,0),t.vec3f64.fromValues(-1,0,0)],d=new v(x.createPolylineGeometry(b),"slice-resize"),e=u.__spreadArrays(k.HANDLE_COLOR,[1]),h=function(a){a=new U({color:e,width:a},"slice-resize");a.renderOccluded=4;return a},l=function(){var a=new P({color:e},"slice-resize");a.renderOccluded=4;return a},g=c?k.RESIZE_HANDLE_CORNER_WIDTH:k.RESIZE_HANDLE_EDGE_WIDTH,m=g*k.DISPLAY_FOCUS_MULTIPLIER;return new D.Manipulator3D({view:a,renderObjects:[{geometry:d,material:1<g?h(g):l(),stateMask:1},
{geometry:d,material:1<m?h(m):l(),stateMask:2}],collisionType:{type:"line",paths:[b]},autoScaleRenderObjects:!1,worldSized:!0,radius:c?k.RESIZE_HANDLE_CORNER_INPUT_RADIUS:k.RESIZE_HANDLE_EDGE_INPUT_RADIUS})};h.createArrowGeometry=W;h.addArrowTips=X;h.planeToShape=function(a,c,b,d){if(B.isNone(a))return null;var f=B.isSome(d.position)?d.position:new Y.Point;c.fromRenderCoords(a.origin,f,b);d.position=f;b=c.worldUpAtPosition(a.origin,l.sv3d.get());c=c.worldBasisAtPosition(a.origin,1,l.sv3d.get());d.width=
2*e.vec3.length(a.basis1);d.height=2*e.vec3.length(a.basis2);d.tilt=G.rad2deg(H.angleAroundAxis(b,a.basis2,a.basis1)+w);d.heading=G.rad2deg(H.angleAroundAxis(a.basis1,c,b)-w);return d};h.shapeToPlane=function(a,c,b){if(B.isNone(a)||B.isNone(a.position))return null;if(!c.toRenderCoords(a.position,b.origin))return ea.error("Failed to project slice plane position, projection from "+a.position.spatialReference.wkid+" is not supported"),null;c.worldBasisAtPosition(b.origin,0,b.basis1);c.worldBasisAtPosition(b.origin,
1,b.basis2);r.plane.fromVectorsAndPoint(b.basis2,b.basis1,b.origin,b.plane);r.boundedPlane.rotate(b,-G.deg2rad(a.heading),r.boundedPlane.normal(b),b);r.boundedPlane.rotate(b,G.deg2rad(a.tilt),b.basis1,b);e.vec3.scale(b.basis1,b.basis1,a.width/2);e.vec3.scale(b.basis2,b.basis2,a.height/2);r.boundedPlane.updateUnboundedPlane(b);return b};h.isAlwaysDrapedLayer=function(a){switch(a.type){case "building-scene":case "csv":case "feature":case "geo-rss":case "geojson":case "graphics":case "group":case "integrated-mesh":case "kml":case "map-notes":case "ogc-feature":case "point-cloud":case "route":case "scene":case "stream":case "unknown":case "unsupported":case null:return!1;
case "base-dynamic":case "base-elevation":case "base-tile":case "bing-maps":case "elevation":case "imagery":case "imagery-tile":case "map-image":case "open-street-map":case "tile":case "vector-tile":case "web-tile":case "wms":case "wmts":return!0;default:return S.neverReached(a.type),!1}};h.DidPointerMoveRecentlyFlag=16;var M=32,L=r.ray.create(),w=Math.PI/2});