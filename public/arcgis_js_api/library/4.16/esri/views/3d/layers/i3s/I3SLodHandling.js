// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/maybe","../../../../core/PooledArray"],function(m,p,e,n){m=function(){function b(a){this.layerView=a;this._lodGlobalDirty=!1}b.prototype.startNodeLoading=function(a,c,f,b,g,d,h){this._maxLodLevel=h.maxLodLevel;this._index=d;this._nodeTraversalState=b;this._isNodeVisible=a;this._isGeometryVisible=c;this._isNodeInScaleBounds=f;this._removeNodes=g};b.prototype.shouldLoadNode=function(a){if(e.isNone(a))return!1;var c=this._nodeTraversalState(a);return this.isChosenMaxLOD(c)?
!0:c.isChosen?this._childrenRequireLoading(a):!1};b.prototype.setLodGlobalDirty=function(){this._lodGlobalDirty=!0};Object.defineProperty(b.prototype,"requiresLODGlobalHandling",{get:function(){return null!=this._index&&!0===this._lodGlobalDirty},enumerable:!0,configurable:!0});b.prototype.lodGlobalHandling=function(a){if(!this.requiresLODGlobalHandling)return!1;var c=Math.max(0,Math.floor(10*(this.layerView.view.resourceController.memoryController.usedMemory-1)));d.clear();this._lodGlobalHandlingRecursion(this._index.rootNode,
c);c=d.length;this._removeNodes(d,a);a=d.length<c;0===d.length&&(this._lodGlobalDirty=!1);d.clear();return a};b.prototype._lodGlobalHandlingRecursion=function(a,c){if(e.isNone(a))return!1;var f=this._nodeTraversalState(a),b=this.isChosenMaxLOD(f);if(f=this.layerView.isNodeLoaded(a.index)){if(b)return this._removeChildrenRecursive(a),this.layerView.updateNodeState(a.index,1),!0;this.layerView.updateNodeState(a.index,0)}var g=!1;if(0<a.childCount)for(var g=!0,k=0;k<a.childCount;k++){var h=this._index.getChildIndex(a,
k),l=this._index.getNode(h);e.isSome(l)?this._isGeometryVisible(h)&&!this._lodGlobalHandlingRecursion(l,c)&&this._isNodeInScaleBounds(l)&&(g=!1):this._isNodeVisible(h)&&(g=!1)}f&&!b&&(g||d.length<c)&&(d.push(a.index),f=!1);a=!a.resources.hasFeatureData;return g||f||a};b.prototype._removeChildrenRecursive=function(a){this._index.traverseChildren(a,function(a){d.push(a.index);return!0})};b.prototype.childrenEmpty=function(a){var c=this,b=!0;this._index.traverseChildren(a,function(a){return b&&c._isNodeVisible(a.index)?
c.layerView.isNodeLoaded(a.index)?b=!1:!0:!1});return b};b.prototype._childrenRequireLoading=function(a){var b=this,d=!1,e=!0;this._index.traverseChildren(a,function(a){if(!e||!b._isNodeVisible(a.index))return!1;var c=b._nodeTraversalState(a);b.isChosenMaxLOD(c)&&b._isGeometryVisible(a.index)&&(d=!0);return b.layerView.isNodeLoaded(a.index)?e=!1:!0});return e&&d};b.prototype.isChosenMaxLOD=function(a){return a.isChosen&&(!a.nodeHasLOD||a.lodLevel===this._maxLodLevel)};return b}();var d=new n({deallocator:null});
return m});