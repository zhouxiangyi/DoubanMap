// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/arrayUtils ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../support/projectionUtils @dojo/framework/shim/Promise".split(" "),function(C,h,z,A,k,D,E,u,v){function r(a,b){return g.intersects(a,b)?g.contains(a,b)?0:2:1}function B(a,b){return g.intersects(a,b)?g.contains(a,b)?1:2:0}Object.defineProperty(h,"__esModule",{value:!0});var g;
h.isGeometryEngineLoaded=function(){return!!g};h.loadGeometryEngine=function(){return z.__awaiter(this,void 0,void 0,function(){return z.__generator(this,function(a){switch(a.label){case 0:return g?[2,g]:[4,new Promise(function(a,c){C(["../../../../geometry/geometryEngine"],a,c)})];case 1:return g=a.sent(),[2,g]}})})};h.processFilterGeometry=function(a,b){if(!a)return null;if("disjoint"===b&&"polygon"===a.type){var c=Array(a.rings.length);for(b=0;b<a.rings.length;++b){var d=u.fromValues(Infinity,
Infinity,-Infinity,-Infinity);u.expandWithNestedArray(d,a.rings[b]);c[b]={type:"polygon",rings:[a.rings[b]],spatialReference:a.spatialReference,aabr:d}}c.sort(function(a,c){return a.aabr[0]-c.aabr[0]});var e=new Set,k=new A.PositionHint;a=function(a){var b=c[a];for(a+=1;a<c.length;++a){var d=c[a];if(d.aabr[0]>=b.aabr[2])break;e.add(d)}e.forEach(function(a){b!==a&&(a.aabr[2]<=b.aabr[0]?e.delete(a):g.intersects(b,a)&&(b.rings=b.rings.concat(a.rings),u.expand(b.aabr,a.aabr),delete b._geVersion,e.delete(a),
a=A.indexOf(c,a,c.length,k),c.splice(a,1)))});e.add(b)};for(b=0;b<c.length;++b)a(b);for(a=0;a<c.length;a++)delete c[a].aabr;return c}return[a]};h.acquireMaskFilterContext=function(a,b,c,d,e){b=b.renderSpatialReference;var k=new Map,m={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:c};m.rings[0][3]=m.rings[0][0];var p,h;switch(a){case "intersects":p=function(a,b){return g.intersects(a,b)?0:2};h=r;break;case "contains":p=function(a,b){return g.contains(a,b)?
2:1};h=r;break;default:p=function(a,b){return g.disjoint(a,b)?2:1},h=B}return{collection:d,object:e,type:a,maskSR:c,renderSR:b,aabbCache:k,triangle:m,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:p,geometryTest:h}};h.computeMaskNodeMBS=function(a,b){var c={x:a[0],y:a[1],hasZ:!1,hasM:!1,type:"point",spatialReference:b.maskSR};a=b.maskSR.isWGS84||b.maskSR.isWebMercator?g.geodesicBuffer(c,a[3],1):g.buffer(c,a[3],1);a.type="polygon";return a};h.testMaskWithGeometry=
function(a,b,c){switch(c){case "intersects":case "contains":return r(a,b);case "disjoint":return B(a,b)}};var F=Math.pow(2,-32);h.filterWithMask=function(a,b,c){var d=c.collection,e=c.object,h=c.renderSR,g=c.maskSR,p=c.geometryTest,w=c.aabbCache,f=w.get(b);if(!f){var n=d.getObjectTransform(e);d.getComponentAABB(e,b,m);for(var l=[[m[0],m[1],0],[m[0],m[4],0],[m[3],m[4],0],[m[3],m[1],0]],f=0;4>f;++f)k.vec3.transformMat3(l[f],l[f],n.rotationScale),k.vec3.add(l[f],l[f],n.position),v.vectorToVector(l[f],
h,l[f],g);f={rings:[l],hasZ:!1,hasM:!1,type:"polygon",spatialReference:g};f.rings[0][4]=f.rings[0][0];w.set(b,f)}switch(p(a,f)){case 1:return!1;case 0:return!0}var p=c.triangle,w=c.triangleTest,f=c.positions,n=p.rings[0][0],l=p.rings[0][1],q=p.rings[0][2],t=d.getObjectTransform(e);d.getComponentPositions(e,b,f);b=f.indices;for(var d=f.data,e=f.stride,u=f.endIndex,f=f.startIndex;f<u;f+=3){var r=e*b[f+0],x=e*b[f+1],y=e*b[f+2];k.vec3.set(n,d[r+0],d[r+1],d[r+2]);k.vec3.set(l,d[x+0],d[x+1],d[x+2]);k.vec3.set(q,
d[y+0],d[y+1],d[y+2]);k.vec3.transformMat3(n,n,t.rotationScale);k.vec3.transformMat3(l,l,t.rotationScale);k.vec3.transformMat3(q,q,t.rotationScale);k.vec3.add(n,n,t.position);k.vec3.add(l,l,t.position);k.vec3.add(q,q,t.position);v.vectorToVector(n,h,n,g);v.vectorToVector(l,h,l,g);v.vectorToVector(q,h,q,g);if(!(Math.abs((l[0]-n[0])*(q[1]-n[1])-(l[1]-n[1])*(q[0]-n[0]))<F))switch(delete p._geVersion,w(a,p)){case 1:return!1;case 0:return!0}}switch(c.type){case "intersects":return!1;default:return!0}};
h.boundingBoxCornerPoints=function(a,b,c,d){a=b.getComponentAABB(c,a,m);b=b.getObjectTransform(c);for(c=0;8>c;++c)e[0]=c&1?a[0]:a[3],e[1]=c&2?a[1]:a[4],e[2]=c&4?a[2]:a[5],k.vec3.transformMat3(e,e,b.rotationScale),k.vec3.add(e,e,b.position),d[3*c]=e[0],d[3*c+1]=e[1],d[3*c+2]=e[2];return d};h.boundingBoxTop=function(a,b,c,d){a=b.getComponentAABB(c,a,m);b=b.getObjectTransform(c);d[0]=0;d[1]=0;for(c=d[2]=0;8>c;++c)e[0]=c&1?a[0]:a[3],e[1]=c&2?a[1]:a[4],e[2]=a[5],k.vec3.transformMat3(e,e,b.rotationScale),
k.vec3.add(e,e,b.position),d[0]+=e[0],d[1]+=e[1],d[2]+=e[2];d[0]/=8;d[1]/=8;d[2]/=8;return d};var m=E.create(),e=D.vec3f64.create()});