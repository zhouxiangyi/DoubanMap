// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Error ../../../../core/lang ../../../../core/Logger ./LEPCC".split(" "),function(G,d,m,k,D,E,u){function F(a,b,c){for(var h="",e=0;e<c;){var f=a[b+e];if(128>f)h+=String.fromCharCode(f),e++;else if(192<=f&&224>f){if(e+1>=c)throw new k("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");var g=a[b+e+1],f=(f&31)<<6|g&63,h=h+String.fromCharCode(f),e=e+2}else if(224<=f&&240>f){if(e+2>=c)throw new k("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");
var g=a[b+e+1],d=a[b+e+2],f=(f&15)<<12|(g&63)<<6|d&63,h=h+String.fromCharCode(f),e=e+3}else if(240<=f&&248>f){if(e+3>=c)throw new k("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");g=a[b+e+1];d=a[b+e+2];f=(f&7)<<18|(g&63)<<12|(d&63)<<6|a[b+e+3]&63;h=65536<=f?h+String.fromCharCode((f-65536>>10)+55296,(f&1023)+56320):h+String.fromCharCode(f);e+=4}else throw new k("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");}return h}function p(a,b){for(var c=
{byteOffset:0,byteCount:0,fields:Object.create(null)},h=0,e=0;e<b.length;e++){var f=b[e],g=f.valueType||f.type;c.fields[f.property]=(0,d.valueType2ArrayBufferReader[g])(a,h);h+=d.valueType2TypedArrayClassMap[g].BYTES_PER_ELEMENT}c.byteCount=h;return c}function v(a,b,c){var h=[],e,f=0,g;for(g=0;g<a;g+=1){e=b[g];if(0<e){if(h.push(F(c,f,e-1)),0!==c[f+e-1])throw new k("string-array-error","Invalid string array: missing null termination.");}else h.push(null);f+=e}return h}function q(a,b){return new d.valueType2TypedArrayClassMap[b.valueType](a,
b.byteOffset,b.count*b.valuesPerElement)}function w(a,b){return new Uint8Array(a,b.byteOffset,b.byteCount)}function x(a,b,c){a=null!=b.header?p(a,b.header):{byteOffset:0,byteCount:0,fields:{count:c}};c={header:a,byteOffset:a.byteCount,byteCount:0,entries:Object.create(null)};for(var h=a.byteCount,e=0;e<b.ordering.length;e++){var f=b.ordering[e],g=D.clone(b[f]);g.count=a.fields.count;if("String"===g.valueType){if(g.byteOffset=h,g.byteCount=a.fields[f+"ByteCount"],"UTF-8"!==g.encoding)throw new k("unsupported-encoding",
"Unsupported String encoding.",{encoding:g.encoding});}else if(r(g.valueType)){var d=n(g.valueType),h=h+(0!==h%d?d-h%d:0);g.byteOffset=h;g.byteCount=d*g.valuesPerElement*g.count}else throw new k("unsupported-value-type","Unsupported binary valueType",{valueType:g.valueType});h+=g.byteCount;c.entries[f]=g}c.byteCount=h-c.byteOffset;return c}function y(a,b,c){b!==a&&t.error("Invalid "+c+" buffer size\n expected: "+a+", actual: "+b+")");if(b<a)throw new k("buffer-too-small","Binary buffer is too small",
{expectedSize:a,actualSize:b});}function z(a){return{isDraco:!1,isLegacy:!1,color:null!=a.color,normal:null!=a.normal,uv0:null!=a.uv0,uvRegion:null!=a.uvRegion,featureIndex:null!=a.faceRange&&null!=a.featureId}}function A(a){for(var b={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},c=0,h=a.ordering;c<h.length;c++){var e=h[c];if(a.vertexAttributes[e])switch(e){case "normal":b.normal=!0;break;case "color":b.color=!0;break;case "uv0":b.uv0=!0;break;case "region":b.uvRegion=
!0}}a.featureAttributes&&a.featureAttributeOrder&&(b.featureIndex=!0);return b}function B(a){for(var b={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},c=0;c<a.length;c++)switch(a[c]){case "normal":b.normal=!0;break;case "uv0":b.uv0=!0;break;case "color":b.color=!0;break;case "uv-region":b.uvRegion=!0;break;case "feature-index":b.featureIndex=!0}return b}function r(a){return d.valueType2TypedArrayClassMap.hasOwnProperty(a)}function n(a){return r(a)?d.valueType2TypedArrayClassMap[a].BYTES_PER_ELEMENT:
0}Object.defineProperty(d,"__esModule",{value:!0});var t=E.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");d.readHeader=p;d.readStringArray=v;d.createTypedView=q;d.createRawView=w;d.createAttributeDataIndex=x;d.createGeometryDescriptorFromDefinition=z;d.createGeometryIndexFromSchema=function(a,b){for(var c=p(a,b&&b.header),h=c.byteCount,e={isDraco:!1,header:c,byteOffset:c.byteCount,byteCount:0,vertexAttributes:{}},f=c.fields,g=null!=f.vertexCount?f.vertexCount:f.count,d=0,l=b.ordering;d<l.length;d++){var k=
l[d];b.vertexAttributes[k]&&(c=m.__assign(m.__assign({},b.vertexAttributes[k]),{byteOffset:h,count:g}),e.vertexAttributes[C[k]?C[k]:"_"+k]=c,h+=n(c.valueType)*c.valuesPerElement*g)}g=f.faceCount;if(b.faces&&g)for(e.faces={},d=0,l=b.ordering;d<l.length;d++)k=l[d],b.faces[k]&&(c=m.__assign(m.__assign({},b.faces[k]),{byteOffset:h,count:g}),e.faces[k]=c,h+=n(c.valueType)*c.valuesPerElement*g);f=f.featureCount;if(b.featureAttributes&&b.featureAttributeOrder&&f)for(e.featureAttributes={},g=0,d=b.featureAttributeOrder;g<
d.length;g++)l=d[g],b.featureAttributes[l]&&(c=m.__assign(m.__assign({},b.featureAttributes[l]),{byteOffset:h,count:f}),e.featureAttributes[l]=c,l="UInt64"===c.valueType?8:n(c.valueType),h+=l*c.valuesPerElement*f);y(h,a.byteLength,"geometry");e.byteCount=h-e.byteOffset;return e};d.createGeometryDescriptor=function(a,b){return a&&a.compressedAttributes&&"draco"===a.compressedAttributes.encoding?B(a.compressedAttributes.attributes):a?z(a):A(b)};d.createGeometryDescriptorFromSchema=A;d.createGeometryDescriptorForDraco=
B;var C={position:"position",normal:"normal",color:"color",uv0:"uv0",region:"uvRegion"};d.readBinaryAttribute=function(a,b,c){if("lepcc-rgb"===a.encoding)return u.decodeRGB(b);if("lepcc-intensity"===a.encoding)return u.decodeIntensity(b);if(null!=a.encoding&&""!==a.encoding)throw new k("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");a["attributeByteCounts "]&&!a.attributeByteCounts&&(t.warn("Warning: Trailing space in 'attributeByteCounts '."),a.attributeByteCounts=
a["attributeByteCounts "]);"ObjectIds"===a.ordering[0]&&a.hasOwnProperty("objectIds")&&(t.warn("Warning: Case error in objectIds"),a.ordering[0]="objectIds");c=x(b,a,c);y(c.byteOffset+c.byteCount,b.byteLength,"attribute");if(a=c.entries.attributeValues||c.entries.objectIds){if("String"===a.valueType){c=c.entries.attributeByteCounts;var d=q(b,c);b=w(b,a);return v(c.count,d,b)}return q(b,a)}throw new k("bad-attribute-storage-info","Bad attributeStorageInfo specification.");};d.valueType2TypedArrayClassMap=
{Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array};d.valueType2ArrayBufferReader={Float32:function(a,b){return(new DataView(a,0)).getFloat32(b,!0)},Float64:function(a,b){return(new DataView(a,0)).getFloat64(b,!0)},UInt8:function(a,b){return(new DataView(a,0)).getUint8(b)},Int8:function(a,b){return(new DataView(a,0)).getInt8(b)},UInt16:function(a,b){return(new DataView(a,0)).getUint16(b,!0)},Int16:function(a,
b){return(new DataView(a,0)).getInt16(b,!0)},UInt32:function(a,b){return(new DataView(a,0)).getUint32(b,!0)},Int32:function(a,b){return(new DataView(a,0)).getInt32(b,!0)}};d.isValueType=r;d.getBytesPerValue=n});