// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Accessor ../../../../core/Evented ../../../../core/Handles ../../../../core/SetUtils ../../../../core/accessorSupport/decorators ./ExtentSet ../../../support/Scheduler".split(" "),function(h,k,c,m,n,p,q,l,r,t){Object.defineProperty(k,"__esModule",{value:!0});h=function(g){function b(){var a=null!==g&&g.apply(this,arguments)||this;a.dirtyExtents=new r.ExtentSet;a.globalDirty=!1;a.dirtyGraphicsSet=new Set;a.handles=new p;a.updateElevation=!1;a.layerView=
null;a.graphicsCore=null;a.events=new n;return a}c.__extends(b,g);Object.defineProperty(b.prototype,"updating",{get:function(){return this.needsUpdate()},enumerable:!0,configurable:!0});b.prototype.setup=function(a,d,b,f){var e=this;this.layerView=a;this.queryGraphicUIDsInExtent=d;this.graphicsCore=b;this.elevationProvider=f;a=this.layerView.view.resourceController.scheduler;this.handles.add([f.on("elevation-change",function(a){return e.elevationUpdateHandler(a)}),this.layerView.watch("suspended",
function(){return e.suspendedChange()}),a.registerTask(t.Task.ELEVATION_ALIGNMENT,function(a){return e.update(a)},function(){return e.needsUpdate()})])};b.prototype.destroy=function(){this.dirtyGraphicsSet=null;this.handles.destroy();this.queryGraphicUIDsInExtent=this.graphicsCore=this.layerView=this.handles=null};b.prototype.clear=function(){this.dirtyGraphicsSet.clear();this.notifyChange("updating")};b.prototype.suspendedChange=function(){!0===this.layerView.suspended?this.updateElevation=!1:!1===
this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))};b.prototype.elevationInfoChange=function(){this.globalDirty=!0;this.notifyChange("updating")};b.prototype.needsUpdate=function(){return this.dirtyGraphicsSet&&0<this.dirtyGraphicsSet.size||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty};b.prototype.update=function(a){var d=this;this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,a.madeProgress());for(a.run(function(){return d.dirtyExtents.merge(a)});this.needsUpdate()&&
!a.done;)this._updateDirtyGraphics(a),this._updateDirtyExtents(a);this.layerView.view.deconflictor.setDirty();this.notifyChange("updating")};b.prototype._updateDirtyGraphics=function(a){for(var d=this,b=this.layerView.view,f=this.graphicsCore.stageLayer.id,e=this.layerView.labeling,c=function(){var c=Math.min(g.dirtyGraphicsSet.size,100);q.someSet(g.dirtyGraphicsSet,function(e){var f=d.graphicsCore.getGraphics3DGraphicById(e);d.dirtyGraphicsSet.delete(e);f&&f.alignWithElevation(d.elevationProvider,
b.renderCoordsHelper,d.graphicsCore.asyncUpdates);a.madeProgress();return 0>=--c||a.done});b._stage.processDirtyLayer(f);e&&e.processStageDirty()},g=this;0<this.dirtyGraphicsSet.size&&!a.done;)c()};b.prototype._updateDirtyExtents=function(a){for(var b=this;!this.dirtyExtents.empty&&100>this.dirtyGraphicsSet.size&&!a.done;){var c=this.dirtyExtents.pop();this.events.emit("invalidate-elevation",{extent:c,spatialReference:this.spatialReference});this.queryGraphicUIDsInExtent(c,this.spatialReference,function(a){var d=
b.graphicsCore.getGraphics3DGraphicById(a);d&&d.needsElevationUpdates()&&b.dirtyGraphicsSet.add(a)});a.madeProgress()}};b.prototype.markAllGraphicsElevationDirty=function(){var a=this;this.dirtyExtents.clear();this.dirtyGraphicsSet.clear();this.graphicsCore.graphics3DGraphics.forEach(function(b,c){return a.dirtyGraphicsSet.add(c)})};b.prototype.elevationUpdateHandler=function(a){if("scene"!==a.context||this.graphicsCore.layer.elevationInfo&&"relative-to-scene"===this.graphicsCore.layer.elevationInfo.mode){var b=
a.extent;this.spatialReference=a.spatialReference;this.layerView.suspended?(this.updateElevation||(a=this.graphicsCore.computedExtent)&&b[2]>a.xmin&&b[0]<a.xmax&&b[3]>a.ymin&&b[1]<a.ymax&&(this.updateElevation=!0),this.events.emit("invalidate-elevation",{extent:b,spatialReference:this.spatialReference})):(-Infinity===b[0]?this.globalDirty=!0:this.dirtyExtents.add(b),this.notifyChange("updating"))}};c.__decorate([l.property({readOnly:!0})],b.prototype,"updating",null);return b=c.__decorate([l.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],
b)}(m);k.default=h});