// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec4f64 ./I3SNode ./I3SUtil ../../support/orientedBoundingBox".split(" "),function(B,y,f,r,C,J,D,w,n,E){function F(c){f.isSome(c.node)&&(c.node.renderMbs[3]=-1,f.isSome(c.node.renderObb)&&(c.node.renderObb.halfSize[0]=-1));f.isSome(c.ref)&&(c.ref.renderMbs[3]=-1,f.isSome(c.ref.renderObb)&&(c.ref.renderObb.halfSize[0]=-1))}
function G(c,a){return 0===a?0:c/a|0}function x(c,a){return 0===a?c:c%a}function H(c){if(c)for(var a=0;a<c.length;a++)for(var b=0,d=K;b<d.length;b++){var h=d[b];if(h[0]===c[a].metricType)return{lodMetric:h[1],maxError:c[a].maxError}}return{lodMetric:0,maxError:0}}function L(c){return Math.sqrt(4/Math.PI*c)}Object.defineProperty(y,"__esModule",{value:!0});var I=function(){return function(c,a,b,d,h){this.childOffset=c;this.childCount=a;this.visibilityCache=b;this.ref=d;this.node=h;this.useAsHole=0}}();
B=function(){function c(a,b,d,c,e,f,l,g,q,m,u){this.streamDataController=b;this.viewportQueries=d;this.logger=c;this.holeFilling=e;this._isLoaded=f;this._isSelected=l;this._enable=g;this._needsUpdate=q;this._canRequest=m;this._computeAuthorativeOBB=u;this._dirty=!0;this.nodePages=[];this.lodMetric=this.rootIndex=this.nodesPerPage=this.nodeCount=0;this.lodConversion=function(a){return a};this._loading=new Set;this._failedNodes=new Set;this._failedPages=new Set;this._indexMissing=1;this._maxUnloadedPrio=
Number.NEGATIVE_INFINITY;this._maxProcessingPrio=Number.POSITIVE_INFINITY;this._nodeTraversalState={};this._version=n.addWraparound(0,2);this._visibilityCacheVersion=n.addWraparound(0,2);this._maxLevel=1;this._featureEstimate={estimate:0,leafsReached:!1};this._unloadedMemoryEstimate=0;this._missing=new r({deallocator:null});this._prefetch=new r({deallocator:null});this._updates=new M;this.ignoreServiceOBB=!1;this.progressiveLoadPenalty=0;this.layerUrl=a.parsedUrl.path;this.rootId=a.rootNode&&a.rootNode.split("/").pop();
a.serviceUpdateTimeStamp&&a.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=""+a.serviceUpdateTimeStamp.lastUpdate);this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1;a.nodePages?this.initNodePages(a.nodePages):this.initNodeDocuments(this.rootId)}c.prototype.initNodePages=function(a){this.nodesPerPage=a.nodesPerPage;this.rootIndex=a.rootIndex;switch(a.lodSelectionMetricType){case "maxScreenThreshold":this.lodMetric=1;break;case "maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=
L}};c.prototype.initNodeDocuments=function(a){this.rootIndex=this.nodesPerPage=0;this.nodePages.push({nodes:[],children:[],parents:[]});this.makeRefNode(new w.NodeBase(a,null),-1)};c.prototype.loadPage=function(a){var b=this;this._loading.add(a);this.streamDataController.request(this.layerUrl+"/nodepages/"+a,"json").then(function(d){b._loading.delete(a);b.addPage(a,d)}).catch(function(d){b._loading.delete(a);if(!C.isAbortError(d)){if(0===b.nodePages.length)return b.initNodeDocuments(b.rootId);b._failedPages.add(a);
b.logger.error("Error when loading page "+a,d)}})};c.prototype.addPage=function(a,b){for(var d=this,c=this.nodePages.length;c<a;c++)this.nodePages[c]=null;var e=[],f=[];b=b.nodes.map(function(b,c){var l=e.length,h=b.children?b.children.length:0;f.push(-1);for(var g=0;g<h;g++)e.push(b.children[g]);var k=""+b.index,g=E.clone(b.obb),m=D.vec4f64.fromArray([g.center[0],g.center[1],g.center[2],J.vec3.length(g.halfSize)]),z=b.mesh&&b.mesh.attribute,p=b.mesh&&b.mesh.geometry,v=b.mesh&&b.mesh.material;b=new w.Node(k,
a*d.nodesPerPage+c,m,h,0,{hasSharedResource:!1,hasFeatureData:!!p,attributes:z&&null!=z.resource?""+z.resource:null,geometry:p&&null!=p.resource?""+p.resource:null,texture:v&&null!=v.resource?""+v.resource:null,geometryDefinition:p?p.definition:-1,materialDefinition:v?v.definition:-1},d.lastUpdate,d.lodMetric,d.lodConversion(b.lodThreshold),p?p.featureCount:null);b.obb=g;b.authorativeObb=d._computeAuthorativeOBB(b);b.vertexCount=p?p.vertexCount:0;return new I(l,h,n.addWraparound(d._visibilityCacheVersion,
-2),null,b)});this.nodePages[a]={nodes:b,children:e,parents:f};this.nodeCount+=b.length;this.updateParentsAndLevel()};c.prototype.updateParentsAndLevel=function(){var a=this,b=[],d=function(d,c,l){var e=a.getPage(d);if(f.isSome(e)){var h=x(d,a.nodesPerPage);e.parents[h]=c;c=e.nodes[h].node;f.isSome(c)&&(c.level=l,b.push(d))}};for(d(this.rootIndex,-1,0);b.length;){var c=b.pop(),e=this.getNode(c);if(f.isSome(e))for(var k=0;k<e.childCount;k++){var l=this.getChildIndex(e,k);d(l,c,e.level+1)}}};c.prototype.getPage=
function(a){return this.nodePages[G(a,this.nodesPerPage)]};c.prototype.getNodeInternal=function(a){var b=this.getPage(a);return f.isNone(b)?null:b.nodes[x(a,this.nodesPerPage)]};c.prototype.addNode=function(a,b){null!=a.children&&this.populateChildren(b,a.children);var d=this.getParent(b),d=f.isSome(d)?d.level+1:1;this._maxLevel=Math.max(this._maxLevel,d);var c=H(a.lodSelection),e=c.lodMetric,c=c.maxError,k=f.unwrap(this.getNodeInternal(b));k.node=new w.Node(a.id,b,D.vec4f64.fromArray(a.mbs),k.childCount,
d,a.resources,a.version,e,c,a.numFeatures);a.obb&&(k.node.obb=E.clone(a.obb));k.node.authorativeObb=this._computeAuthorativeOBB(k.node);f.isSome(k.ref)&&(null==k.ref.mbs&&(k.ref.mbs=a.mbs),k.node.renderMbs=k.ref.renderMbs,k.node.renderObb=k.ref.renderObb,k.ref.authorativeObb=k.node.authorativeObb);return k.node};c.prototype.makeRefNode=function(a,b){var d=this.nodePages[0],c=d.nodes.length;d.nodes.push(new I(0,0,n.addWraparound(this._visibilityCacheVersion,-2),a,null));this.nodeCount++;d.parents.push(b);
a.renderMbs[3]=-1;f.isSome(a.renderObb)&&(a.renderObb.halfSize[0]=-1);return c};c.prototype.populateChildren=function(a,b){var d=f.unwrap(this.getNodeInternal(a)),c=f.unwrap(this.getPage(a));d.childOffset=c.children.length;d.childCount=b.length;for(d=0;d<b.length;d++){var e=this.makeRefNode(b[d],a);c.children.push(e)}};c.prototype.getNode=function(a){a=this.getNodeInternal(a);return f.isSome(a)?a.node:null};c.prototype.getIndexById=function(a){var b;this.forAllNodes(function(d,c){f.isSome(d.node)&&
d.node.id===a?b=c:f.isSome(d.ref)&&d.ref.id===a&&(b=c)});return b};c.prototype.getNodeById=function(a){a=this.getIndexById(a);return 0<=a?this.getNode(a):null};c.prototype.getChildIndex=function(a,b){var d=this.getPage(a.index);if(f.isNone(d))return-1;a=d.nodes[x(a.index,this.nodesPerPage)];return d.children[a.childOffset+b]};c.prototype.getParentIndex=function(a){var b=this.getPage(a);return f.isSome(b)?b.parents[x(a,this.nodesPerPage)]:-1};c.prototype.getParent=function(a){a=this.getParentIndex(a);
return 0<=a?this.getNode(a):null};c.prototype.isLeaf=function(a){a=this.getNodeInternal(a);return f.isSome(a)&&0===a.childCount};Object.defineProperty(c.prototype,"rootNode",{get:function(){return this.getNode(this.rootIndex)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"size",{get:function(){return this.nodeCount},enumerable:!0,configurable:!0});c.prototype.invalidateVisibilityCache=function(a){null==a?this._visibilityCacheVersion=n.addWraparound(this._visibilityCacheVersion,
2):(a=this.getNodeInternal(a),f.isSome(a)&&(a.visibilityCache=n.addWraparound(this._visibilityCacheVersion,-2)))};c.prototype.invalidateBoundingVolumeCache=function(a){a=this.getNodeInternal(a);f.isSome(a)&&(F(a),a.visibilityCache=n.addWraparound(this._visibilityCacheVersion,-2))};c.prototype.invalidateComputedOBBs=function(){f.isNone(this.rootNode)||this.traverse(this.rootNode,function(a){a.isComputedObb&&(a.obb=null);a.renderMbs[3]=-1;f.isSome(a.renderObb)&&(a.renderObb.halfSize[0]=-1);return!0})};
c.prototype.recomputeAuthorativeOBBs=function(){var a=this;f.isNone(this.rootNode)||this.traverse(this.rootNode,function(b){b.authorativeObb=a._computeAuthorativeOBB(b);return!0})};c.prototype.isNodeVisible=function(a){a=this.getNodeInternal(a);if(f.isNone(a)||f.isSome(a.ref)&&!a.ref.mbs)return!0;if((a.visibilityCache&-2)!==this._visibilityCacheVersion){var b=!0;f.isSome(a.node)&&(f.isNone(a.ref)||f.isSome(a.node.authorativeObb))?b=this.viewportQueries.isNodeVisible(a.node):f.isSome(a.ref)&&(b=this.viewportQueries.isNodeVisible(a.ref));
a.visibilityCache=this._visibilityCacheVersion+(b?1:0);return b}return 1===(a.visibilityCache&1)};c.prototype.isGeometryVisible=function(a){if(!this.isNodeVisible(a))return!1;a=this.getNodeInternal(a);return f.isNone(a)?!0:f.isSome(a.node)&&f.isSome(a.ref)&&!a.ref.obb?this.viewportQueries.isGeometryVisible(a.node):!0};c.prototype._traverseCoverage=function(a,b,d,c,e){var h=this.getPage(a);if(!f.isNone(h)&&0!==b.childCount){var l=b.childOffset+b.childCount;a=[];for(var g=b.childOffset;g<l;++g){b=h.children[g];
var q=this.getNodeInternal(b);f.isSome(q)&&f.isSome(q.node)&&this.isGeometryVisible(b)&&a.push(q)}c/=a.length;for(h=0;h<a.length;h++)q=a[h],b=f.unwrap(q.node).index,this._isLoaded(b)?(e.delta=Math.max(e.delta,d),e.coverage+=c):this._traverseCoverage(b,q,d+1,c,e)}};c.prototype.useNodeAsHole=function(a){if("off"===this.holeFilling)return!1;var b=this.getNodeInternal(a);if(f.isNone(b))return!1;if("always"===this.holeFilling)return!0;if((b.useAsHole&-2)===this._version)return 1===(b.useAsHole&1);var d=
{delta:0,coverage:0};this._traverseCoverage(a,b,0,1,d);a=.5>=d.delta*d.coverage;b.useAsHole=this._version+(a?1:0);return a};Object.defineProperty(c.prototype,"maxLevel",{get:function(){return this._maxLevel},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"dirty",{get:function(){return this._dirty},enumerable:!0,configurable:!0});c.prototype.destroy=function(){this._updates.add.prune();this._updates.update.prune()};c.prototype.requestUpdate=function(){this._dirty=!0;this._indexMissing=
1;this._version=n.addWraparound(this._version,2)};c.prototype.update=function(a,b){var d=this;if(this._dirty){this._maxProcessingPrio=this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._missing.clear();this._prefetch.clear();this._updates.reset(a,this._missing);m.clear();var c=!0,e=new A,k=new A;this.traverseVisible(function(l,g){if(g){var h=g.node;d._updateNodeFeatureEstimate(h,k);if(f.isNone(h))g=d.entryPriority(l),d._loading.has(l)||d._failedNodes.has(l)||(d._missing.push(l),m.set(l,g)),d._maxProcessingPrio=
Math.max(d._maxProcessingPrio,g);else{var n=f.unwrap(d.getPage(l));if(0===d._missing.length&&0===d.nodesPerPage)for(var u=0;u<g.childCount;u++){var t=n.children[g.childOffset+u],r=d.getNodeInternal(t);!f.isSome(r)||r.node||d._loading.has(t)||d._failedNodes.has(t)||(m.set(t,d.entryPriority(t)),d._prefetch.push(t))}!h.failed&&h.resources.hasFeatureData&&(d._isLoaded(l)?(e.known+=h.memory,++e.knownNodes,d._isSelected(h)?0<g.childCount&&(c=!1):(e.unremoved+=h.memory,c=!1),d._needsUpdate(h)&&(g=d.entryPriority(l),
m.set(l,g),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,g),d._updates.update.push(l))):(h.memory&&(e.known+=h.memory,++e.knownNodes),d._isSelected(h)&&(0<g.childCount&&(c=!1),h.memory?(e.missing+=h.memory,e.known+=h.memory,++e.knownNodes):++e.missingNodes,0<=a.indexOf(h.index)?(d._maxProcessingPrio=Math.max(d._maxProcessingPrio,d.entryPriority(l)),d._updates.cancel=d._updates.cancel.filter(function(a){return a!==h.index})):!b.done&&d._enable(h)?b.madeProgress():(g=d.entryPriority(l),m.set(l,
g),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,g),d._updates.add.push(l)))))}}else g=d.entryPriority(l),l=G(l,d.nodesPerPage),m.set(l,Math.max(g,m.get(l)||0)),d._loading.has(l)||d._failedPages.has(l)||d._missing.push(l),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,g)});this._unloadedMemoryEstimate=e.missing-e.unremoved;3<e.knownNodes&&0<e.missingNodes&&(this._unloadedMemoryEstimate+=e.known/e.knownNodes*e.missingNodes);this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate);
this._featureEstimate.estimate=this._computeFeatureEstimate(k);this._featureEstimate.leafsReached=c;this._missing.sort(function(a,b){return a-b});this._missing.filterInPlace(function(a,b){return 1>b||d._missing.data[b-1]!==a});this._missing.sort(function(a,b){return m.get(a)-m.get(b)});0<this._missing.length?(this._maxUnloadedPrio=m.get(this._missing.back()),this._prefetch.clear()):this._prefetch.sort(function(a,b){return m.get(a)-m.get(b)});this._updates.add.filterInPlace(function(a){return m.get(a)>=
d._maxUnloadedPrio}).sort(function(a,b){return m.get(a)-m.get(b)});this._updates.update.sort(function(a,b){return m.get(a)-m.get(b)});this._indexMissing=this._loading.size+this._missing.length;this._dirty=0<this._indexMissing;m.clear()}};c.prototype.checkFeatureTarget=function(a,b){for(var d=this.viewportQueries.updateScreenSpaceErrorBias(b),c=b,e=b,f=d,l=10;l--;){var g=new A;this._updateFeatureEstimate(c,g);if(this._computeFeatureEstimate(g)<=a){if(c>=b||0<g.missingNodes||0===l)break;f=c;c=.5*(c+
e)}else e=c,c=.5*(c+f)}this._version=n.addWraparound(this._version,2);this.viewportQueries.updateScreenSpaceErrorBias(d);return Math.min(b,c)};c.prototype._updateFeatureEstimate=function(a,b){var d=this;this._version=n.addWraparound(this._version,2);this.viewportQueries.updateScreenSpaceErrorBias(a);this.traverseVisible(function(a,c){return d._updateNodeFeatureEstimate(c&&c.node,b)})};c.prototype._updateNodeFeatureEstimate=function(a,b){f.isNone(a)||a.failed||f.isNone(a.numFeatures)||(this._isLoaded(a.index)?
(b.known+=a.numFeatures,++b.knownNodes,this._isSelected(a)||(b.unremoved+=a.numFeatures)):this._isSelected(a)&&(f.isSome(a.numFeatures)?(b.missing+=a.numFeatures,b.known+=a.numFeatures,++b.knownNodes):++b.missingNodes))};c.prototype._computeFeatureEstimate=function(a){var b=a.known-a.unremoved;3<a.knownNodes&&0<a.missingNodes&&(b+=a.known/a.knownNodes*a.missingNodes);return Math.max(0,b)};c.prototype.load=function(){return this._load(this._missing)};c.prototype.prefetch=function(){return this._load(this._prefetch)};
c.prototype._load=function(a){if(0===a.length||!this._canRequest())return!1;for(;0<a.length&&this._canRequest();)0===this.nodesPerPage?this._loadNode(a.pop()):this.loadPage(a.pop());return!0};c.prototype.isLoading=function(){return 0<this._indexMissing};c.prototype.getIndexLoading=function(){return this._loading.size};c.prototype.getIndexMissing=function(){return this._indexMissing};c.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate};Object.defineProperty(c.prototype,
"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0});c.prototype.getFeatureEstimate=function(){return this._featureEstimate};c.prototype.nodeTraversalState=function(a){if(f.isNone(a))return null;var b=this._nodeTraversalState[a.index];if(b&&(b.version&-2)===this._version)return b;var d=this.viewportQueries.getLodLevel(a),c=this.viewportQueries.hasLOD(a),e=!0;c?(e=this.getParentIndex(a.index),e=0<=e?(e=this._nodeTraversalState[e])&&d>e.lodLevel:0<d):e=0===a.childCount;if(b)return b.lodLevel=
d,b.isChosen=e,b.version=this._version+1,b;this._nodeTraversalState[a.index]={nodeHasLOD:c,lodLevel:d,isChosen:e,version:this._version+1};return this._nodeTraversalState[a.index]};c.prototype._loadNode=function(a){var b=this;this._loading.add(a);var d=f.unwrap(this.getNodeInternal(a)).ref;if(f.isNone(d))this._failedNodes.add(a);else{var c=d.id,e=this.layerUrl+"/nodes/"+c,k=function(){b._loading.delete(a);0===b._missing.length&&0===b._loading.size&&b.requestUpdate()};this.streamDataController.request(e,
"json").then(function(d){d=b._validateNode(c,d);null!=d&&(d.obb&&b.invalidateVisibilityCache(a),d=b.addNode(d,a),b.nodeTraversalState(d));k()},function(d){C.isAbortError(d)||(b.logger.error("Error loading node: "+e),b._failedNodes.add(a));k()})}};c.prototype._validateNode=function(a,b){var d=this;if(null==b||"object"!==typeof b||b.id!==a)return this.logger.error('Invalid node. Wrong type or wrong id "'+a+'"'),null;b.sharedResource&&"./shared"!==b.sharedResource.href&&"./shared/"!==b.sharedResource.href&&
this.logger.warn('Invalid shared resource href on node "'+a+'"');null==b.geometryData||Array.isArray(b.geometryData)&&1===b.geometryData.length&&"./geometries/0"===b.geometryData[0].href||this.logger.warn('Invalid geometry data on node "'+a+'"');null==b.attributeData||Array.isArray(b.attributeData)&&!b.attributeData.some(function(a,b){return a.href!=="./attributes/f_"+b+"/0"})||this.logger.warn('Invalid attribute data on node "'+a+'"');b.featureData&&1<b.featureData.length&&this.logger.warn("Node "+
a+" has "+b.featureData.length+" bundles. Only the first bundle will be loaded.");var c=b.hasOwnProperty("obb")&&!this.ignoreServiceOBB?b.obb:null,e=b.featureData&&1===b.featureData.length&&b.featureData[0].featureRange?b.featureData[0].featureRange[1]-b.featureData[0].featureRange[0]+1:null,f=function(b){if(null==b)return null;var c=function(b){return d.logger.error("Invalid node reference on node "+a+": "+b)};if("number"===typeof b.id)c("id "+b.id+" is a number instead of a string.");else if("string"!==
typeof b.id||!Array.isArray(b.mbs))return c("Missing or invalid id."),null;if(!Array.isArray(b.mbs))return c("Invalid bounding volume on reference "+b.id+"."),null;b.href&&b.href!=="../"+b.id&&d.logger.error('Invalid node href on node "'+a+'"');c=b.hasOwnProperty("obb")&&!d.ignoreServiceOBB?b.obb:null;b=new w.NodeBase(""+b.id,b.mbs);b.obb=c;return b},f=Array.isArray(b.children)?b.children.map(f).filter(function(a){return null!=a}):null;return{id:a,mbs:b.mbs,obb:c,children:f,resources:{hasFeatureData:b.featureData&&
0<b.featureData.length,hasSharedResource:null!=b.sharedResource,attributes:b.attributeData?a:null,texture:b.textureData&&0<b.textureData.length?a:null,geometry:null!=b.geometryData?a:null},version:"string"===typeof b.version?b.version:null,lodSelection:Array.isArray(b.lodSelection)?b.lodSelection:null,numFeatures:e}};c.prototype.resetFailedNodes=function(){this._failedNodes.clear();this._failedPages.clear();this.forAllNodes(function(a){f.isSome(a.node)&&(a.node.failed=!1)})};c.prototype.entryPriority=
function(a){var b=this.getNodeInternal(a),d=this.getParentIndex(a);if(f.isNone(b)||0>d&&null==b.node)return 0>d?Infinity:this.entryPriority(d);var c=0;b.node&&0<=d&&(d=this._nodeTraversalState[d],null!=d&&(c=d.lodLevel));for(d=this.progressiveLoadPenalty;0<=a;a=this.getParentIndex(a))if(this._isLoaded(a)){d=0;break}b=f.isSome(b.ref)?this.viewportQueries.distToPOI(b.ref):f.isSome(b.node)?this.viewportQueries.distToPOI(b.node):0;return-b-c*(b+this.progressiveLoadPenalty)+d};c.prototype.traverseVisible=
function(a){var b=this.getNodeInternal(this.rootIndex);f.isNone(b)?a(this.rootIndex,null):this._traverseVisible(this.rootIndex,b,a)};c.prototype._traverseVisible=function(a,b,d){if(b.node&&0===b.childCount)this.isGeometryVisible(a)&&d(a,b);else if(this.isNodeVisible(a)&&(d(a,b),null!=b.node)){var c=this.nodeTraversalState(b.node);if(!c.nodeHasLOD||c.lodLevel!==this._maxLodLevel)for(a=f.unwrap(this.getPage(a)),c=0;c<b.childCount;c++){var e=a.children[b.childOffset+c],k=this.getNodeInternal(e);f.isSome(k)?
this._traverseVisible(e,k,d):d(e,null)}}};c.prototype.traverse=function(a,b){b(a)&&this.traverseChildren(a,b)};c.prototype.traverseChildren=function(a,b){a=a.index;var c=this.getNodeInternal(a);f.isSome(c)&&this._traverseChildren(a,c,b)};c.prototype._traverseChildren=function(a,b,c){a=this.getPage(a);if(!f.isNone(a)){var d=b.childOffset+b.childCount;for(b=b.childOffset;b<d;++b){var e=a.children[b],k=this.getNodeInternal(e);f.isSome(k)&&f.isSome(k.node)&&c(k.node)&&this._traverseChildren(e,k,c)}}};
c.prototype.updateStats=function(a){0<this._updates.add.length&&(a.nodes+=" + "+this._updates.add.length);if(this._indexMissing||0<this._prefetch.length)a.index+=" + "+this._indexMissing||this._prefetch.length;a.prio=this._maxProcessingPrio;if(this._featureEstimate.estimate){var b=this._featureEstimate.estimate-a.features;0<b?a.features+=" + "+b:0>b&&(a.features+=" - "+-b)}};c.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)};c.prototype.updateElevationInfo=
function(a){this.forAllNodes(F);this.viewportQueries.updateElevationInfo(a)};c.prototype.forAllNodes=function(a){for(var b=0;b<this.nodePages.length;b++){var c=this.nodePages[b];if(c)for(var f=b*this.nodesPerPage,e=0;e<c.nodes.length;e++)a(c.nodes[e],f+e)}};Object.defineProperty(c.prototype,"test",{get:function(){var a=this;return{addNode:function(b,c){return a.addNode(b,c)}}},enumerable:!0,configurable:!0});return c}();y.I3SIndex=B;var m=new Map,M=function(){function c(){this.update=new r({deallocator:null});
this.add=new r({deallocator:null});this.cancel=[]}c.prototype.reset=function(a,b){this.add.clear();this.update.clear();this.cancel=a;this.missing=b};return c}(),K=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];y.selectErrorMetric=H;var A=function(){return function(){this.unremoved=this.missingNodes=this.missing=this.knownNodes=this.known=0}}()});