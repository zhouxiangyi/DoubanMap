// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../Color ../../../../core/arrayUtils ../../../../core/compilerUtils ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ./elevationAlignmentUtils ./ElevationContext ./featureExpressionInfoUtils ./graphicUtils ./Loadable ./symbolComplexity".split(" "),function(n,k,u,v,w,x,y,r,h,z,A,p,B,C,q,D,E){function l(g,b){g=null!=g?b.attributes[g]:0;return null!=g&&isFinite(g)?
g:0}Object.defineProperty(k,"__esModule",{value:!0});var m=y.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");n=function(g){function b(a,c,d,b){var e=g.call(this)||this;e._elevationInfoOverride=null;e.complexity=null;e.logger=m;e._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0};e.symbol=a;e.symbolLayer=c;e._context=d;e._renderPriority=b.renderPriority;e._renderPriorityStep=b.renderPriorityStep;e._elevationContext=new B.ElevationContext;e.complexity=e.computeComplexity();
e._updateDrivenProperties(b.ignoreDrivers);e._updateElevationContext();return e}u.__extends(b,g);b.prototype.getCachedSize=function(){return null};Object.defineProperty(b.prototype,"needsDrivenTransparentPass",{get:function(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque},enumerable:!0,configurable:!0});b.prototype._logGeometryCreationWarnings=function(a,c,d,b){var e="polygons"in a?a.polygons:null;b+=" geometry failed to be created";var f=null;a.projectionSuccess?
!c.length||1===c.length&&!c[0].length?f=b+" (no "+d+" were defined)":Array.isArray(c)&&Array.isArray(c[0])?c.some(function(a){return 1===a.length})?f=b+" ("+d+" should contain at least 2 vertices)":e&&0===e.length&&"rings"===d&&(f=b+" (filled "+d+" should use clockwise winding - try reversing the order of vertices)"):f=b+" ("+d+" should be defined as a 2D array)":f=b+" (failed to project geometry to view spatial reference)";f&&m.warnOncePerTick(f)};b.prototype._validateGeometryType=function(a,c,b){if(w.includes(c,
a.type))return!0;this.logger.warn("unsupported geometry type for "+b+(" symbol: "+a.type));return!1};b.prototype._validateGeometry=function(a){return"point"!==a.type||r.isFinite(a.x)&&r.isFinite(a.y)?!0:(m.warn("point coordinate is not a valid number, graphic skipped"),!1)};b.prototype._defaultElevationInfoNoZ=function(){return F};b.prototype._defaultElevationInfoZ=function(){return G};b.prototype._updateElevationContext=function(){h.isSome(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),
this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()};b.prototype.getDefaultElevationInfo=function(a){return a.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()};b.prototype.getGeometryElevationMode=function(a,c){void 0===c&&
(c=this.getDefaultElevationInfo(a));return this._elevationContext.mode||c.mode};b.prototype.setElevationInfoOverride=function(a){this._elevationInfoOverride=a;this._updateElevationContext()};b.prototype.setGraphicElevationContext=function(a,c){var b=h.unwrap(a.geometry),f=this.getDefaultElevationInfo(b);c.unit=null!=this._elevationContext.unit?this._elevationContext.unit:f.unit;c.mode=this.getGeometryElevationMode(b,f);c.offsetMeters=h.unwrapOr(this._elevationContext.meterUnitOffset,h.unwrapOr(f.offset,
0));if(b=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===c.mode)c.mode="relative-to-ground",c.offsetMeters=0;c.updateFeatureExpressionInfoContext(b?C.zeroContext:this._elevationContext.featureExpressionInfoContext,a,this._context.layer);return c};b.prototype.prepareSymbolLayerPatch=function(a){};b.prototype.updateGeometry=function(a,c){return!1};b.prototype.onRemoveGraphic=function(a){};b.prototype._updateDrivenProperties=function(a){var c={color:!1,opacity:!1,opacityAlwaysOpaque:!0,
size:!1};a||(a=this._context.renderer)&&"visualVariables"in a&&a.visualVariables&&a.visualVariables.forEach(function(a){switch(a.type){case "color":c.color=!0;if(a.stops)for(var b=0;b<a.stops.length;b++){var d=a.stops[b].color;d&&(c.opacity=!0,1>d.a&&(c.opacityAlwaysOpaque=!1))}break;case "opacity":c.opacity=!0;c.opacityAlwaysOpaque=!1;break;case "size":c.size=!0}});this._drivenProperties=c};b.prototype._getLayerOpacity=function(){if(this._context.layerView&&"fullOpacity"in this._context.layerView)return this._context.layerView.fullOpacity;
var a=this._context.layer.opacity;return null==a?1:a};b.prototype._getCombinedOpacity=function(a,c){void 0===c&&(c=t);var b=1;this.draped||(b*=this._getLayerOpacity());if(this._drivenProperties.opacity)return b;h.isSome(a)?b*=a.a:c.hasIntrinsicColor||(b=0);return b};b.prototype._getCombinedOpacityAndColor=function(a,b){void 0===b&&(b=t);b=this._getCombinedOpacity(a,b);if(this._drivenProperties.color)return q.mixinColorAndOpacity(null,b);a=h.isSome(a)?v.toUnitRGB(a):z.vec3f64.ONES;return q.mixinColorAndOpacity(a,
b)};b.prototype._getVertexOpacityAndColor=function(a,b,d){a=q.mixinColorAndOpacity(this._drivenProperties.color?a.color:null,this._drivenProperties.opacity?a.opacity:null);d&&(a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d);return b?new b(a):a};b.prototype._getIdHint=function(a){void 0===a&&(a="");return this._context.layer.id+"_symbol"+a};b.prototype.isFastUpdatesEnabled=function(){return this._fastUpdates&&this._fastUpdates.enabled};b.prototype.computeComplexity=function(){return E.defaultSymbolLayerComplexity(this.symbol,
this.symbolLayer)};b.prototype.destroy=function(){this.abortLoad()};b.prototype.globalPropertyChanged=function(a,b,d){switch(a){case "opacity":return this.layerOpacityChanged(b,d);case "elevationInfo":return a=this._elevationContext.mode,this._updateElevationContext(),this.layerElevationInfoChanged(b,d,a)===p.SymbolUpdateType.RECREATE?!1:!0;case "slicePlaneEnabled":return this.slicePlaneEnabledChanged(b,d);case "physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case "pixelRatio":return this.pixelRatioChanged();
default:return x.neverReachedSilent(a),!1}};b.prototype.updateGraphics3DGraphicElevationInfo=function(a,b,d){var c=this,e=p.SymbolUpdateType.UPDATE;a.forEach(function(a){var f=b(a);h.isSome(f)?(c.setGraphicElevationContext(a.graphic,f.elevationContext),f.needsElevationUpdates=d(f.elevationContext.mode)):e=p.SymbolUpdateType.RECREATE});return e};b.prototype.applyRendererDiff=function(a,b){return!1};b.prototype.getFastUpdateAttrValues=function(a){if(!this._fastUpdates.enabled)return null;var b=this._fastUpdates.visualVariables,
d=b.size?l(b.size.field,a):0,f=b.color?l(b.color.field,a):0;a=b.opacity?l(b.opacity.field,a):0;return A.vec4f64.fromValues(d,f,a,0)};Object.defineProperty(b.prototype,"draped",{get:function(){return this._draped},enumerable:!0,configurable:!0});b.prototype.ensureDrapedStatus=function(a){if(null==this._draped)return this._draped=a,!0;a!==this.draped&&m.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary.");
return!1};return b}(D.Loadable);k.Graphics3DSymbolLayer=n;k.getAttributeValue=l;var F={mode:"on-the-ground",offset:0,unit:"meters"},G={mode:"absolute-height",offset:0,unit:"meters"},t={hasIntrinsicColor:!1};k.default=n});