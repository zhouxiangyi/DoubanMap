// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Color ../../core/Logger ../cim/CIMPlacements ./CIMSymbolDrawHelper ./packingUtils".split(" "),function(m,q,y,z,A,w,t,B){function u(e,a){switch(a.type){case "CIMSymbolReference":var b={type:"point",x:0,y:0};e.drawSymbol(a.symbol,b);break;case "CIMPointSymbol":b={type:"point",x:0,y:0};e.drawSymbol(a,b);break;case "CIMVectorMarker":b=new w.Placement,e.drawMarker(a,b)}return e.envelope()}Object.defineProperty(q,"__esModule",{value:!0});var x=Math.PI,C=x/2,v=A.getLogger("esri.symbols.cim.CIMSymbolHelper");
m=function(){function e(){}e.getEnvelope=function(a){var b=new t.EnvDrawHelper;if(Array.isArray(a)){for(var c=void 0,d=0;d<a.length;d++){var e=a[d];c?c.union(u(b,e)):c=u(b,e)}return c}return u(b,a)};e.getTextureAnchor=function(a){a=this.getEnvelope(a);if(!a||0>=a.width||0>=a.height)return[0,0,0];var b=96/72,c=a.height*b+2;return[(a.x+.5*a.width)*b/(a.width*b+2),-(a.y+.5*a.height)*b/c,c]};e.rasterize=function(a,b,c,d){void 0===d&&(d=!0);var e=c||this.getEnvelope(b);if(!e||0>=e.width||0>=e.height)return[null,
0,0,0,0];var f=96/72,g=(e.x+.5*e.width)*f,k=(e.y+.5*e.height)*f;a.width=e.width*f;a.height=e.height*f;c||(a.width+=2,a.height+=2);c=a.getContext("2d");f=t.Transformation.createScale(f,-f);f.translate(.5*a.width-g,.5*a.height+k);f=new t.CanvasDrawHelper(c,f);switch(b.type){case "CIMPointSymbol":f.drawSymbol(b,{type:"point",x:0,y:0});break;case "CIMVectorMarker":e=new w.Placement,f.drawMarker(b,e)}b=c.getImageData(0,0,a.width,a.height);b=new Uint8Array(b.data);if(d)for(d=void 0,c=0;c<b.length;c+=4)d=
b[c+3]/255,b[c]*=d,b[c+1]*=d,b[c+2]*=d;return[b,a.width,a.height,-g/a.width,-k/a.height]};e.fromSimpleMarker=function(a){var b,c,d=a.style;if("circle"===d||"esriSMSCircle"===d){b=Math.acos(.995);c=Math.ceil(x/b/4);0===c&&(c=1);b=C/c;c*=4;d=[];d.push([50,0]);for(var e=1;e<c;e++)d.push([50*Math.cos(e*b),-50*Math.sin(e*b)]);d.push([50,0]);b={rings:[d]};c={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("cross"===d||"esriSMSCross"===d)b=0,b={rings:[[[b,50],[b,b],[50,b],[50,-b],[b,-b],[b,-50],[-b,-50],[-b,
-b],[-50,-b],[-50,b],[-b,b],[-b,50],[b,50]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("diamond"===d||"esriSMSDiamond"===d)b={rings:[[[-50,0],[0,50],[50,0],[0,-50],[-50,0]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("square"===d||"esriSMSSquare"===d)b={rings:[[[-50,-50],[-50,50],[50,50],[50,-50],[-50,-50]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("x"===d||"esriSMSX"===d)b=0,b={rings:[[[0,b],[50-b,50],[50,50-b],[b,0],[50,b-50],[50-b,-50],[0,-b],[b-50,-50],[-50,b-50],[-b,0],[-50,50-
b],[b-50,50],[0,b]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("triangle"===d||"esriSMSTriangle"===d)c=2/3*100,d=c-100,b={rings:[[[-57.735026918962575,d],[0,c],[57.735026918962575,d],[-57.735026918962575,d]]]},c={xmin:-57.735026918962575,ymin:d,xmax:57.735026918962575,ymax:c};else if("arrow"===d||"esriSMSArrow"===d)b={rings:[[[-50,50],[50,0],[-50,-50],[-33,-20],[-33,20],[-50,50]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};var f;b&&c&&(f=[{type:"CIMSolidFill",enable:!0,color:a.color}],a.outline&&
f.push({type:"CIMSolidStroke",enable:!0,width:a.outline.width,color:a.outline.color}),f={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:a.angle,size:a.size,offsetX:a.xoffset,offsetY:a.yoffset,frame:c,markerGraphics:[{type:"CIMMarkerGraphic",geometry:b,symbol:{type:"CIMPolygonSymbol",symbolLayers:f}}]}]});return f};e.fromCIMHatchFill=function(a){for(var b=void 0!==a.separation?a.separation:4,c=b/2,d=this._getLineSymbolPeriod(a.lineSymbol)||4;4>d;)d*=2;d/=2;return{type:"CIMVectorMarker",
frame:{xmin:-d,xmax:d,ymin:-c,ymax:c},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{paths:[[[-d,0],[d,0]]]},symbol:a.lineSymbol}],size:b}};e._getLineSymbolPeriod=function(a){if(a){var b=this._getEffectsRepeat(a.effects);if(b)return b;if(a.symbolLayers)for(b=0,a=a.symbolLayers;b<a.length;b++){var c=a[b],d=this._getEffectsRepeat(c.effects);if(d)return d;if(c&&(c=this._getPlacementRepeat(c.markerPlacement)))return c}}return 0};e._getEffectsRepeat=function(a){if(a)for(var b=0;b<a.length;b++){var c=
a[b];if(c)switch(c.type){case "CIMGeometricEffectDashes":if((c=c.dashTemplate)&&c.length){for(var b=a=0,d=c;b<d.length;b++)a+=d[b];c.length&1&&(a*=2);return a}break;case "CIMGeometricEffectWave":return c.period;default:v.error("unsupported geometric effect type "+c.type)}}return 0};e._getPlacementRepeat=function(a){if(a)switch(a.type){case "CIMMarkerPlacementAlongLineSameSize":case "CIMMarkerPlacementAlongLineRandomSize":case "CIMMarkerPlacementAlongLineVariableSize":if((a=a.placementTemplate)&&a.length){for(var b=
0,c=0;c<a.length;c++)b+=a[c];a.length&1&&(b*=2);return b}}return 0};e.fromCIMInsidePolygon=function(a){var b=a.markerPlacement,c=b.stepX/2,d=b.stepY/2,c={xmin:-c,xmax:c,ymin:-d,ymax:d};a=y.__assign({type:a.type},a);a.markerPlacement=null;a.anchorPoint=null;return{type:"CIMVectorMarker",frame:c,markerGraphics:[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:{type:"CIMPointSymbol",symbolLayers:[a]}}],size:b.stepY}};e.getFillColor=function(a){if(!a)return null;switch(a.type){case "CIMPolygonSymbol":if(a.symbolLayers){var b=
0;for(a=a.symbolLayers;b<a.length;b++){var c=e.getFillColor(a[b]);if(null!=c)return c}}break;case "CIMTextSymbol":return e.getFillColor(a.symbol);case "CIMSolidFill":return a.color}};e.getStrokeColor=function(a){if(a)switch(a.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(a.symbolLayers){var b=0;for(a=a.symbolLayers;b<a.length;b++){var c=e.getStrokeColor(a[b]);if(void 0!==c)return c}}break;case "CIMTextSymbol":return e.getStrokeColor(a.symbol);case "CIMSolidStroke":return a.color}};e.getStrokeWidth=
function(a){if(a)switch(a.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(a.symbolLayers){var b=0;for(a=a.symbolLayers;b<a.length;b++){var c=e.getStrokeWidth(a[b]);if(void 0!==c)return c}}break;case "CIMTextSymbol":return e.getStrokeWidth(a.symbol);case "CIMSolidStroke":case "CIMGradientStroke":case "CIMPictureStroke":return a.width}};e.getSize=function(a){if(a)switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":var b=0;if(a.symbolLayers){var c=0;for(a=a.symbolLayers;c<
a.length;c++){var d=e.getSize(a[c]);d>b&&(b=d)}}return b;case "CIMSolidStroke":case "CIMPictureStroke":case "CIMGradientStroke":return a.width;case "CIMCharacterMarker":case "CIMPictureMarker":case "CIMVectorMarker":return a.size}};e.getMarkerScaleRatio=function(a){if(a)switch(a.type){case "CIMVectorMarker":if(!1!==a.scaleSymbolsProportionally&&a.frame)return a.size/(a.frame.ymax-a.frame.ymin)}return 1};return e}();q.CIMSymbolHelper=m;m=function(){function e(){}e.rasterizeSimpleFill=function(a,b){"solid"!==
b&&"none"!==b&&"esriSFSSolid"!==b&&"esriSFSNull"!==b||console.error("Unexpected: style does not require rasterization");a.width=8;a.height=8;var c=a.getContext("2d");c.strokeStyle="#FFFFFF";c.lineWidth=1;c.beginPath();if("vertical"===b||"cross"===b||"esriSFSCross"===b||"esriSFSVertical"===b)c.moveTo(0,0),c.lineTo(0,8);if("horizontal"===b||"cross"===b||"esriSFSCross"===b||"esriSFSHorizontal"===b)c.moveTo(0,0),c.lineTo(8,0);if("forward-diagonal"===b||"diagonal-cross"===b||"esriSFSDiagonalCross"===b||
"esriSFSForwardDiagonal"===b)c.moveTo(0,0),c.lineTo(8,8);if("backward-diagonal"===b||"diagonal-cross"===b||"esriSFSBackwardDiagonal"===b||"esriSFSDiagonalCross"===b)c.moveTo(8,0),c.lineTo(0,8);c.stroke();b=c.getImageData(0,0,a.width,a.height);b=new Uint8Array(b.data);for(var d=0;d<b.length;d+=4)c=b[d+3]/255,b[d]*=c,b[d+1]*=c,b[d+2]*=c;return[b,a.width,a.height]};e.rasterizeSimpleLine=function(a,b){switch(b){case "butt":b="Butt";break;case "square":b="Square";break;default:b="Round"}var c="Butt"===
b;switch(a){case "dash":case "esriSLSDash":a=c?[4,3]:[3,4];break;case "dash-dot":case "esriSLSDashDot":a=c?[4,3,1,3]:[3,4,0,4];break;case "dot":case "esriSLSDot":a=c?[1,3]:[0,4];break;case "long-dash":case "esriSLSLongDash":a=c?[8,3]:[7,4];break;case "long-dash-dot":case "esriSLSLongDashDot":a=c?[8,3,1,3]:[7,4,0,4];break;case "long-dash-dot-dot":case "esriSLSDashDotDot":a=c?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case "short-dash":case "esriSLSShortDash":a=c?[4,1]:[3,2];break;case "short-dash-dot":case "esriSLSShortDashDot":a=
c?[4,1,1,1]:[3,2,0,2];break;case "short-dash-dot-dot":case "esriSLSShortDashDotDot":a=c?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case "short-dot":case "esriSLSShortDot":a=c?[1,1]:[0,2];break;case "solid":case "esriSLSSolid":case "none":v.error("Unexpected: style does not require rasterization");a=[0,0];break;default:v.error("Tried to rasterize SLS, but found an unexpected style: "+a+"!"),a=[0,0]}return this.rasterizeDash(a,b)};e.rasterizeDash=function(a,b){var c="Butt"===b,d="Square"===b;b=!c&&!d;for(var e=
0,f=0;f<a.length;f++)var g=a[f],e=e+g;for(var e=15*e,k=31*e,f=new Float32Array(k),l=b?225:15,g=0;g<k;++g)f[g]=l;for(var l=k=0,m=!0,q=0;q<a.length;q++){for(var g=a[q],k=l,l=l+15*g,n=k;n<l;){for(var r=0;31>r;){var g=r*e+n,p=b?(r-15)*(r-15):Math.abs(r-15);f[g]=m?c?Math.max(Math.max(k+7.5-n,p),Math.max(n-l+7.5,p)):p:b?Math.min((n-k)*(n-k)+p,(n-l)*(n-l)+p):d?Math.min(Math.max(n-k,p),Math.max(l-n,p)):Math.min(Math.max(n-k+7.5,p),Math.max(l+7.5-n,p));r++}n++}m=!m}a=f.length;c=new Uint8Array(4*a);for(g=0;g<
a;++g)B.packFloatRGBA((b?Math.sqrt(f[g]):f[g])/15,c,4*g);return[c,e,31]};return e}();q.SymbolHelper=m;m=function(){function e(){}e.findApplicableOverrides=function(a,b,c){if(b){if(a.primitiveName){for(var d=!1,h=0;h<c.length;h++){var f=c[h];if(f.primitiveName===a.primitiveName){d=!0;break}}if(!d)for(d=0;d<b.length;d++)f=b[d],f.primitiveName===a.primitiveName&&c.push(f)}switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(a.effects)for(d=0,h=a.effects;d<h.length;d++)f=
h[d],e.findApplicableOverrides(f,b,c);if(a.symbolLayers)for(f=0,a=a.symbolLayers;f<a.length;f++)e.findApplicableOverrides(a[f],b,c);break;case "CIMSolidStroke":case "CIMPictureStroke":case "CIMGradientStroke":case "CIMSolidFill":case "CIMPictureFill":case "CIMHatchFill":case "CIMGradientFill":case "CIMVectorMarker":case "CIMCharacterMarker":case "CIMPictureMarker":if(a.effects)for(d=0,h=a.effects;d<h.length;d++)f=h[d],e.findApplicableOverrides(f,b,c);a.markerPlacement&&e.findApplicableOverrides(a.markerPlacement,
b,c);if("CIMVectorMarker"===a.type){if(a.markerGraphics)for(f=0,a=a.markerGraphics;f<a.length;f++)d=a[f],e.findApplicableOverrides(d,b,c),e.findApplicableOverrides(d.symbol,b,c)}else"CIMCharacterMarker"===a.type?e.findApplicableOverrides(a.symbol,b,c):"CIMHatchFill"===a.type&&e.findApplicableOverrides(a.lineSymbol,b,c)}}};e.applyOverrides=function(a,b,c,d){if(b){if(a.primitiveName)for(var h=0;h<b.length;h++){var f=b[h];if(f.primitiveName===a.primitiveName){var g;g=(g=f.propertyName)?g.charAt(0).toLowerCase()+
g.substr(1):g;d&&d.push({cim:a,nocapPropertyName:g,value:a[g]});f.expression&&(f.value=e.toValue(f.propertyName,f.expression));if(c){for(var k=!1,l=0,m=c;l<m.length;l++)m[l].primitiveName===a.primitiveName&&(k=!0);k||c.push(f)}a[g]=f.value}}switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(a.effects)for(f=0,g=a.effects;f<g.length;f++)h=g[f],e.applyOverrides(h,b,c,d);if(a.symbolLayers)for(h=0,a=a.symbolLayers;h<a.length;h++)e.applyOverrides(a[h],b,c,d);break;case "CIMSolidStroke":case "CIMSolidFill":case "CIMVectorMarker":if(a.effects)for(f=
0,g=a.effects;f<g.length;f++)h=g[f],e.applyOverrides(h,b,c,d);if("CIMVectorMarker"===a.type&&a.markerGraphics)for(h=0,a=a.markerGraphics;h<a.length;h++)f=a[h],e.applyOverrides(f,b,c,d),e.applyOverrides(f.symbol,b,c,d)}}};e.restoreOverrides=function(a){for(var b=0;b<a.length;b++){var c=a[b];c.cim[c.nocapPropertyName]=c.value}};e.buildOverrideKey=function(a){for(var b="",c=0;c<a.length;c++){var d=a[c];void 0!==d.value&&(b+=""+d.primitiveName+d.propertyName+JSON.stringify(d.value))}return b};e.toValue=
function(a,b){return"DashTemplate"===a?b.split(" ").map(function(a){return Number(a)}):"Color"===a?(a=(new z(b)).toRgba(),a[3]*=255,a):b};return e}();q.OverrideHelper=m});