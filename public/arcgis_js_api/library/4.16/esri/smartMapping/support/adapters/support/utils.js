// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/promiseUtils ../../../../renderers/support/heatmapUtils ../../utils ../../../../support/arcadeOnDemand ../../../../tasks/support/ClassBreaksDefinition ../../../../tasks/support/generateRendererUtils".split(" "),function(V,e,n,F,G,v,N,O,P){function H(a,b,c){b=null==b?-Infinity:b;c=null==c?Infinity:c;return a.filter(function(a){return null!=a&&q(a)&&a>=b&&a<=c})}function u(a,b){return n.__awaiter(this,void 0,void 0,function(){var c,d,f,g,m,k,l,h,C,e,t;
return n.__generator(this,function(p){switch(p.label){case 0:return c=a.field,d="function"===typeof c,f=a.valueExpression,g=a.normalizationType,m=a.normalizationField,k=a.normalizationTotal,l=[],h=a.view,e=C=null,f?r?[3,2]:[4,N.loadArcade()]:[3,3];case 1:r=t=p.sent().arcadeUtils,p.label=2;case 2:C=r.createFunction(f),e=h&&r.getViewInfo({viewingMode:"2d"===h.type?"map":h.viewingMode,scale:h.scale,spatialReference:h.spatialReference}),p.label=3;case 3:if(!b)return[2,l];b.forEach(function(a){var b=a.attributes,
h;f?(h=r.createExecContext(a,e),h=r.executeFunction(C,h)):d?h=c.call(null,a):b&&(h=b[c]);g&&null!=h&&q(h)&&(b=b&&parseFloat(b[m]),"log"===g&&0!==h?h=Math.log(h)*Math.LOG10E:"percent-of-total"===g&&q(k)&&0!==k?h=h/k*100:"field"===g&&q(b)&&0!==b&&(h/=b));l.push(h)});return[2,l]}})})}function Q(a,b){for(var c=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,f=null,g=null,m=null,k=null,l=0;l<a.length;l++)var h=a[l],f=f+h,c=Math.min(c,h),d=Math.max(d,h);if(l=a.length){g=f/l;for(k=m=0;k<a.length;k++)h=
a[k],m+=Math.pow(h-g,2);k=b?1<l?m/(l-1):0:0<l?m/l:0;m=Math.sqrt(k)}else d=c=null;return{avg:g,count:l,max:d,min:c,stddev:m,sum:f,variance:k}}function I(a){var b=a.field,c=a.classificationMethod||"equal-interval",d=a.normalizationType,f=a.normalizationField,g=new O;g.classificationField=b;g.breakCount=a.breakCount;g.classificationMethod=c;g.standardDeviationInterval="standard-deviation"===c?a.standardDeviationInterval||1:void 0;g.normalizationType=d;g.normalizationField="field"===d?f:void 0;return g}
function J(a,b){var c=b.classBreaks,d=c[0].minValue,f=c[c.length-1].maxValue,g="standard-deviation"===a.classificationMethod,m=R,c=c.map(function(a){var b=a.label;a={minValue:a.minValue,maxValue:a.maxValue,label:b};if(g&&b){var c=b.match(m).map(function(a){return+a.trim()});2===c.length?(a.minStdDev=c[0],a.maxStdDev=c[1],0>c[0]&&0<c[1]&&(a.hasAvg=!0)):1===c.length&&(-1<b.indexOf("\x3c")?(a.minStdDev=null,a.maxStdDev=c[0]):-1<b.indexOf("\x3e")&&(a.minStdDev=c[0],a.maxStdDev=null))}return a});return{minValue:d,
maxValue:f,classBreakInfos:c,normalizationTotal:b.normalizationTotal}}function x(a,b,c){b=(b-a)/c;for(var d=[],f,g=1;g<=c;g++)f=a+b,f=Number(f.toFixed(16)),d.push([a,f]),a=f;return d}function K(a){var b=a.field,c=a.normalizationType,d=a.normalizationField,f=a.normalizationTotal;a=v.isIntegerField(a.layer,b);var g=b;"percent-of-total"===c?g="(("+(a?v.castIntegerFieldToFloat(b):b)+" / "+f+") * 100)":"log"===c?g="(log("+b+") * "+S+")":"field"===c&&(g="("+(a?v.castIntegerFieldToFloat(b):b)+" / "+d+")");
return g}function T(a,b){for(var c=-1,d=a.length-1;0<=d;d--)if(b>=a[d][0]){c=d;break}return c}function L(a,b){var c;b=b.toLowerCase();if(a)for(var d in a)if(d.toLowerCase()!==b){c=a[d];break}return c}function D(a,b){var c;b=b.toLowerCase();if(a)for(var d in a)if(d.toLowerCase()===b){c=a[d];break}return c}function E(a,b){if(b)for(var c in a)a[c].label=b[c];return{count:a}}function M(a,b,c){var d=a.count;a=[];c&&b&&"coded-value"===b.type&&b.codedValues.forEach(function(a){a=a.code;d.hasOwnProperty(a)||
(d[a]={data:a,count:0})});for(var f in d)b=d[f],a.push({value:b.data,count:b.count,label:b.label});return{uniqueValueInfos:a}}function q(a){return"number"===typeof a&&!isNaN(a)&&Infinity!==a&&-Infinity!==a}Object.defineProperty(e,"__esModule",{value:!0});var U=/_value$/i,R=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,S=Math.LOG10E;e.statisticTypes="min max avg stddev count sum variance".split(" ");var r=null;e.getSummaryStatisticsFromFeatureSet=function(a,b){a=(a=a&&a.features)&&a[0]&&a[0].attributes;
var c={},d;for(d in a)c[d.replace(U,"").toLowerCase()]=a[d];c.min===c.max&&null!=c.min&&null==c.stddev&&(c.stddev=c.variance=0);b&&("min max avg stddev sum variance".split(" ").forEach(function(a){null!=c[a]&&(c[a]=Math.ceil(c[a]))}),c.min===c.max&&null!=c.min&&(c.avg=c.min,c.stddev=c.variance=0));return c};e.calculateStatsFromMemory=function(a,b,c){return n.__awaiter(this,void 0,void 0,function(){var d,f;return n.__generator(this,function(g){switch(g.label){case 0:return[4,u(a,b)];case 1:return d=
g.sent(),d=H(d,a.minValue,a.maxValue),f=Q(d,!a.normalizationType),c&&["avg","stddev","variance"].forEach(function(a){null!=f[a]&&(f[a]=Math.ceil(f[a]))}),[2,f]}})})};e.getDataValues=u;e.processSummaryStatisticsResult=function(a){for(var b in a)-1<e.statisticTypes.indexOf(b)&&(q(a[b])||(a[b]=null));return a};e.createCBDefn=I;e.calculateHeatmapStats=function(a,b,c,d,f,g){void 0===b&&(b=10);var m=new Float64Array(f*g),k=G.createKernel(b);b=Math.round(3*b);var l=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,
e=0,n=0,t=0,p=0;c=G.createValueFunction(d,c);for(d=0;d<a.length;d++)for(var z=a[d],w=z.geometry,q=w.x-b,r=w.y-b,u=Math.max(0,q),e=Math.max(0,r),v=Math.min(g,w.y+b),w=Math.min(f,w.x+b),z=+c(z.attributes),A=e;A<v;A++)for(var x=k[A-r],B=u;B<w;B++){var e=A*f+B,y=m[e],e=m[e]+=x*k[B-q]*z,y=e-y,n=n+y,t=t+y*y;e<l&&(l=e);e>h&&(h=e);p++}return p?{mean:n/p,stdDev:Math.sqrt((t-n*n/p)/p),min:l,max:h,mid:(h-l)/2,count:p}:{mean:0,stddev:0,min:0,max:0,mid:0,count:0}};e.calculateClassBreaksFromMemory=function(a,b){return n.__awaiter(this,
void 0,void 0,function(){var c,d,f,g;return n.__generator(this,function(e){switch(e.label){case 0:return c=a.normalizationTotal,d=I({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5}),[4,u(a,b)];case 1:return f=e.sent(),f=H(f,a.minValue,a.maxValue),g=P.createGenerateRendererClassBreaks({definition:d,values:f,normalizationTotal:c}),
[2,J(a,g)]}})})};e.resolveCBResult=J;e.getEqualIntervalBins=x;e.generateBinParams=function(a){var b=[],c=a.classBreaks,d=c[0].minValue,f=c[c.length-1].maxValue;c.forEach(function(a){b.push([a.minValue,a.maxValue])});return{min:d,max:f,intervals:b,sqlExpr:K({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,layer:a.layer}),excludeZerosExpr:a.where,normTotal:a.normalizationTotal}};e.getFieldExpr=K;e.calculateHistogramFromMemory=
function(a,b,c){return n.__awaiter(this,void 0,void 0,function(){var d,f,g,e,k,l,h,q,r,t,p;return n.__generator(this,function(m){switch(m.label){case 0:return d=b.min,f=b.max,g=b.normTotal,e=a.numBins||10,k=b.intervals||x(d,f,e),l=k.map(function(a,c){return{minValue:k[c][0],maxValue:k[c][1],count:0}}),[4,u(a,c)];case 1:h=m.sent();q=0;for(r=h;q<r.length;q++)t=r[q],null!=t&&t>=d&&t<=f&&(p=T(k,t),-1<p&&l[p].count++);return[2,{bins:l,minValue:d,maxValue:f,normalizationTotal:g}]}})})};e.getHistogramFromFeatureSet=
function(a,b,c,d,f){var g={};a&&a.features&&a.features.forEach(function(a){var c=a.attributes;a=L(c,"countOFExpr");c=D(c,"countOFExpr");0!==a&&(g[a]=c)});var e=[];x(b,c,d).forEach(function(a,c){c=(c+1).toString();e.push({minValue:a[0],maxValue:a[1],count:g.hasOwnProperty(c)?g[c]:0})});return{bins:e,minValue:b,maxValue:c,normalizationTotal:f}};e.getUniqueValuesFromFeatureSet=function(a,b,c,d,f){var g="countOF"+(c||"Expr"),e={},k=!1;(a&&a.features).forEach(function(a){var b=a.attributes;a=D(b,g);b=
c?D(b,c):L(b,g);null===b&&0===a&&(k=!0);if(null==b||"string"===typeof b&&""===b.trim())b=null;null==e[b]?e[b]={count:a,data:b}:e[b].count+=a});return c&&k?b.queryFeatureCount(c+" is NULL",f).then(function(a){e["null"].count+=a||0;return E(e,d)}).catch(function(){F.throwIfAborted(f);return E(e,d)}):F.resolve(E(e,d))};e.createUVResult=M;e.calculateUniqueValuesFromMemory=function(a,b,c){return n.__awaiter(this,void 0,void 0,function(){var d,e,g,m,k;return n.__generator(this,function(f){switch(f.label){case 0:return[4,
u(a,b)];case 1:d=f.sent();e={};g=0;for(m=d;g<m.length;g++){k=m[g];if(null==k||"string"===typeof k&&""===k.trim())k=null;null==e[k]?e[k]={count:1,data:k}:e[k].count++}return[2,M({count:e},c,a.returnAllCodedValues)]}})})};e.msSinceUnixEpochSQL=function(a,b){return v.getDateDiffSQL(a,new Date(0),b,"milliseconds").sqlExpression};e.isValidNumber=q});