// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Graphic ../../core/arrayUtils ../../core/compilerUtils ../../core/maybe ../../core/promiseUtils ../../core/screenUtils ../../core/accessorSupport/diffUtils ../../layers/support/fieldUtils ../../renderers/support/clickToleranceUtils ../../renderers/support/utils ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/visualVariables/support/visualVariableUtils ../../symbols/support/symbolConversion ../../symbols/support/symbolLayerUtils ../../symbols/support/symbolUtils ../../views/support/drapedUtils".split(" "),
function(W,k,f,G,H,C,u,q,z,I,D,J,K,L,M,N,E,A,O){function F(a){var c=a.layer,d;a:switch(c.renderer.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":d=!0;break a;default:d=!1}var b=(a=d&&M.getVisualVariableValues(c.renderer,a))?a.map(function(a){return a.variable}):[];d=b.filter(function(a){return"rotation"===a.type&&(!a.axis||"heading"===a.axis)});a=d[0];d=1===d.length&&a.field&&!a.valueExpression;var e=b.filter(function(a){return"size"===a.type}),b=
e[0],e=1===e.length&&"real-world-size"===L.getTransformationType(b)&&b.field&&!b.useSymbolValue&&!b.valueExpression;return{rotation:d?P(a,c):null,size:e?Q(b,c):null}}function P(a,c){var d="heading"===(a.axis||"heading")&&"arithmetic"===a.rotationType?-1:1,b=a.field,e=(a=c.fields&&c.fields.filter(function(a){return a.name===b}))&&1===a.length?a[0].type:"double",g=0,l=0;return{field:b,getDefault:function(){return q.resolve(0)},getValue:function(a){l=g-d*a;return B((l+360)%360,e)},initValue:function(a){g=
null!=a?a:l;l=0},isUpdatingInteractively:!1}}function R(a,c){switch(c){case "width":return a[0];case "depth":return a[1];case "height":return a[2];default:return a[2]||a[1]||a[0]}}function S(a,c,d){return f.__awaiter(this,void 0,void 0,function(){var b,e,g,l,p,n,h,m;return f.__generator(this,function(f){switch(f.label){case 0:if(u.isNone(c))return[2,0];b=N.to3D(c).symbol;if(u.isNone(b)||"web-style"===b.type)return[2,0];e=b.symbolLayers.getItemAt(0);if(!e)return[2,0];g=e.type;switch(g){case "icon":return[3,
1];case "text":return[3,4];case "line":return[3,5];case "object":return[3,6];case "path":return[3,8];case "extrude":return[3,8];case "fill":return[3,9];case "water":return[3,9]}return[3,10];case 1:if(l=e.size)return[3,3];n=(p=Math).min;h=[k.sizeDefaults.icon];return[4,E.computeIconLayerResourceSize(e,k.sizeDefaults.icon)];case 2:l=n.apply(p,h.concat([f.sent()[0]])),f.label=3;case 3:return[2,l||k.sizeDefaults.icon];case 4:return[2,e.size||k.sizeDefaults.text];case 5:return[2,e.size||k.sizeDefaults.line];
case 6:return[4,E.computeObjectLayerResourceSize(e,a.scale/k.sizeDefaults.viewScaleSizeFactor)];case 7:return m=f.sent(),[2,R(m,d)];case 8:return[2,e.size||a.scale/k.sizeDefaults.viewScaleSizeFactor];case 9:return[2,0];case 10:return C.neverReached(e),[2,0]}})})}function Q(a,c){var d=this,b=a.field,e=a.axis,g=(c=c.fields&&c.fields.filter(function(a){return a.name===b}))&&1===c.length?c[0].type:"double",l=0,p=0,n=K.meterIn[a.valueUnit],h;h="area"===a.valueRepresentation?function(a){return Math.pow(a*
n/2,2)*Math.PI}:"radius"===a.valueRepresentation||"distance"===a.valueRepresentation?function(a){return a*n/2}:function(a){return a*n};return{field:b,getDefault:function(a,l){return f.__awaiter(d,void 0,void 0,function(){var b,c;return f.__generator(this,function(d){switch(d.label){case 0:return b=B,c=h,[4,S(l,a,e)];case 1:return[2,b.apply(void 0,[c.apply(void 0,[d.sent()]),g])]}})})},getValue:function(a,b){l||(l=b.pixelSizeAt(b.center));p=l*a;return B(p,g)},initValue:function(a){l=null!=a?a:p;p=
0},isUpdatingInteractively:!1}}function B(a,c){switch(c){case "small-integer":case "integer":case "long":return Math.round(a);case "double":case "single":return a;default:return 0}}function w(a){return f.__awaiter(this,void 0,void 0,function(){var c,d;return f.__generator(this,function(b){switch(b.label){case 0:return[4,A.getDisplayedSymbol(a,{ignoreGraphicSymbol:!0})];case 1:return c=b.sent(),d=I.diff(a.symbol,c),u.isSome(d)&&(a.symbol=c),[2]}})})}function T(a,c,d){return f.__awaiter(this,void 0,
void 0,function(){var b,e,g,l,p,n,h,m,v,k,r,x,y,w;return f.__generator(this,function(t){switch(t.label){case 0:if("3d"!==d.type)return[2];b=c.layer;e=f.__assign({},c.template.prototype.attributes);g=new G({layer:b,sourceLayer:b,attributes:e});l=F(g);p=l.rotation;n=l.size;return[4,A.getDisplayedSymbol(g)];case 1:h=t.sent(),m=!1,v=0,k=[n,p],t.label=2;case 2:if(!(v<k.length))return[3,5];r=k[v];if(u.isNone(r))return[3,4];x=e[r.field];if(null!=x)return[3,4];y=e;w=r.field;return[4,r.getDefault(h,d)];case 3:y[w]=
t.sent(),m=!0,t.label=4;case 4:return v++,[3,2];case 5:return m?[4,A.getDisplayedSymbol(g)]:[3,7];case 6:h=t.sent(),t.label=7;case 7:switch(null===h||void 0===h?void 0:h.type){case "simple-fill":case "polygon-3d":a.polygonSymbol=h;break;case "simple-line":case "line-3d":a.polylineSymbol=h;break;case "simple-marker":case "point-3d":a.pointSymbol=h}return[2]}})})}function U(a,c,d){return f.__awaiter(this,void 0,void 0,function(){var b,e;return f.__generator(this,function(g){switch(g.label){case 0:return 0===
a.length?[2,[]]:[4,c.hitTest(d)];case 1:b=g.sent();if(0===b.results.length)return[2,[]];e=new Map;b.results.forEach(function(a){a=a.graphic;var b=a.layer;e.has(b)||e.set(b,[]);e.get(b).push(a)});return[2,q.eachAlways(a.items.filter(function(a){var b=a.layer;return-1<a.supports.indexOf("update")&&e.has(b)}).map(function(a){a=a.layer;var b=a.displayField,c=[a.objectIdField];D.hasField(a.fields,b)&&c.push(b);b=e.get(a);if(b.some(function(a){return c.some(function(b){return!(b in a.attributes)})})){var d=
a.createQuery();d.outFields=c;d.returnGeometry=!1;d.objectIds=b.map(function(a){return a.getObjectId()});return a.queryFeatures(d).then(function(a){return a.features})}return q.resolve(b)}))]}})})}function V(a,c,d){return f.__awaiter(this,void 0,void 0,function(){var b,e;return f.__generator(this,function(g){switch(g.label){case 0:return 0===a.length?[2,[]]:[4,c.hitTest(d)];case 1:b=g.sent();if(0===b.results.length)return[2,[]];e=new Set;b.results.forEach(function(a){return e.add(a.graphic.layer)});
return[2,q.eachAlways(a.items.filter(function(a){var b=a.layer;return-1<a.supports.indexOf("update")&&e.has(b)}).map(function(a){a=a.layer;var b=a.displayField,e=[a.objectIdField];D.hasField(a.fields,b)&&e.push(b);b=a.createQuery();b.outFields=e;b.returnGeometry=!1;e=J.calculateTolerance({renderer:a.renderer,event:d});b.geometry=O.createQueryGeometry(d.mapPoint,e,c);return a.queryFeatures(b).then(function(a){return a.features})}))]}})})}Object.defineProperty(k,"__esModule",{value:!0});k.getVisualVariableAttributes=
F;k.setUpFeatureAdd=function(a,c,d,b){return f.__awaiter(this,void 0,void 0,function(){var e,g,l,k=this;return f.__generator(this,function(n){switch(n.label){case 0:return e=c.layer,[4,T(a,c,d)];case 1:return n.sent(),a.layer.elevationInfo=e.elevationInfo,g=function(){return a.create(e.geometryType,{hasZ:e.capabilities.data.supportsZ})},[4,g()];case 2:return n.sent(),l=a.on("create",function(d){return f.__awaiter(k,void 0,void 0,function(){var h,l,k;return f.__generator(this,function(m){switch(m.label){case 0:h=
d.state;l=d.graphic;if("cancel"===h)return g(),[2];if("complete"!==h)return[3,2];k=l.clone();k.attributes=f.__assign({},c.template.prototype.attributes);k.layer=e;a.layer.remove(l);return[4,w(k)];case 1:m.sent(),b(k),m.label=2;case 2:return[2]}})})}),d.map.add(a.layer),[2,{remove:function(){l.remove();d.map.remove(a.layer);a.cancel()}}]}})})};k.findLayerInfo=function(a,c){return a&&H.find(a,function(a){return a.layer===c})};k.fetchCandidates=function(a,c,d){return f.__awaiter(this,void 0,void 0,function(){return f.__generator(this,
function(b){switch(c.type){case "3d":return[2,U(a,c,d)];case "2d":return[2,V(a,c,d)];default:return C.neverReached(c),[2,null]}})})};k.fetchFullFeature=function(a,c,d){var b=a.layer,e=b.createQuery();e.objectIds=[a.getAttribute(b.objectIdField)];e.outFields=["*"];e.outSpatialReference=c.spatialReference;e.returnM=b.capabilities.data.supportsM;e.returnZ=b.capabilities.data.supportsZ;return b.queryFeatures(e,d).then(function(a){return a.features[0]})};k.setUpGeometryUpdate=function(a,c,d,b,e){return f.__awaiter(this,
void 0,void 0,function(){var g,l,k,n,h,m,v,q,r,x,y=this;return f.__generator(this,function(p){switch(p.label){case 0:return g=a.clone(),[4,w(g)];case 1:return p.sent(),d.layer.add(g),g.sourceLayer=a.layer,l=function(){var d=a.layer;if("graphics"===d.type)return{remove:function(){}};var c=a.attributes[d.objectIdField],e=b.whenLayerView(d);e.then(function(a){return a.setVisibility(c,!1)});return{remove:function(){e.then(function(a){return a.setVisibility(c,!0)})}}},k=l(),n=a.layer,h=c.size,m=c.rotation,
v={multipleSelectionEnabled:!1},"point"===n.geometryType&&(v.enableRotation=!!m,v.enableScaling=!!h),d.layer.elevationInfo=n.elevationInfo,d.update(g,v),q=(u.isSome(h)||u.isSome(m))&&a.watch("attributes",function(a){return f.__awaiter(y,void 0,void 0,function(){var d,c,e;return f.__generator(this,function(f){switch(f.label){case 0:d=!1;for(c in a)e=a[c],e!==g.attributes[c]&&(g.setAttribute(c,e),d=!0,u.isSome(h)&&!h.isUpdatingInteractively&&h.field===c&&h.initValue(e),u.isSome(m)&&!m.isUpdatingInteractively&&
m.field===c&&m.initValue(e));return d&&"3d"===b.type?[4,w(g)]:[3,2];case 1:f.sent(),f.label=2;case 2:return[2]}})})}),[m,h].forEach(function(c){return f.__awaiter(y,void 0,void 0,function(){var d,e;return f.__generator(this,function(f){switch(f.label){case 0:if(u.isNone(c))return[2];d=a.attributes[c.field];if(null==d)return[3,1];c.initValue(d);return[3,4];case 1:return[4,c.getDefault(g.symbol,b)];case 2:return e=f.sent(),c.initValue(e),g.setAttribute(c.field,e),"3d"!==b.type?[3,4]:[4,w(g)];case 3:f.sent(),
f.label=4;case 4:return[2]}})})}),r=d.on("update",function(a){return f.__awaiter(y,void 0,void 0,function(){var c,k,l,n,p,q,r,t;return f.__generator(this,function(f){switch(f.label){case 0:c=a.graphics[0];k=a.state;l=a.toolEventInfo;if("complete"===k)return d.update(c,v),[2];n=l;u.isSome(m)&&n&&(p=m.field,q=m.getValue,r=m.initValue,"rotate-stop"===n.type?(m.isUpdatingInteractively=!1,r()):null!=n.angle&&(m.isUpdatingInteractively=!0,g.attributes[p]=q(n.angle/Math.PI*180,b)));t=l;u.isSome(h)&&t&&(p=
h.field,q=h.getValue,r=h.initValue,"scale-stop"===t.type?(h.isUpdatingInteractively=!1,r()):null!=t.xScale&&(h.isUpdatingInteractively=!0,g.attributes[p]=q(t.xScale,b)));return"3d"!==b.type?[3,2]:[4,w(g)];case 1:f.sent(),f.label=2;case 2:return e(c.clone()),[2]}})})}),b.map.add(d.layer),x=function(){},[2,{interactive:{remove:function(){r.remove();d.cancel();q&&q.remove();this.remove=x}},visual:{remove:function(){k.remove();b.map.remove(d.layer);d.layer.removeAll();this.remove=x}}}]}})})};k.sizeDefaults=
{icon:z.px2pt(24),text:z.px2pt(12),line:z.px2pt(1),viewScaleSizeFactor:100}});