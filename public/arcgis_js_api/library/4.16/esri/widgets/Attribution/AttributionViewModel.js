// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../geometry ../../core/arrayUtils ../../core/asyncUtils ../../core/Collection ../../core/HandleOwner ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/support/contains ../../geometry/support/webMercatorUtils".split(" "),function(A,B,e,u,v,w,q,x,r,l,y,t){function z(f,c){return f.length!==c.length||f.some(function(b,a){return b.text!==c[a].text})}function n(f,c,b){b&&c&&(v.find(f,function(a){return a.layerView===c&&a.text===b})||f.push({text:b,
layerView:c}))}var d=[];return function(f){function c(b){var a=f.call(this,b)||this;a.clear=function(){a._fetchedAttributionData.clear();a._pendingAttributions.clear();a.handles.remove("suspension");a.notifyChange("state")};a._pendingAttributions=new Set;a._fetchedAttributionData=new Map;a.items=new q;a.view=null;a._allLayerViewsChange=function(b){a.handles.remove("suspension");var k=a.get("view.allLayerViews");k&&a.handles.add(k.map(function(b){return b.watch(["suspended","attributionVisible"],a._updateAttributionItems)}),
"suspension");b&&b.removed&&b.removed.forEach(function(b){a._pendingAttributions.delete(b);a._fetchedAttributionData.delete(b)});a._updateAttributionItems()};a._updateAttributionItems=function(){var b=a.get("view.allLayerViews");d.length=0;b?(b.forEach(function(b){if(!b.suspended&&b.get("layer.attributionVisible")){var c=b.layer;if(c&&"copyright"in c&&"function"===typeof c.originOf&&"user"===c.originOf("copyright"))n(d,b,c.copyright);else if(c.hasAttributionData)if(a._fetchedAttributionData.has(b)){var h=
a._fetchedAttributionData.get(b);h&&n(d,b,a._getDynamicAttribution(h,a.view,c))}else a._fetchAttributionData(b);else(h=c.get("portalItem.accessInformation"))?n(d,b,h):n(d,b,c.copyright)}}),z(a.items,d)&&(a.items.removeAll(),a.items.addMany(d)),a.notifyChange("state")):a.clear()};a.handles.add([r.on(a,"view.allLayerViews","change",a._allLayerViewsChange,a._allLayerViewsChange,a.clear),r.whenTrue(a,"view.stationary",function(){return a._updateAttributionItems()})]);return a}e.__extends(c,f);c.prototype.destroy=
function(){this.view=null;this._fetchedAttributionData.clear();this._pendingAttributions.clear()};Object.defineProperty(c.prototype,"state",{get:function(){return this.get("view.ready")?0<this._pendingAttributions.size?"loading":"ready":"disabled"},enumerable:!0,configurable:!0});c.prototype._fetchAttributionData=function(b){return e.__awaiter(this,void 0,void 0,function(){var a,c;return e.__generator(this,function(h){switch(h.label){case 0:if(this._pendingAttributions.has(b))return[2];this._pendingAttributions.add(b);
return[4,w.result(b.layer.fetchAttributionData())];case 1:return a=h.sent(),this._pendingAttributions.has(b)&&(c=a.ok?this._createContributionIndex(a.value,"bing-maps"===b.layer.type):null,this._pendingAttributions.delete(b),this._fetchedAttributionData.set(b,c)),this._updateAttributionItems(),[2]}})})};c.prototype._createContributionIndex=function(b,a){b=b.contributors;var c={};if(!b)return c;for(var k=0;k<b.length;k++){var f=b[k],e=f.coverageAreas;if(!e)return;for(var p=0;p<e.length;p++)for(var g=
e[p],d=g.bbox,m=g.zoomMin-(a&&g.zoomMin?1:0),l=g.zoomMax-(a&&g.zoomMax?1:0),g={extent:t.geographicToWebMercator({xmin:d[1],ymin:d[0],xmax:d[3],ymax:d[2],spatialReference:u.SpatialReference.WGS84}),attribution:f.attribution||"",score:null!=g.score?g.score:100,id:k};m<=l;m++)c[m]=c[m]||[],c[m].push(g)}c.maxKey=Math.max.apply(null,Object.keys(c));return c};c.prototype._getDynamicAttribution=function(b,a,c){var d=a.extent;c=c.tileInfo.scaleToZoom(a.scale);c=Math.min(b.maxKey,Math.round(c));if(!d||null==
c||-1>=c)return"";b=b[c];var e=t.project(d.center.clone().normalize(),a.spatialReference),f={};return b?b.filter(function(a){var b=!f[a.id]&&e&&y.extentContainsPoint(a.extent,e);b&&(f[a.id]=!0);return b}).sort(function(a,b){return b.score-a.score||a.objectId-b.objectId}).map(function(a){return a.attribution}).join(", "):""};e.__decorate([l.property({readOnly:!0,type:q})],c.prototype,"items",void 0);e.__decorate([l.property({dependsOn:["view.ready"],readOnly:!0})],c.prototype,"state",null);e.__decorate([l.property()],
c.prototype,"view",void 0);return c=e.__decorate([l.subclass("esri.widgets.Attribution.AttributionViewModel")],c)}(x.HandleOwner)});