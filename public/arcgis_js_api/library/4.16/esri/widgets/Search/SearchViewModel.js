// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../assets ../../Graphic ../../PopupTemplate ../../core/Accessor ../../core/Collection ../../core/Error ../../core/Evented ../../core/geolocationUtils ../../core/Handles ../../core/has ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/Point ../../geometry/SpatialReference ../../intl/locale ../../intl/messages ../../portal/Portal ../../smartMapping/symbology/location ../../symbols/PictureMarkerSymbol ../../symbols/SimpleFillSymbol ../../symbols/SimpleLineSymbol ../../symbols/SimpleMarkerSymbol ../../symbols/TextSymbol ../../views/support/layerViewUtils ./LayerSearchSource ./LocatorSearchSource ./SearchSource ./support/geometryUtils ./support/locatorUtils ../support/GoTo".split(" "),
function(ca,da,c,G,C,w,H,I,m,J,r,K,L,M,u,g,q,e,v,N,O,P,x,y,Q,R,S,T,U,V,z,D,W,B,X,Y){function l(c,a){return c.hasOwnProperty(a)&&null!=c[a]&&""!==c[a]}var n=M.getLogger("esri.widgets.Search.SearchViewModel"),t=I.ofType({key:function(c){return c.layer?"layer":"locator"},base:W,typeMap:{layer:z,locator:D}}),F=N.WGS84,Z=/<(?:.|\s)*?>/g;return function(E){function a(b){b=E.call(this,b)||this;b._handles=new K;b._gotoController=null;b._searching=null;b.autoNavigate=!0;b.autoSelect=!0;b.defaultPopupTemplate=
null;b.defaultSources=new t;b.defaultSymbol=new Q({url:G.getAssetUrl(L("trident")?"esri/images/search/search-symbol-32.png":"esri/images/search/search-symbol-32.svg"),size:24,width:24,height:24});b.includeDefaultSources=!0;b.maxInputLength=128;b.maxResults=6;b.maxSuggestions=6;b.messages=null;b.minSuggestCharacters=1;b.popupEnabled=!0;b.popupTemplate=null;b.portal=x.getDefault();b.resultCount=null;b.resultGraphicEnabled=!0;b.resultGraphic=null;b.results=null;b.selectedSuggestion=null;b.searchAllEnabled=
!0;b.selectedResult=null;b.sources=new t;b.suggestionDelay=150;b.suggestionCount=null;b.suggestions=null;b.suggestionsEnabled=!0;b.view=null;return b}c.__extends(a,E);a.prototype.initialize=function(){var b=this,d=function(){return c.__awaiter(b,void 0,void 0,function(){var b;return c.__generator(this,function(d){switch(d.label){case 0:return[4,P.loadMessageBundle("esri/widgets/Search/t9n/Search")];case 1:return this.messages=b=d.sent(),this.defaultPopupTemplate=new w({title:b.searchResult,content:"{Match_addr}"}),
[2]}})})};d();this._handles.add([q.on(this,["defaultSources","sources"],"change",function(){return b.notifyChange("allSources")}),q.init(this,["includeDefaultSources","view","portal"],function(){return b._update()}),O.onLocaleChange(d)])};a.prototype.destroy=function(){this._abortGoTo();this.clearGraphics();this._handles.destroy();this._handles=null};Object.defineProperty(a.prototype,"activeSource",{get:function(){return this.allSources.getItemAt(this.activeSourceIndex)||null},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"activeSourceIndex",{get:function(){return 1!==this.allSources.length&&this.searchAllEnabled?-1:0},set:function(b){void 0===b?this._clearOverride("activeSourceIndex"):this._override("activeSourceIndex",b)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"allPlaceholder",{get:function(){var b;return null===(b=this.messages)||void 0===b?void 0:b.allPlaceholder},set:function(b){b?this._override("allPlaceholder",b):this._clearOverride("allPlaceholder")},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"allSources",{get:function(){var b=this.sources,d=this.defaultSources,f=this.includeDefaultSources,b="function"===typeof f?f.call(null,{sources:b,defaultSources:d}):f?d.concat(b):b,d=this._get("allSources")||new t;d.removeAll();d.addMany(b.filter(Boolean));return d},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"locationEnabled",{get:function(){return this._get("locationEnabled")||r.supported()},set:function(b){if(void 0===
b)this._clearOverride("locationEnabled");else{var d=r.supported();if(b&&!d){var f=new m("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});n.error(f)}this._override("locationEnabled",b&&d)}},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"placeholder",{get:function(){var b=this.activeSourceIndex,d=this.allPlaceholder;return-1===b?d:(b=this.allSources.getItemAt(b))?b.placeholder:""},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"searchTerm",{get:function(){return this._get("searchTerm")||""},set:function(b){this._set("searchTerm",b||"");this.clearGraphics();this.selectedSuggestion&&this.selectedSuggestion.text!==b&&this._set("selectedSuggestion",null);""===b&&this._clear()},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"state",{get:function(){return this._searching?"searching":this.updating?"loading":0===this.allSources.length?"disabled":"ready"},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"updating",{get:function(){return null!=this._updatingPromise},enumerable:!0,configurable:!0});a.prototype.clear=function(){this.searchTerm=""};a.prototype.clearGraphics=function(){this._removeHighlight();this._closePopup();this.view&&this.view.graphics.remove(this.resultGraphic);this._set("resultGraphic",null)};a.prototype.search=function(b,d){var f=this;this.emit("search-start");this.clearGraphics();var a=this._createSuggestionForSearch(b);this._searching=b=this.when().then(function(){return f._getResultsFromSources(a,
d).then(function(b){var d={activeSourceIndex:f.activeSourceIndex,searchTerm:a.text,numResults:0,numErrors:0,errors:[],results:[]};f._formatResponse(d,b,a);b=f._getFirstResult(d.results);var k=(a.location&&b?b.name:a.text).replace(Z,"");f._set("searchTerm",k);(a.key&&"number"===typeof a.sourceIndex||a.location)&&f._set("selectedSuggestion",a);f._set("results",d.results);f._set("resultCount",d.results.reduce(function(b,d){return b+d.results.length},0));f.emit("search-complete",d);return f._selectFirstResult(b).then(function(){return d})})}).then(function(b){f._clearSearching();
return b},function(b){f._clearSearching();throw b;});this.notifyChange("state");return b};a.prototype.searchNearby=function(b){var d=this;if(!this.locationEnabled){var a=new m("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});n.error(a);return g.reject(a)}this._searching=a=r.getCurrentPosition().then(function(a){return r.positionToPoint({position:a,view:d.view},b)}).then(function(a){return d.search(a,b)});this.notifyChange("state");a.catch(function(){}).then(function(){return d._clearSearching()});
return a};a.prototype.select=function(b){var d=this;this.clearGraphics();if(!b){var a=new m("select:missing-parameter","Cannot select without a searchResult.",{searchResult:b});n.error(a);return g.reject(a)}var k=this.view,c=l(b,"sourceIndex")?b.sourceIndex:this._getSourceIndexOfResult(b),h=this.allSources.getItemAt(c);if(!h)return a=new m("select:missing-source","Cannot select without a source.",{source:h}),n.error(a),g.reject(a);var a=h instanceof z?this._getLayerSourcePopupTemplate(h):h.popupTemplate,
e=h.resultSymbol||this._getDefaultSymbol(b),ba=l(h,"resultGraphicEnabled")?h.resultGraphicEnabled:this.resultGraphicEnabled,r=l(h,"autoNavigate")?h.autoNavigate:this.autoNavigate,q=l(h,"popupEnabled")?h.popupEnabled:this.popupEnabled,t=q?a||this.popupTemplate||this.defaultPopupTemplate:null,p=b.feature;if(!p)return a=new m("select:missing-feature","Cannot select without a feature.",{feature:p}),n.error(a),g.reject(a);var w=p.attributes,v=p.geometry,x=p.layer,y=p.sourceLayer,A=B.getPointFromGeometry(v),
a={layerViewQuery:this._getLayerView(p),elevationQuery:k&&u.isSome(A)?B.getPointWithElevation(A,k).catch(function(){return A}):g.resolve(A)};return g.eachAlways(a).then(function(a){var f=a.layerViewQuery.value,aa=a.elevationQuery.value;e instanceof U&&(e.text=b.name);a=k&&r?b.target||b.extent:null;return(u.isSome(a)?d._goToSearchResult(a):g.resolve()).then(function(){var a=f?p:new C({geometry:v,symbol:e,attributes:w,layer:x,sourceLayer:y,popupTemplate:t}),g=q&&d.get("view.popup");(g=g&&a.getEffectivePopupTemplate(g.defaultPopupTemplateEnabled))&&
k.popup.open({features:[a],location:aa});f&&V.highlightsSupported(f)&&!g&&d._highlightFeature({graphic:a,layerView:f});!f&&ba&&k&&k.graphics.push(a);d._set("selectedResult",b);d._set("resultGraphic",a);d.emit("select-result",{result:b,source:h,sourceIndex:c});return b})})};a.prototype.suggest=function(b,a,f){var d=this,c=b||this.searchTerm;this.emit("suggest-start",{searchTerm:c});return this._suggestTimer(a,f).then(function(){return d._suggestImmediate(c,f).then(function(b){d._set("suggestions",
b.results);d._set("suggestionCount",b.results.reduce(function(b,a){return b+a.results.length},0));d.emit("suggest-complete",b);return b})})};a.prototype.when=function(){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(b){switch(b.label){case 0:return[4,q.whenFalseOnce(this,"updating")];case 1:return b.sent(),[2]}})})};a.prototype._update=function(){return c.__awaiter(this,void 0,void 0,function(){var b,a,f,k,e;return c.__generator(this,function(d){switch(d.label){case 0:b=
this;a=b.portal;f=b.view;if(!this.includeDefaultSources)return[3,2];k=this._updatingPromise=g.eachAlways([null===a||void 0===a?void 0:a.load(),null===f||void 0===f?void 0:f.when()]);if(this.destroyed)return[2];this.notifyChange("updating");return[4,k];case 1:d.sent();if(k!==this._updatingPromise)return[2];d.label=2;case 2:this._updatingPromise=null;this.notifyChange("updating");e=q.whenOnce(this,"messages");if(this.destroyed)return[2];this._handles.add(e);return[4,e];case 3:return d.sent(),this._updateDefaultSources(),
[2]}})})};a.prototype._clearSearching=function(){this._searching=null;this.notifyChange("state")};a.prototype._convertHelperServices=function(){var b=this,a=this.get("portal.helperServices.geocode");return a?a.map(function(a){if(!1!==a.placefinding&&(a=D.fromJSON(a),X.isArcGISWorldGeocoder(a.get("locator.url"))&&a.set({singleLineFieldName:"SingleLine",outFields:["Addr_type","Match_addr","StAddr","City"],placeholder:b.messages.placeholder,defaultZoomScale:2500}),a.singleLineFieldName))return a}).filter(Boolean):
[]};a.prototype._convertApplicationProperties=function(){var b=this,a=this.get("view.map.applicationProperties.viewing.search"),f=this.get("view.map");if(!f||!a)return[];var k=a.hintText;return a.enabled?a.layers.map(function(a){var d=f.findLayerById(a.id);if(d){a=b._getLayerJSON(a);var c=z.fromJSON(a);c.placeholder=k;b._getLayer(d,a).then(function(b){c.layer=b});return c}}).filter(Boolean).toArray():[]};a.prototype._getSubLayer=function(b,a){return b&&b.allSublayers?(b=b.allSublayers.find(function(b){return b.id===
a.subLayer}))?b.createFeatureLayer():g.reject():g.reject()};a.prototype._getLayer=function(b,a){var d=this;if("feature"===b.type||"scene"===b.type)return g.resolve(b);if("map-image"===b.type)return b.load().then(function(){return d._getSubLayer(b,a).catch(function(){var a=new m("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:b});n.error(a);return null})})};a.prototype._getLayerJSON=function(b){return"function"===typeof b.toJSON?b.toJSON():b};a.prototype._updateDefaultSources=
function(){var b=this.defaultSources,a=this.includeDefaultSources;b.removeAll();a&&b.addMany(c.__spreadArrays(this._convertApplicationProperties(),this._convertHelperServices()));this.notifyChange("allSources")};a.prototype._abortGoTo=function(){this._gotoController&&this._gotoController.abort();this._gotoController=null};a.prototype._clear=function(){this._abortGoTo();this._set("resultCount",null);this._set("results",null);this._set("suggestions",null);this._set("suggestionCount",null);this._set("selectedResult",
null);this._set("selectedSuggestion",null);this.emit("search-clear")};a.prototype._closePopup=function(){var b=this.get("view.popup"),a=this.resultGraphic;if(b&&a){var f=b.selectedFeature;f&&f===a&&b.close()}};a.prototype._suggestTimer=function(b,a){return g.after(null!=b?b:this.suggestionDelay,null,a&&a.signal)};a.prototype._createLocationForSearch=function(b){return b instanceof C?B.getPointFromGeometry(b.geometry):b instanceof v?b:Array.isArray(b)&&2===b.length?new v({longitude:b[0],latitude:b[1]}):
null};a.prototype._createSuggestionForSearch=function(b){if(b&&l(b,"key")&&l(b,"text")&&l(b,"sourceIndex"))return b;var a=this._createLocationForSearch(b),f="string"===typeof b?b:this.searchTerm,k=this.selectedSuggestion,c=this.selectedResult,e=(b=!b&&k&&c)&&k.location;return b&&k.key===c.key&&k.sourceIndex===c.sourceIndex||e?k:{location:u.unwrap(a),text:a?"":f,sourceIndex:null,key:null}};a.prototype._getFirstResult=function(b){var a=null;b&&b.some(function(b){b=b.results[0];var d=!!b;d&&(a=b);return d});
return a};a.prototype._selectFirstResult=function(b){return this.autoSelect&&b?this.select(b):g.resolve()};a.prototype._suggestImmediate=function(b,a){var d=this;return this.when().then(function(){return d._getSuggestionsFromSources(b,a)}).then(function(a){var c={activeSourceIndex:d.activeSourceIndex,searchTerm:b,numResults:0,numErrors:0,errors:[],results:[]};d._formatResponse(c,a);return c})};a.prototype._formatSourceResponse=function(b,a,c){var d=a&&a.value||[];a=a&&a.error;var f=this.allSources.getItemAt(c);
a?(b.errors.push({sourceIndex:c,source:f,error:a}),b.numErrors++):(b.results.push({sourceIndex:c,source:f,results:d}),b.numResults+=d.length)};a.prototype._formatResponse=function(b,a,c){var d=this;if(a)if(-1===b.activeSourceIndex){var f=c&&l(c,"sourceIndex")&&-1!==c.sourceIndex?c.sourceIndex:void 0;a.forEach(function(a,c){d._formatSourceResponse(b,a,void 0!==f?f:c)})}else this._formatSourceResponse(b,a[0],b.activeSourceIndex)};a.prototype._getResultsFromSources=function(b,a){var d=this,c=this.allSources,
e=!b.location&&l(b,"sourceIndex")?b.sourceIndex:this.activeSourceIndex,h=[];if(!c.length)return c=new m("search:no-sources-defined","At least one source is required.",{allSources:c}),n.error(c),g.reject(c);-1===e?c.forEach(function(c,f){h.push(d._getResultsFromSource(b,f,a))}):h.push(this._getResultsFromSource(b,e,a));return g.eachAlways(h)};a.prototype._getSuggestionsFromSources=function(b,a){var d=this,c=this.allSources,e=this.activeSourceIndex,h=[];if(!c.length)return c=new m("suggest:no-sources-defined",
"At least one source is required.",{allSources:c}),n.error(c),g.reject(c);-1===e?c.forEach(function(c,f){h.push(d._getSuggestionsFromSource(b,f,a))}):h.push(this._getSuggestionsFromSource(b,e,a));return g.eachAlways(h)};a.prototype._getResultsFromSource=function(b,a,c){var d=this.allSources.getItemAt(a),f=b.location,f=void 0===f?null:f,e=this.get("view.spatialReference")||F,g=l(d,"maxResults")?d.maxResults:this.maxResults,m=d instanceof z&&l(d,"exactMatch")?d.exactMatch:!1;return d.getResults({view:this.view,
sourceIndex:a,location:f,suggestResult:b,spatialReference:e,exactMatch:m,maxResults:g},c)};a.prototype._getSuggestionsFromSource=function(b,a,c){var d=this.allSources.getItemAt(a),f=l(d,"suggestionsEnabled")?d.suggestionsEnabled:this.suggestionsEnabled,e=b.length,m=l(d,"minSuggestCharacters")?d.minSuggestCharacters:this.minSuggestCharacters;return f&&b.trim()&&e>=m?(f=this.get("view.spatialReference")||F,e=l(d,"maxSuggestions")?d.maxSuggestions:this.maxSuggestions,d.getSuggestions({view:this.view,
sourceIndex:a,suggestTerm:b,spatialReference:f,maxSuggestions:e},c)):g.resolve()};a.prototype.createDefaultSymbol=function(b,a){if("point"===a)return new T({color:b.color,size:b.size,outline:{color:b.outline.color,width:b.outline.width}});if("polyline"===a)return new S({color:b.color,width:b.width});if("polygon"===a)return new R({color:b.color,outline:{color:b.outline.color,width:b.outline.width}})};a.prototype._getLayerSourcePopupTemplate=function(b){var a=b.layer;if(a)return l(b,"popupTemplate")?
b.popupTemplate:a.popupTemplate};a.prototype._getSourceIndexOfResult=function(b){var a=null;this.results.some(function(d){return d.results.some(function(c){return c===b?(a=d.sourceIndex,!0):!1})});return a};a.prototype._goToSearchResult=function(b){return c.__awaiter(this,void 0,void 0,function(){var a,f,e;return c.__generator(this,function(d){switch(d.label){case 0:return a=!!b,this._abortGoTo(),this._gotoController=f=g.createAbortController(),e={target:{target:b},options:{animate:a,signal:f.signal}},
[4,this.callGoTo(e)];case 1:return d.sent(),this._gotoController=null,[2]}})})};a.prototype._getDefaultSymbol=function(b){var a=this.get("view.map.basemap.id");b=u.get(b,"feature","geometry","type");return u.isSome(b)&&(a=(a=y.getSchemes({basemap:a,geometryType:b})||y.getSchemes({basemap:"topo",geometryType:b}))&&a.primaryScheme)?(a.color&&l(a,"opacity")&&(a.color.a=a.opacity),this.createDefaultSymbol(a,b)):this.defaultSymbol};a.prototype._removeHighlight=function(){this._handles.remove("highlight")};
a.prototype._getLayerView=function(b){return c.__awaiter(this,void 0,void 0,function(){var a,f;return c.__generator(this,function(c){switch(c.label){case 0:a=this.view;if(!b||!a)return[2,g.resolve(null)];f=b.layer;return[4,a.when()];case 1:return c.sent(),[2,a.whenLayerView(f)]}})})};a.prototype._highlightFeature=function(b){var a=b.graphic,c=a.attributes,e=a.layer.objectIdField;b=b.layerView.highlight(c&&c[e]||a);this._handles.add(b,"highlight")};a.ALL_INDEX=-1;c.__decorate([e.property({readOnly:!0,
dependsOn:["activeSourceIndex","allSources.length"],value:null})],a.prototype,"activeSource",null);c.__decorate([e.property({dependsOn:["allSources.length","searchAllEnabled"]})],a.prototype,"activeSourceIndex",null);c.__decorate([e.property({dependsOn:["messages"]})],a.prototype,"allPlaceholder",null);c.__decorate([e.property({dependsOn:["defaultSources.length","sources.length","includeDefaultSources"],readOnly:!0})],a.prototype,"allSources",null);c.__decorate([e.property()],a.prototype,"autoNavigate",
void 0);c.__decorate([e.property()],a.prototype,"autoSelect",void 0);c.__decorate([e.property()],a.prototype,"defaultPopupTemplate",void 0);c.__decorate([e.property({readOnly:!0})],a.prototype,"defaultSources",void 0);c.__decorate([e.property()],a.prototype,"defaultSymbol",void 0);c.__decorate([e.property()],a.prototype,"includeDefaultSources",void 0);c.__decorate([e.property()],a.prototype,"locationEnabled",null);c.__decorate([e.property()],a.prototype,"maxInputLength",void 0);c.__decorate([e.property()],
a.prototype,"maxResults",void 0);c.__decorate([e.property()],a.prototype,"maxSuggestions",void 0);c.__decorate([e.property()],a.prototype,"messages",void 0);c.__decorate([e.property()],a.prototype,"minSuggestCharacters",void 0);c.__decorate([e.property({readOnly:!0,dependsOn:["activeSourceIndex","activeSource.placeholder","allPlaceholder","allSources"]})],a.prototype,"placeholder",null);c.__decorate([e.property()],a.prototype,"popupEnabled",void 0);c.__decorate([e.property({type:w})],a.prototype,
"popupTemplate",void 0);c.__decorate([e.property({type:x})],a.prototype,"portal",void 0);c.__decorate([e.property()],a.prototype,"resultCount",void 0);c.__decorate([e.property()],a.prototype,"resultGraphicEnabled",void 0);c.__decorate([e.property({readOnly:!0})],a.prototype,"resultGraphic",void 0);c.__decorate([e.property({readOnly:!0})],a.prototype,"results",void 0);c.__decorate([e.property({readOnly:!0})],a.prototype,"selectedSuggestion",void 0);c.__decorate([e.property()],a.prototype,"searchAllEnabled",
void 0);c.__decorate([e.property({readOnly:!0})],a.prototype,"selectedResult",void 0);c.__decorate([e.property()],a.prototype,"searchTerm",null);c.__decorate([e.property({type:t})],a.prototype,"sources",void 0);c.__decorate([e.property({readOnly:!0,dependsOn:["allSources.length","updating"]})],a.prototype,"state",null);c.__decorate([e.property()],a.prototype,"suggestionDelay",void 0);c.__decorate([e.property()],a.prototype,"suggestionCount",void 0);c.__decorate([e.property({readOnly:!0})],a.prototype,
"suggestions",void 0);c.__decorate([e.property()],a.prototype,"suggestionsEnabled",void 0);c.__decorate([e.property({readOnly:!0})],a.prototype,"updating",null);c.__decorate([e.property()],a.prototype,"view",void 0);c.__decorate([e.property()],a.prototype,"clear",null);return a=c.__decorate([e.subclass("esri.widgets.Search.SearchViewModel")],a)}(Y.GoToMixin(J.EventedMixin(H)))});