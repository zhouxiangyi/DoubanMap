// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../intl ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/unitUtils ../../../geometry/Polygon ./geometryUtils".split(" "),function(W,z,B,u,J,K,L,A,M,N,C){function D(a,c){var b=a.filter;c=c&&c.extent;a=a.withinViewEnabled&&c?c:void 0;return b&&b.geometry||a}function E(a){return a?a.load().then(A.resolve).catch(A.reject):A.resolve()}function F(a){return a&&!!a.get("capabilities.query.supportsPagination")}
function G(a){var c="";a&&(a=a.fields)&&a.some(function(a){return"string"===a.type?(c=a.name,!0):!1});return c}function x(a,c){return a&&c?c.every(function(c){return!!a.getField(c)}):!1}function O(a){for(var c=0;c<a.length;c++)if(255<a.charCodeAt(c))return!0;return!1}function P(a,c,b){var h=null;(a=a.codedValues)&&a.some(function(a){var e=a.name,e=b?e:e.toLowerCase();return(b?c:c.toLowerCase())===e?(h=a.code.toString(),!0):!1});return h}function t(a,c){return(c=c&&c.where)?"("+a+") AND ("+c+")":a}
function H(a,c,b,h,k){var e=c.definitionExpression,l="";if(a){var d=Q.test(c.url)&&O(a)?"N":"";b&&b.forEach(function(b){var f=c.getField(b);b=((b="function"===typeof c.getFieldDomain&&c.getFieldDomain(b))&&"coded-value"===b.type?P(b,a,k):null)||a||null;if(null!==b){var e=f.type,f=f.name;"string"===e||"date"===e||"global-id"===e?k?f=t(f+" \x3d "+d+"'"+b+"'",h):(b=b.toUpperCase(),f=t("UPPER("+f+") LIKE "+d+"'%"+b+"%'",h)):"oid"===e||"small-integer"===e||"integer"===e||"single"===e||"double"===e?(b=
Number(b),f=isNaN(b)?null:t(f+" \x3d "+b,h)):f=t(f+" \x3d "+b,h);f&&(l+=l?" OR ("+f+")":"("+f+")")}})}return e?"("+e+") AND ("+l+")":l}function R(a,c){var b=null;(a=a.codedValues)&&a.length&&a.some(function(a){return a.code===c?(b=a.name,!0):!1});return b}function I(a,c,b){var h=a.layer,k=a.attributes,e="function"===typeof h.getFieldDomain&&h.getFieldDomain(b);return c?B.substitute(c,k):b&&a.hasOwnProperty("attributes")&&k.hasOwnProperty(b)?(a=k[b],b=h.getField(b),e&&"coded-value"===e.type?R(e,a):
b&&"date"===b.type?B.formatDate(new Date(a)):"number"===typeof a?a.toString():"string"!==typeof a?"":a.trim()):""}function S(a,c,b,h){return a.features.map(function(a){var e=a.attributes[a.layer.objectIdField];return{text:I(a,c.suggestionTemplate,h),key:e,sourceIndex:b}})}function T(a,c,b,h,k,e,l){return a.features.map(function(a){var d=a.clone(),f=a.layer,f=(f=f&&f.objectIdField)&&a.attributes[f],r=I(a,b.searchTemplate,k),g=C.createExtentFromGeometry(d.geometry,c,e),g="number"===typeof l?C.scaleExtent(J.clone(g),
c,l):g;a=a.clone();L.isSome(g)&&(a.geometry=N.fromExtent(g));return{extent:g,target:a,feature:d,key:f,name:r,sourceIndex:h}})}Object.defineProperty(z,"__esModule",{value:!0});var Q=/https?:\/\/services.*\.arcgis\.com/i,U=/(?:\{([^}]+)\})/g,v=K.getLogger("esri.widgets.Search.support.layerSearchUtils");z.getResults=function(a,c){var b=a.exactMatch,h=void 0===b?!1:b,k=a.location,e=a.maxResults,l=a.spatialReference,d=a.source,t=a.sourceIndex,f=a.suggestResult,r=a.view,g=d.layer,V=d.filter,q=d.zoomScale,
m=r&&r.scale,n=D(d,r),w=c&&c.signal;return E(g).then(function(){var a=g.popupTemplate;return a?a.getRequiredFields(g.fields):null}).then(function(a){var b=g.objectIdField,c=g.returnZ,y=d.displayField||d.layer.displayField||G(d.layer);if(!g.getField(y))throw v.error("invalid-field: displayField is invalid."),new u("getResults():invalid-field","displayField is invalid.");a=a&&a.length?a:[y];var p=(a=d.outFields||a)&&-1!==a.indexOf("*");-1!==a.indexOf(b)||p||a.push(b);if(!p&&!x(g,a))throw v.error("invalid-field: outField is invalid."),
new u("getResults():invalid-field","outField is invalid.");b=g.createQuery();if(p=d.orderByFields)b.orderByFields=p;l&&(b.outSpatialReference=l,p=1/M.getMetersPerUnitForSR(l))&&(b.maxAllowableOffset=p);p=!!g.get("capabilities.data.supportsZ");b.returnZ=p&&!1!==c;b.returnGeometry=!0;a&&(b.outFields=a);if(k)b.geometry=k;else if(f.key)b.objectIds=[parseInt(f.key,10)];else{c=d.searchFields||[y];if(!x(g,c))throw v.error("invalid-field: search field is invalid."),new u("getResults():invalid-field","search field is invalid.");
F(g)&&(b.num=e);n&&(b.geometry=n);if(!f.text.trim())return[];a=d.prefix;p=d.suffix;a=(""+(void 0===a?"":a)+f.text+(void 0===p?"":p)).replace(/\'/g,"''");c=H(a,g,c,V,h);if(!c)return[];b.where=c}return g.queryFeatures(b,{signal:w}).then(function(a){return T(a,r,d,t,y,m,q)})})};z.getSuggestions=function(a,c){var b=a.source,h=a.spatialReference,k=a.suggestTerm,e=a.maxSuggestions,l=a.sourceIndex,d=b.layer,t=b.filter,f=c&&c.signal,r=D(b,a.view);return E(d).then(function(){if(!F(d))return[];var a=b.displayField||
b.layer.displayField||G(b.layer),c=b.searchFields||[a],q=[];b.suggestionTemplate?b.suggestionTemplate.replace(U,function(a,b){q.push(b);return a}):q.push(a);var m=q&&-1!==q.indexOf("*");-1!==q.indexOf(d.objectIdField)||m||q.push(d.objectIdField);var n=!!d.getField(a),m=m||x(d,q),w=x(d,c);if(!n)throw v.error("invalid-field: displayField is invalid."),new u("getSuggestions():invalid-field","displayField is invalid.");if(!m)throw v.error("invalid-field: outField is invalid."),new u("getSuggestions():invalid-field",
"outField is invalid.");if(!w)throw v.error("invalid-field: search field is invalid."),new u("getSuggestions():invalid-field","search field is invalid.");n=d.createQuery();if(m=b.orderByFields)n.orderByFields=m;n.outSpatialReference=h;n.returnGeometry=!1;n.num=e;n.outFields=q;r&&(n.geometry=r);if(!k.trim())return[];m=b.prefix;w=b.suffix;m=(""+(void 0===m?"":m)+k+(void 0===w?"":w)).replace(/\'/g,"''");c=H(m,d,c,t,!1);if(!c)return[];n.where=c;return d.queryFeatures(n,{signal:f}).then(function(c){return S(c,
b,l,a)})})}});