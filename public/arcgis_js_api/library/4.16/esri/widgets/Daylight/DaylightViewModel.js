// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../core/HandleOwner ../../core/maybe ../../core/scheduling ../../core/watchUtils ../../core/accessorSupport/decorators ../../views/SceneView ../../views/3d/environment/SceneViewLighting ../../views/3d/support/earthUtils ./daylightUtils ./daylightUtils ./support/SliderWithDropdownViewModel ../support/DatePickerViewModel".split(" "),function(u,v,d,m,n,p,f,c,q,r,t,e,g,h,k){return function(l){function a(b){b=l.call(this,b)||this;b.view=null;b.datePickerViewModel=new k;
b.timeSliderViewModel=new h.SliderWithDropdownViewModel;b.lightingUpdateInterval=200;b._cachedLightingDateUTC=new Date(0);b._cachedDisplayUTCOffset=0;b._enableShadowsOnFirstInteraction=!0;b._lastLightingUpdate=0;b._nextLightingUpdate=null;b.playSpeedMultiplier=1;return b}d.__extends(a,l);a.prototype.initialize=function(){var b=this;this.handles.add([f.init(this,"view",function(){b.view&&b.view.when(function(){return b._updateLighting(null)})}),f.watch(this,"view.environment.lighting.date",function(a){return b._scheduleUpdateLighting(a)}),
f.on(this,"view.environment.lighting","timezone-will-change",function(a){return b._timezoneWillChange(a)},function(){return b._timezoneWillChange(null)}),f.init(this,"view.stationary",function(){(b.dayPlaying||b.yearPlaying)&&b._updateSunriseAndSunset()}),this.watch(["timeSliderPosition","timeSliderViewModel.state"],function(){"ready"===b.timeSliderViewModel.state&&b.timeSliderViewModel.setValue(0,b.timeSliderPosition)}),this.timeSliderViewModel.watch("currentItem",function(a){return b.utcOffset=
a.abbr}),this.timeSliderViewModel.watch("isDropdownOpen",function(){return b.stopPlaying()}),this.timeSliderViewModel.watch("values",function(a){return b.timeSliderPosition=a[0]}),this.datePickerViewModel.watch("value",function(a){b.dayPlaying=!1;b.localDate=a}),this.watch("localDate",function(a){return d.__awaiter(b,void 0,void 0,function(){return d.__generator(this,function(b){this.datePickerViewModel.value.valueOf()!==a.getTime()&&this.datePickerViewModel.set("value",a);return[2]})})})])};a.prototype.destroy=
function(){this._nextLightingUpdate&&(clearTimeout(this._nextLightingUpdate),this._nextLightingUpdate=null);this.view=null};Object.defineProperty(a.prototype,"isSupported",{get:function(){return!this.view||"3d"===this.view.type},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"utcOffset",{get:function(){return this._cachedDisplayUTCOffset},set:function(b){b!==this.utcOffset&&(this.view.environment.lighting.displayUTCOffset=b,this._updateLighting(null))},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"localDate",{get:function(){return e.dateTimeToLocalDate(this._lightingDateDisplay)},set:function(b){b.getTime()!==this.localDate.getTime()&&(this._lightingDateDisplay=e.localDateToDateTime(this._lightingDateDisplay,b))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"timeSliderPosition",{get:function(){return e.dateTimeToSliderPos(this._lightingDateDisplay)},set:function(b){Math.abs(b-this.timeSliderPosition)>1/60&&(this._lightingDateDisplay=e.sliderPosToDateTime(this._lightingDateDisplay,
b),this.stopPlaying(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"_lightingDateDisplay",{get:function(){return e.dateAddHours(this._cachedLightingDateUTC,this._cachedDisplayUTCOffset)},set:function(b){b=e.dateAddHours(b,-this._cachedDisplayUTCOffset);b.getTime()!==this.view.environment.lighting.date.getTime()&&(this.view.environment.lighting.date=b,this._updateLighting(null))},
enumerable:!0,configurable:!0});a.prototype._timezoneFromCamera=function(b){b=b.camera.position;b=t.positionToTimezone([b.longitude,b.latitude]);return n.isSome(b)?Math.round(b.hours+b.minutes/60+b.seconds/3600):0};Object.defineProperty(a.prototype,"directShadowsAvailable",{get:function(){return void 0!==this.view._stage.renderView.getRenderParameters().shadowMap},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"playingState",{set:function(b){this.playingState!==b&&(this._set("playingState",
b),"none"!==b&&(this._updateSunriseAndSunset(),this._lastTime=(new Date).getTime(),this._play(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1)))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"dayPlaying",{get:function(){return"day"===this.playingState},set:function(b){b?this.playingState="day":this.dayPlaying&&(this.playingState="none")},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"yearPlaying",
{get:function(){return"year"===this.playingState},set:function(b){b?this.playingState="year":this.yearPlaying&&(this.playingState="none")},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"currentSeason",{get:function(){return e.getSeasonFromDate(this.localDate,this._currentHemisphere)},set:function(b){this.stopPlaying();b=e.getNorthernHemisphereSeason(b,this._currentHemisphere);this.localDate=e.getSeasonDate(this.localDate,b,g.Hemisphere.NORTHERN)},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"_currentHemisphere",{get:function(){var b,a,d=null===(a=null===(b=this.view)||void 0===b?void 0:b.camera)||void 0===a?void 0:a.position;return d?0<=d.latitude?g.Hemisphere.NORTHERN:g.Hemisphere.SOUTHERN:g.Hemisphere.NORTHERN},enumerable:!0,configurable:!0});a.prototype.stopPlaying=function(){this.playingState="none"};a.prototype.toggleDayPlaying=function(){this.dayPlaying=!this.dayPlaying};a.prototype.toggleYearPlaying=function(){this.yearPlaying=!this.yearPlaying};
a.prototype.toggleDirectShadows=function(){this.stopPlaying();this.directShadowsEnabled=!this.directShadowsEnabled};a.prototype._updateLighting=function(b){var a,d;this._lastLightingUpdate=Date.now();var c=null===(d=null===(a=this.view)||void 0===a?void 0:a.environment)||void 0===d?void 0:d.lighting;c&&(b=b||c.date,c=c.displayUTCOffset,c=null!==c?c:this._timezoneFromCamera(this.view),this._cachedLightingDateUTC.getTime()!==b.getTime()&&(this._cachedLightingDateUTC=new Date(b.getTime())),this._cachedDisplayUTCOffset!==
c&&(this._cachedDisplayUTCOffset=c))};a.prototype._timezoneWillChange=function(b){var a,d,c=null===(d=null===(a=this.view)||void 0===a?void 0:a.environment)||void 0===d?void 0:d.lighting;if(c){if(b)b=b.timezoneOffset;else{if(null!=c.displayUTCOffset)return;b=r.calculateTimezoneOffset(c.positionTimezoneInfo)}c.displayUTCOffset=b;this._scheduleUpdateLighting(null)}};a.prototype._scheduleUpdateLighting=function(b){var a=this;if(!this._nextLightingUpdate){var c=Date.now()-this._lastLightingUpdate,c=this.lightingUpdateInterval-
c;0>=c?p.schedule(function(){return a._updateLighting(b)}):this._nextLightingUpdate=setTimeout(function(){a._updateLighting(null);a._nextLightingUpdate=null},c)}};a.prototype._play=function(){var b=this,a,c=this.view;if(null!==(a=this.view)&&void 0!==a&&a.environment&&(this.dayPlaying||this.yearPlaying)){a=(new Date).getTime()-this._lastTime;if(this.dayPlaying){if(this._lastTime=(new Date).getTime(),a*=e.calculatePlaySpeed(this._sunrise,this._sunset,c.environment.lighting.date)*this.playSpeedMultiplier/
100,0<a){var d=new Date(c.environment.lighting.date.getTime()+a),f=((d.getUTCHours()+c.environment.lighting.displayUTCOffset)%24+24)%24,g=((c.environment.lighting.date.getUTCHours()+c.environment.lighting.displayUTCOffset)%24+24)%24;f<g&&(d=new Date(c.environment.lighting.date.getTime()+a-864E5));c.environment.lighting.date=d}}else 1E3<a&&(this._lastTime=(new Date).getTime(),a=(c.environment.lighting.date.getUTCMonth()+1)%12,d=new Date(c.environment.lighting.date.getTime()),d.setUTCMonth(a),c.environment.lighting.date=
d);requestAnimationFrame(function(){return b._play()})}};a.prototype._updateSunriseAndSunset=function(){var a=e.getSunriseAndSunsetTimes(this.view.environment.lighting.date,this.view.camera.position.latitude,this.view.camera.position.longitude,this.view.environment.lighting.displayUTCOffset);this._sunrise=new Date(a.sunrise);this._sunset=new Date(a.sunset)};d.__decorate([c.property({type:q})],a.prototype,"view",void 0);d.__decorate([c.property({type:k})],a.prototype,"datePickerViewModel",void 0);
d.__decorate([c.property({type:h.SliderWithDropdownViewModel})],a.prototype,"timeSliderViewModel",void 0);d.__decorate([c.property({dependsOn:["view.type"]})],a.prototype,"isSupported",null);d.__decorate([c.property()],a.prototype,"lightingUpdateInterval",void 0);d.__decorate([c.property()],a.prototype,"_cachedLightingDateUTC",void 0);d.__decorate([c.property()],a.prototype,"_cachedDisplayUTCOffset",void 0);d.__decorate([c.property()],a.prototype,"_enableShadowsOnFirstInteraction",void 0);d.__decorate([c.property({dependsOn:["_cachedDisplayUTCOffset"]})],
a.prototype,"utcOffset",null);d.__decorate([c.property({dependsOn:["_lightingDateDisplay"]})],a.prototype,"localDate",null);d.__decorate([c.property({dependsOn:["_lightingDateDisplay"]})],a.prototype,"timeSliderPosition",null);d.__decorate([c.property({dependsOn:["_cachedDisplayUTCOffset","_cachedLightingDateUTC"]})],a.prototype,"_lightingDateDisplay",null);d.__decorate([c.property({aliasOf:"view.environment.lighting.directShadowsEnabled"})],a.prototype,"directShadowsEnabled",void 0);d.__decorate([c.property({dependsOn:["view"],
readOnly:!0})],a.prototype,"directShadowsAvailable",null);d.__decorate([c.property({type:["none","day","year"],value:"none"})],a.prototype,"playingState",null);d.__decorate([c.property({dependsOn:["playingState"]})],a.prototype,"dayPlaying",null);d.__decorate([c.property({dependsOn:["playingState"]})],a.prototype,"yearPlaying",null);d.__decorate([c.property()],a.prototype,"playSpeedMultiplier",void 0);d.__decorate([c.property({dependsOn:["localDate","_currentHemisphere"]})],a.prototype,"currentSeason",
null);d.__decorate([c.property()],a.prototype,"_lastTime",void 0);d.__decorate([c.property()],a.prototype,"_sunrise",void 0);d.__decorate([c.property()],a.prototype,"_sunset",void 0);d.__decorate([c.property({readOnly:!0,dependsOn:["view.camera.position.latitude"]})],a.prototype,"_currentHemisphere",null);return a=d.__decorate([c.subclass("esri.widgets.Daylight.DaylightViewModel")],a)}(m.HandleOwner)});