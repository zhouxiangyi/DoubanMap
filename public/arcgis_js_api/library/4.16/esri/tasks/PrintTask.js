// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports tslib ../kernel ../request ../core/Error ../core/has ../core/jsonMap ../core/lang ../core/promiseUtils ../core/screenUtils ../core/SetUtils ../core/string ../core/urlUtils ../core/accessorSupport/decorators ../geometry/Polygon ../renderers/visualVariables/support/visualVariableUtils ./Geoprocessor ./Task ./support/fileFormat ./support/layoutTemplate ./support/printTaskUtils ./support/PrintTemplate ./support/Query @dojo/framework/shim/Promise".split(" "),function(R,fa,d,G,M,
S,N,H,K,T,v,U,O,E,I,V,W,X,Y,Z,aa,r,ba,ca){function J(d){return d&&(d.path||"image/svg+xml"===d.contentType||d.url&&O.endsWith(d.url,".svg"))}var P={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},Q=new H.default({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),da=new H.default({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"}),ea=new ca({returnGeometry:!0});return function(H){function h(){for(var a=[],c=0;c<arguments.length;c++)a[c]=arguments[c];
a=H.apply(this,a)||this;a._ssExtent=null;a._legendLayers=[];a._legendLayerNameMap={};a._gpServerUrl=null;a._cimVersion=null;a._is11xService=!1;a._gpMetadata=null;a.updateDelay=1E3;return a}d.__extends(h,H);Object.defineProperty(h.prototype,"_geoprocessor",{get:function(){return new X({url:this.url})},enumerable:!0,configurable:!0});Object.defineProperty(h.prototype,"mode",{get:function(){return this._gpMetadata&&this._gpMetadata.executionType?da.fromJSON(this._gpMetadata.executionType):"sync"},enumerable:!0,
configurable:!0});h.prototype.execute=function(a,c){var e=this,b=this.url,g=b.lastIndexOf("/GPServer/");0<g&&(b=b.slice(0,g+9));return T.resolve().then(function(){if(e._gpServerUrl===b)return{data:e._gpMetadata};e._gpServerUrl=b;return M(b,{query:{f:"json"}})}).then(function(b){e._gpMetadata=b.data;e._cimVersion=e._gpMetadata.cimVersion;e._is11xService=!!e._cimVersion;return e._getGpPrintParams(a)}).then(function(a){var b=function(a){return"sync"===e.mode?a.results&&a.results[0]&&a.results[0].value:
e._geoprocessor.getResultData(a.jobId,"Output_File",c).then(function(a){return a.value})};return"async"===e.mode?e._geoprocessor.submitJob(a,c).then(function(a){return e._geoprocessor.waitForJobCompletion(a.jobId,{interval:e.updateDelay}).then(b)}):e._geoprocessor.execute(a,c).then(b)})};h.prototype._createOperationalLayers=function(a,c){return d.__awaiter(this,void 0,void 0,function(){var e,b,g,q,k,n,l,f,m;return d.__generator(this,function(d){switch(d.label){case 0:e=[],b={layerView:null,printTemplate:c,
view:a},g=0,c.scalePreserved&&(g=c.outScale||a.scale),q=r.getVisibleLayerViews(a,g),k=0,n=q,d.label=1;case 1:if(!(k<n.length))return[3,27];l=n[k];f=l.layer;if(!f.loaded||r.isGroupLayer(f))return[3,26];m=void 0;b.layerView=l;if(!r.isBingMapsLayer(f))return[3,2];m=this._createBingMapsLayerJSON(f);return[3,25];case 2:return r.isCSVLayer(f)?[4,this._createCSVLayerJSON(f,b)]:[3,4];case 3:return m=d.sent(),[3,25];case 4:return r.isFeatureLayer(f)?[4,this._createFeatureLayerJSON(f,b)]:[3,6];case 5:return m=
d.sent(),[3,25];case 6:return r.isGraphicsLayer(f)?[4,this._createGraphicsLayerJSON(f,b)]:[3,8];case 7:return m=d.sent(),[3,25];case 8:if(!r.isImageryLayer(f))return[3,9];m=this._createImageryLayerJSON(f);return[3,25];case 9:return r.isKMLLayer(f)?[4,this._createKMLLayerJSON(f,b)]:[3,11];case 10:return m=d.sent(),[3,25];case 11:if(!r.isMapImageLayer(f))return[3,12];m=this._createMapImageLayerJSON(f,b);return[3,25];case 12:return r.isMapNotesLayer(f)?[4,this._createMapNotesLayerJSON(b)]:[3,14];case 13:return m=
d.sent(),[3,25];case 14:if(!r.isOpenStreetMapLayer(f))return[3,15];m=this._createOpenStreetMapLayerJSON();return[3,25];case 15:return r.isStreamLayer(f)?[4,this._createStreamLayerJSON(f,b)]:[3,17];case 16:return m=d.sent(),[3,25];case 17:if(!r.isTileLayer(f))return[3,18];m=this._createTileLayerJSON(f);return[3,25];case 18:return r.isVectorTileLayer(f)?[4,this._createVectorTileLayerJSON(f,b)]:[3,20];case 19:return m=d.sent(),[3,25];case 20:if(!r.isWebTileLayer(f))return[3,21];m=this._createWebTileLayerJSON(f);
return[3,25];case 21:if(!r.isWMSLayer(f))return[3,22];m=this._createWMSLayerJSON(f);return[3,25];case 22:if(!r.isWMTSLayer(f))return[3,23];m=this._createWMTSLayerJSON(f);return[3,25];case 23:return[4,this._createScreenshotJSON(f,b)];case 24:m=d.sent(),d.label=25;case 25:m&&(Array.isArray(m)?e.push.apply(e,m):(m.id=f.id,m.title=this._legendLayerNameMap[f.id]||f.title,m.opacity=f.opacity,m.minScale=f.minScale||0,m.maxScale=f.maxScale||0,e.push(m))),d.label=26;case 26:return k++,[3,1];case 27:return g&&
e.forEach(function(a){a.minScale=0;a.maxScale=0}),a.graphics&&a.graphics.length?[4,this._createFeatureCollectionJSON(null,a.graphics,c)]:[3,29];case 28:(m=d.sent())&&e.push(m),d.label=29;case 29:return[2,e]}})})};h.prototype._createBingMapsLayerJSON=function(a){return{culture:a.culture,key:a.key,type:"BingMaps"+("aerial"===a.style?"Aerial":"hybrid"===a.style?"Hybrid":"Road")}};h.prototype._createCSVLayerJSON=function(a,c){var e=c.layerView,b=c.printTemplate;return d.__awaiter(this,void 0,void 0,function(){var c,
q;return d.__generator(this,function(g){switch(g.label){case 0:this._legendLayers&&this._legendLayers.push({id:a.id});if(!this._is11xService)return[3,1];c={type:"CSV"};a.write(c,{origin:"web-map"});delete c.popupInfo;delete c.layerType;c.showLabels=b.showLabels&&a.labelsVisible;return[3,3];case 1:return[4,this._getGraphics(e)];case 2:return q=g.sent(),[2,this._createFeatureCollectionJSON(a,q,b)];case 3:return[2,c]}})})};h.prototype._createFeatureCollectionJSON=function(a,c,e){return d.__awaiter(this,
void 0,void 0,function(){var b,g,q,k,n,l,f,m,h,C,t,u,z,p,x,A,B,y,v,F,D,L;return d.__generator(this,function(w){switch(w.label){case 0:b=a;g=r.createPolygonLayer();q=r.createPolylineLayer();k=r.createPointLayer();n=r.createMultipointLayer();l=r.createPointLayer();l.layerDefinition.name="textLayer";delete l.layerDefinition.drawingInfo;b&&("esri.layers.FeatureLayer"===b.declaredClass||"esri.layers.StreamLayer"===b.declaredClass?g.layerDefinition.name=q.layerDefinition.name=k.layerDefinition.name=n.layerDefinition.name=
this._legendLayerNameMap[b.id]||b.get("arcgisProps.title")||b.title:"esri.layers.GraphicsLayer"===b.declaredClass&&(c=b.graphics.items));b&&b.renderer?(f=b.renderer.toJSON(),g.layerDefinition.drawingInfo.renderer=f,q.layerDefinition.drawingInfo.renderer=f,k.layerDefinition.drawingInfo.renderer=f,n.layerDefinition.drawingInfo.renderer=f):(delete g.layerDefinition.drawingInfo,delete q.layerDefinition.drawingInfo,delete k.layerDefinition.drawingInfo,delete n.layerDefinition.drawingInfo);h=b&&b.fields;
C=b&&b.renderer;if(!h||!C||"function"!==typeof C.collectRequiredFields)return[3,2];t=new Set;return[4,C.collectRequiredFields(t,h)];case 1:w.sent(),m=U.valuesOfSet(t),w.label=2;case 2:h&&(u=h.map(function(a){return a.toJSON()}),g.layerDefinition.fields=u,q.layerDefinition.fields=u,k.layerDefinition.fields=u,n.layerDefinition.fields=u),z=c&&c.length,x=function(a){var f,h,w,t,F,u;return d.__generator(this,function(d){switch(d.label){case 0:f=c[a]||c.getItemAt(a);if(!1===f.visible||!f.geometry)return[2,
"continue"];p=f.toJSON();p.hasOwnProperty("popupTemplate")&&delete p.popupTemplate;p.geometry&&p.geometry.z&&delete p.geometry.z;if(p.symbol&&p.symbol.outline&&"esriCLS"===p.symbol.outline.type&&!A._is11xService)return[2,"continue"];!A._is11xService&&p.symbol&&p.symbol.outline&&p.symbol.outline.color&&p.symbol.outline.color[3]&&(p.symbol.outline.color[3]=255);h=b&&b.renderer&&("valueExpression"in b.renderer&&b.renderer.valueExpression||"hasVisualVariables"in b.renderer&&b.renderer.hasVisualVariables());
if(p.symbol||!b||!b.renderer||!h||A._is11xService)return[3,2];w=b.renderer;return[4,w.getSymbolAsync(f)];case 1:t=d.sent();if(!t)return[2,"continue"];p.symbol=t.toJSON();"hasVisualVariables"in w&&w.hasVisualVariables()&&r.applyVisualVariables(p.symbol,{renderer:w,graphic:f,symbol:t});d.label=2;case 2:if(!p.symbol)return[3,5];p.symbol.angle||delete p.symbol.angle;if(!J(p.symbol))return[3,4];F=p;return[4,A._convertSvgToPictureMarkerSymbolJson(p.symbol)];case 3:return F.symbol=d.sent(),[3,5];case 4:p.symbol.text&&
delete p.attributes,d.label=5;case 5:return e&&e.forceFeatureAttributes||!m||!m.length||(u={},m.forEach(function(a){p.attributes&&p.attributes.hasOwnProperty(a)&&(u[a]=p.attributes[a])}),p.attributes=u),"polygon"===f.geometry.type?g.featureSet.features.push(p):"polyline"===f.geometry.type?q.featureSet.features.push(p):"point"===f.geometry.type?p.symbol&&p.symbol.text?l.featureSet.features.push(p):k.featureSet.features.push(p):"multipoint"===f.geometry.type?n.featureSet.features.push(p):"extent"===
f.geometry.type&&(p.geometry=V.fromExtent(f.geometry).toJSON(),g.featureSet.features.push(p)),[2]}})},A=this,B=0,w.label=3;case 3:return B<z?[5,x(B)]:[3,6];case 4:w.sent(),w.label=5;case 5:return B++,[3,3];case 6:y=[g,q,n,k,l].filter(function(a){return 0<a.featureSet.features.length}),v=0,F=y,w.label=7;case 7:if(!(v<F.length))return[3,10];D=F[v];L=D.featureSet.features.every(function(a){return a.symbol});!L||e&&e.forceFeatureAttributes||D.featureSet.features.forEach(function(a){delete a.attributes});
L&&delete D.layerDefinition.drawingInfo;return D.layerDefinition.drawingInfo&&D.layerDefinition.drawingInfo.renderer?[4,this._convertSvgRenderer(D.layerDefinition.drawingInfo.renderer)]:[3,9];case 8:w.sent(),w.label=9;case 9:return v++,[3,7];case 10:return[2,y.length?{featureCollection:{layers:y}}:null]}})})};h.prototype._createFeatureLayerJSON=function(a,c){var e,b,g,q;return d.__awaiter(this,void 0,void 0,function(){var k,n,l,f,m,h,r,t,u,v;return d.__generator(this,function(d){switch(d.label){case 0:this._legendLayers&&
this._legendLayers.push({id:a.id});n=a.renderer;if(a.featureReduction||n&&"dot-density"===n.type&&(!this._is11xService||2.6>parseFloat(this._cimVersion)))return[2,this._createScreenshotJSON(a,c)];l=c.layerView;f=c.printTemplate;m=c.view;h=n&&("valueExpression"in n&&n.valueExpression||"hasVisualVariables"in n&&n.hasVisualVariables());r="feature-layer"!==(null===(e=a.source)||void 0===e?void 0:e.type)&&"ogc-feature"!==(null===(b=a.source)||void 0===b?void 0:b.type);if(!this._is11xService&&h||a.featureReduction||
r||!n||"field"in n&&null!=n.field&&("string"!==typeof n.field||!a.getField(n.field)))return[3,3];d=a.write();k={id:d.id,title:d.title,opacity:d.opacity,minScale:d.minScale,maxScale:d.maxScale,url:d.url,layerDefinition:d.layerDefinition};k.showLabels=f.showLabels&&a.labelsVisible;this._setURLandToken(k,a);if(null===(q=null===(g=k.layerDefinition)||void 0===g?void 0:g.drawingInfo)||void 0===q||!q.renderer)return[3,2];delete k.layerDefinition.minScale;delete k.layerDefinition.maxScale;return[4,this._convertSvgRenderer(k.layerDefinition.drawingInfo.renderer)];
case 1:d.sent(),"visualVariables"in n&&n.visualVariables&&n.visualVariables[0]&&(t=n.visualVariables[0],"size"===t.type&&t.maxSize&&"number"!==typeof t.maxSize&&t.minSize&&"number"!==typeof t.minSize&&(u=W.getSizeRangeAtScale(t,m.scale),k.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=u.minSize,k.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=u.maxSize)),d.label=2;case 2:return[3,6];case 3:return[4,this._getGraphics(l)];case 4:return v=d.sent(),[4,this._createFeatureCollectionJSON(a,
v,f)];case 5:k=d.sent(),d.label=6;case 6:return[2,k]}})})};h.prototype._createGraphicsLayerJSON=function(a,c){var e=c.printTemplate;return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(b){return[2,this._createFeatureCollectionJSON(a,null,e)]})})};h.prototype._createImageryLayerJSON=function(a){this._legendLayers&&this._legendLayers.push({id:a.id});var c={bandIds:a.bandIds,compressionQuality:a.compressionQuality,format:a.format,interpolation:a.interpolation};if(a.mosaicRule||
a.definitionExpression)c.mosaicRule=a.exportImageServiceParameters.mosaicRule.toJSON();if(a.renderingRule||a.renderer)if(this._is11xService)a.renderingRule&&(c.renderingRule=a.renderingRule.toJSON()),a.renderer&&(c.layerDefinition=c.layerDefinition||{},c.layerDefinition.drawingInfo=c.layerDefinition.drawingInfo||{},c.layerDefinition.drawingInfo.renderer=a.renderer.toJSON());else{var e=a.exportImageServiceParameters.combineRendererWithRenderingRule();e&&(c.renderingRule=e.toJSON())}this._setURLandToken(c,
a);return c};h.prototype._createKMLLayerJSON=function(a,c){return d.__awaiter(this,void 0,void 0,function(){var e,b,g,q,k,n,l;return d.__generator(this,function(f){switch(f.label){case 0:e=c.printTemplate;if(this._is11xService)return b={type:"kml"},a.write(b,{origin:"web-map"}),delete b.layerType,b.url=E.normalize(a.url),[2,b];g=[];q=c.layerView;q.allVisibleMapImages.forEach(function(b,c){c={id:a.id+"_image"+c,type:"image",title:a.id,minScale:a.minScale||0,maxScale:a.maxScale||0,opacity:a.opacity,
extent:b.extent};"data:image/png;base64,"===b.href.substr(0,22)?c.imageData=b.href.substr(22):c.url=b.href;g.push(c)});k=d.__spreadArrays(q.allVisiblePoints.items,q.allVisiblePolylines.items,q.allVisiblePolygons.items);l=[{id:a.id}];return[4,this._createFeatureCollectionJSON(null,k,e)];case 1:return n=d.__assign.apply(void 0,l.concat([f.sent()])),g.push(n),[2,g]}})})};h.prototype._createMapImageLayerJSON=function(a,c){var e,b={id:a.id,subLayerIds:[]},g=[],d=c.view.scale,k=function(a){var c=0===d,
e=0===a.minScale||d<=a.minScale,m=0===a.maxScale||d>=a.maxScale;a.visible&&(c||e&&m)&&(a.sublayers?a.sublayers.forEach(k):(c=a.write({}),e=a.toExportImageJSON(),c.layerDefinition={drawingInfo:e.drawingInfo,definitionExpression:e.definitionExpression,source:e.source},g.unshift(c),b.subLayerIds.push(a.id)))};a.sublayers&&a.sublayers.forEach(k);g.length&&(g=g.map(function(a){return{id:a.id,name:a.name,layerDefinition:a.layerDefinition}}),e={layers:g,visibleLayers:b.subLayerIds},this._setURLandToken(e,
a),this._legendLayers.push(b));return e};h.prototype._createMapNotesLayerJSON=function(a){var c=a.layerView,e=a.printTemplate;return d.__awaiter(this,void 0,void 0,function(){var a,g,q,k,n;return d.__generator(this,function(b){switch(b.label){case 0:a=[],g=0,q=c.graphicsViews,b.label=1;case 1:if(!(g<q.length))return[3,4];k=q[g];return[4,this._createFeatureCollectionJSON(k,k.graphics,e)];case 2:(n=b.sent())&&a.push.apply(a,n.featureCollection.layers),b.label=3;case 3:return g++,[3,1];case 4:return[2,
{featureCollection:{layers:a}}]}})})};h.prototype._createOpenStreetMapLayerJSON=function(){return{type:"OpenStreetMap"}};h.prototype._createScreenshotJSON=function(a,c){var e=c.printTemplate,b=c.view;return d.__awaiter(this,void 0,void 0,function(){var c,q,k,n,l,f,m,h,r,t;return d.__generator(this,function(d){switch(d.label){case 0:return c={type:"image"},q={format:"png",ignoreBackground:!0,layers:[a],rotation:0},k=this._ssExtent||b.extent.clone(),n=96,f=l=!0,e.exportOptions&&(m=e.exportOptions,0<
m.dpi&&(n=m.dpi),0<m.width&&(l=m.width%2===b.width%2),0<m.height&&(f=m.height%2===b.height%2)),"map-only"!==e.layout||!e.scalePreserved||e.outScale&&e.outScale!==b.scale||96!==n||l&&f||(q.area={x:0,y:0,width:b.width,height:b.height},l||--q.area.width,f||--q.area.height,this._ssExtent||(h=b.toMap(v.createScreenPoint(q.area.width,q.area.height)),k.ymin=h.y,k.xmax=h.x,this._ssExtent=k)),c.extent=k.clone()._normalize(!0).toJSON(),[4,b.takeScreenshot(q)];case 1:return r=d.sent(),t=E.dataComponents(r.dataUrl),
c.imageData=t.data,[2,c]}})})};h.prototype._createStreamLayerJSON=function(a,c){var e=c.layerView,b=c.printTemplate;return d.__awaiter(this,void 0,void 0,function(){var c;return d.__generator(this,function(d){switch(d.label){case 0:return this._legendLayers&&this._legendLayers.push({id:a.id}),[4,this._getGraphics(e)];case 1:return c=d.sent(),[2,this._createFeatureCollectionJSON(a,c,b)]}})})};h.prototype._createTileLayerJSON=function(a){var c={};this._setURLandToken(c,a);return c};h.prototype._createVectorTileLayerJSON=
function(a,c){return d.__awaiter(this,void 0,void 0,function(){var e,b,g;return d.__generator(this,function(d){return this._is11xService&&a.serviceUrl&&a.styleUrl&&(e=G.id&&G.id.findCredential(a.styleUrl),b=G.id&&G.id.findCredential(a.serviceUrl),!e&&!b||"2.1.0"!==this._cimVersion)?(g={type:"VectorTileLayer"},g.styleUrl=E.normalize(a.styleUrl),e&&(g.token=e.token),b&&b.token!==g.token&&(g.additionalTokens=[{url:a.serviceUrl,token:b.token}]),[2,g]):[2,this._createScreenshotJSON(a,c)]})})};h.prototype._createWebTileLayerJSON=
function(a){var c={type:"WebTiledLayer",urlTemplate:a.urlTemplate.replace(/\${/g,"{"),credits:a.copyright};a.subDomains&&0<a.subDomains.length&&(c.subDomains=a.subDomains);return c};h.prototype._createWMSLayerJSON=function(a){var c,e=[],b=function(a){a.visible&&(a.sublayers?a.sublayers.forEach(b):a.name&&e.unshift(a.name))};a.sublayers&&a.sublayers.forEach(b);e.length&&(c={type:"wms",customLayerParameters:a.customLayerParameters,customParameters:a.customParameters,transparentBackground:a.imageTransparency,
visibleLayers:e,url:E.normalize(a.url),version:a.version});return c};h.prototype._createWMTSLayerJSON=function(a){var c=a.activeLayer;return{type:"wmts",customLayerParameters:a.customLayerParameters,customParameters:a.customParameters,format:c.imageFormat,layer:c.id,style:c.styleId,tileMatrixSet:c.tileMatrixSetId,url:E.normalize(a.url)}};h.prototype._setURLandToken=function(a,c){var e;c.url&&(a.url=E.normalize(a.url||c.url),c=null===(e=G.id)||void 0===e?void 0:e.findCredential(c.url))&&(a.token=c.token)};
h.prototype._convertSvgToPictureMarkerSymbolJson=function(a){var c;return d.__awaiter(this,void 0,void 0,function(){var e,b,g,q,k,n,l,f,m,h,C,t,u,z,p,x;return d.__generator(this,function(d){switch(d.label){case 0:if(N("trident"))return[2,null];this._canvas||(this._canvas=document.createElement("canvas"));e=1024;this._canvas.width=e;this._canvas.height=e;b=this._canvas.getContext("2d");if(!a.path)return[3,4];k=void 0;if(!N("edge"))return[3,2];k=new Path2D;return[4,new Promise(function(a,b){R(["../libs/draw-svg-path/index"],
a,b)})];case 1:return n=d.sent(),n.draw(k,a.path),[3,3];case 2:k=new Path2D(a.path),d.label=3;case 3:k.closePath();b.fillStyle=Array.isArray(a.color)?"rgba("+a.color[0]+","+a.color[1]+","+a.color[2]+","+a.color[3]/255+")":"rgb(0,0,0)";b.fill(k);l=r.getContextBoundingBox(b);if(!l)return[2,null];b.clearRect(0,0,e,e);f=v.pt2px(a.size)/Math.max(l.width,l.height);b.scale(f,f);m=e/f;h=m/2-l.width/2-l.x;C=m/2-l.height/2-l.y;b.translate(h,C);Array.isArray(a.color)&&b.fill(k);(null===(c=a.outline)||void 0===
c?0:c.width)&&Array.isArray(a.outline.color)&&(t=a.outline,b.lineWidth=v.pt2px(t.width)/f,b.lineJoin="round",b.strokeStyle="rgba("+t.color[0]+","+t.color[1]+","+t.color[2]+","+t.color[3]/255+")",b.stroke(k),l.width+=b.lineWidth,l.height+=b.lineWidth);l.width*=f;l.height*=f;u=b.getImageData(e/2-l.width/2,e/2-l.height/2,Math.ceil(l.width),Math.ceil(l.height));g=u.width;q=u.height;b.canvas.width=g;b.canvas.height=q;b.putImageData(u,0,0);return[3,6];case 4:return z="image/svg+xml"===a.contentType?"data:image/svg+xml;base64,"+
a.imageData:a.url,[4,M(z,{responseType:"image"})];case 5:p=d.sent().data,g=v.pt2px(a.width),q=v.pt2px(a.height),b.canvas.width=g,b.canvas.height=q,b.drawImage(p,0,0,b.canvas.width,b.canvas.height),d.label=6;case 6:return x=b.canvas.toDataURL("image/png"),[2,{type:"esriPMS",imageData:x.substr(22),angle:a.angle,contentType:"image/png",height:v.px2pt(q),width:v.px2pt(g),xoffset:a.xoffset,yoffset:a.yoffset}]}})})};h.prototype._convertSvgRenderer=function(a){return d.__awaiter(this,void 0,void 0,function(){var c,
e,b,g,h,k,n,l,f;return d.__generator(this,function(d){switch(d.label){case 0:c=a.type;if("simple"!==c||!J(a.symbol))return[3,2];e=a;return[4,this._convertSvgToPictureMarkerSymbolJson(a.symbol)];case 1:return e.symbol=d.sent(),[3,8];case 2:if("unique-value"!==c&&"class-breaks"!==c)return[3,8];if(!J(a.defaultSymbol))return[3,4];b=a;return[4,this._convertSvgToPictureMarkerSymbolJson(a.defaultSymbol)];case 3:b.defaultSymbol=d.sent(),d.label=4;case 4:g="unique-value"===c?"uniqueValueInfos":"classBreakInfos";
h=a[g];if(!h)return[3,8];k=0;n=h;d.label=5;case 5:if(!(k<n.length))return[3,8];l=n[k];if(!J(l.symbol))return[3,7];f=l;return[4,this._convertSvgToPictureMarkerSymbolJson(l.symbol)];case 6:f.symbol=d.sent(),d.label=7;case 7:return k++,[3,5];case 8:return[2]}})})};h.prototype._getGraphics=function(a){return a.queryFeatures(ea).then(function(a){return a.features})};h.prototype._getPrintDefinition=function(a,c){return d.__awaiter(this,void 0,void 0,function(){var e,b,g,h,k;return d.__generator(this,function(d){switch(d.label){case 0:return e=
a.view,b=e.spatialReference,h={},[4,this._createOperationalLayers(e,c)];case 1:return g=(h.operationalLayers=d.sent(),h),k=this._ssExtent||a.extent||e.extent,b&&b.isWrappable&&(k=k.clone()._normalize(!0),b=k.spatialReference),g.mapOptions={extent:k&&k.toJSON(),spatialReference:b&&b.toJSON(),showAttribution:c.attributionVisible},this._ssExtent=null,e.rotation&&(g.mapOptions.rotation=-e.rotation),c.scalePreserved&&(g.mapOptions.scale=c.outScale||e.scale),[2,g]}})})};h.prototype._getGpPrintParams=function(a){return d.__awaiter(this,
void 0,void 0,function(){var c,e,b,g,h,k,n,l,f,m,r,v,t,u,z,p,x,A,B,y=this;return d.__generator(this,function(d){switch(d.label){case 0:c=a.template||new ba;null==c.showLabels&&(c.showLabels=!0);e=c.exportOptions;g=aa.toJSON(c.layout);e&&(h=e.dpi,b={dpi:h},"map_only"===g.toLowerCase()||""===g)&&(k=e.width,n=e.height,b.outputSize=[k,n]);if(l=c.layoutOptions){r=m=void 0;if("Miles"===l.scalebarUnit||"Kilometers"===l.scalebarUnit)m="Kilometers",r="Miles";else if("Meters"===l.scalebarUnit||"Feet"===l.scalebarUnit)m=
"Meters",r="Feet";f={titleText:l.titleText,authorText:l.authorText,copyrightText:l.copyrightText,customTextElements:l.customTextElements,scaleBarOptions:{metricUnit:Q.toJSON(m),metricLabel:P[m],nonMetricUnit:Q.toJSON(r),nonMetricLabel:P[r]}}}v=null;l&&l.legendLayers&&(v=l.legendLayers.map(function(a){y._legendLayerNameMap[a.layerId]=a.title;var b={id:a.layerId};a.subLayerIds&&(b.subLayerIds=a.subLayerIds);return b}));return[4,this._getPrintDefinition(a,c)];case 1:return t=d.sent(),t.operationalLayers&&
(u=/[\u4E00-\u9FFF\u0E00-\u0E7F\u0900-\u097F\u3040-\u309F\u30A0-\u30FF\u31F0-\u31FF]/,z=/[\u0600-\u06FF]/,p=function(a){var b=a.text,c=(a=a.font)&&a.family&&a.family.toLowerCase();b&&a&&("arial"===c||"arial unicode ms"===c)&&(a.family=u.test(b)?"Arial Unicode MS":"Arial","normal"!==a.style&&z.test(b)&&(a.family="Arial Unicode MS"))},x=function(){throw new S("print-task:cim-symbol-unsupported","CIMSymbol is not supported by a print service published from ArcMap");},t.operationalLayers.forEach(function(a){var b,
c,d;(null===(b=a.featureCollection)||void 0===b?0:b.layers)?a.featureCollection.layers.forEach(function(a){var b,c,d,e;if(null===(d=null===(c=null===(b=a.layerDefinition)||void 0===b?void 0:b.drawingInfo)||void 0===c?void 0:c.renderer)||void 0===d?0:d.symbol)b=a.layerDefinition.drawingInfo.renderer,"esriTS"===b.symbol.type?p(b.symbol):"CIMSymbolReference"!==b.symbol.type||y._is11xService||x();(null===(e=a.featureSet)||void 0===e?0:e.features)&&a.featureSet.features.forEach(function(a){a.symbol&&("esriTS"===
a.symbol.type?p(a.symbol):"CIMSymbolReference"!==a.symbol.type||y._is11xService||x())})}):!y._is11xService&&(null===(d=null===(c=a.layerDefinition)||void 0===c?void 0:c.drawingInfo)||void 0===d?0:d.renderer)&&O.includes(JSON.stringify(a.layerDefinition.drawingInfo.renderer),'"type":"CIMSymbolReference"')&&x()})),a.outSpatialReference&&(t.mapOptions.spatialReference=a.outSpatialReference.toJSON()),K.mixin(t,{exportOptions:b,layoutOptions:f}),K.mixin(t.layoutOptions,{legendOptions:{operationalLayers:null!=
v?v:this._legendLayers.slice()}}),this._legendLayers.length=0,A=JSON.stringify(t),B={Web_Map_as_JSON:A,Format:Z.toJSON(c.format),Layout_Template:g},a.extraParameters&&K.mixin(B,a.extraParameters),[2,B]}})})};d.__decorate([I.property({dependsOn:["url"]})],h.prototype,"_geoprocessor",null);d.__decorate([I.property()],h.prototype,"_gpMetadata",void 0);d.__decorate([I.property({dependsOn:["_gpMetadata"],readOnly:!0})],h.prototype,"mode",null);d.__decorate([I.property()],h.prototype,"updateDelay",void 0);
return h=d.__decorate([I.subclass("esri.tasks.PrintTask")],h)}(Y)});